<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>시나리오 쓰기: 나의 이야기로 성장하기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2em;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 1em;
            text-align: center;
            font-size: 2.2em;
        }

        h3 {
            color: #34495e;
            margin-bottom: 1em;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5em;
        }

        .prompt {
            white-space: pre-line;
            background-color: #ecf0f1;
            padding: 1.5em;
            border-radius: 8px;
            margin-bottom: 1em;
            border-left: 4px solid #3498db;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1em;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .api-section {
            margin: 1em 0;
            padding: 1em;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        input[type="password"] {
            width: 300px;
            padding: 0.5em;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            margin-right: 1em;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.7em 1.5em;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .button-group {
            text-align: center;
            margin-top: 1.5em;
        }

        .button-group button {
            margin: 0 0.5em;
        }

        .summary-block {
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 1em;
            margin-bottom: 1em;
            border-radius: 5px;
        }

        .summary-block strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 0.5em;
        }

        .summary-block p {
            white-space: pre-line;
            margin: 0;
        }

        

        .loading {
            opacity: 0.7;
        }

        /* PHQ-9 공통 스타일 */
        .phq9-screening {
            --bg:#f7f8fa; --fg:#222; --muted:#6b7280; --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
            --card:#ffffff; --border:#e5e7eb; --shadow:0 8px 24px rgba(0,0,0,.06);
            background: var(--bg); 
            min-height: 100vh; 
            padding: 24px; 
            font-family: system-ui, -apple-system, sans-serif;
            position: relative;
            z-index: 1000;
            display: block !important;
        }
        .phq9-screening * { box-sizing: border-box; }
        .phq9-wrap { max-width: 920px; margin: 0 auto; }
        .phq9-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 24px; }
        .phq9-title { font-size: 28px; margin: 0 0 8px; color: var(--fg); }
        .phq9-sub { color: var(--muted); margin-bottom: 16px; }
        .phq9-grid { display: grid; gap: 12px; }
        .phq9-q { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: #fff; }
        .phq9-q h3 { margin: 0 0 8px; font-size: 16px; }
        .phq9-opts { display: flex; gap: 12px; flex-wrap: wrap; }
        .phq9-opt { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; }
        .phq9-opt input { accent-color: var(--brand); }
        .phq9-result { margin-top: 18px; border-top: 1px solid var(--border); padding-top: 16px; }
        .phq9-score { font-size: 18px; font-weight: 700; }
        .phq9-sev { display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
        .phq9-sev.none { background: #e5f9f1; }
        .phq9-sev.mild { background: #e8f0ff; }
        .phq9-sev.mod { background: #fff7e6; }
        .phq9-sev.modsev { background: #ffe7e7; }
        .phq9-sev.sev { background: #ffd6d6; }
        .phq9-note { color: var(--muted); font-size: 13px; }
        .phq9-btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .phq9-btn { 
            appearance: none; 
            border: none; 
            border-radius: 10px; 
            padding: 12px 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 5px;
            display: inline-block;
        }
        .phq9-primary { background: var(--brand); color: #fff; }
        .phq9-ghost { background: #fff; border: 1px solid var(--border); color: var(--fg); }
        .phq9-danger { background: var(--bad); color: #fff; }
        .phq9-foot { margin-top: 16px; font-size: 12px; color: var(--muted); }
        .phq9-warn { color: var(--bad); font-weight: 700; }
        .phq9-ok { color: var(--ok); font-weight: 700; }
        .phq9-progress { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }

        /* fadeIn 애니메이션 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-indicator {
            text-align: center;
            margin-bottom: 2em;
        }

        .progress-step {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #bdc3c7;
            color: white;
            text-align: center;
            line-height: 30px;
            margin: 0 0.5em;
            font-weight: bold;
        }

        .progress-step.active {
            background-color: #3498db;
        }

        .progress-step.completed {
            background-color: #27ae60;
        }
        .input-guide {
            background: #fffbe6;
            color: #b8860b;
            border-left: 4px solid #ffd700;
            padding: 0.7em 1em;
            margin-bottom: 1em;
            border-radius: 6px;
            font-size: 1em;
        }
        /* ========= 갈등 다이어그램 스타일 (여기서부터 수정됨) ========= */
        .diagram-container {
            position: relative;
            width: 650px;
            height: 650px;
            margin: 0 auto;
        }

        .circle {
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
        }

        .outer-circle { width: 100%; height: 100%; border: 2.5px solid #333; }
        .middle-circle { width: 65%; height: 65%; border: 2px solid #e0e0e0; }
        .inner-circle { width: 35%; height: 35%; border: 2px solid #e0e0e0; }

        .label-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            padding: 1em;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .label-container > div {
            pointer-events: auto;
        }

        .label-intrapersonal {
            width: 35%;
            height: 35%;
            font-size: 1em;
            justify-content: center;
        }
        .label-personal {
            width: 65%;
            height: 65%;
            justify-content: flex-start;
            padding-top: 1%;
        }
        .label-transpersonal {
            width: 100%;
            height: 100%;
            justify-content: flex-start;
            padding-top: 2%;
        }

        .conflict-title {
            font-weight: 700;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 0.1em;
        }
        .conflict-meaning {
            font-size: 1em;
            color: #777;
            margin-bottom: 0.7em;
        }
        .conflict-example {
            font-size: 0.9em;
            color: #999;
            line-height: 1.4;
        }
        /* ========= 스타일 수정 끝 ========= */
        
        /* ========= GAD-7 전용 스타일 ========= */
        .gad7-wrap {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .gad7-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .gad7-title {
            color: #1f2937;
            font-size: 1.875rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .gad7-sub {
            color: #6b7280;
            font-size: 1.125rem;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 32px;
        }
        
        .gad7-grid {
            display: grid;
            gap: 24px;
        }
        
        .gad7-q {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }
        
        .gad7-q h3 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .gad7-opts {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gad7-opt {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .gad7-opt:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .gad7-opt input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .gad7-opt.selected {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1e40af;
        }
        
        .gad7-progress, .gad7-result {
            text-align: center;
            margin: 24px 0;
        }
        
        .gad7-btns {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }
        
        .gad7-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 1rem;
        }
        
        .gad7-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .gad7-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .gad7-btn.gad7-ghost {
            background: #f3f4f6;
            color: #374151;
        }
        
        .gad7-btn.gad7-primary {
            background: #3b82f6;
            color: white;
        }
        
        .gad7-score {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin: 16px 0;
        }
        
        .gad7-sev {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            margin: 16px 0;
        }
        
        .gad7-sev.none { background: #d4edda; color: #155724; }
        .gad7-sev.mild { background: #fff3cd; color: #856404; }
        .gad7-sev.mod { background: #f8d7da; color: #721c24; }
.gad7-sev.sev { background: #f5c6cb; color: #721c24; }
        
        .gad7-note {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #0c4a6e;
        }
        
        .gad7-foot {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        
        .gad7-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0c4a6e;
        }
        
        .gad7-warn {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        /* ========= GAD-7 전용 스타일 끝 ========= */
        
        /* ========= 인구통계 수집 화면 스타일 ========= */
        .demographics-survey {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Arial', sans-serif;
        }
        
        .demo-wrap {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .demo-card {
            padding: 32px;
        }
        
        .demo-title {
            text-align: center;
            color: #1f2937;
            margin-bottom: 16px;
            font-size: 2em;
            font-weight: 700;
        }
        
        .demo-sub {
            text-align: center;
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .demo-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .demo-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .demo-section h3 {
            color: #374151;
            margin: 0 0 16px 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .demo-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .demo-option {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .demo-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .demo-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .demo-label {
            font-size: 1.1em;
            color: #374151;
            font-weight: 500;
        }
        
        .demo-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .demo-input input,
        .demo-input select {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.2s ease;
        }
        
        .demo-input input:focus,
        .demo-input select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .demo-unit {
            color: #6b7280;
            font-size: 1.1em;
            font-weight: 500;
            min-width: 30px;
        }
        
        .demo-btns {
            text-align: center;
            margin-top: 40px;
        }
        
        .demo-btn {
            padding: 16px 32px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .demo-primary {
            background: #3b82f6;
            color: white;
        }
        
        .demo-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .demo-primary:active {
            transform: translateY(0);
        }
        
        /* ========= 인구통계 수집 화면 스타일 끝 ========= */
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:right;margin-bottom:0.5em;">
            <button id="showIntroBtn" style="background:#f1c40f;color:#333;font-size:0.97em;padding:0.5em 1.2em;border-radius:6px;">안내사항 보기</button>
        </div>
        <h2 id="programTitle" style="cursor:pointer;">시나리오 쓰기: 나의 이야기로 성장하기</h2>
        <div id="programDesc" style="display:none;text-align:center;margin-bottom:1.5em;color:#555;font-size:1.13em;line-height:1.7;">
            누구나 인생의 전환점이 되는 힘든 경험을 합니다.<br><br>
            이 프로그램은 마음에 오래 남아있는 기억들을 한 편의 이야기로 완성하며, 그 안에서 새로운 의미와 자신의 강점을 발견하도록 돕습니다.<br><br>
            시나리오를 쓰면서 생각과 감정을 정리하고, 성장하는 경험을 해보세요.
        </div>
        

        
        <div class="progress-indicator">
            <span class="progress-step" id="step1">1</span>
            <span class="progress-step" id="step2">2</span>
            <span class="progress-step" id="step3">3</span>
            <span class="progress-step" id="step4">4</span>
        </div>

        <h3 id="stageTitle"></h3>
        
        <div class="prompt" id="stagePrompt"></div>
        
        <textarea id="responseTextarea" placeholder="여기에 내용을 작성하세요..."></textarea>
        
        <div class="api-section">
            
            <button id="suggestBtn" style="margin-left: 1em;">AI 제안/질문</button>
    
        </div>
        
        <div id="aiResults"></div>
        
        <div class="button-group">
            <button id="clearAllBtn" style="background:#e74c3c;color:white;">입력값 전체 삭제</button>
            <button id="prevBtn" style="display: none;">← 이전</button>
            <button id="nextBtn">다음 →</button>
        </div>
    </div>

    <footer style="font-size: 0.8em; color: #666; text-align: center; margin-top: 2em;">
      <div style="margin-bottom:8px;">
        <button id="toggleRefsBtn" style="background:#f1c40f;color:#333;font-size:0.9em;padding:0.35em 0.9em;border-radius:6px;border:none;cursor:pointer;">참고문헌 보기</button>
      </div>
      <div id="referencesPanel" style="display:none; text-align:left; max-width:880px; margin:0 auto; background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; padding:12px;">
        <ol style="margin:0; padding-left:20px;">
          <li style="margin:6px 0;">
            <a href="https://scienceon.kisti.re.kr/srch/selectPORSrchArticle.do?cn=DIKO0013987988" target="_blank" style="color:#2563eb; text-decoration:underline;">박수진(2016). 시나리오치료 프로그램의 개발과 효과. 경성대학교 석사학위 청구논문</a>
          </li>
          <li style="margin:6px 0;">
            <a href="https://www.riss.kr/search/detail/DetailView.do?p_mat_type=be54d9b8bc7cdb09&control_no=f9c97862a831b72bffe0bdc3ef48d419&keyword=%EC%9A%B0%EC%9A%B8%EC%A6%9D%20%EC%84%B1%EC%9D%B8%EC%9D%84%20%EC%9C%84%ED%95%9C%20%EC%98%81%ED%99%94%EC%A0%9C%EC%9E%91%20%EC%B9%98%EB%A3%8C%20%EC%82%AC%EB%A1%80%EC%97%B0%EA%B5%AC" target="_blank" style="color:#2563eb; text-decoration:underline;">박준형(2011). 우울증 성인을 위한 영화제작 치료 사례연구. 성균관대학교 일반대학원 사회복지학과 석사학위 청구논문</a>
          </li>
        </ol>
      </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =======================================================
            // 1. 기존 코드에서 유지해야 할 모든 함수를 여기에 붙여넣으세요.
            // (예: saveAllResponses, loadAllResponses, encrypt, decrypt, 
            //  validatePrivacyAndEthics, callAICompletion 등)
            // =======================================================
            
            // 예시: 기존 저장 함수가 있다고 가정
            function saveAllResponses() {
                // 기존에 작성하신 로컬 스토리지 저장 로직
                try {
                    // 이 함수는 이미 가지고 계신 코드를 그대로 사용하시면 됩니다.
                    localStorage.setItem('scenario_responses', JSON.stringify(responses));
                    console.log("Responses saved to local storage.");
                } catch (e) {
                    console.error("Failed to save responses:", e);
                }
            }
            
            // 예시: 기존 로드 함수가 있다고 가정
            function loadAllResponses() {
                const data = localStorage.getItem('scenario_responses');
                if (data) {
                    try {
                        const loadedResponses = JSON.parse(data);
                        // 배열 구조가 맞는지 간단히 확인 후 로드
                        if (Array.isArray(loadedResponses) && loadedResponses.length === STAGE_FIELDS.length) {
                            return loadedResponses;
                        }
                    } catch(e) {
                        console.error("Failed to load or parse responses:", e);
                    }
                }
                // 기본값 반환
                return STAGE_FIELDS.map(fields => Array(fields.length).fill(""));
            }



        });


        // 개인정보 보호 및 상담윤리 우선 검증 함수 (1순위 보안)
        function validatePrivacyAndEthics(data) {
            // 1순위: 개인정보 보호법 및 상담윤리 준수 검증
            if (!data || typeof data !== 'object') {
                console.warn('Privacy Check: Invalid data structure detected');
                return false;
            }
            
            // 민감정보 검출 및 가명처리 강제
            const sensitivePatterns = [
                /\b\d{6}-\d{7}\b/g,  // 주민등록번호
                /\b\d{3}-\d{3,4}-\d{4}\b/g,  // 전화번호
                /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,  // 이메일
                /\b\d{5,6}\b/g,  // 우편번호
                /\b(서울|부산|대구|인천|광주|대전|울산|세종|경기|강원|충북|충남|전북|전남|경북|경남|제주)\b/g,  // 지역명
                /\b(회사|학교|병원|은행|기관|단체|조직)\b/g  // 기관명
            ];
            
            let hasSensitiveInfo = false;
            const sanitizedData = JSON.parse(JSON.stringify(data));
            
            // 재귀적으로 민감정보 검출 및 가명처리
            function sanitizeObject(obj) {
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (typeof obj[key] === 'string') {
                            // 민감정보 패턴 검출
                            sensitivePatterns.forEach(pattern => {
                                if (pattern.test(obj[key])) {
                                    hasSensitiveInfo = true;
                                    // 가명처리: 민감정보를 [가명처리됨]으로 대체
                                    obj[key] = obj[key].replace(pattern, '[가명처리됨]');
                                }
                            });
                        } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                            sanitizeObject(obj[key]);
                        }
                    }
                }
            }
            
            sanitizeObject(sanitizedData);
            
            if (hasSensitiveInfo) {
                console.warn('Privacy Check: Sensitive information detected and anonymized');
            }
            
            // 상담윤리 검증: 비밀보장 원칙 준수
            let hasRiskContent = false;
            if (data.content && typeof data.content === 'string') {
                // 자해/타해 위험 표현 검출 (상담윤리 1순위)
                const riskPatterns = [
                    /\b(자살|자해|죽고|죽어|끝내|해치|해치겠|위험|폭력|학대)\b/g,
                    /\b(차라리|그만|더는|못살겠|힘들어|괴로워|절망|무의미)\b/g,
                    /\b(약물|술|담배|도박|중독|과도한|극단적)\b/g
                ];
                
                riskPatterns.forEach(pattern => {
                    if (pattern.test(data.content)) {
                        hasRiskContent = true;
                        console.warn('Ethics Check: Risk content detected - immediate attention required');
                    }
                });
                
                if (hasRiskContent) {
                    // 위험 신호 감지 시 로그 기록 및 관리자 알림 필요
                    const riskLog = {
                        timestamp: Date.now(),
                        stage: data.stage || 'unknown',
                        riskLevel: 'high',
                        content: data.content.substring(0, 100) + '...',
                        action: 'immediate_review_required',
                        ethics: 'counseling_ethics_violation_detected'
                    };
                    console.warn('Risk Assessment Required:', riskLog);
                    
                    // 상담윤리 위반 시 즉시 알림 (실제 운영 시에는 관리자에게 전송)
                    if (typeof window.showEthicsAlert === 'function') {
                        window.showEthicsAlert('상담윤리 위반 신호가 감지되었습니다. 전문가의 즉시 검토가 필요합니다.');
                    }
                }
            }
            
            // 개인정보 보호법 준수 확인
            const privacyCompliance = {
                timestamp: Date.now(),
                dataType: 'user_response',
                validation: 'passed',
                anonymization: hasSensitiveInfo ? 'applied' : 'not_required',
                ethicsCheck: hasRiskContent ? 'risk_detected' : 'passed'
            };
            
            console.log('Privacy & Ethics Compliance:', privacyCompliance);
            return sanitizedData;
        }

        function saveConversation(stage, questionId, conversationData) {
            try {
                // 1순위: 개인정보 보호 및 상담윤리 검증
                const validatedData = validatePrivacyAndEthics(conversationData);
                if (!validatedData) {
                    console.error('Privacy validation failed - data not saved');
                    return;
                }
                
                const key = localStorage.getItem('encryption_key') || setupEncryption();
                const existingData = loadConversation(stage, questionId) || [];
                existingData.push(validatedData);
                
                const encrypted = encrypt(existingData, key);
                if (encrypted) {
                    localStorage.setItem(`conversation_${stage}_${questionId}`, encrypted);
                    console.log('Privacy Check: Conversation data saved with validation');
                } else {
                    console.error('Failed to encrypt conversation data');
                }
            } catch (error) {
                console.error('Error saving conversation:', error);
            }
        }

        function loadConversation(stage, questionId) {
            try {
                const key = localStorage.getItem('encryption_key');
                if (!key) return null;
                
                const encrypted = localStorage.getItem(`conversation_${stage}_${questionId}`);
                if (!encrypted) return null;
                
                return decrypt(encrypted, key);
            } catch (error) {
                console.error('Error loading conversation:', error);
                return null;
            }
        }

        function clearConversation(stage, questionId) {
            try {
                localStorage.removeItem(`conversation_${stage}_${questionId}`);
            } catch (error) {
                console.error('Error clearing conversation:', error);
            }
        }

        // 대화형 AI 피드백 함수
        async function handleConversationalAI(stage, questionId, userInput, concept = null) {
            try {
                const conversationHistory = loadConversation(stage, questionId) || [];
                const key = localStorage.getItem('encryption_key') || setupEncryption();
                
                // 사용자 입력 저장
                const userMessage = {
                    role: 'user',
                    content: userInput,
                    timestamp: Date.now()
                };
                conversationHistory.push(userMessage);
                
                // AI 응답 생성
                let prompt = '';
                if (concept) {
                    // 개념 정의와 핵심 척도 몇 개만 선별해서 포함
                    const conceptDefinitions = {};
                    
                    const conceptScales = scaleItems[concept] || [];
                    
                    const scaleText = conceptScales.length > 0 ? 
                        `\n\n${concept} (${conceptDefinitions[concept]})의 모든 척도 항목들:
${conceptScales.map((item, idx) => `${idx + 1}. ${item}`).join('\n')}
위 모든 척도 항목들을 참고해서 사용자의 구체적 경험을 탐색하는 자연스러운 질문을 해주세요.` : '';
                    
                    prompt = `사용자와 ${concept} 관점에서 대화형으로 상호작용해주세요. 
사용자의 답변을 듣고, 더 깊이 있는 질문이나 피드백을 제공하여 자기 탐색을 돕는 대화를 이어가세요.${scaleText}

대화 히스토리:
${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

현재 사용자 입력: ${userInput}

${concept} 개념에 맞는 다음 질문이나 피드백을 제공해주세요.`;
                } else {
                    prompt = `사용자와 대화형으로 상호작용해주세요. 
사용자의 답변을 듣고, 더 깊이 있는 질문이나 피드백을 제공하여 자기 탐색을 돕는 대화를 이어가세요.

대화 히스토리:
${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

현재 사용자 입력: ${userInput}

다음 질문이나 피드백을 제공해주세요.`;
                }
                
                const messages = [{ role: 'user', content: prompt }];
                const url = "http://127.0.0.1:5000/gemini";
                const body = JSON.stringify({ messages, temperature: 0.7, max_tokens: 500 });
                const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const aiMessage = {
                    role: 'assistant',
                    content: data.content || "AI 응답 없음",
                    timestamp: Date.now()
                };
                
                conversationHistory.push(aiMessage);
                saveConversation(stage, questionId, conversationHistory);
                
                return aiMessage.content;
            } catch (error) {
                console.error('AI 대화 오류:', error);
                return "AI 응답을 받아오는 중 오류가 발생했습니다.";
            }
        }

        // 이 정의들은 코드 내부에서만 참고하며, 화면(UI)에는 노출되지 않음



        // 윤리강령 및 응답 정책 (최우선 적용)
        const ETHICS_CODE = {
            ethics_rules: {
                professionalism: [
                    "역량과 한계를 넘어서는 조언·판정 금지, 의심 시 전문 자문 권고",
                    "내담자의 복지와 안전을 기관·개인 이익보다 우선",
                    "성별, 연령, 장애, 문화, 종교, 성적 지향 등 어떤 이유로도 차별 금지",
                    "개인적 가치·신념 강요 금지",
                    "상담 의존성 조장 금지 — 자율성 강화 방향"
                ],
                risk_handling: [
                    "자/타해, 불법행위, 중독 악화, 성적 착취, 폭력 등은 즉시 안전 안내와 전문기관 의뢰",
                    "위험행동은 긍정적 재해석 금지, 대신 교훈·대안 중심 의미 재구성",
                    "다중관계·성적 관계·금전 거래·착취 행위 금지"
                ],
                confidentiality: [
                    "내담자 개인정보·기록은 비식별화 후 사용, 동의 없는 공개 금지",
                    "비밀보호 한계(자/타해 위험, 법적 요구)는 최소한 범위에서만 공개, 사전·사후 고지"
                ],
                assessment_feedback: [
                    "검증된 도구만 사용, 결과 해석 시 문화·환경 고려",
                    "평가·피드백은 교육·치료 목적 한정, 진단 확정은 금지"
                ],
                communication: [
                    "상담·프로그램 홍보 시 과장·허위 금지, 강요 금지",
                    "참여자의 권리·선택권 보장"
                ]
            },
            response_policy: {
                prohibited: [
                    "위험행동 미화",
                    "차별·편견 발언",
                    "진단명 확정",
                    "강압적 조언"
                ],
                allowed: [
                    "교육적 피드백",
                    "자가돌봄 제안",
                    "의미 재구성",
                    "전문기관 의뢰"
                ],
                required: [
                    "위험도 평가",
                    "고위험 시 안전 안내 및 대화 중단",
                    "저·중위험 시 긍정적 재평가 및 지원"
                ]
            }
        };



        // 윤리강령 기반 AI 프롬프트 생성 함수
        function createEthicalPrompt(basePrompt, userInput, context = '') {
            const ethicsHeader = `당신은 임상심리사이자 상담자입니다. 다음 윤리강령을 반드시 준수해야 합니다:

**전문성 및 역량**
- 역량과 한계를 넘어서는 조언·판정 금지, 의심 시 전문 자문 권고
- 내담자의 복지와 안전을 기관·개인 이익보다 우선
- 성별, 연령, 장애, 문화, 종교, 성적 지향 등 어떤 이유로도 차별 금지
- 개인적 가치·신념 강요 금지
- 상담 의존성 조장 금지 — 자율성 강화 방향

**위험 행동 처리**
- 자/타해, 불법행위, 중독 악화, 성적 착취, 폭력 등은 즉시 안전 안내와 전문기관 의뢰
- 위험행동은 긍정적 재해석 금지, 대신 교훈·대안 중심 의미 재구성
- 다중관계·성적 관계·금전 거래·착취 행위 금지

**평가 및 피드백**
- 검증된 도구만 사용, 결과 해석 시 문화·환경 고려
- 평가·피드백은 교육·치료 목적 한정, 진단 확정은 금지

**응답 정책**
- 금지: 위험행동 미화, 차별·편견 발언, 진단명 확정, 강압적 조언
- 허용: 교육적 피드백, 자가돌봄 제안, 의미 재구성, 전문기관 의뢰
- 필수: 위험도 평가, 고위험 시 안전 안내 및 대화 중단, 저·중위험 시 긍정적 재평가 및 지원

위 윤리강령을 준수하여 응답해 주세요.`;

            return `${ethicsHeader}

${basePrompt}`;
        }

        // 위험도 평가 함수
        function assessRisk(userInput) {
            const highRiskKeywords = ['자살', '죽고 싶다', '죽일 것이다', '폭력', '살인', '강간', '성폭력', '아동학대', '가정폭력', '마약', '약물', '불법', '범죄'];
            const mediumRiskKeywords = ['우울', '절망', '무가치', '고립', '분노', '복수', '자해', '상처', '트라우마'];
            
            const input = userInput.toLowerCase();
            const highRiskCount = highRiskKeywords.filter(keyword => input.includes(keyword)).length;
            const mediumRiskCount = mediumRiskKeywords.filter(keyword => input.includes(keyword)).length;
            
            if (highRiskCount > 0) return 'high';
            if (mediumRiskCount > 2) return 'medium';
            return 'low';
        }

        // 안전 안내 메시지 생성
        function getSafetyMessage(riskLevel) {
            if (riskLevel === 'high') {
                return `⚠️ 안전 주의: 귀하의 안전이 최우선입니다. 즉시 전문가의 도움을 받으시기 바랍니다.

📞 긴급 연락처:
- 자살예방상담전화: 1393
- 정신건강상담전화: 1577-0199
- 경찰서: 112
- 응급실: 119

현재 대화를 중단하고 전문가와 상담하시기 바랍니다.`;
            } else if (riskLevel === 'medium') {
                return `💡 안전 안내: 현재 상황에 대해 전문가와 상담하는 것을 권장합니다. 정신건강상담전화(1577-0199)를 이용해보세요.`;
            }
            return '';
        }

        const STAGES = [
            {
                title: "1단계: 주인공의 정보 작성"
            },
            {
                title: "2단계: 기획의도 작성"
            },
            {
                title: "3단계: 씬(Scene) 리스트 작성"
            },
            {
                title: "4단계: 영화 제목 짓기",
                prompt: `이 모든 여정을 영화나 드라마 제목으로 나타낸다면 뭐라고 할 수 있을까요?`
            }
        ];

        // 1단계~4단계 항목 분리 (프롬프트에 바로 작성)
        const STAGE_FIELDS = [
            [
                '이름', '성별', '연령', '직업', '성격적 특성', '가족 구성(아버지, 어머니, 형제자매 등)',
                '주인공에게 정서적으로 영향을 미친 인물',
                '친구 혹은 지지자'
            ],
            [
                '기획의도',
                '1. 주인공이 현재 겪고 있는 상황이나 어려움은 무엇인가요?',
                '2. 그 상황에서 주인공은 어떤 감정을 느끼고 있나요?',
                '3. 그 경험을 통해 주인공은 무엇을 배우거나 깨달았나요?'
            ],

            [
                '주제',
                // 스토리보드: [{title, desc, lines}] 객체 배열
                { label: '장면 제목', key: 'title' },
                { label: '장면 설명', key: 'desc' },
                { label: '주요 대사 및 행동', key: 'lines' }
            ],
            [
                '영화 제목'
            ]
        ];

        // responses를 2차원 배열로 확장 (스토리보드는 객체 배열)
        let responses = [
            STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""],
            STAGE_FIELDS[1].length ? Array(STAGE_FIELDS[1].length).fill("") : [""],
            STAGE_FIELDS[2].length ? Array(STAGE_FIELDS[2].length).fill("") : [""],
            ["", "", []] // 4단계: 주제, 스토리보드 배열
        ];

        let currentIndex = 0;
        let loadingMindmap = false;
        let programMounted = false; // 프로그램 UI가 한 번이라도 렌더된 적이 있는지 표시

        // 질문-심리학 개념 매핑 객체 (질문 텍스트와 100% 일치)
        const questionToConcept = {
           
        };

        // 척도 항목들을 AI 프롬프트에 포함시키기 위한 객체
        const scaleItems = {
        };

        // AI 제안/질문 버튼을 눌렀을 때 각 심리학 개념별 기본 질문
        const aiDefaultQuestions = {
        };

        // 예시: 2단계(상황 탐색 관련) 답변을 저장할 때 해당 답변이 어떤 심리학 개념에 해당하는지 태깅
        // responses[1] 배열의 각 답변은 STAGE_FIELDS[1]의 각 질문에 대응
        function getConceptsForStage2Responses() {
            return STAGE_FIELDS[1].map((question, idx) => {
                const answer = responses[1][idx];
                const concept = questionToConcept[question];
                return { question, answer, concept };
            });
        }
        // 사용 예시: getConceptsForStage2Responses()를 호출하면 각 답변에 개념이 자동 태깅된 배열 반환

        // DOM 요소들
        const stageTitle = document.getElementById('stageTitle');
        const stagePrompt = document.getElementById('stagePrompt');
        const responseTextarea = document.getElementById('responseTextarea');
        const summaryBlocks = document.getElementById('summaryBlocks');
        const aiResults = document.getElementById('aiResults');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const suggestBtn = document.getElementById('suggestBtn');
        const programTitle = document.getElementById('programTitle');
        const programDesc = document.getElementById('programDesc');
        




        // AI API 호출 전 개인정보 보호 검증 함수
        function validateAIRequest(messages, promptText) {
            // 1순위: 개인정보 보호법 및 상담윤리 준수 검증
            if (!messages && !promptText) {
                console.warn('Privacy Check: No content to validate for AI request');
                return false;
            }
            
            let hasSensitiveInfo = false;
            let hasRiskContent = false;
            
            // 메시지 배열 검증
            if (messages && Array.isArray(messages)) {
                messages.forEach((msg, index) => {
                    if (msg.content && typeof msg.content === 'string') {
                        // 민감정보 패턴 검출
                        const sensitivePatterns = [
                            /\b\d{6}-\d{7}\b/g,  // 주민등록번호
                            /\b\d{3}-\d{3,4}-\d{4}\b/g,  // 전화번호
                            /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,  // 이메일
                            /\b\d{5,6}\b/g,  // 우편번호
                            /\b(서울|부산|대구|인천|광주|대전|울산|세종|경기|강원|충북|충남|전북|전남|경북|경남|제주)\b/g,  // 지역명
                            /\b(회사|학교|병원|은행|기관|단체|조직)\b/g  // 기관명
                        ];
                        
                        sensitivePatterns.forEach(pattern => {
                            if (pattern.test(msg.content)) {
                                hasSensitiveInfo = true;
                                console.warn(`Privacy Check: Sensitive info detected in message ${index}`);
                            }
                        });
                        
                        // 위험 신호 검출 (상담윤리)
                        const riskPatterns = [
                            /\b(자살|자해|죽고|죽어|끝내|해치|해치겠|위험|폭력|학대)\b/g,
                            /\b(차라리|그만|더는|못살겠|힘들어|괴로워)\b/g
                        ];
                        
                        riskPatterns.forEach(pattern => {
                            if (pattern.test(msg.content)) {
                                hasRiskContent = true;
                                console.warn(`Ethics Check: Risk content detected in message ${index}`);
                            }
                        });
                    }
                });
            }
            // 프롬프트 텍스트 검증
            if (promptText && typeof promptText === 'string') {
                const sensitivePatterns = [
                    /\b\d{6}-\d{7}\b/g,
                    /\b\d{3}-\d{3,4}-\d{4}\b/g,
                    /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
                    /\b\d{5,6}\b/g
                ];
                
                sensitivePatterns.forEach(pattern => {
                    if (pattern.test(promptText)) {
                        hasSensitiveInfo = true;
                        console.warn('Privacy Check: Sensitive info detected in prompt text');
                    }
                });
            }
            
            // 검증 결과에 따른 처리
            if (hasSensitiveInfo) {
                console.error('Privacy Check: AI request blocked due to sensitive information');
                return false;
            }
            
            if (hasRiskContent) {
                // 위험 신호 감지 시 로그 기록
                const riskLog = {
                    timestamp: Date.now(),
                    type: 'ai_request_risk_detected',
                    riskLevel: 'high',
                    action: 'ai_request_allowed_with_caution'
                };
                console.warn('Risk Assessment for AI Request:', riskLog);
            }
            
            return true;
        }

        // AI API 호출 함수 (openai/gemini 선택)
        async function callAICompletion(_apiKey, messages, mode = 'gemini', promptText = '') {
            try {
                // 1순위: 개인정보 보호 및 상담윤리 검증
                if (!validateAIRequest(messages, promptText)) {
                    console.error('Privacy Check: AI request validation failed');
                    return "개인정보 보호를 위해 요청이 차단되었습니다. 민감한 정보가 포함되어 있는지 확인해 주세요.";
                }
                
                const temperature = 0.5;
                
                let url, body;
                if (mode === 'openai') {
                    url = "http://localhost:5000/openai";
                    body = JSON.stringify({
                        prompt: promptText,
                        max_tokens: 1000
                    });
                } else {
                    url = "http://127.0.0.1:5000/gemini";
                    body = JSON.stringify({
                        messages,
                        temperature: temperature,
                        max_tokens: 1000
                    });
                }
                
                // AI 요청 전 최종 개인정보 보호 확인
                console.log('Privacy Check: AI request validated and proceeding');
                
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body
                });
                const data = await response.json();
                if (data.error) return `AI 오류: ${data.error}`;
                
                const aiResponse = data.content || "AI 응답 없음";
                return aiResponse;
            } catch (error) {
                console.error('AI API 호출 오류:', error);
                return "AI 응답을 받아오는 중 오류가 발생했습니다.";
            }
        }

        // 현재 단계 업데이트
        function updateStage() {
            stageTitle.textContent = STAGES[currentIndex].title;
            
            // 프롬프트 동적 변경
            let currentPrompt = STAGES[currentIndex].prompt;
            
            if (!currentPrompt) {
                stagePrompt.innerHTML = '';
                stagePrompt.style.display = 'none';
            } else {
                stagePrompt.innerHTML = currentPrompt;
                stagePrompt.style.display = 'block';
            }
            
            loadStepData(currentIndex);
            renderTextareas();
            updateProgress();
            prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
            if (currentIndex < STAGES.length - 1) {
                nextBtn.textContent = '다음 →';
            } else {
                nextBtn.textContent = '완료';
            }
            
            // 1, 2, 3, 4단계에서는 AI 제안/질문 접기 버튼 숨기기
            if (currentIndex === 0 || currentIndex === 1 || currentIndex === 2 || currentIndex === 3) {
                const suggestBtn = document.getElementById('suggestBtn');
                if (suggestBtn) suggestBtn.style.display = 'none';
                
            } else {
                const suggestBtn = document.getElementById('suggestBtn');
                if (suggestBtn) suggestBtn.style.display = '';
                const aiResults = document.getElementById('aiResults');
                if (aiResults) aiResults.style.display = '';
            }
            
            
        }

        // 진행 상태 표시 업데이트
        function updateProgress() {
            for (let i = 0; i < STAGES.length; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    if (i < currentIndex) {
                        step.classList.add('completed');
                    } else if (i === currentIndex) {
                        step.classList.add('active');
                    }
                }
            }
            // 진행 상태 표시를 STAGES.length까지만 보이게
            for (let i = STAGES.length; i < 5; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) step.style.display = 'none';
            }
        }

        

        // AI 제안/질문 처리 (프롬프트 보강)
        async function handleAISuggestion() {
            // 3단계(시놉시스/스토리보드)에서 공통 대사 제안 안내문 분기 제거
            // 기존: if (currentIndex === 2) { ... return; }
            // 이하 기존 로직 유지
            // 1단계에서 모든 입력값이 비어 있으면 안내문구를 버튼 아래에 표시
            if (currentIndex === 0 && responses[0].every(v => !v.trim())) {
                document.getElementById('emptyGuideMsg')?.remove();
                const guideMsg = document.createElement('div');
                guideMsg.id = 'emptyGuideMsg';
                guideMsg.className = 'input-guide';
                guideMsg.textContent = '본인의 인적 사항, 성격적 특성, 주변인들을 생각해보세요.';
                document.getElementById('suggestBtn').after(guideMsg);
                return;
            } else if (currentIndex === 0) {
                document.getElementById('emptyGuideMsg')?.remove();
            }
            // responses 전체(각 단계 요약) 통합
            const hasContent = responses.some(r => r.some(item => item.trim()));
            if (!hasContent) {
                alert('AI 제안/질문을 생성할 내용이 없습니다.');
                return;
            }

            // 기존 summary-block(제안/질문) 모두 삭제 (중복 방지)
            document.querySelectorAll('.summary-block').forEach(e => e.remove());

            // 이전 단계 입력을 모두 모음 (현재 단계까지)
            const previousInputs = responses.slice(0, currentIndex + 1)
                .map((r, i) => `단계${i+1}: ${r.filter(item => item.trim()).join('\n\n')}`)
                .join('\n\n');

            // 갈등 유형별 프롬프트 (구/절 제한 없이 전체 입력 사용)
            let prompt = '';
            let items = [];
                            let labels = [];
            if (currentIndex === 1) {

                prompt = `1단계와 2단계에서 입력된 모든 정보를 참고해서\n전체 입력을 바탕으로 다음 단계에 도움이 될 만한 질문이나 제안을 해주세요.\n\n전체 입력:\n${previousInputs}`;
                // 기존 LLM 호출 및 분리 로직 유지
                const messages = [
                    { role: "system", content: `너는 시나리오 쓰기 치료를 돕는 AI 조력자야. 유저의 입력을 참고해서 다음 단계에 도움이 될 만한 질문이나 제안을 해줘.` },
                    { role: "user", content: prompt }
                ];
                const suggestBtn = document.getElementById('suggestBtn');
                suggestBtn.textContent = '생성 중...';
                suggestBtn.disabled = true;
                const suggestion = await callAICompletion(null, messages, 'gemini');
                // 분리
                if (/1[).\-\s]/.test(suggestion) && /2[).\-\s]/.test(suggestion) && /3[).\-\s]/.test(suggestion)) {
                    items = suggestion.split(/\n?\s*\d[).\-\s]/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('\\n')) {
                    items = suggestion.split(/\\n+/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('- ')) {
                    items = suggestion.split(/- /).map(s => s.trim()).filter(Boolean);
                } else {
                    items = [suggestion.trim()];
                }
                // 중복 제거
                items = items.filter((item, idx, arr) => item && arr.indexOf(item) === idx);
                while (items.length < 3) items.push('');
                items = items.slice(0, 3);
            } else if (currentIndex === 2) {
                prompt = `3단계 시나리오 작성을 위한 질문을 생성해주세요.\n\n사용자의 입력을 바탕으로 시나리오 작성에 도움이 될 만한 질문이나 제안을 만들어주세요.`;
                // 기존 LLM 호출 및 분리 로직 유지
                const messages = [
                    { role: "system", content: `너는 시나리오 쓰기 치료를 돕는 AI 조력자야. 유저의 입력을 참고해서 다음 단계에 도움이 될 만한 질문이나 제안을 해줘.` },
                    { role: "user", content: prompt }
                ];
                const suggestBtn = document.getElementById('suggestBtn');
                suggestBtn.textContent = '생성 중...';
                suggestBtn.disabled = true;
                const suggestion = await callAICompletion(null, messages, 'gemini');
                // 분리
                if (/1[).\-\s]/.test(suggestion) && /2[).\-\s]/.test(suggestion)) {
                    items = suggestion.split(/\n?\s*\d[).\-\s]/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('\\n')) {
                    items = suggestion.split(/\\n+/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('- ')) {
                    items = suggestion.split(/- /).map(s => s.trim()).filter(Boolean);
                } else {
                    items = [suggestion.trim()];
                }
                // 중복 제거
                items = items.filter((item, idx, arr) => item && arr.indexOf(item) === idx);
                while (items.length < 2) items.push('');
                items = items.slice(0, 2);
            } else {
                // 간단한 AI 제안 생성
                const prompt = `${previousInputs}

위 내용을 바탕으로 다음 단계에 도움이 될 만한 질문이나 제안을 만들어주세요.`;

                try {
                    const messages = [
                        { role: "system", content: `너는 시나리오 쓰기 치료를 돕는 AI 조력자야. 다음 단계에 도움이 될 만한 질문이나 제안을 만들어줘.` },
                        { role: "user", content: prompt }
                    ];
                    
                    const suggestion = await callAICompletion(null, messages, 'gemini');
                    items = [suggestion.trim()];
                } catch (error) {
                    items = ['AI 제안을 생성하는 중 오류가 발생했습니다.'];
                }
            }
            // 화면에 제안/질문 표시
            const suggestionBlock = document.createElement('div');
            suggestionBlock.className = 'summary-block';
            suggestionBlock.innerHTML = `
                <strong>🤖 AI 제안/질문</strong>
                <ul style='margin:0;padding-left:1.2em;'>
                    ${items.map((item, i) => `<li><b>${labels[i]||''}:</b> ${item || "<span style=\"color:#aaa\">질문/제안 없음</span>"}</li>`).join('')}
                </ul>
            `;
            aiResults.appendChild(suggestionBlock);
            suggestBtn.textContent = 'AI 제안/질문 접기';
            suggestBtn.disabled = false;
            suggestBtn.dataset.open = 'true';
        }

        // 토글형 버튼으로 변경
        document.getElementById('suggestBtn').addEventListener('click', async function() {
            const suggestBtn = document.getElementById('suggestBtn');
            if (suggestBtn.dataset.open === 'true') {
                // 접기
                document.querySelectorAll('.summary-block').forEach(e => e.remove());
                suggestBtn.textContent = 'AI 제안/질문 펼치기';
                suggestBtn.dataset.open = 'false';
            } else {
                // 펼치기(매번 새로 생성)
                await handleAISuggestion();
            }
        });

        // 단계별 저장 함수
        function saveStepData(stepIdx) {
            // 1순위: 개인정보 보호 및 상담윤리 검증
            const stepData = responses[stepIdx];
            if (!stepData) {
                console.warn('Privacy Check: No step data to save');
                return;
            }
            
            // 민감정보 검출 및 가명처리
            const sanitizedData = validatePrivacyAndEthics(stepData);
            if (sanitizedData) {
                localStorage.setItem('scenario_step_' + stepIdx, JSON.stringify(sanitizedData));
                console.log(`Privacy Check: Step ${stepIdx} data saved with validation`);
            } else {
                console.error('Privacy validation failed for step data');
            }
        }
        // 단계별 불러오기 함수
        function loadStepData(stepIdx) {
            const data = localStorage.getItem('scenario_step_' + stepIdx);
            if (data) {
                if (stepIdx === 3) {
                    responses[3] = JSON.parse(data);
                } else {
                    responses[stepIdx] = JSON.parse(data);
                }
            }
        }

        // 5단계에서만 버튼 보이게
        function renderTextareas() {
            document.getElementById('customTextareas')?.remove();
            responseTextarea.style.display = 'none';
            let html = '';
            const containerDiv = document.createElement('div');
            containerDiv.id = 'customTextareas';

            if (currentIndex === 0) {
                responseTextarea.style.display = 'none';
                
                // STAGE_FIELDS[0] 기반 동적 렌더링으로 전환 (하드코딩 UI 우회)
                STAGE_FIELDS[0].forEach((label, idx) => {
                    const value = (responses[0] && typeof responses[0][idx] === 'string') ? responses[0][idx] : '';
                    html += `<div style='margin-bottom:1em;'>
                        <label style='font-weight:bold;'>${label}</label><br/>
                        <input data-field-idx='${idx}' value='${value.replace(/`/g, "&#96;").replace(/\\/g, "\\\\").replace(/"/g, '&quot;')}' style='width:100%;min-height:38px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;'/>
                    </div>`;
                });
                containerDiv.innerHTML = html;
                setTimeout(() => {
                    const inputs = containerDiv.querySelectorAll('input[data-field-idx]');
                    inputs.forEach(input => {
                        input.addEventListener('input', function() {
                            const i = parseInt(this.getAttribute('data-field-idx'));
                            if (!responses[0] || !Array.isArray(responses[0])) {
                                responses[0] = STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""];
                            }
                            responses[0][i] = this.value;
                        });
                    });
                }, 0);
                containerDiv && responseTextarea.parentNode.insertBefore(containerDiv, responseTextarea);
                programMounted = true; // 한 번이라도 UI가 렌더됐음을 표시
                return;
                
                // 1단계에 씬 브레이크다운만 표시 (이하는 우회됨)
                html += `<h2 style='margin-top:2em;margin-bottom:1em;'>시나리오 씬 브레이크다운</h2>`;
                html += `<table style='width:100%;border-collapse:collapse;margin-bottom:20px;'>`;
                html += `<thead><tr><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:12%;'>장면</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>주인공(성별, 연령, 성격)</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>가족 구성</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>정서적 영향 인물</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>친구/지지자</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:28%;'>각 인물 주요 대사 및 행동</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:10%;'>삭제</th></tr></thead>`;
                html += `<tbody id='sceneTableBody'>`;
                html += `<tr><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;font-weight:bold;'>장면1</td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='1' data-type='protagonist' data-placeholder='주인공 정보 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='2' data-type='family' data-placeholder='가족 구성 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='3' data-type='emotional' data-placeholder='정서적 영향 인물 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='4' data-type='support' data-placeholder='친구/지지자 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='5' data-type='action-dialogue' data-placeholder='각 인물 주요 대사 및 행동 입력'></td><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='0' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>삭제</button></td></tr>`;
                html += `<tr><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:top;font-weight:bold;'>장면2</td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='1' data-type='protagonist' data-placeholder='주인공 정보 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='2' data-type='family' data-placeholder='가족 구성 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='3' data-type='emotional' data-placeholder='정서적 영향 인물 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='4' data-type='support' data-placeholder='친구/지지자 입력'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='5' data-type='action-dialogue' data-placeholder='각 인물 주요 대사 및 행동 입력'></td><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='1' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>삭제</button></td></tr>`;
                html += `</tbody></table>`;
                html += `<button id='addSceneBtn' style='padding:10px 15px;font-size:16px;cursor:pointer;border:1px solid #000;background-color:#1e3a8a;color:#fff;font-weight:bold;'>씬 추가</button>`;
                
                // Placeholder 스타일 추가
                html += `<style>
                    [contenteditable="true"][data-placeholder]:empty:before {
                        content: attr(data-placeholder);
                        color: #999;
                        font-style: italic;
                        pointer-events: none;
                    }
                    [contenteditable="true"][data-placeholder]:focus:empty:before {
                        content: "";
                    }
                </style>`;
                
                containerDiv.innerHTML = html;
                
                // 씬 추가 버튼 이벤트 리스너
                setTimeout(() => {
                    const addSceneBtn = containerDiv.querySelector('#addSceneBtn');
                    if (addSceneBtn) {
                        addSceneBtn.addEventListener('click', function() {
                            const tableBody = document.getElementById('sceneTableBody');
                            const newRow = document.createElement('tr');
                            const sceneNumber = tableBody.children.length + 1;
                            
                            newRow.innerHTML = `
                                <td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;font-weight:bold;'>장면${sceneNumber}</td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='1' data-type='protagonist' data-placeholder='주인공 정보 입력'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='2' data-type='family' data-placeholder='가족 구성 입력'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='3' data-type='emotional' data-placeholder='정서적 영향 인물 입력'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='4' data-type='support' data-placeholder='친구/지지자 입력'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='5' data-type='action-dialogue' data-placeholder='각 인물 주요 대사 및 행동 입력'></td>
                                <td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='${sceneNumber-1}' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>삭제</button></td>
                            `;
                            
                            tableBody.appendChild(newRow);
                            
                            // 새로 추가된 씬의 삭제 버튼에 이벤트 리스너 추가
                            const newDeleteBtn = newRow.querySelector('.deleteSceneBtn');
                            if (newDeleteBtn) {
                                newDeleteBtn.addEventListener('click', function() {
                                    if (confirm('이 씬을 삭제하시겠습니까?')) {
                                        newRow.remove();
                                        // 장면 번호 재정렬
                                        const remainingRows = tableBody.querySelectorAll('tr');
                                        remainingRows.forEach((row, index) => {
                                            const sceneCell = row.querySelector('td:first-child');
                                            if (sceneCell) {
                                                sceneCell.textContent = `장면${index + 1}`;
                                            }
                                            const deleteBtn = row.querySelector('.deleteSceneBtn');
                                            if (deleteBtn) {
                                                deleteBtn.setAttribute('data-row', index);
                                            }
                                        });
                            }
                        });
                    }
                });
            }
                }, 0);
                // 기존 씬들의 삭제 버튼 이벤트 리스너 추가
                setTimeout(() => {
                    const deleteBtns = containerDiv.querySelectorAll('.deleteSceneBtn');
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (confirm('이 씬을 삭제하시겠습니까?')) {
                                const row = btn.closest('tr');
                                row.remove();
                                // 장면 번호 재정렬
                                const tableBody = document.getElementById('sceneTableBody');
                                const remainingRows = tableBody.querySelectorAll('tr');
                                remainingRows.forEach((row, index) => {
                                    const sceneCell = row.querySelector('td:first-child');
                                    if (sceneCell) {
                                        sceneCell.textContent = `장면${index + 1}`;
                                    }
                                    const deleteBtn = row.querySelector('.deleteSceneBtn');
                                    if (deleteBtn) {
                                        deleteBtn.setAttribute('data-row', index);
                                    }
                                });
                            }
                        });
                    });
                }, 0);
                
            } else if (currentIndex === 1) {
                // 2단계: 기획의도 작성 (PHQ-9/1단계 기반)
                const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                const phq9Score = phq9Data && typeof phq9Data.score === 'number' ? phq9Data.score : '미확인';
                const stage1Brief = (responses[0] || []).filter(v => typeof v === 'string' && v.trim()).slice(0,5).join(', ');
                // PHQ-9 문항별 점수 상세 표시
                let phq9Details = '미확인';
                if (phq9Data && phq9Data.items && Array.isArray(phq9Data.items)) {
                    const phq9Items = [
                        '기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다',
                        '평소에 하던 일에 대한 흥미가 없어지거나 즐거움을 느끼지 못했다',
                        '잠들기 어렵거나, 자주 깨거나, 너무 많이 잤다',
                        '피곤하거나 기운이 없었다',
                        '식욕이 없거나, 너무 많이 먹었다',
                        '자신이 좋지 않다는 느낌, 또는 자신이 실패자라는 느낌, 또는 자신이나 가족을 실망시켰다는 느낌',
                        '신문을 읽거나 TV를 보는 것과 같은 일상적인 일을 하는데 어려움을 겪었다',
                        '움직임이나 말하는 것이 느려져서 다른 사람들이 눈치챌 정도였다. 또는 반대로 너무 안절부절 못해서 가만히 앉아있을 수 없었다',
                        '차라리 죽는 것이 나을 것 같다고 생각했다. 또는 자해할 생각을 했다'
                    ];
                    
                    const nonZeroItems = phq9Data.items
                        .map((score, index) => ({ score, question: phq9Items[index] }))
                        .filter(item => item.score > 0)
                        .map(item => `${item.question}: ${item.score}점`)
                        .join('\n');
                    
                    phq9Details = nonZeroItems || '모든 문항 0점';
                }
                
                // 1단계 기본 정보 요약
                const stage1Info = (responses[0] || []).filter(v => typeof v === 'string' && v.trim());
                const stage1Summary = stage1Info.length > 0 ? stage1Info.join(', ') : '1단계 기본 정보를 먼저 입력해 주세요.';
                

                STAGE_FIELDS[1].forEach((label, idx) => {
                    html += `<div style='margin-bottom:1em;display:flex;align-items:flex-start;gap:0.5em;'>
                        <div style='flex:1;'>
                            <label style='font-weight:bold;'>${label}</label><br/>
                            <textarea data-field-idx="${idx}" style='width:100%;min-height:160px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;resize:vertical;'>${responses[1][idx]}</textarea>
                            <div class='ai-suggest-area' data-field-idx='${idx}'></div>
                        </div>
                        <button type='button' class='ai-suggest-btn' data-field-idx='${idx}' style='height:40px;margin-top:2.2em;'>AI 지원</button>
                    </div>`;
                });
                containerDiv.innerHTML = html;
                // AI 지원 버튼 이벤트 연결
                setTimeout(() => {
                    const aiSuggestBtns = containerDiv.querySelectorAll('.ai-suggest-btn');
                    aiSuggestBtns.forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const idx = parseInt(btn.getAttribute('data-field-idx'));
                            const area = containerDiv.querySelector(`.ai-suggest-area[data-field-idx='${idx}']`);
                            const textarea = containerDiv.querySelector(`textarea[data-field-idx='${idx}']`);
                            if (!textarea || !area) return;
                            const userInput = textarea.value.trim();
                            if (currentIndex === 1) {
                                try {
                                    const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                                    const phq9Score = typeof phq9Data.score === 'number' ? phq9Data.score : null;
                                    let phq9Label = '미확인';
                                    if (typeof getSeverityClass === 'function' && typeof phq9Score === 'number') {
                                        const sev = getSeverityClass(phq9Score);
                                        phq9Label = Array.isArray(sev) ? sev[0] : phq9Label;
                                    }

                                    const stage1Brief = (responses[0] || []).filter(v => typeof v === 'string' && v.trim()).slice(0,5).join(', ');
                                    area.innerHTML = `<div class='summary-block'>
                                        <strong>✍️ 기획의도 작성 가이드</strong>
                                        <ul style='margin:0;padding-left:1.2em;'>
                                                                            <li><b>PHQ-9 요약</b>: ${phq9Label}</li>
                                <li><b>기본정보 기반 목표</b>: ${stage1Brief ? stage1Brief : '1단계 기본 정보를 먼저 입력해 주세요.'}</li>
                                <li><b>프로그램 체험 가능 여부</b>: ${(phq9Score >= 0 && phq9Score <= 14 && (phq9Items?.['9'] ?? 0) === 0) ? '가능 (0–14점, 9번 문항 0점)' : '불가 (범위 외 또는 9번 문항 점수 있음)'}</li>
                                        </ul>
                                    </div>`;
                                } catch (e) {
                                    area.innerHTML = `<div class='summary-block'>
                                        <strong>✍️ 기획의도 작성 가이드</strong>
                                        <ul style='margin:0;padding-left:1.2em;'>
                                                                            <li><b>PHQ-9 요약</b>: 미확인</li>
                                <li><b>기본정보 기반 목표</b>: 1단계 기본 정보를 먼저 입력해 주세요.</li>
                                <li><b>프로그램 체험 가능 여부</b>: PHQ-9 검사 완료 후 확인 가능</li>
                                        </ul>
                                    </div>`;
                                }
                                return;
                            }
                            // 의미 있는 한글(완성형) 또는 영문 단어가 있는지 판별
                            const isValidWord = (str) => /([가-힣]{2,}|[a-zA-Z]{2,})/.test(str);
                                        // 입력이 없거나 의미 없는 경우 기본 질문 안내
                            if (!userInput || !isValidWord(userInput)) {
                                let defaultQuestion = '';
                                // 2단계 질문별 특별한 기본 질문
                                if (idx === 0) { // 1번 질문
                                    defaultQuestion = '주인공이 겪고 있는 상황에 대해 자세히 설명해주세요.';
                                } else {
                                    // 각 심리학적 개념에 맞는 기본 질문 생성
                                    const question = STAGE_FIELDS[1][idx];
                                    const concept = questionToConcept[question];
                                    
                                    if (concept && aiDefaultQuestions[concept]) {
                                        // 해당 개념의 기본 질문 사용
                                        defaultQuestion = aiDefaultQuestions[concept];
                                    } else {
                                        // 기본 안내 메시지
                                        defaultQuestion = '이 질문에 대해 더 자세히 답변해주세요.';
                                    }
                                }
                                
                                area.innerHTML = `<div style='margin-top:0.5em;background:#f8f9fa;padding:0.7em 1em;border-radius:6px;border:1px solid #d0d7de;font-size:0.97em;'>${defaultQuestion}</div>`;
                                return;
                            }
                            // 윤리강령 기반 위험도 평가 및 안전 안내
                            const riskLevel = assessRisk(userInput);
                            const safetyMessage = getSafetyMessage(riskLevel);
                            
                            if (riskLevel === 'high') {
                                area.innerHTML = `<div style='margin-top:0.5em;background:#fff3cd;padding:0.7em 1em;border-radius:6px;border:1px solid #ffc107;font-size:0.97em;'>${safetyMessage}</div>`;
                                return;
                            }
                            
                            // 의미 있는 어절이 있으면 LLM 맞춤 피드백
                            area.innerHTML = `<span style='color:#aaa'>AI가 답변을 분석 중입니다...</span>`;
                            // 질문 텍스트로 심리학 개념 찾기
                            const question = STAGE_FIELDS[1][idx];
                            const concept = questionToConcept[question];
                            
                            // 해당 개념의 척도 항목들 중에서 랜덤으로 하나 선택하여 추가 질문으로 포함
                            let additionalQuestion = '';
                            if (concept && scaleItems[concept]) {
                                const randomIndex = Math.floor(Math.random() * scaleItems[concept].length);
                                // 척도 문장을 직접 인용하지 않고 방향성만 제시
                                additionalQuestion = `\n\n추가로 고려해볼 방향: 이 답변과 관련하여 더 깊이 탐구할 수 있는 질문이나 관점을 제시해 주세요.`;
                            }
                            
                            // 윤리강령 기반 프롬프트 구성
                            const basePrompt = `아래는 사용자가 자기 탐색을 위해 작성한 답변입니다.\n답변: ${userInput}\n\n이 답변에 대해 한 문장으로만 간결한 피드백이나 코칭을 제공해 주세요. 반드시 한 문장으로 끝내야 합니다.${additionalQuestion}`;
                            const prompt = createEthicalPrompt(basePrompt, userInput, 'Stage 2 상황 탐색');
                            try {
                                const messages = [
                                    { role: 'user', content: prompt }
                                ];
                                const url = "http://127.0.0.1:5000/gemini";
                                const body = JSON.stringify({ messages, temperature: 0.5, max_tokens: 500 });
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body
                });
                const data = await response.json();
                                if (data.error) {
                                    area.innerHTML = `<span style='color:#e74c3c'>AI 오류: ${data.error}</span>`;
                                } else {
                                    // AI 응답을 한 문장으로 제한
                                    let aiResponse = data.content || "AI 응답 없음";
                                    // 첫 번째 문장만 추출 (마침표, 느낌표, 물음표로 구분)
                                    const firstSentence = aiResponse.match(/^[^.!?]+[.!?]/);
                                    if (firstSentence) {
                                        aiResponse = firstSentence[0];
                                    }
                                    area.innerHTML = `<div style='margin-top:0.5em;background:#f8f9fa;padding:0.7em 1em;border-radius:6px;border:1px solid #d0d7de;font-size:0.97em;'>🤖 <b>AI 피드백</b><br/>${aiResponse}</div>`;
                                }
                            } catch (err) {
                                area.innerHTML = `<span style='color:#e74c3c'>AI 응답을 받아오는 중 오류가 발생했습니다.</span>`;
                            }
                        });
                    });
                }, 0);
            } else if (currentIndex === 2) {
              
                
                containerDiv.innerHTML = html;
                
                // 시나리오 프롬프트 생성기 JavaScript 기능 추가
                setTimeout(() => {
                    let sceneCount = 1;
                    let showDeleteConfirm = true; // 삭제 확인 창 표시 여부
                    
                    // 예시 토글 버튼 기능 추가 - 더 안정적인 방법으로 구현
                    const toggleExampleBtn = document.getElementById('toggle-example-btn');
                    const exampleContent = document.getElementById('example-content');
                    
                    if (toggleExampleBtn && exampleContent) {
                        toggleExampleBtn.addEventListener('click', function() {
                            if (exampleContent.style.display === 'none' || exampleContent.style.display === '') {
                                exampleContent.style.display = 'block';
                                toggleExampleBtn.textContent = '예시 숨기기';
                                toggleExampleBtn.style.backgroundColor = '#dc3545';
            } else {
                                exampleContent.style.display = 'none';
                                toggleExampleBtn.textContent = '예시 보기';
                                toggleExampleBtn.style.backgroundColor = '#6c757d';
                            }
                        });
                    }
                    
                    // 장면 삭제 함수
                    function removeScene(sceneElement) {
                        // 방어코드: sceneElement가 올바른 카드 요소가 아닐 수 있으므로 보정
                        if (sceneElement && !(sceneElement.matches && sceneElement.matches('div[style*="border: 1px solid #ced4da"], .scene-card'))) {
                            const fallback = sceneElement.closest ? sceneElement.closest('div[style*="border: 1px solid #ced4da"], .scene-card') : null;
                            if (fallback) {
                                sceneElement = fallback;
                            }
                        }

                        if (showDeleteConfirm) {
                            // 커스텀 확인 창 생성
                            const confirmDialog = document.createElement('div');
                            confirmDialog.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;';
                            
                            confirmDialog.innerHTML = `
                                <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                    <h3 style="margin: 0 0 20px 0; color: #333;">정말 삭제하시겠습니까?</h3>
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                            <input type="checkbox" id="dontShowAgain" style="margin-right: 8px;">
                                            <span>다시 안 보기</span>
                                        </label>
                                    </div>
                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                        <button id="confirmDelete" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">삭제</button>
                                        <button id="cancelDelete" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">취소</button>
                                    </div>
                                </div>
                            `;
                            
                            document.body.appendChild(confirmDialog);
                            
                            // 삭제 확인
                            document.getElementById('confirmDelete').addEventListener('click', function() {
                                const dontShowAgain = document.getElementById('dontShowAgain').checked;
                                if (dontShowAgain) {
                                    showDeleteConfirm = false;
                                }
                                if (sceneElement && sceneElement.parentNode) {
                                    sceneElement.parentNode.removeChild(sceneElement);
            } else {
                                    console.warn('removeScene: 삭제 대상 요소를 찾지 못했습니다.');
                                }
                                if (confirmDialog && confirmDialog.parentNode) {
                                    confirmDialog.parentNode.removeChild(confirmDialog);
                                }
                                // 삭제 후 장면 번호 재정렬
                                if (typeof renumberScenes === 'function') {
                                    renumberScenes();
                                }
                            });
                            
                            // 취소
                            document.getElementById('cancelDelete').addEventListener('click', function() {
                                if (confirmDialog && confirmDialog.parentNode) {
                                    confirmDialog.parentNode.removeChild(confirmDialog);
                                }
                            });
            } else {
                            // 확인 창 없이 바로 삭제
                            if (sceneElement && sceneElement.parentNode) {
                                sceneElement.parentNode.removeChild(sceneElement);
                            } else {
                                console.warn('removeScene: 삭제 대상 요소를 찾지 못했습니다.');
                            }
                            // 삭제 후 장면 번호 재정렬
                            if (typeof renumberScenes === 'function') {
                                renumberScenes();
                            }
                        }
                    }

                    // 장면 번호와 관련 ID를 재정렬하는 함수
                    function renumberScenes() {
                        const container = document.getElementById('scene-container');
                        if (!container) return;
                        const cards = container.querySelectorAll('.scene-card');
                        cards.forEach((card, index) => {
                            const num = index + 1;
                            const header = card.querySelector('div[style*="font-size: 1.5rem"]');
                            if (header) header.textContent = '장면 ' + num;
                            const removeBtn = card.querySelector('.remove-scene-btn');
                            if (removeBtn) removeBtn.setAttribute('data-scene-id', String(num));
                            const headingInput = card.querySelector('input[id^="scene-heading-"]');
                            const headingLabel = card.querySelector('label[for^="scene-heading-"]');
                            if (headingInput) headingInput.id = 'scene-heading-' + num;
                            if (headingLabel) headingLabel.setAttribute('for', 'scene-heading-' + num);
                            const charInput = card.querySelector('input[id^="characters-"]');
                            const charLabel = card.querySelector('label[for^="characters-"]');
                            if (charInput) charInput.id = 'characters-' + num;
                            if (charLabel) charLabel.setAttribute('for', 'characters-' + num);
                            const summaryTextarea = card.querySelector('textarea[id^="summary-"]');
                            const summaryLabel = card.querySelector('label[for^="summary-"]');
                            if (summaryTextarea) summaryTextarea.id = 'summary-' + num;
                            if (summaryLabel) summaryLabel.setAttribute('for', 'summary-' + num);
                            const contentTextarea = card.querySelector('textarea[id^="content-"]');
                            const contentLabel = card.querySelector('label[for^="content-"]');
                            if (contentTextarea) contentTextarea.id = 'content-' + num;
                            if (contentLabel) contentLabel.setAttribute('for', 'content-' + num);
                        });
                    }
                    
                    // 기본 장면 1의 삭제 버튼 이벤트 추가
                    const firstSceneRemoveBtn = document.querySelector('.remove-scene-btn');
                    if (firstSceneRemoveBtn) {
                        firstSceneRemoveBtn.addEventListener('click', function() {
                            const sceneContainer = document.getElementById('scene-container');
                            if (sceneContainer.children.length > 1) {
                                removeScene(this.closest('.scene-card'));
                } else {
                                alert('마지막 장면은 삭제할 수 없습니다.');
                            }
                        });
                    }
                    
                    const addSceneBtn = document.getElementById('add-scene-btn');
                    if (addSceneBtn) {
                        addSceneBtn.addEventListener('click', function() {
                            sceneCount++;
                            const sceneContainer = document.getElementById('scene-container');
                            
                            if (sceneContainer) {
                                const newScene = document.createElement('div');
                                newScene.className = 'scene-card';
                                newScene.style.cssText = 'border: 1px solid #ced4da; border-radius: 8px; padding: 20px; margin-bottom: 30px; background-color: #fff;';
                                
                                // 템플릿 리터럴 대신 문자열 연결 사용으로 안정성 향상
                                newScene.innerHTML = 
                                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                                        '<div style="font-size: 1.5rem; font-weight: bold; color: #007bff;">장면 ' + sceneCount + '</div>' +
                                        '<button class="remove-scene-btn" type="button" data-scene-id="' + sceneCount + '" style="padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s;">삭제</button>' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="scene-heading-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">장소 및 시간 (Scene Heading)</label>' +
                                        '<input type="text" id="scene-heading-' + sceneCount + '" placeholder="예: 도서관 - 밤" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem;">' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="characters-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">등장인물 (Characters)</label>' +
                                        '<input type="text" id="characters-' + sceneCount + '" placeholder="예: 민준, 할머니" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem;">' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="summary-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">장면 요약 (Summary)</label>' +
                                        '<textarea id="summary-' + sceneCount + '" placeholder="이 장면의 목표는 무엇인가요? 장면이 끝났을 때 무엇이 변해야 하나요?" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; height: 150px; resize: vertical;"></textarea>' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="content-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">내용 (대사 및 지문)</label>' +
                                        '<textarea id="content-' + sceneCount + '" placeholder="이곳에 장면의 구체적인 대사와 행동을 자유롭게 작성해 주세요." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; height: 150px; resize: vertical;"></textarea>' +
                                    '</div>';
                                
                                sceneContainer.appendChild(newScene);
                                
                                // 새로 추가된 장면의 삭제 버튼에 이벤트 추가
                                const newRemoveBtn = newScene.querySelector('.remove-scene-btn');
                                if (newRemoveBtn) {
                                    newRemoveBtn.addEventListener('click', function() {
                                        const sceneContainer = document.getElementById('scene-container');
                                        if (sceneContainer.children.length > 1) {
                                            removeScene(this.closest('.scene-card'));
            } else {
                                            alert('마지막 장면은 삭제할 수 없습니다.');
                                        }
                                    });
                                }
                                // 장면 추가 후 번호 재정렬
                                if (typeof renumberScenes === 'function') {
                                    renumberScenes();
                                }
                            }
                        });
                    }
                }, 0);
                

            } else if (currentIndex === 3) {
                // 4단계: 영화 제목 (고정된 질문, AI 피드백 없음)
                html += `<div style='margin-bottom:1em;'>
                    <label style='font-weight:bold;'>이 모든 여정을 영화나 드라마 제목으로 나타낸다면 뭐라고 할 수 있을까요?</label><br/>
                    <textarea data-field-idx='0' style='width:100%;min-height:80px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;resize:vertical;' placeholder='예시: "내 안의 용기", "새로운 시작", "회복의 시간" 등으로 표현해보세요.'>${responses[3] ? responses[3][0] || '' : ''}</textarea>
                </div>`;
                containerDiv.innerHTML = html;
            }
            
            responseTextarea.parentNode.insertBefore(containerDiv, responseTextarea);
        }

        // 진행 상태 표시 업데이트
        function updateProgress() {
            for (let i = 0; i < STAGES.length; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    if (i < currentIndex) {
                        step.classList.add('completed');
                    } else if (i === currentIndex) {
                        step.classList.add('active');
                    }
                }
            }
            // 진행 상태 표시를 STAGES.length까지만 보이게
            for (let i = STAGES.length; i < 5; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) step.style.display = 'none';
            }
        }

        // 이전 버튼 복구
        prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';

        // 다음 버튼 동작
        nextBtn.addEventListener('click', () => {
            if (currentIndex < STAGES.length - 1) {
                currentIndex++;
                updateStage();
            } else {
                alert('시나리오 쓰기 치료가 완료되었습니다.');
                // 완료 후 추가 기능 또는 페이지 이동

                // 프로그램 종료 시 심리상담 포털 재안내
                const portal = document.createElement('div');
                portal.setAttribute('data-portal-root', '1');
                portal.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #e8f5e8; border-left:4px solid #27ae60; border-radius:10px; padding:12px 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); z-index: 10000; max-width: 360px;';
                portal.innerHTML = '<div style="font-weight:700; color:#166534; margin-bottom:6px;">💡 심리상담 포털</div><div style="font-size:13px; color:#111827; line-height:1.45;"><a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color:#2563eb; text-decoration:none; font-weight:600;">https://www.mindinfo.kr/new/index.asp</a> ↗<br><span style="color:#374151;">상담심리사 찾기, 심리상담센터 찾기, 공공 심리상담 기관 및 서비스 정보 제공</span></div><div style="text-align:right; margin-top:8px;"><button id="portal-close-btn" style="background:#27ae60; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">닫기</button></div>';
                document.body.appendChild(portal);
                // 안전장치: 이벤트 리스너도 추가 (일부 환경에서 inline 차단 대비)
                const portalCloseBtn = portal.querySelector('#portal-close-btn');
                if (portalCloseBtn) {
                    portalCloseBtn.addEventListener('click', function() {
                        const root = this.closest('[data-portal-root]') || portal;
                        if (root) root.remove();
                    });
                }
            }
        });

        // 이전 버튼 동작
        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateStage();
            }
        });

        

        // 입력값 전체 삭제 버튼 동작
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('모든 입력값을 정말로 삭제하시겠습니까?')) {
                responses = [
                    STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""],
                    STAGE_FIELDS[1].length ? Array(STAGE_FIELDS[1].length).fill("") : [""],
                    ["", "", []], // 3단계: 주제, 위기, 스토리보드 배열
                    [""] // 4단계: 영화 제목
                ];
                localStorage.clear(); // 로컬 스토리지도 모두 삭제
                
                // 마인드맵 내용도 삭제
                const aiResults = document.getElementById('aiResults');
                if (aiResults) {
                    aiResults.innerHTML = '';
                }
                
                updateStage(); // 화면 상태 업데이트
                alert('모든 입력값이 삭제되었습니다.');
            }
        });

        // 저장 함수
        function saveAllResponses() {
            // 1순위: 개인정보 보호 및 상담윤리 검증
            if (!responses || !Array.isArray(responses)) {
                console.warn('Privacy Check: Invalid responses structure');
                return;
            }
            
            // 모든 단계 데이터에 대해 개인정보 보호 검증
            const sanitizedResponses = responses.map((stepData, index) => {
                if (stepData) {
                    const sanitized = validatePrivacyAndEthics(stepData);
                    if (!sanitized) {
                        console.error(`Privacy validation failed for step ${index}`);
                        return null;
                    }
                    return sanitized;
                }
                return stepData;
            });
            
            // 검증 실패한 단계가 있으면 저장 중단
            if (sanitizedResponses.includes(null)) {
                console.error('Privacy Check: Some steps failed validation - saving aborted');
                return;
            }
            
            localStorage.setItem('scenario_responses', JSON.stringify(sanitizedResponses));
            console.log('Privacy Check: All responses saved with comprehensive validation');
        }
        function loadAllResponses() {
            const data = localStorage.getItem('scenario_responses');
            if (data) {
                try {
                    const loaded = JSON.parse(data);
                    if (Array.isArray(loaded) && loaded.length === responses.length) {
                        // 1순위: 로드된 데이터의 개인정보 보호 검증
                        const validatedResponses = loaded.map((stepData, index) => {
                            if (stepData) {
                                const validated = validatePrivacyAndEthics(stepData);
                                if (!validated) {
                                    console.error(`Privacy Check: Step ${index} validation failed during load`);
                                    return null;
                                }
                                return validated;
                            }
                            return stepData;
                        });
                        
                        // 검증 실패한 단계가 있으면 로드 중단
                        if (validatedResponses.includes(null)) {
                            console.error('Privacy Check: Some steps failed validation during load - loading aborted');
                            return;
                        }
                        
                        responses = validatedResponses;
                        console.log('Privacy Check: All responses loaded with validation');
                    }
            } catch (error) {
                    console.error('Privacy Check: Error parsing loaded data:', error);
                }
            }
        }

        // 0단계 안내 화면 추가
        let showIntro = true;
        let introOriginStage = null; // 안내로 진입한 기존 단계 인덱스(처음 화면이면 null)
        let isShowingPHQ9Results = false; // PHQ-9 결과 화면이 표시 중인지 확인하는 플래그
        function renderIntro() {
            const introDiv = document.createElement('div');
            introDiv.id = 'introScreen';
            introDiv.style = 'max-width:700px;margin:3em auto 0 auto;padding:2em;background:#fffbe6;border-radius:12px;border:1.5px solid #ffd700;box-shadow:0 2px 12px #ffd70022;';
            introDiv.innerHTML = `
                <!-- 개인정보 보호법 가이드 위젯 -->
                <div style="margin-bottom:2em;padding:1.5em;background:#0f172a;border-radius:12px;border:1px solid #1f2937;">
                    <div style="color:#e5e7eb;font-size:1.1em;margin-bottom:1em;"><b>🔒 개인정보 보호법 가이드</b></div>
                    <div style="color:#94a3b8;font-size:0.95em;line-height:1.6;margin-bottom:1.5em;">
                        본 프로그램은 <span style="color:#22c55e;font-weight:bold;">개인정보 보호법</span>과 <span style="color:#22c55e;font-weight:bold;">상담심리학회 상담윤리</span>를 <span style="color:#f59e0b;font-weight:bold;">최우선</span>으로 준수하여 운영됩니다. 아래 가이드를 확인하시고 서비스를 이용해 주세요.
                    </div>
                    
                    <!-- 수집·이용 동의 (제15조) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>수집·이용 동의 (제15조)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            • <b>수집 목적:</b> 시나리오 치료 진행 및 기록 관리<br>
                            • <b>수집 항목:</b> 이름(가명), 이메일, 작성 콘텐츠(가명처리)<br>
                            • <b>보유·이용 기간:</b> 365일 (목적 달성 후 파기)<br>
                            • <b>동의 거부:</b> 서비스 제공이 제한될 수 있습니다
                        </div>
                    </div>
                    
                    <!-- 제3자 제공 (제17·18조) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>제3자 제공 (제17·18조)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            
                            • <b>안전조치:</b> 가명처리 및 암호화를 통해 개인정보를 보호합니다<br>
                            • <b>제공 범위:</b> 분석 목적으로만 제한적으로 이용됩니다
                        </div>
                    </div>
                    
                    <!-- 상담윤리 및 비밀보장 (한국상담심리학회) -->
                    <div style="background:#1e3a8a;border:1px solid #3b82f6;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>💙 상담윤리 및 비밀보장 (한국상담심리학회)</b></div>
                        <div style="color:#93c5fd;font-size:0.9em;line-height:1.5;">
                            • <b>비밀보장 원칙:</b> 모든 상담 내용은 철저한 비밀보장 원칙을 따릅니다<br>
                            • <b>윤리적 책임:</b> 상담사는 내담자의 복지를 최우선으로 합니다<br>
                            • <b>경계 설정:</b> 전문적 관계 유지를 위한 명확한 경계를 설정합니다
                        </div>
                    </div>
                    
                    <!-- 정보주체 권리 (제35·36·37·37의2) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>정보주체 권리 (제35·36·37·37의2)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            • <b>열람 요구:</b> 본인정보 열람을 요구할 수 있습니다<br>
                            • <b>정정·삭제:</b> 부정확한 정보의 정정 또는 삭제를 요구할 수 있습니다<br>
                            • <b>처리정지:</b> 개인정보 처리의 정지 또는 동의철회를 요구할 수 있습니다
                        </div>
                    </div>
                    
                    <!-- 중요 안내사항 -->
                    <div style="background:#dc2626;border:1px solid #ef4444;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#fecaca;font-size:1em;margin-bottom:0.8em;"><b>⚠️ 최우선 보호 원칙</b></div>
                        <div style="color:#fca5a5;font-size:0.9em;line-height:1.5;">
                            • <b>1순위:</b> 개인정보 보호법 및 상담윤리 준수<br>
                            • <b>절대 원칙:</b> 비밀보장 및 프라이버시 보호<br>
                            • <b>안전조치:</b> 모든 데이터는 암호화 및 가명처리 후 처리
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-top:1.5em;">
                        <button onclick="showPrivacyGuide()" style="background:#22c55e;color:white;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;margin-right:10px;">상세 가이드 보기</button>
                        <button onclick="showServiceGuidePage()" style="background:#f59e0b;color:white;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;">서비스 안내사항 보기</button>
                    </div>
                </div>

                <div style="text-align:center;margin-top:2.5em;">
                    <div style="color:#666;font-size:0.9em;margin-bottom:1em;">
                        📋 개인정보보호법 가이드를 확인하신 후, 서비스 안내사항을 통해 단계별로 진행해주세요.
                    </div>
                </div>
            `;
            const containerRef = document.body.querySelector('.container');
            if (containerRef) {
                // 프로그램 UI가 한 번도 렌더된 적이 없다면(첫 화면), 복귀 버튼을 숨기기 위해 origin=null
                introOriginStage = programMounted ? currentIndex : null;
                containerRef.style.display = 'none';
            } else {
                introOriginStage = null;
            }
            document.body.appendChild(introDiv);
     
            // 프로그램으로 복귀 네비게이션: 처음 화면에서는 표시하지 않음, 안내로 들어온 경우에만 표시
            if (introOriginStage !== null) {
                introDiv.insertAdjacentHTML('beforeend', `
                    <div style="text-align:center;margin-top:1.5em;">
                        <button id="backToProgramBtn" style="background:#22c55e;color:#fff;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;">프로그램으로 돌아가기</button>
                    </div>
                `);
                const containerEl = document.body.querySelector('.container');
                const backBtn = document.getElementById('backToProgramBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', function() {
                        // 안내로 들어오기 전 단계로만 복귀 허용
                        currentIndex = introOriginStage;
                        if (introDiv && introDiv.parentNode) introDiv.parentNode.removeChild(introDiv);
                        if (containerEl) containerEl.style.display = '';
                        updateStage();
                    });
                }
            }
        }
        function showPHQ9Results(score) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'phq9-screening';
            resultDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card" style="max-width: 720px; margin: 0 auto;">
                                            <h1 class="phq9-title">PHQ-9 검사 결과 (이미 완료됨)</h1>
                    <div class="phq9-sub">
                        이전에 완료하신 PHQ-9 검사 결과입니다.<br>
                        <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                            📋 <a href="https://www.ncmh.go.kr/ncmh/board/boardView.do?no=8834&fno=106&bn=newsView&menu_cd=04_02_02_04&bno=&pageIndex=1&search_item=&search_content=#" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                PHQ-9 한국판 표준지침 (국립정신건강센터)
                            </a> ↗
                        </small>

                    </div>
                        
                        <div class="phq9-result">
                            <div class="phq9-score">총점: <span id="phq9ResultTotal">${score}</span> / 27 <span id="phq9ResultSevTag" class="phq9-sev">결과</span></div>
                            <div id="phq9ResultAdvice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns" style="margin-top: 20px;">
                                <button id="phq9ResultStartBtn" class="phq9-btn phq9-primary" style="margin-right: 10px;">프로그램 체험 시작</button>
                                <button id="phq9RetakeBtn" class="phq9-btn phq9-danger" style="margin-right: 10px;">설문 다시하기</button>
                                <button id="phq9ResultBackBtn" class="phq9-btn phq9-ghost">뒤로 가기</button>
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * 설문을 다시 하려면 "설문 다시하기" 버튼을 클릭하세요. 이전 결과는 삭제됩니다.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(resultDiv);
            console.log('PHQ-9 결과 화면 DOM에 추가됨');
            
            // 결과 표시
            const [label, cls] = getSeverityClass(score);
            document.getElementById('phq9ResultSevTag').textContent = label;
            document.getElementById('phq9ResultSevTag').className = 'phq9-sev ' + cls;
            
            console.log('PHQ-9 결과 화면 렌더링 완료, 점수:', score);
            
            const advice = document.getElementById('phq9ResultAdvice');
            const startBtn = document.getElementById('phq9ResultStartBtn');
            
            // 9번 질문(자해/자살 생각) 점수 확인
            // localStorage에서 PHQ-9 개별 응답 데이터 확인
            const phq9Responses = localStorage.getItem('phq9_responses');
            let question9Score = 0;
            
            if (phq9Responses) {
                try {
                    const responses = JSON.parse(phq9Responses);
                    if (responses && responses.length > 8) {
                        question9Score = parseInt(responses[8]) || 0;
                    }
                } catch (e) {
                    console.error('PHQ-9 응답 데이터 파싱 오류:', e);
                }
            }
            
            // 9번 질문에서 1점 이상이면 즉시 위험 안내 및 프로그램 시작 버튼 비활성화
            if (question9Score >= 1) {
                startBtn.disabled = true;
                advice.className = 'phq9-note phq9-warn';
                advice.innerHTML = '<strong>⚠️ 안전 안내:</strong> 자해나 자살 생각이 있는 경우 즉시 전문가의 도움을 받으세요.';
                
                // 위기 상담 연락처 안내 추가
                const crisisDiv = document.createElement('div');
                crisisDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0; animation: fadeIn 0.5s ease-in;';
                crisisDiv.innerHTML = `
                    <h4 style="margin: 0 0 12px; color: #856404;">⚠️ 위기 상황 대응 안내</h4>
                    <p style="margin: 0 0 16px; color: #856404;">자해나 자살 생각이 있는 경우 즉시 전문가의 도움을 받으세요.</p>
                    
                    <h4 style="margin: 0 0 12px; color: #856404;">📞 위기 상담 연락처</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr style="background: #fff8e1;">
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 20%;">구분</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 40%;">기관/서비스명</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 25%;">전화/채팅</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 15%;">비고</th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">생명의 전화 1588-9191</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 자살·정서 위기 전문 상담, 비밀보장</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">자살예방상담전화 1393</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 보건복지부·한국생명존중희망재단</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">정신건강 상담전화 1577-0199</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 정신건강복지센터 연결</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #74b9ff;">청소년</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">청소년 전화 1388</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화·문자(#1388)·채팅</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 청소년 대상 위기·정서 지원</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #6c5ce7;">채팅 중심</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">카카오톡 '자살예방상담' 채널</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">채팅</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 1393 운영</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">긴급</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">119</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">자·타해 위험 즉시 구조</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">긴급</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">112</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">범죄·폭력 위험 포함 시</td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>💡 심리상담 포털:</strong> 
                        <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                            https://www.mindinfo.kr/new/index.asp
                        </a> ↗
                        <br><small style="color: #6b7280;">상담심리사 찾기, 심리상담센터 찾기, 공공 심리상담 기관 및 서비스 정보 제공</small>
                    </div>
                `;
                
                // advice 요소 다음에 위기 상담 안내 추가
                advice.parentNode.insertBefore(crisisDiv, advice.nextSibling);
            } else {
                // 9번 질문에서 1점 미만인 경우 기존 게이팅 로직 적용
                if(score >= 5 && score <= 14) {
                    // 경증 우울군: 바로 프로그램 시작 가능
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = '프로그램 체험 시작';
                    
                    advice.innerHTML = '<strong>💡 프로그램 시작:</strong> 해당 점수는 <b>0–14점</b> 범위입니다. <br><br><strong>프로그램을 바로 시작할 수 있습니다.</strong>';
                    advice.className = 'phq9-note phq9-info';
                } else {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    if(score <= 4) {
                        advice.innerHTML = '현재 점수는 <b>우울 아님(0–4)</b> 범위입니다. 필요 시 추후 다시 체크하거나, 생활 리듬 관리를 유지해 주세요.';
                    } else if(score >= 20) {
                        advice.innerHTML = '현재 점수는 <b>심한 우울(20–27)</b> 범위일 수 있습니다. 즉시 전문가의 평가와 도움을 권합니다.';
                    } else { // 15–19
                        advice.innerHTML = '현재 점수는 <b>중등도(15–19)</b> 범위입니다. 본 체험 프로그램은 제공되지 않습니다. 전문가 상담/치료를 권합니다.';
                    }
                }
            }
            
            // 이벤트 리스너 연결 확인
            console.log('PHQ-9 결과 화면 버튼 이벤트 리스너 연결 시작');
            
            const resultStartBtn = document.getElementById('phq9ResultStartBtn');
            const resultRetakeBtn = document.getElementById('phq9RetakeBtn');
            const resultBackBtn = document.getElementById('phq9ResultBackBtn');
            
            console.log('버튼 요소들:', { resultStartBtn, resultRetakeBtn, resultBackBtn });
            
            if (resultStartBtn) {
                resultStartBtn.onclick = () => {
                    console.log('프로그램 체험 시작 버튼 클릭됨');
                    resultDiv.remove();
                    document.querySelector('.container').style.display = '';
                    updateStage();
                };
            }
            
            if (resultRetakeBtn) {
                resultRetakeBtn.onclick = () => {
                    console.log('설문 다시하기 버튼 클릭됨');
                    if(confirm('이전 검사 결과가 삭제됩니다. 정말 다시 하시겠습니까?')) {
                        // 하이브리드 스토리지에서 모든 PHQ-9 데이터 삭제
                        sessionStorage.removeItem('phq9_data');
                        localStorage.removeItem('phq9_data');
                        localStorage.removeItem('phq9_responses'); // 개별 응답 데이터도 삭제
                        console.log('PHQ-9 데이터 완전 삭제됨 (하이브리드)');
                        resultDiv.remove();
                        renderDemographicsSurvey();
                    }
                };
            }
            
            if (resultBackBtn) {
                resultBackBtn.onclick = () => {
                    console.log('뒤로 가기 버튼 클릭됨');
                    resultDiv.remove();
                    showIntro = true;
                    renderIntro();
                };
            }
            
            console.log('PHQ-9 결과 화면 버튼 이벤트 리스너 연결 완료');
        }

        function getSeverityClass(score) {
            if(score <= 4) return ['정상 (0–4)', 'none'];
            if(score <= 14) return ['경함 (0–14)', 'mild'];
            return ['심각함 (15–27)', 'sev'];
        }

        function getPHQ9DataFromStorage() {
            const now = Date.now();
            
            // 1순위: sessionStorage 체크 (탭별 독립, 최고 보안)
            const sessionData = sessionStorage.getItem('phq9_data');
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    if (data.expires > now) {
                        console.log('sessionStorage에서 유효한 PHQ-9 데이터 발견');
                        return data;
                    } else {
                        console.log('sessionStorage의 PHQ-9 데이터 만료됨');
                        sessionStorage.removeItem('phq9_data');
                    }
                } catch (e) {
                    console.error('sessionStorage PHQ-9 데이터 파싱 오류:', e);
                    sessionStorage.removeItem('phq9_data');
                }
            }
            
            // 2순위: localStorage 체크 (24시간 백업, 연속성)
            const localData = localStorage.getItem('phq9_data');
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    if (data.expires > now) {
                        console.log('localStorage에서 유효한 PHQ-9 데이터 발견, sessionStorage로 복사');
                        // sessionStorage로 복사하여 동기화
                        sessionStorage.setItem('phq9_data', localData);
                        return data;
                    } else {
                        console.log('localStorage의 PHQ-9 데이터 만료됨');
                        localStorage.removeItem('phq9_data');
                    }
                } catch (e) {
                    console.error('localStorage PHQ-9 데이터 파싱 오류:', e);
                    localStorage.removeItem('phq9_data');
                }
            }
            
            console.log('유효한 PHQ-9 데이터 없음');
            return null;
        }

        // 인구통계 수집 함수
        function renderDemographicsSurvey() {
            console.log('인구통계 수집 화면 시작');
            
            // 기존 화면이 있다면 제거
            const existingSurvey = document.querySelector('.demographics-survey');
            if (existingSurvey) {
                existingSurvey.remove();
            }
            
            const surveyDiv = document.createElement('div');
            surveyDiv.className = 'demographics-survey';
            
            surveyDiv.innerHTML = `
                <div class="demo-wrap">
                    <div class="demo-card">
                        <h1 class="demo-title">📊 인구통계 정보 수집</h1>
                        <div class="demo-sub">
                            프로그램 참여를 위한 기본 정보를 수집합니다.<br>
                            모든 정보는 익명으로 처리되며, 매칭 목적으로만 사용됩니다.
                        </div>
                        
                        <form id="demographicsForm" class="demo-form">
                            <div class="demo-section" style="display: none;">
                                <h3>1. 성별</h3>
                                <div class="demo-options">
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="0">
                                        <span class="demo-label">남성</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="1">
                                        <span class="demo-label">여성</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="2">
                                        <span class="demo-label">기타</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="demo-section" style="display: none;">
                                <h3>2. 연령대</h3>
                                <div class="demo-input">
                                    <input type="number" id="age" name="age" min="13" max="100" placeholder="나이를 입력하세요">
                                    <span class="demo-unit">세</span>
                                </div>
                            </div>
                            
                            <div class="demo-section" style="display: none;">
                                <h3>3. 집단 영화제작 상담 참여 희망</h3>
                                <div class="demo-options">
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="yes">
                                        <span class="demo-label">네, 참여하고 싶습니다</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="no">
                                        <span class="demo-label">혼자 제작하고 싶습니다.</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="none">
                                        <span class="demo-label">아니오, 어느 것에도 참여하지 않겠습니다.</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="demo-section" id="locationSection" style="display: none;">
                                <h3>4. 거주 지역</h3>
                                <div class="demo-input">
                                    <select id="region" name="region">
                                        <option value="">지역을 선택하세요</option>
                                        <option value="서울">서울특별시</option>
                                        <option value="부산">부산광역시</option>
                                        <option value="대구">대구광역시</option>
                                        <option value="인천">인천광역시</option>
                                        <option value="광주">광주광역시</option>
                                        <option value="대전">대전광역시</option>
                                        <option value="울산">울산광역시</option>
                                        <option value="세종">세종특별자치시</option>
                                        <option value="경기">경기도</option>
                                        <option value="강원">강원도</option>
                                        <option value="충북">충청북도</option>
                                        <option value="충남">충청남도</option>
                                        <option value="전북">전라북도</option>
                                        <option value="전남">전라남도</option>
                                        <option value="경북">경상북도</option>
                                        <option value="경남">경상남도</option>
                                        <option value="제주">제주특별자치도</option>
                                        <option value="기타">기타</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="demo-btns">
                                <button type="submit" class="demo-btn demo-primary">다음 단계로 진행</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // 기존 컨테이너 숨기기
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            document.body.appendChild(surveyDiv);
            
            // 폼 제출 이벤트 처리
            const form = document.getElementById('demographicsForm');
            const groupParticipationRadios = document.querySelectorAll('input[name="groupParticipation"]');
            const locationSection = document.getElementById('locationSection');
            const regionSelect = document.getElementById('region');
            
            // 집단 참여 희망 여부에 따른 거주지역 표시/숨김
            groupParticipationRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        locationSection.style.display = 'block';
                        regionSelect.required = true;
                    } else {
                        locationSection.style.display = 'none';
                        regionSelect.required = false;
                        regionSelect.value = '';
                    }
                });
            });
            
            // 폼 제출 처리
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const demographics = {
                    gender: parseInt(formData.get('gender')),
                    age: parseInt(formData.get('age')),
                    groupParticipation: formData.get('groupParticipation'),
                    region: formData.get('groupParticipation') === 'yes' ? formData.get('region') : null,
                    timestamp: Date.now()
                };
                
                // 인구통계 데이터 저장
                sessionStorage.setItem('demographics_data', JSON.stringify(demographics));
                localStorage.setItem('demographics_data', JSON.stringify(demographics));
                
                console.log('인구통계 데이터 저장 완료:', demographics);
                
                // PHQ-9 검사로 진행
                renderPHQ9Screening();
            });
        }

        // PHQ-9 건강설문 (윤리강령 적용됨)
        function renderPHQ9Screening() {
            console.log('renderPHQ9Screening 함수 시작');
            
            // 기존 PHQ-9 검사가 있다면 제거
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('기존 PHQ-9 검사 제거');
                existingScreening.remove();
            }
            
            // 기존 인구통계 설문 숨기기
            const existingDemographics = document.querySelector('.demographics-survey');
            if (existingDemographics) {
                console.log('기존 인구통계 설문 숨김');
                existingDemographics.style.display = 'none';
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'phq9-screening';
            console.log('PHQ-9 검사 div 생성됨');
            
            screeningDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card">
                        <!-- 워크플로우 안내 제거 -->
                        
                        <h1 class="phq9-title">우울증 건강설문‑9 (PHQ‑9) — 한국판</h1>
                        <div class="phq9-sub">
                            지난 <b>2주</b> 동안 다음과 같은 문제들로 <b>얼마나 자주</b> 곤란을 겪었는지 선택하세요. (0=없음, 1=2–6일, 2=7–12일, 3=거의 매일)<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                📋 <a href="https://www.ncmh.go.kr/ncmh/board/boardView.do?no=8834&fno=106&bn=newsView&menu_cd=04_02_02_04&bno=&pageIndex=1&search_item=&search_content=#" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    PHQ-9 한국판 표준지침 (국립정신건강센터)
                                </a> ↗
                            </small>

                        </div>
                        
                        <div class="phq9-grid" id="phq9Grid"></div>

                        
                        

                        
                        <div class="phq9-result" id="phq9Result" style="display: none;">
                            <div class="phq9-score">총점: <span id="phq9Total">0</span> / 27 <span id="phq9SevTag" class="phq9-sev none">정상 (0–4)</span></div>
                            <div id="phq9Advice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns">
                                <button id="phq9StartBtn" class="phq9-btn phq9-primary" disabled>프로그램 체험 시작</button>
                                <button id="phq9BackBtn" class="phq9-btn phq9-ghost">뒤로 가기</button>
                            </div>
                        </div>
                        
                        <div class="phq9-progress" id="phq9Progress">
                            <div class="phq9-btns">
                                <button id="phq9CalcBtn" class="phq9-btn phq9-primary" disabled>결과 확인하기</button>
                                <button id="phq9BackBtn2" class="phq9-btn phq9-ghost">뒤로 가기</button>
                            </div>
                            <div class="phq9-note" style="margin-top: 8px;">
                                완료된 문항: <span id="phq9CompletedCount">0</span> / 9
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * 이 설문은 참고용입니다. 점수가 높으면, 위험 신호일 수 있으니 지역 정신건강 전문기관에 꼭 상의하세요.
                        </div>
                    </div>
                </div>
            `;
            
            console.log('PHQ-9 검사 화면 DOM에 추가');
            // 기존 컨테이너 숨기기
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
                console.log('기존 컨테이너 숨김');
            }
            
            console.log('DOM에 PHQ-9 검사 추가 시도...');
            document.body.appendChild(screeningDiv);
            console.log('PHQ-9 검사 화면 DOM에 추가됨');
            console.log('현재 body의 자식 요소들:', document.body.children);
            
            // PHQ-9 검사가 실제로 표시되는지 확인
            const addedScreening = document.querySelector('.phq9-screening');
            if (addedScreening) {
                console.log('PHQ-9 검사 요소가 DOM에 성공적으로 추가됨');
                console.log('initPHQ9 함수 호출');
                initPHQ9();
            } else {
                console.error('PHQ-9 검사 요소를 찾을 수 없음!');
                alert('PHQ-9 검사 화면을 불러올 수 없습니다. 페이지를 새로고침해주세요.');
            }
        }

        function initPHQ9() {
            console.log('initPHQ9 함수 시작');
            
            // PHQ-9 검사 요소가 존재하는지 확인
            const screeningElement = document.querySelector('.phq9-screening');
            if (!screeningElement) {
                console.error('PHQ-9 검사 요소를 찾을 수 없음!');
                return;
            }
            
            console.log('PHQ-9 검사 요소 확인됨:', screeningElement);
            
            // 윤리강령 기반 위험도 평가 및 안전 안내 시스템 통합
            const ITEMS = [
                '기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다',
                '평소 하던 일에 대한 흥미가 없어지거나 즐거움을 느끼지 못했다',
                '잠들기가 어렵거나 자주 깼다 / 혹은 너무 많이 잤다',
                '평소보다 식욕이 줄었다 / 혹은 평소보다 많이 먹었다',
                '다른 사람들이 눈치 챌 정도로 평소보다 말과 행동이 느려졌다 / 혹은 너무 안절부절 못해서 가만히 앉아 있을 수 없었다',
                '피곤하고 기운이 없었다',
                '내가 잘못했거나, 실패했다는 생각이 들었다 / 혹은 자신과 가족을 실망시켰다고 생각했다',
                '신문을 읽거나 TV를 보는 것과 같은 일상적인 일에도 집중할 수가 없었다',
                '차라리 죽는 것이 더 낫겠다고 생각했다 / 혹은 자해할 생각을 했다'
            ];

            const grid = document.getElementById('phq9Grid');
            ITEMS.forEach((txt, i) => {
                const q = document.createElement('div');
                q.className = 'phq9-q';
                q.innerHTML = `<h3>${i+1}. ${txt}</h3>
                    <div class="phq9-opts">
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="0">없음(0)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="1">2–6일(1)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="2">7–12일(2)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="3">거의 매일(3)</label>
                    </div>`;
                grid.appendChild(q);
            });

            const totalEl = document.getElementById('phq9Total');
            const sevTag = document.getElementById('phq9SevTag');
            const advice = document.getElementById('phq9Advice');
            const startBtn = document.getElementById('phq9StartBtn');
            const backBtn = document.getElementById('phq9BackBtn');
            const calcBtn = document.getElementById('phq9CalcBtn');
            const backBtn2 = document.getElementById('phq9BackBtn2');
            const resultDiv = document.getElementById('phq9Result');
            const progressDiv = document.getElementById('phq9Progress');
            const completedCount = document.getElementById('phq9CompletedCount');

            function getPHQ9Score() {
                let sum = 0;
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    sum += v ? Number(v.value) : 0;
                }
                return sum;
            }



            function getCompletedCount() {
                let completed = 0;
                // 9개 주요 문항 체크
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    if(v) completed++;
                }
                
                return completed;
            }

            function updateProgress() {
                const completed = getCompletedCount();
                completedCount.textContent = completed;
                
                // 윤리강령 기반 즉시 위험도 체크 (9번 문항 자해/자살 생각)
                // 설문 완료 후에만 경고 표시하도록 showResults 함수로 이동
                
                // 모든 문항 완료시 결과 확인 버튼 활성화
                if(completed === 9) {
                    calcBtn.disabled = false;
                    calcBtn.textContent = '결과 확인하기 ✅';
                } else {
                    calcBtn.disabled = true;
                    calcBtn.textContent = `결과 확인하기 (${completed}/9)`;
                }
            }
            


            // PHQ-9 윤리강령 기반 위험도 평가 및 안전 안내
            function assessPHQ9Risk(score, responses) {
                // 자/타해 위험도 평가 (9번 문항: 자해/자살 생각)
                const suicideRisk = responses[8]; // 9번 문항 (0-3)
                
                if (suicideRisk >= 2) { // 7-12일 또는 거의 매일
                    return {
                        risk: 'high',
                        message: '자해/자살 생각이 있는 것으로 보입니다. 즉시 전문가의 도움을 받으세요.',
                        action: 'emergency'
                    };
                }
                
                if (score >= 20) {
                    return {
                        risk: 'high',
                        message: '심한 우울 증상이 나타나고 있습니다. 즉시 전문가의 평가와 치료를 받으세요.',
                        action: 'professional'
                    };
                }
                
                if (score >= 15) {
                    return {
                        risk: 'moderate',
                        message: '중등도 우울 증상이 나타나고 있습니다. 전문가 상담을 권합니다.',
                        action: 'consultation'
                    };
                }
                
                return {
                    risk: 'low',
                    message: '현재 우울 증상은 경미합니다.',
                    action: 'selfcare'
                };
            }

            function showResults() {
                const score = getPHQ9Score();
                console.log('PHQ-9 결과 계산 완료, 점수:', score);
                
                // 윤리강령 기반 위험도 평가
                const responses = [];
                for(let i = 0; i < 9; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    responses[i] = v ? Number(v.value) : 0;
                }
                
                const riskAssessment = assessPHQ9Risk(score, responses);
                console.log('PHQ-9 위험도 평가 결과:', riskAssessment);
                
                // 인구통계 데이터 가져오기
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                
                // PHQ-9 점수를 하이브리드 스토리지에 저장 (결과 확인 시점)
                const timestamp = Date.now();
                const phq9Data = {
                    score: score,
                    riskLevel: riskAssessment.risk,
                    timestamp: timestamp,
                    expires: timestamp + (24 * 60 * 60 * 1000), // 24시간 후 만료
                    demographics: demographicsData // 인구통계 데이터 포함
                };
                
                // Primary: sessionStorage (탭별 독립, 즉시 보안)
                sessionStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                
                // Fallback: localStorage (연속성, 24시간 만료)
                localStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                
                // 개별 응답 데이터도 localStorage에 저장 (9번 질문 점수 확인용)
                localStorage.setItem('phq9_responses', JSON.stringify(responses));
                
                console.log('하이브리드 스토리지 저장 완료 (결과 화면):', { 
                    session_data: sessionStorage.getItem('phq9_data'),
                    local_data: localStorage.getItem('phq9_data'),
                    responses: responses,
                    expires_at: new Date(phq9Data.expires)
                });
                
                totalEl.textContent = score;
                const [label, cls] = getSeverityClass(score);
                sevTag.textContent = label;
                sevTag.className = 'phq9-sev ' + cls;



                // 9번 질문(자해/자살 생각) 점수 확인
                const question9Score = responses[8]; // 9번 질문 (0-3)
                
                    // 9번 질문에서 1점 이상이면 즉시 위험 안내 및 프로그램 시작 버튼 비활성화
                if (question9Score >= 1) {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    advice.innerHTML = '<strong>⚠️ 안전 안내:</strong> 자해나 자살 생각이 있는 경우 즉시 전문가의 도움을 받으세요.';
                    
                    // 위기 상담 연락처 안내 추가
                    const crisisDiv = document.createElement('div');
                    crisisDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0; animation: fadeIn 0.5s ease-in;';
                    crisisDiv.innerHTML = `
                        <h4 style="margin: 0 0 12px; color: #856404;">⚠️ 위기 상황 대응 안내</h4>
                        <p style="margin: 0 0 16px; color: #856404;">자해나 자살 생각이 있는 경우 즉시 전문가의 도움을 받으세요.</p>
                        
                        <h4 style="margin: 0 0 12px; color: #856404;">📞 위기 상담 연락처</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr style="background: #fff8e1;">
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 20%;">구분</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 40%;">기관/서비스명</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 25%;">전화/채팅</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 15%;">비고</th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">생명의 전화 1588-9191</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 자살·정서 위기 전문 상담, 비밀보장</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">자살예방상담전화 1393</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 보건복지부·한국생명존중희망재단</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">위기 상담</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">정신건강 상담전화 1577-0199</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 정신건강복지센터 연결</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #74b9ff;">청소년</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">청소년 전화 1388</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화·문자(#1388)·채팅</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 청소년 대상 위기·정서 지원</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #6c5ce7;">채팅 중심</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">카카오톡 '자살예방상담' 채널</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">채팅</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24시간, 1393 운영</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">긴급</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">119</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">자·타해 위험 즉시 구조</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">긴급</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">112</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">전화</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">범죄·폭력 위험 포함 시</td>
                            </tr>
                        </table>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                            <h4 style="margin: 0 0 12px; color: #27ae60;">💡 카카오톡 상담 채널</h4>
                            <p style="margin: 0 0 12px; color: #27ae60;">우울증 및 불안증 전문 상담을 위한 채널입니다.</p>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>다 들어줄 개:</strong> 
                                <a href="https://pf.kakao.com/_CxoBxcC" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_CxoBxcC
                                </a> ↗
                                <br><small style="color: #6b7280;">우울증 및 불안증 전문 상담, 24시간 채팅 상담 가능</small>
                            </div>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>마들랜:</strong> 
                                <a href="https://pf.kakao.com/_DAxbYG" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_DAxbYG
                                </a> ↗
                                <br><small style="color: #6b7280;">우울증 및 불안증 전문 상담, 24시간 채팅 상담 가능</small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                            <strong>💡 심리상담 포털:</strong> 
                            <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                https://www.mindinfo.kr/new/index.asp
                            </a> ↗
                            <br><small style="color: #6b7280;">상담심리사 찾기, 심리상담센터 찾기, 공공 심리상담 기관 및 서비스 정보 제공</small>
                        </div>
                    `;
                    
                    // advice 요소 다음에 위기 상담 안내 추가
                    advice.parentNode.insertBefore(crisisDiv, advice.nextSibling);
                } else {
                    // 9번 질문에서 1점 미만인 경우 기존 게이팅 로직 적용
                    if (riskAssessment.risk === 'high') {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    advice.innerHTML = `<strong>⚠️ 안전 안내:</strong> ${riskAssessment.message}`;
                } else if (score <= 14 && question9Score === 0) {
                    // 0–14점이며 9번 문항 0점: 불안증상 검사로 진행
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = '불안증상 검사 진행';
                    
                    advice.innerHTML = '<strong>💡 다음 단계:</strong> 해당 점수는 <b>0–14점</b> 범위이며, <b>9번 문항이 0점</b>입니다. <br><br><strong>이제 불안증상 검사(GAD-7)를 진행할 수 있습니다.</strong>';
                    advice.className = 'phq9-note phq9-info';
                    
                } else if (score > 14 || question9Score >= 1) {
                    // 15점 이상이거나 9번 문항 1점 이상: 프로그램 시작 불가
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = '프로그램 시작 불가';
                    
                    if (score > 14) {
                        advice.innerHTML = '현재 점수는 <b>15점 이상</b>으로 불안증상 검사로 진행할 수 없습니다. 전문가 상담을 권합니다.';
                    } else {
                        advice.innerHTML = '9번 문항에 <b>1점 이상</b>이 있어 안전상 불안증상 검사로 진행할 수 없습니다.';
                    }
                    advice.className = 'phq9-note phq9-warn';
                } else if (score <= 4) {
                    // 0-4점: 정상 범위
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>정상(0–4)</b> 범위입니다. 필요 시 추후 다시 체크하거나, 생활 리듬 관리를 유지해 주세요.';
                    advice.className = 'phq9-note phq9-warn';
                }
                }

                // PHQ-9 9번 질문(자해/자살 생각)에서 1점 이상일 때 위기 상담 연락처 안내는 이미 위에서 표시됨

                // 결과 화면으로 전환
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                // 심리상담 포털 및 카카오톡 상담 채널 안내 (PHQ-9 완료 즉시)
                // 심리상담 포털 안내 (PHQ-9 완료 즉시) - 심각한 증상이 아닐 때만 표시
                if (!document.getElementById('counselingPortalInfo') && score <= 14 && question9Score === 0) {
                    const portal = document.createElement('div');
                    portal.id = 'counselingPortalInfo';
                    portal.style.cssText = 'margin-top:16px; padding:12px; background:#e8f5e8; border-left:4px solid #27ae60; border-radius:6px;';
                    portal.innerHTML = `
                        <strong>💡 심리상담 포털:</strong> 
                        <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color:#2563eb; text-decoration:none; font-weight:500;">
                            https://www.mindinfo.kr/new/index.asp
                        </a> ↗
                        <br><small style="color:#6b7280;">상담심리사 찾기, 심리상담센터 찾기, 공공 심리상담 기관 및 서비스 정보 제공</small>
                    `;
                    resultDiv.appendChild(portal);
                }
            }

            document.addEventListener('change', e => {
                if(e.target.matches('.phq9-screening input[type=radio]')) updateProgress();
            });

            // 결과 확인 버튼
            calcBtn.addEventListener('click', showResults);

            // 첫 번째 뒤로 가기 버튼 (진행 중)
            backBtn2.addEventListener('click', () => {
                document.querySelector('.phq9-screening').remove();
                showIntro = true;
                renderIntro();
            });

            // 두 번째 뒤로 가기 버튼 (결과 화면)
            backBtn.addEventListener('click', () => {
                document.querySelector('.phq9-screening').remove();
                showIntro = true;
                renderIntro();
            });

            // 불안증상 검사 진행 버튼 (GAD-7)
            startBtn.addEventListener('click', () => {
                console.log('불안증상 검사 진행 버튼 클릭');
                
                // GAD-7 검사 화면으로 이동
                renderGAD7Screening();
            });

            // 초기 진행 상태 업데이트
            updateProgress();
        }

        // 프로그램 시작 함수
        function startProgram() {
            // PHQ-9 또는 GAD-7 결과 컨테이너 중 존재하는 것을 사용
            const screeningContainer = document.querySelector('.phq9-screening') || document.querySelector('.gad7-screening');
            if (!screeningContainer) return;
            
            // 영화제작치료 참여 여부 확인
            const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
            const groupParticipation = demographicsData.groupParticipation;
            
            if (groupParticipation === 'none') {
                // '아니오, 참여하지 않겠습니다' 선택 시
                showCompletionMessage(screeningContainer);
            } else if (groupParticipation === 'yes' || groupParticipation === 'no') {
                // '함께 하는 집단 영화제작치료' 또는 '혼자 진행하는 개인 영화제작치료' 선택 시
                showHighScoreItems(screeningContainer);
            } else {
                // 선택하지 않은 경우
                screeningContainer.innerHTML = '<div style="text-align:center; padding:20px;">영화제작치료 참여 여부를 선택해주세요.</div>';
            }
        }
        
        // 완료 메시지 표시 (참여하지 않겠습니다 선택 시)
        function showCompletionMessage(container) {
            // PHQ-9과 GAD-7 총점 계산
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');
            
            const phq9Total = phq9Data.score || 0;
            const gad7Total = gad7Data.score || 0;
            
            container.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">수고하셨습니다!</h1>
                        <div style="text-align:center; margin:20px 0;">
                            <p style="font-size:1.2em; color:#6b7280; margin-bottom:20px;">
                                영화제작치료에 참여하지 않기로 하셨습니다.<br>
                                검사 결과는 다음과 같습니다:
                            </p>
                            <div style="display:flex; justify-content:center; gap:40px; margin:20px 0;">
                                <div style="text-align:center;">
                                    <div style="font-size:2em; font-weight:bold; color:#6f42c1;">${phq9Total}</div>
                                    <div style="color:#6b7280;">PHQ-9 (우울)</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:2em; font-weight:bold; color:#dc3545;">${gad7Total}</div>
                                    <div style="color:#6b7280;">GAD-7 (불안)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 최고점 문항 표시 및 상황 분석 질문 (참여하겠습니다 선택 시)
        function showHighScoreItems(container) {
            // PHQ-9과 GAD-7 데이터 가져오기
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');
            
            // 디버깅을 위한 데이터 구조 로깅
            console.log('PHQ-9 데이터 구조:', phq9Data);
            console.log('GAD-7 데이터 구조:', gad7Data);
            console.log('PHQ-9 items 타입:', typeof phq9Data.items, Array.isArray(phq9Data.items));
            console.log('GAD-7 items 타입:', typeof gad7Data.items, Array.isArray(gad7Data.items));

            // 항목 텍스트 헬퍼 (전역 함수가 없을 때 안전한 대체)
            const PHQ9_TEXTS = {
                1: "기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다.",
                2: "평소에 아무렇지 않게 하던 일에 흥미가 없어지거나 즐거움을 느끼지 못했다",
                3: "잠들기 어렵거나 자주 깼다/혹은 너무 많이 잤다.",
                4: "평소보다 식욕이 줄었다/혹은 평소보다 많이 먹었다",
                5: "다른 사람들이 눈치 챌 정도로 평소보다 말과 행동이 느려졌다/혹은 너무 안절부절 못 해서 가만히 앉아 있을 수 없었다.",
                6: "피곤하고 기운이 없었다",
                7: "내가 잘못했거나 실패했다는 생각이 들었다/혹은 자신과 가족을 실망시켰다고 생각했다.",
                8: "신문을 읽거나 TV를 보는 것과 같은 일상적인 일에도 집중하기 어려웠다.",
                9: "차라리 죽는 것이 더 낫겠다고 생각했다/혹은 자해할 생각을 했다"
            };
            const GAD7_TEXTS = {
                1: "초조하거나 불안하거나 조마조마하게 느낀다.",
                2: "걱정하는 것을 멈추거나 조절할 수가 없다.",
                3: "여러 가지 것들에 대해 걱정을 너무 많이 한다.",
                4: "편하게 있기가 어렵다.",
                5: "쉽게 짜증이 나거나 쉽게 성을 내게 된다.",
                6: "너무 안절부절못해서 가만히 있기가 힘들다.",
                7: "마치 끔찍한 일이 생길 것처럼 두렵게 느껴진다."
            };
            const resolvePhq9Text = (num) => {
                try {
                    if (typeof getPhq9ItemText === 'function') return getPhq9ItemText(num);
                } catch (_) {}
                return PHQ9_TEXTS[num] || `항목 ${num}`;
            };
            const resolveGad7Text = (num) => {
                try {
                    if (typeof getGad7ItemText === 'function') return getGad7ItemText(num);
                } catch (_) {}
                return GAD7_TEXTS[num] || `항목 ${num}`;
            };
            
            // 공통: items 정규화 유틸 (배열/객체/누락 모두 허용 → 1..count 키 객체)
            const normalizeItems = (items, count) => {
                const result = {};
                if (items) {
                    if (Array.isArray(items)) {
                        for (let i = 0; i < items.length; i++) result[String(i+1)] = Number(items[i]) || 0;
                    } else if (typeof items === 'object') {
                        Object.keys(items).forEach(k => { result[String(k)] = Number(items[k]) || 0; });
                    }
                }
                if (count) {
                    for (let i = 1; i <= count; i++) if (result[String(i)] == null) result[String(i)] = 0;
                }
                return result;
            };

            // PHQ-9 최고점 문항 추출 (0점 제외) - 배열/객체/로컬백업 모두 처리
            let phq9HighScores = [];
            {
                let sourceItems = phq9Data.items;
                if (!sourceItems) {
                    // 백업: 과거 저장 형태 배열(localStorage: phq9_responses)
                    try {
                        const legacy = JSON.parse(localStorage.getItem('phq9_responses') || 'null');
                        if (Array.isArray(legacy) && legacy.length) {
                            const temp = {};
                            for (let i = 0; i < 9; i++) temp[String(i+1)] = Number(legacy[i]) || 0;
                            sourceItems = temp;
                        }
                    } catch(_) {}
                }
                const norm = normalizeItems(sourceItems, 9);
                phq9HighScores = Object.entries(norm)
                    .map(([n, s]) => ({ score: Number(s), itemNum: Number(n), text: resolvePhq9Text(Number(n)) }))
                    .filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score);
            }
            
            // GAD-7 최고점 문항 추출 (0점 제외) - 배열과 객체 모두 처리
            let gad7HighScores = [];
            if (gad7Data.items) {
                if (Array.isArray(gad7Data.items)) {
                    // 배열 형태인 경우
                    gad7HighScores = gad7Data.items
                        .map((score, index) => ({ score: Number(score), itemNum: index + 1, text: resolveGad7Text(index + 1) }))
                        .filter(item => item.score > 0)
                        .sort((a, b) => b.score - a.score);
                } else if (typeof gad7Data.items === 'object') {
                    // 객체 형태인 경우 (예: {1: 3, 2: 3, 3: 0, ...})
                    gad7HighScores = Object.entries(gad7Data.items)
                        .map(([itemNum, score]) => ({ 
                            score: Number(score), 
                            itemNum: parseInt(itemNum), 
                            text: resolveGad7Text(parseInt(itemNum)) 
                        }))
                        .filter(item => item.score > 0)
                        .sort((a, b) => b.score - a.score);
                }
            }
            
            // 표 생성
            let tableHTML = '';
            if (phq9HighScores.length > 0 || gad7HighScores.length > 0) {
                tableHTML = `
                    <table style="width:100%; border-collapse:collapse; margin:20px 0; border:1px solid #e5e7eb;">
                        <thead>
                            <tr style="background-color:#f9fafb;">
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:center;">척도</th>
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:left;">문항</th>
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:center;">점수</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // PHQ-9 항목 추가
                phq9HighScores.forEach(item => {
                    tableHTML += `
                        <tr>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; background-color:#f8f9fa;">PHQ-9 (우울)</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:left;">${item.text}</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; font-weight:bold; color:#6f42c1;">${item.score}점</td>
                        </tr>
                    `;
                });
                
                // GAD-7 항목 추가
                gad7HighScores.forEach(item => {
                    tableHTML += `
                        <tr>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; background-color:#f8f9fa;">GAD-7 (불안)</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:left;">${item.text}</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; font-weight:bold; color:#dc3545;">${item.score}점</td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
            } else {
                tableHTML = '<div style="text-align:center; color:#6c757d; padding:20px;">검사 결과가 없습니다.</div>';
            }
            
            container.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">PHQ-9과 GAD-7 최고점 문항</h1>
                        <div style="margin:20px 0;">
                            <p style="font-size:1.1em; color:#6b7280; margin-bottom:20px;">
                                아래는 각 척도에서 0점이 아닌 문항들을 점수 순으로 정리한 표입니다.
                            </p>
                            ${tableHTML}
                        </div>
                        
                        <div class="demo-section" style="margin-top:20px;">
                            <h4>지난 2주 간 어떤 일 때문에 위와 같은 점수를 부여하셨나요?</h4>
                            <textarea id="situationAnalysis" 
                                style="width:100%; min-height:120px; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; resize:vertical;"
                                placeholder="지난 2주간 겪었던 상황이나 일들을 자세히 설명해주세요..."></textarea>
                        </div>
                        
                        <div class="gad7-btns" style="margin-top:20px;">
                            <button id="saveSituationBtn" class="gad7-btn gad7-primary">저장</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 저장 버튼 이벤트 리스너 추가
            const saveBtn = document.getElementById('saveSituationBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const situationText = document.getElementById('situationAnalysis').value.trim();
                    if (situationText) {
                        // 상황 분석 텍스트 저장
                        const analysisData = {
                            timestamp: Date.now(),
                            situation: situationText,
                            phq9Score: phq9Data.score || 0,
                            gad7Score: gad7Data.score || 0
                        };
                        
                        sessionStorage.setItem('situation_analysis', JSON.stringify(analysisData));
                        localStorage.setItem('situation_analysis', JSON.stringify(analysisData));
                        
                        alert('상황 분석이 저장되었습니다.');
                    } else {
                        alert('상황을 입력해주세요.');
                    }
                });
            }
        }
        
        // 시나리오 역할극 초기화 및 로직 (3475 라인부터 적용)
        function initScenarioChatbot() {
            const chatbox = document.getElementById("chatbox");
            const startBtn = document.getElementById("startBtn");
            const sendBtn = document.getElementById("sendBtn");
            const endBtn = document.getElementById("endBtn");
            const userInput = document.getElementById("userInput");
            const scenarioPreview = document.getElementById("scenarioPreview");

            let scenarioContext = "";
            let conversationStep = 0;
            let chatHistory = [];
            let awaitingSituation = false;
            let selectedEmotionLabel = "";
            let selectedEmotionCategory = "";
            let awaitingAutoThought = false;
            let awaitingRationalResponse = false;
            let awaitingFutureScenario = false;
            let autoThoughtText = "";
            let rationalResponseText = "";
            let futureScenarioText = "";
            let scenarioModeActive = false;

            // 챗봇 컨텍스트 프롬프트 정의 (윤리강령이 1순위로 적용)
            const contextPrompt = `
너는 심리상담 보조 챗봇 "회복의 씨앗"이야.
사용자가 "검은 파도" 역할로 부정적인 생각을 말하면,
너는 "회복의 씨앗"으로서 반드시 소크라테스식 질문을 활용해 응답해야 해.

소크라테스식 질문이란:
- "그렇게 믿게 된 구체적인 이유가 있나요?"
- "그게 항상 사실인가요, 아니면 이번만 그런가요?"
- "비슷한 상황에서 다른 결과가 나온 적은 없었나요?"
- "만약 친구가 같은 말을 했다면 뭐라고 조언해주고 싶나요?"
처럼, 사용자가 스스로 자신의 생각의 근거를 검토하도록 유도하는 질문 방식이야.

대화 규칙:
1. 먼저 사용자의 감정을 공감해줘.
2. 이어서 반드시 위와 같은 **소크라테스식 질문 패턴 중 하나**를 적용해.
3. 가능하다면 사용자가 말한 긍정적인 면이나 깨달음을 연결해 맞춤 피드백을 해줘.
4. 답변은 1~3문장 이내로 간결하게.
5. PHQ-9(우울)과 GAD-7(불안) 각 설문에서 "최고점"에 해당하는 문항만 표로 요약해 보여줘.
   표 열 구성: "척도", "문항", "점수". 각 척도에서 최고점 문항만 포함해.
   표가 생성된 뒤 챗봇은 다음 질문을 이어서 해:
   "표의 점수는 사용자님께서 매기신 우울 척도와 불안 척도의 최고점에 해당하는 문항이에요. 지난 2주간 어떤 일 때문에 위와 같은 점수를 부여하셨나요?"
6. 사용자가 '종료'를 선택하면, 지금까지 오간 대화를 "대화 스크립트" 형태로 정리해줘.
   이때 **아무것도 추가하지 말고 오로지 오간 대화만** 있어야 해.
`;

            function addMessage(sender, message) {
                const div = document.createElement("div");
                div.className = sender;
                if (scenarioModeActive) {
                    // 시나리오 형식: 화자, (톤/행동), “대사”
                    const speaker = sender === "bot" ? "챗봇" : "나";
                    const parenthetical = sender === "bot" ? "(차분하게)" : "";
                    const dialogue = `“${message}”`;
                    div.style.margin = "8px 0";
                    div.style.whiteSpace = "pre-wrap";
                    div.innerHTML = `${speaker}<br>${parenthetical}<br>${dialogue}`;
                } else {
                    div.innerHTML = `${sender === "bot" ? "챗봇" : "나"}: ${message}`;
                }
                if (chatbox) {
                    chatbox.appendChild(div);
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
                chatHistory.push({ sender, message });
            }

            async function callGeminiAPI(userMessage) {
                try {
                    // 윤리적 가이드라인 우선 검증 (1순위)
                    const ethicalCheck = validatePrivacyAndEthics(userMessage);
                    if (ethicalCheck.requiresAttention) {
                        return ethicalCheck.message;
                    }

                    // 위험도 평가
                    const riskAssessment = assessRisk(userMessage);
                    if (riskAssessment.level === 'high') {
                        return getSafetyMessage(riskAssessment.type);
                    }

                    // Gemini API 호출
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            context: contextPrompt,
                            chatHistory: chatHistory.slice(-10) // 최근 10개 메시지만 전송
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API 호출 실패: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.response || "죄송합니다. 응답을 생성할 수 없습니다.";

                } catch (error) {
                    console.error('Gemini API 호출 오류:', error);
                    return "죄송합니다. 일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요.";
                }
            }

            // 윤리적 가이드라인 검증 함수
            function validatePrivacyAndEthics(message) {
                const sensitivePatterns = [
                    /자해|자살|죽고\s*싶|끝내고\s*싶/gi,
                    /폭력|살인|범죄/gi,
                    /개인정보|전화번호|주민번호|주소/gi
                ];

                for (const pattern of sensitivePatterns) {
                    if (pattern.test(message)) {
                        return {
                            requiresAttention: true,
                            message: "이런 심각한 내용에 대해서는 전문가와 상담하시는 것이 좋겠습니다. 24시간 상담전화 1393 또는 1588-9191로 연락해주세요."
                        };
                    }
                }

                return { requiresAttention: false };
            }

            // 위험도 평가 함수
            function assessRisk(message) {
                const text = message.toLowerCase();
                
                if (/자해|자살|죽고\s*싶|끝내고\s*싶/.test(text)) {
                    return { level: 'high', type: 'suicide' };
                }
                if (/폭력|살인|범죄/.test(text)) {
                    return { level: 'high', type: 'violence' };
                }
                if (/극단적|절망|희망\s*없|답\s*없/.test(text)) {
                    return { level: 'medium', type: 'despair' };
                }
                
                return { level: 'low', type: 'normal' };
            }

            // 안전 메시지 생성 함수
            function getSafetyMessage(type) {
                const messages = {
                    suicide: "지금 이 순간이 정말 힘드시겠어요. 하지만 당신의 생명은 소중합니다. 지금 당장 24시간 상담전화 1393 또는 1588-9191로 연락해주세요. 전문가들이 당신을 도와드릴 것입니다.",
                    violence: "이런 감정을 느끼는 것입니다. 하지만 폭력은 해결책이 아닙니다. 전문가와 상담하여 더 나은 해결책을 찾아보세요.",
                    despair: "지금은 정말 어려운 시기인 것 같아요. 하지만 이 상황은 영원하지 않습니다. 전문가와 상담하여 도움을 받아보세요."
                };
                return messages[type] || "전문가와 상담하시는 것을 권장합니다.";
            }

            // 대화 요약 생성 함수
            function generateConversationSummary() {
                let summary = "🎯 오늘의 대화 요약\n\n";
                
                if (scenarioContext) {
                    summary += `📝 주요 상황: ${scenarioContext}\n\n`;
                }
                
                if (chatHistory.length > 0) {
                    summary += "💬 대화 내용:\n";
                    chatHistory.forEach((msg, index) => {
                        if (msg.sender === 'user') {
                            summary += `- 나: ${msg.message}\n`;
                        } else if (msg.sender === 'bot') {
                            // HTML 태그 제거하고 순수 텍스트만 추출
                            const cleanMessage = msg.message.replace(/<[^>]*>/g, '').trim();
                            if (cleanMessage) {
                                summary += `- 챗봇: ${cleanMessage}\n`;
                            }
                        }
                    });
                }
                
                summary += "\n✨ 오늘도 당신의 회복을 위한 한 걸음을 내딛으셨습니다. 내일도 힘내세요!";
                
                return summary;
            }

            function analyzeTextSimple(text) {
                const t = (text || '').toLowerCase();
                const hits = {
                    angry: ['화', '짜증', '분노', '열받', '빡', '성남'],
                    sad: ['슬프', '우울', '서러', '눈물', '서글프', '상실'],
                    anxious: ['불안', '걱정', '초조', '두렵', '긴장'],
                    hurt: ['상처', '억울', '배신', '모욕', '괴롭'],
                    embarrassed: ['당황', '머쓱', '창피', '부끄'],
                    happy: ['기쁨', '행복', '좋았', '설렘', '뿌듯']
                };
                let maxCat = '';
                let maxCount = 0;
                Object.entries(hits).forEach(([cat, words]) => {
                    const count = words.reduce((acc, w) => acc + (t.includes(w) ? 1 : 0), 0);
                    if (count > maxCount) { maxCount = count; maxCat = cat; }
                });
                return { dominant: maxCat, score: maxCount };
            }

            startBtn && startBtn.addEventListener("click", () => {
                conversationStep = 0;
                chatHistory = [];
                awaitingSituation = false;

                chatbox.innerHTML = "";
                // 초기 안내 메시지 제거: 패널 표시와 동시에 자동 질의
                const panel = document.getElementById('emotionPanel');
                if (panel) panel.style.display = 'block';
                displaySymptomItems();
                // 패널 표시 직후 자동으로 최고점 문항에 대해 질문
                askHighestSymptomQuestion();
                // 상황 질문 대기 상태로 설정
                awaitingSituation = true;

                userInput.disabled = false;
                sendBtn.disabled = false;
                endBtn.disabled = false;
            });

            sendBtn && sendBtn.addEventListener("click", async () => {
                const message = userInput.value.trim();
                if (!message) return;

                addMessage("user", message);
                    userInput.value = "";

                if (awaitingSituation) {
                    // 유저가 어절(단어) 단위로 응답했는지 확인 후 폼 UI 적용
                    const tokens = message.split(/\s+/).filter(Boolean);
                    
                    // 의미 있는 단어만 필터링 (한국어, 영어, 숫자, 특수문자 조합 제외)
                    const meaningfulTokens = tokens.filter(token => {
                        // 2글자 미만은 제외
                        if (token.length < 2) return false;
                        
                        // 한글이나 영어가 포함된 단어만 허용
                        const hasKorean = /[가-힣]/.test(token);
                        const hasEnglish = /[a-zA-Z]/.test(token);
                        const hasNumber = /\d/.test(token);
                        
                        // 한글이나 영어가 포함되어야 하며, 숫자만으로는 안됨
                        return (hasKorean || hasEnglish) && !(hasNumber && !hasKorean && !hasEnglish);
                    });
                    
                    if (meaningfulTokens.length === 0) {
                        addMessage('bot', '의미 있는 단어를 입력해주세요. 예: "회사에서 상사가 나를 무시했다" (한글, 영어 단어만 인정됩니다)');
                        return;
                    }

                    // 의미 있는 토큰만 사용하여 시나리오 컨텍스트 설정
                    scenarioContext = meaningfulTokens.join(' ');

     

                    // 상태 전환하여 contextPrompt 기반 대화 시작
                    awaitingSituation = false;
                    scenarioModeActive = true;
                    
                    // 챗봇이 첫 응답을 생성하도록 API 호출
                    const firstResponse = await callGeminiAPI(`사용자가 "${scenarioContext}"라는 상황에 대해 이야기하고 있습니다. 이 상황에 대해 공감적이고 소크라틱한 질문으로 대화를 시작해주세요.`);
                    if (firstResponse) {
                        addMessage("bot", firstResponse);
                    }
                    return;
                }

                // '종료' 명령 처리
                if (message === '종료') {
                    const summary = generateConversationSummary();
                    addMessage("bot", summary);
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    endBtn.disabled = true;
                    return;
                }

                // 이후 단계는 일단 중단 (감정 → 상황까지)

                // 그 외 일반 대화
                conversationStep++;

                const reply = await callGeminiAPI(message);
                if (reply) {
                    addMessage("bot", reply);
                }
            });

                        // PHQ-9과 GAD-7 결과 기반 증상 항목 표시 및 상황 분석
            function displaySymptomItems() {
                const symptomItems = document.getElementById('symptomItems');
                if (!symptomItems) return;

                // PHQ-9과 GAD-7 데이터 가져오기
                const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');

                let html = '';

                // GAD-7 항목 (점수 높은 순으로 정렬)
                if (gad7Data.items && Object.keys(gad7Data.items).length > 0) {
                    const sortedGad7 = Object.entries(gad7Data.items)
                        .filter(([_, score]) => score > 0)
                        .sort(([_, a], [__, b]) => b - a); // 높은 점수 순

                    if (sortedGad7.length > 0) {
                        html += '<div style="margin-bottom:16px;"><h4 style="color:#dc3545; margin:0 0 8px 0;">😰 불안 증상 (GAD-7)</h4>';
                        sortedGad7.forEach(([itemNum, score]) => {
                            const itemText = getGad7ItemText(itemNum);
                            html += `<div style="padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border-left:4px solid #dc3545;">
                                <strong>${itemText}</strong><br>
                                <small style="color:#6c757d;">점수: ${score}/3</small>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }

                // PHQ-9 항목 (점수 높은 순으로 정렬)
                if (phq9Data.items && Object.keys(phq9Data.items).length > 0) {
                    const sortedPhq9 = Object.entries(phq9Data.items)
                        .filter(([_, score]) => score > 0)
                        .sort(([_, a], [__, b]) => b - a); // 높은 점수 순

                    if (sortedPhq9.length > 0) {
                        html += '<div style="margin-bottom:16px;"><h4 style="color:#6f42c1; margin:0 0 8px 0;">😔 우울 증상 (PHQ-9)</h4>';
                        sortedPhq9.forEach(([itemNum, score]) => {
                            const itemText = getPhq9ItemText(itemNum);
                            html += `<div style="padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border-left:4px solid #6f42c1;">
                                <strong>${itemText}</strong><br>
                                <small style="color:#6c757d;">점수: ${score}/3</small>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }

                if (html === '') {
                    html = '<div style="text-align:center; color:#6c757d; padding:20px;">검사 결과가 없습니다. 먼저 PHQ-9과 GAD-7 검사를 완료해주세요.</div>';
                }

                symptomItems.innerHTML = html;
            }

            // PHQ-9 항목 텍스트 반환
            function getPhq9ItemText(itemNum) {
                const items = {
                    1: "기분이 가라앉거나, 우울하거나, 희망이 없다고 느꼈다.",
                    2: "평소에 아무렇지 않게 하던 일에 흥미가 없어지거나 즐거움을 느끼지 못했다",
                    3: "잠들기 어렵거나 자주 깼다/혹은 너무 많이 잤다.",
                    4: "평소보다 식욕이 줄었다/혹은 평소보다 많이 먹었다",
                    5: "다른 사람들이 눈치 챌 정도로 평소보다 말과 행동이 느려졌다/혹은 너무 안절부절 못 해서 가만히 앉아 있을 수 없었다.",
                    6: "피곤하고 기운이 없었다",
                    7: "내가 잘못했거나 실패했다는 생각이 들었다/혹은 자신과 가족을 실망시켰다고 생각했다.",
                    8: "신문을 읽거나 TV를 보는 것과 같은 일상적인 일에도 집중하기 어려웠다.",
                    9: "차라리 죽는 것이 더 낫겠다고 생각했다/혹은 자해할 생각을 했다"
                };
                return items[itemNum] || `항목 ${itemNum}`;
            }

            // GAD-7 항목 텍스트 반환
            function getGad7ItemText(itemNum) {
                const items = {
                    1: "초조하거나 불안하거나 조마조마하게 느낀다.",
                    2: "걱정하는 것을 멈추거나 조절할 수가 없다.",
                    3: "여러 가지 것들에 대해 걱정을 너무 많이 한다.",
                    4: "편하게 있기가 어렵다.",
                    5: "쉽게 짜증이 나거나 쉽게 성을 내게 된다.",
                    6: "너무 안절부절못해서 가만히 있기가 힘들다.",
                    7: "마치 끔찍한 일이 생길 것처럼 두렵게 느껴진다."
                };
                return items[itemNum] || `항목 ${itemNum}`;
            }

            // 상황 분석 시작 버튼 클릭 처리
            // 최고점 문항 자동 질문 함수 (버튼 없이 즉시 실행)
            function askHighestSymptomQuestion() {
                    const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                    const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');

                    // items 정규화: 배열/객체/문자점수 모두 허용, 1-base 키로 변환
                    const normalizeItems = (items, count) => {
                        const result = {};
                        if (!items) return result;
                        if (Array.isArray(items)) {
                            for (let i = 0; i < items.length; i++) {
                                result[String(i+1)] = Number(items[i]) || 0;
                            }
                        } else if (typeof items === 'object') {
                            Object.keys(items).forEach(k => {
                                result[String(k)] = Number(items[k]) || 0;
                            });
                        }
                        // 보장: 없는 키는 0으로 채움 (옵션)
                        if (count) {
                            for (let i = 1; i <= count; i++) {
                                if (result[String(i)] == null) result[String(i)] = 0;
                            }
                        }
                        return result;
                    };

                    // PHQ-9 최고점 문항 추출
                    let phqMax = null;
                    let phqTop = [];
                    if (phq9Data.items || localStorage.getItem('phq9_responses')) {
                        // phq9_data.items 우선, 없으면 phq9_responses 배열 사용
                        let sourceItems = phq9Data.items;
                        if (!sourceItems) {
                            try {
                                const resp = JSON.parse(localStorage.getItem('phq9_responses') || '[]');
                                const temp = {};
                                for (let i = 0; i < 9; i++) temp[String(i+1)] = Number(resp[i]) || 0;
                                sourceItems = temp;
                            } catch (_) {}
                        }
                        const norm = normalizeItems(sourceItems, 9);
                        const entries = Object.entries(norm)
                            .filter(([_, s]) => Number(s) > 0);
                        if (entries.length > 0) {
                            const maxScore = Math.max(...entries.map(([_, s]) => Number(s)));
                            phqTop = entries
                                .filter(([_, s]) => Number(s) === maxScore)
                                .map(([n, s]) => ({ type: 'PHQ-9', itemNum: n, score: Number(s), text: getPhq9ItemText(n) }));
                        }
                    }

                    // GAD-7 최고점 문항 추출
                    let gadTop = [];
                    if (gad7Data.items) {
                        const norm = normalizeItems(gad7Data.items, 7);
                        const entries = Object.entries(norm)
                            .filter(([_, s]) => Number(s) > 0);
                        if (entries.length > 0) {
                            const maxScore = Math.max(...entries.map(([_, s]) => Number(s)));
                            gadTop = entries
                                .filter(([_, s]) => Number(s) === maxScore)
                                .map(([n, s]) => ({ type: 'GAD-7', itemNum: n, score: Number(s), text: getGad7ItemText(n) }));
                        }
                    }

                    // 표 생성: 각 척도에서 최고점 문항만 포함
                    const rows = [...phqTop, ...gadTop];
                    if (rows.length > 0) {
                        let tableHtml = '<table style="width:100%; border-collapse:collapse; margin:8px 0;">';
                        tableHtml += '<thead><tr><th style="border:1px solid #ddd; padding:6px; text-align:center;">척도</th><th style="border:1px solid #ddd; padding:6px; text-align:center;">문항</th><th style="border:1px solid #ddd; padding:6px; text-align:center;">점수</th></tr></thead><tbody>';
                        rows.forEach(r => {
                            const scaleLabel = r.type === 'PHQ-9' ? '우울' : (r.type === 'GAD-7' ? '불안' : r.type);
                            tableHtml += `<tr><td style=\"border:1px solid #ddd; padding:6px; text-align:center;\">${scaleLabel}</td><td style=\"border:1px solid #ddd; padding:6px;\">${r.text}</td><td style=\"border:1px solid #ddd; padding:6px; text-align:center;\">${r.score}</td></tr>`;
                        });
                        tableHtml += '</tbody></table>';
                        addMessage('bot', tableHtml);
                    }
                    // 고정 질문 (지시문 업데이트)
                    addMessage('bot', '표의 점수는 사용자님께서 매기신 우울 척도와 불안 척도의 최고점에 해당하는 문항이에요. 지난 2주간 어떤 일 때문에 위와 같은 점수를 부여하셨나요?');
                    
                    const panel = document.getElementById('emotionPanel');
                    if (panel) panel.style.display = 'none';
                }

            // 감정 버튼 로직 제거 (PHQ-9/GAD-7 기반으로 대체)

            endBtn && endBtn.addEventListener("click", () => {
                userInput.disabled = true;
                sendBtn.disabled = true;
                endBtn.disabled = true;

                let script = "🎬 시나리오 완성본\n\n";
                script += `상황: ${scenarioContext}\n\n`;
                chatHistory.forEach((msg) => {
                    const raw = String(msg && msg.message ? msg.message : '');
                    // 화면에서는 표를 보여주되, 완성본에는 표(HTML) 대사를 포함하지 않음
                    if (raw.toLowerCase().includes('<table')) {
                        return; // skip HTML table summaries in export
                    }
                    const speaker = msg.sender === "bot" ? "챗봇" : "나";
                    const parenthetical = msg.sender === "bot" ? "(차분하게)" : "";
                    const dialogue = `“${raw}”`;
                    script += `${speaker}\n${parenthetical}\n${dialogue}\n`;
                });

                // generateConversationSummary 함수를 사용하여 대화 요약 생성
                const summary = generateConversationSummary();
                addMessage("bot", summary);
            });

            function buildScenarioScript(contextText) {
                const emotion = selectedEmotionLabel ? selectedEmotionLabel.replace(/\n/g, ' / ') : '';
                const emotionKo = selectedEmotionLabel ? (selectedEmotionLabel.split('\n')[1] || selectedEmotionLabel) : '그 감정';
                function getObjectParticle(word) {
                    if (!word || typeof word !== 'string') return '을/를';
                    const lastChar = word.trim().slice(-1);
                    const code = lastChar.charCodeAt(0);
                    // Hangul syllable range
                    if (code < 0xAC00 || code > 0xD7A3) return '을/를';
                    const jong = (code - 0xAC00) % 28;
                    return jong === 0 ? '를' : '을';
                }
                const objParticle = getObjectParticle(emotionKo);
                function inferScene(text) {
                    const t = (text || '').toLowerCase();
                    let place = '장소 미상';
                    let isExt = false;
                    if (t.includes('지하철') || t.includes('subway')) place = '지하철';
                    else if (t.includes('회의') || t.includes('사무실') || t.includes('office') || t.includes('meeting')) place = '회의실';
                    else if (t.includes('집') || t.includes('home')) place = '집';
                    else if (t.includes('학교') || t.includes('school')) place = '학교';
                    else if (t.includes('병원') || t.includes('hospital')) place = '병원';
                    else if (t.includes('카페') || t.includes('cafe') || t.includes('coffee')) place = '카페';
                    else if (t.includes('버스') || t.includes('bus')) place = '버스';
                    else if (t.includes('거리') || t.includes('road') || t.includes('street')) { place = '거리'; isExt = true; }
                    else if (t.includes('공원') || t.includes('park')) { place = '공원'; isExt = true; }
                    // 외부 단서
                    if (t.includes('밖') || t.includes('야외')) isExt = true;
                    // 시간대 추정
                    let timeLabel = 'DAY';
                    if (t.includes('밤') || t.includes('야밤') || t.includes('저녁') || t.includes('night') || t.includes('evening')) timeLabel = 'NIGHT';
                    else if (t.includes('새벽') || t.includes('dawn')) timeLabel = 'DAWN';
                    else if (t.includes('아침') || t.includes('morning')) timeLabel = 'MORNING';
                    return { slug: `${isExt ? 'EXT.' : 'INT.'} ${place} - ${timeLabel}` };
                }
                const scene = inferScene(contextText);
                const now = new Date();
                const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
                return (
`${scene.slug} (${dateStr})

나
(현재 감정: ${emotion || '미상'})
“${contextText}”
`
                );
            }
        }
        
        // GAD-7 불안증상 검사 함수
        function renderGAD7Screening() {
            console.log('renderGAD7Screening 함수 시작');
            
            // 기존 PHQ-9 검사가 있다면 제거
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('기존 PHQ-9 검사 제거');
                existingScreening.remove();
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'gad7-screening';
            console.log('GAD-7 검사 div 생성됨');
            
            screeningDiv.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">2단계: 불안증상 검사 (GAD-7)</h1>
                        <div class="gad7-sub">
                            지난 2주일 동안 당신은 다음의 문제들로 인해서 얼마나 자주 방해를 받았습니까?<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                📋 <a href="https://nct.go.kr/distMental/rating/rating02_3.do" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    GAD-7 한국판 표준지침 (국립정신건강센터-국가트라우마센터)
                                </a> ↗
                            </small>
                        </div>
                        
                        <div class="phq9-grid" id="gad7Grid"></div>
                        
                        <div class="phq9-result" id="gad7Result" style="display: none;">
                            <div class="phq9-score">총점: <span id="gad7Total">0</span> / 21 <span id="gad7SevTag" class="phq9-sev none">불안 아님 (0–4)</span></div>
                            <div id="gad7Advice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns">
                                <button id="gad7StartBtn" class="phq9-btn phq9-primary">프로그램 시작하기</button>
                                <button id="gad7BackBtn" class="phq9-btn phq9-ghost">PHQ-9 결과로 돌아가기</button>
                            </div>
                        </div>
                        
                        <div class="phq9-progress" id="gad7Progress">
                            <div class="phq9-btns">
                                <button id="gad7CalcBtn" class="phq9-btn phq9-primary" disabled>결과 확인하기</button>
                                <button id="gad7BackBtn2" class="phq9-btn phq9-ghost">PHQ-9 결과로 돌아가기</button>
                            </div>
                            <div class="phq9-note" style="margin-top: 8px;">
                                완료된 문항: <span id="gad7CompletedCount">0</span> / 7
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * 이 설문은 참고용입니다. 점수가 높으면, 위험 신호일 수 있으니 지역 정신건강 전문기관에 꼭 상의하세요.
                        </div>
                    </div>
                </div>
            `;
            
            console.log('GAD-7 검사 화면 DOM에 추가');
            // 기존 컨테이너 숨기기
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
                console.log('기존 컨테이너 숨김');
            }
            
            console.log('DOM에 GAD-7 검사 추가 시도...');
            document.body.appendChild(screeningDiv);
            console.log('GAD-7 검사 화면 DOM에 추가됨');
            
            // GAD-7 검사가 실제로 표시되는지 확인
            const addedScreening = document.querySelector('.gad7-screening');
            if (addedScreening) {
                console.log('GAD-7 검사 요소가 DOM에 성공적으로 추가됨');
                console.log('initGAD7 함수 호출');
            initGAD7();
            } else {
                console.error('GAD-7 검사 요소를 찾을 수 없음!');
                alert('GAD-7 검사 화면을 불러올 수 없습니다. 페이지를 새로고침해주세요.');
            }
        }


        
        // PHQ-9 결과 화면으로 돌아가기 함수
        function showPHQ9Results() {
            const phq9Container = document.querySelector('.phq9-screening');
            if (!phq9Container) return;
            
            // PHQ-9 결과 화면 복원
            phq9Container.innerHTML = `
                <div class="phq9-result" style="text-align: center; padding: 2em;">
                    <h1 class="phq9-title">PHQ-9 검사 결과</h1>
                    <div class="phq9-score" style="margin: 2em 0;">
                        <div style="font-size: 3em; font-weight: bold; color: #3498db;" id="totalScore">0</div>
                        <div style="font-size: 1.2em; color: #7f8c8d;">총점</div>
                    </div>
                    <div class="phq9-severity" style="margin: 2em 0;">
                        <span id="severityTag" class="phq9-sev phq9-sev-ok">정상</span>
                    </div>
                    <div class="phq9-advice" id="advice" style="margin: 2em 0; padding: 1em; background: #f8f9fa; border-radius: 8px;">
                        <!-- 조언 내용이 여기에 표시됩니다 -->
                    </div>
                    <button id="startBtn" style="background:#3498db;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;">프로그램 시작</button>
                </div>
            `;
            // PHQ-9 결과 데이터 복원
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            if (phq9Data.score !== undefined) {
                const totalScore = document.getElementById('totalScore');
                const severityTag = document.getElementById('severityTag');
                const advice = document.getElementById('advice');
                const startBtn = document.getElementById('startBtn');
                
                totalScore.textContent = phq9Data.score;
                // 문항별 점수가 없다면 기본 items를 0으로 채움 (1–9)
                if (!phq9Data.items) {
                    const items = {};
                    for (let i=1;i<=9;i++) items[String(i)] = 0;
                    phq9Data.items = items;
                    sessionStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                    localStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                }
                
                // 심각도에 따른 조언 복원
                // 심각도에 따른 조언 복원 (가벼운 우울군은 불안증상 검사로 진행)
                if (phq9Data.score <= 14 && ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) === 0) {
                    // 0–14점이며 9번 문항 0점: 불안증상 검사로 진행
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = '불안증상 검사 진행';
                    
                    advice.innerHTML = '<strong>💡 다음 단계:</strong> 해당 점수는 <b>0–14점</b> 범위이며, <b>9번 문항이 0점</b>입니다. <br><br><strong>이제 불안증상 검사(GAD-7)를 진행할 수 있습니다.</strong>';
                    advice.className = 'phq9-note phq9-info';
                    
                    // 불안증상 검사 진행 버튼만 표시
            } else {
                    // 다른 점수 범위는 프로그램 체험 불가
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = '프로그램 체험 불가';
                    
                    if (phq9Data.score <= 4) {
                        advice.innerHTML = '현재 점수는 <b>정상(0–4)</b> 범위입니다. 필요 시 추후 다시 체크하거나, 생활 리듬 관리를 유지해 주세요.';
                    } else if (phq9Data.score >= 20) {
                        advice.innerHTML = '현재 점수는 <b>20점 이상</b>으로 심각한 우울 증상이 나타나고 있습니다. 즉시 전문가의 평가와 도움을 권합니다.';
                    } else if (phq9Data.score >= 15 && phq9Data.score <= 19) {
                        advice.innerHTML = '현재 점수는 <b>15점 이상</b>으로 불안증상 검사로 진행할 수 없습니다. 전문가 상담을 권합니다.';
                    } else { // 10-14
                        advice.innerHTML = '현재 점수는 <b>0–14점</b> 범위이지만 9번 문항에 점수가 있어 안전상 불안증상 검사로 진행할 수 없습니다.';
                    }
                    advice.className = 'phq9-note phq9-warn';
                }
            }
        }

        // DOMContentLoaded에서 intro 먼저 띄우기
        document.addEventListener('DOMContentLoaded', function() {
            // 안내사항 보기 버튼 동작
            const showIntroBtn = document.getElementById('showIntroBtn');
            if (showIntroBtn) {
                showIntroBtn.addEventListener('click', function() {
                    showIntro = true;
                    renderIntro();
                });
            }

            // 참고문헌 토글
            const toggleRefsBtn = document.getElementById('toggleRefsBtn');
            const referencesPanel = document.getElementById('referencesPanel');
            if (toggleRefsBtn && referencesPanel) {
                toggleRefsBtn.addEventListener('click', function() {
                    const isHidden = referencesPanel.style.display === 'none' || referencesPanel.style.display === '';
                    referencesPanel.style.display = isHidden ? 'block' : 'none';
                    toggleRefsBtn.textContent = isHidden ? '참고문헌 숨기기' : '참고문헌 보기';
                });
            }
            
            // PHQ-9 결과 화면이 표시 중인지 확인 (더 안전한 체크)
            const phq9Screening = document.querySelector('.phq9-screening');
            if (isShowingPHQ9Results || phq9Screening) {
                console.log('PHQ-9 결과 화면이 표시 중이므로 renderIntro 호출하지 않음');
                console.log('isShowingPHQ9Results:', isShowingPHQ9Results, 'phq9Screening 존재:', !!phq9Screening);
                // PHQ-9 결과 화면이 표시 중이면 renderIntro를 호출하지 않음
            } else if (showIntro) {
                renderIntro();
            } else {
                updateStage();
            }
            loadAllResponses();

            // 입력값 입력 시 즉시 저장
            document.addEventListener('input', function(event) {
                const target = event.target;
                const stepIdx = currentIndex;
                if (target.dataset.fieldIdx !== undefined) {
                    const fieldIdx = parseInt(target.dataset.fieldIdx);
                    responses[stepIdx][fieldIdx] = target.value;
                    saveAllResponses();
                } else if (target.name === 'gender') {
                    responses[0][1] = target.value;
                    saveAllResponses();
                } else if(target.dataset.sceneIdx !== undefined) {
                    const sceneIdx = parseInt(target.dataset.sceneIdx);
                    const key = target.dataset.key;
                    if(responses[2][3][sceneIdx]) {
                        responses[2][3][sceneIdx][key] = target.value;
                        saveAllResponses();
                    }
                }
            });
            
            // 프로그램 이름 클릭 시 설명 토글
            const programTitle = document.getElementById('programTitle');
            const programDesc = document.getElementById('programDesc');
            if (programTitle && programDesc) {
                programTitle.addEventListener('click', function() {
                    if (programDesc.style.display === 'none') {
                        programDesc.style.display = 'block';
                } else {
                        programDesc.style.display = 'none';
                    }
                });
            }
        });

        
        // 서비스 안내사항 완료 함수 (우울 검사 시작 버튼 활성화)
        window.completeServiceGuide = function() {
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.style.background = '#3498db';
                startBtn.style.cursor = 'pointer';
                startBtn.textContent = '검사 시작';
                
                // 확인 완료 버튼을 비활성화
                const confirmBtn = event.target;
                confirmBtn.disabled = true;
                confirmBtn.textContent = '확인 완료';
                confirmBtn.style.background = '#6b7280';
                confirmBtn.style.cursor = 'not-allowed';
            }
        };

        // 서비스 안내사항 페이지 표시 함수 (개인정보 보호법 가이드 확인 후)
        window.showServiceGuidePage = function() {
            const introDiv = document.getElementById('introScreen');
            if (introDiv) {
                introDiv.innerHTML = `
                    <!-- 서비스 이용 전 안내사항 페이지 -->
                    <div style="margin-bottom:2em;padding:1.5em;background:#fffbe6;border-radius:12px;border:1.5px solid #ffd700;">
                        <div style="color:#b8860b;font-size:1.1em;margin-bottom:1em;"><b>⚠️ 서비스 이용 전 안내사항</b></div>
                        
                        <div style="color:#333;font-size:1.05em;line-height:1.7;margin-bottom:1.5em;">
                            이 프로그램이 안전하고 의미 있는 자기 탐색의 시간이 될 수 있도록, 몇 가지 중요한 점을 안내해 드립니다.
                        </div>
                        
                        <div style="margin-bottom:1.2em;">
                            <b>프로그램의 역할과 책임</b>
                            <ul style="margin:0.7em 0 0 1.2em;padding:0;list-style:disc;">
                                <li><b>의료적 책임 한계:</b> 본 프로그램은 정신건강의학과 진료나 전문 심리상담과 같은 전문적인 의료 서비스를 대체할 수 없음을 명확히 알려드립니다.</b></li>
                                
                            </ul>
                        </div>
                        
                        
                        
                        <!-- 서비스 안내사항 확인 버튼 -->
                        <div style="text-align:center;margin-top:2em;">
                            <button onclick="completeServiceGuide()" style="background:#22c55e;color:white;font-size:1em;padding:0.7em 1.5em;border-radius:8px;border:none;cursor:pointer;">서비스 안내사항 확인 완료</button>
                        </div>
                    </div>

                    <div style="text-align:center;margin-top:2.5em;">
                        <button id="startBtn" style="background:#6b7280;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;cursor:not-allowed;" disabled>검사 시작</button>
                        <div style="margin-top:1em;color:#666;font-size:0.9em;">
                            ⚠️ 서비스 안내사항을 모두 확인한 후에만 검사를 시작할 수 있습니다.
                        </div>
                    </div>
                `;
                
                // PHQ-9 시작 버튼 이벤트 연결
                document.getElementById('startBtn').onclick = () => {
                    showIntro = false;
                    introDiv.remove();
                    
                    // 우울 검사 시작 버튼을 누르면 무조건 PHQ-9 검사 진행
                    console.log('우울 검사 시작 버튼 클릭됨 - PHQ-9 검사 시작');
                    
                    // 기존 PHQ-9 데이터 삭제하고 새로 검사
                    sessionStorage.removeItem('phq9_data');
                    localStorage.removeItem('phq9_data');
                    localStorage.removeItem('phq9_responses');
                    
                    console.log('기존 PHQ-9 데이터 삭제 완료, PHQ-9 바로 시작');
                    renderPHQ9Screening();
                };
            }
        };
        // 서비스 안내사항 모달 함수 (개인정보 보호법 가이드와 완전 분리)
        window.showServiceGuide = function() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="width: min(720px,92vw); background: #fffbe6; border: 1.5px solid #ffd700; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <h2 style="color: #b8860b; margin: 0;">⚠️ 서비스 이용 전 안내사항</h2>
                        <button onclick="this.closest('.service-modal').remove()" style="background: transparent; border: 1px solid #ffd700; color: #b8860b; padding: 8px 12px; border-radius: 8px; cursor: pointer;">닫기</button>
                    </div>
                    
                    <!-- 분리 안내 -->
                    <div style="background: #fff3cd; border: 1px solid #ffd700; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="color: #b8860b; font-size: 0.95em; font-weight: bold;">📋 정보 분리 안내</div>
                        <div style="color: #856404; font-size: 0.9em; margin-top: 4px;">
                            이 내용은 <b>개인정보 보호법 가이드</b>와 <b>완전히 분리</b>된 <b>서비스 이용 안내사항</b>입니다.
                        </div>
                    </div>
                    
                    <div style="color: #333; font-size: 1.05em; line-height: 1.7; margin-bottom: 1.5em;">
                        이 프로그램이 안전하고 의미 있는 자기 탐색의 시간이 될 수 있도록, 몇 가지 중요한 점을 안내해 드립니다.
                    </div>
                    
                    <div style="margin-bottom: 1.2em;">
                        <b>프로그램의 역할과 책임</b>
                        <ul style="margin: 0.7em 0 0 1.2em; padding: 0; list-style: disc;">
                            <li><b>의료적 책임 한계:</b> 본 프로그램은 <b> 정신건강의학과 진료나 전문 심리상담과 같은 전문 서비스를 대체할 수 없음을 명확히 알려드립니다.</li>
                        </ul>
                    </div>
                    
                    
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('.service-modal').remove()" style="background: #ffd700; color: #333; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold;">확인</button>
                    </div>
                </div>
            `;
            
            modal.className = 'service-modal';
            document.body.appendChild(modal);
            
            // 모달 외부 클릭 시 닫기
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // 상담윤리 위반 시 알림 함수 (1순위 보안)
        window.showEthicsAlert = function(message) {
            // 상담윤리 위반 시 즉시 사용자에게 알림
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc2626;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-weight: bold;
            `;
            alertDiv.innerHTML = `
                <div style="margin-bottom: 10px;">⚠️ 상담윤리 위반 신호</div>
                <div style="font-size: 14px; font-weight: normal;">${message}</div>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; background: white; color: #dc2626; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">확인</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 10초 후 자동 제거
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 10000);
            
            // 콘솔에 상세 로그 기록
            console.error('ETHICS VIOLATION ALERT:', {
                message: message,
                timestamp: new Date().toISOString(),
                action: 'immediate_attention_required',
                priority: 'highest'
            });
        };

        // 디버깅 헬퍼 함수들 (콘솔에서 사용 가능)
        window.checkPHQ9Status = function() {
            const sessionData = sessionStorage.getItem('phq9_data');
            const localData = localStorage.getItem('phq9_data');
            const hybridData = getPHQ9DataFromStorage();
            
            console.log('PHQ-9 하이브리드 상태:', {
                sessionStorage: sessionData ? JSON.parse(sessionData) : null,
                localStorage: localData ? JSON.parse(localData) : null,
                hybridResult: hybridData,
                isCompleted: hybridData !== null
            });
            return hybridData;
        };
        
        window.clearPHQ9Data = function() {
            sessionStorage.removeItem('phq9_data');
            localStorage.removeItem('phq9_data');
            console.log('PHQ-9 하이브리드 데이터가 완전 삭제되었습니다.');
        };
        
        // 인구통계 데이터 확인 함수
        window.checkDemographicsData = function() {
            const sessionData = sessionStorage.getItem('demographics_data');
            const localData = localStorage.getItem('demographics_data');
            
            console.log('인구통계 데이터 상태:', {
                sessionStorage: sessionData ? JSON.parse(sessionData) : null,
                localStorage: localData ? JSON.parse(localData) : null,
                isCompleted: !!(sessionData || localData)
            });
            
            if (sessionData || localData) {
                const data = JSON.parse(sessionData || localData);
                console.log('인구통계 상세 정보:', {
                    성별: ['남성', '여성', '기타'][data.gender] || '미입력',
                    연령: data.age ? `${data.age}세` : '미입력',
                    집단참여: data.groupParticipation === 'yes' ? '참여 희망' : '개인 진행',
                    거주지역: data.region || '해당 없음'
                });
            }
            
            return sessionData || localData;
        };
        
        // 인구통계 데이터 삭제 함수
        window.clearDemographicsData = function() {
            sessionStorage.removeItem('demographics_data');
            localStorage.removeItem('demographics_data');
            console.log('인구통계 데이터가 완전 삭제되었습니다.');
        };

        // 페이지 로드 시 PHQ-9 및 인구통계 상태 자동 체크
        console.log('페이지 로드됨, 상태 체크:');
        if (typeof window.checkPHQ9Status === 'function') {
            window.checkPHQ9Status();
        }
        if (typeof window.checkDemographicsData === 'function') {
            window.checkDemographicsData();
        }

        // GAD-7에서 PHQ-9 결과로 돌아가기 함수
        function showPHQ9ResultsFromGAD7() {
            console.log('GAD-7에서 PHQ-9 결과로 돌아가기');
            
            // PHQ-9 결과 화면이 표시 중임을 표시
            isShowingPHQ9Results = true;
            console.log('isShowingPHQ9Results를 true로 설정함');
            
            // showIntro 플래그를 false로 설정하여 개인정보 보호법 가이드가 나타나지 않도록 함
            showIntro = false;
            console.log('showIntro를 false로 설정함');
            
            // 기존 introScreen이 있다면 제거
            const existingIntroScreen = document.querySelector('.introScreen');
            if (existingIntroScreen) {
                console.log('기존 introScreen 제거됨');
                existingIntroScreen.remove();
            } else {
                console.log('기존 introScreen이 없음');
            }
            
            // PHQ-9 결과 화면 생성
            const phq9ResultDiv = document.createElement('div');
            phq9ResultDiv.className = 'phq9-screening';
            
            // 저장된 PHQ-9 데이터 가져오기
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const phq9Responses = JSON.parse(localStorage.getItem('phq9_responses') || '[]');
            
            phq9ResultDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card">
                        <h1 class="phq9-title">PHQ-9 검사 결과</h1>
                        <div class="phq9-score" style="margin: 2em 0;">
                            <div style="font-size: 3em; font-weight: bold; color: #3498db;" id="totalScore">${phq9Data.score || 0}</div>
                            <div style="font-size: 1.2em; color: #7f8c8d;">총점</div>
                        </div>
                        <div class="phq9-severity" style="margin: 2em 0;">
                            <span id="severityTag" class="phq9-sev phq9-sev-ok">${phq9Data.riskLevel || '정상'}</span>
                        </div>
                        <div class="phq9-advice" id="advice" style="margin: 2em 0; padding: 1em; background: #f8f9fa; border-radius: 8px;">
                            <!-- 조언 내용이 여기에 표시됩니다 -->
                        </div>
                        <div class="phq9-btns">
                            <button id="startBtn" style="background:#3498db;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;">프로그램 체험 시작</button>
                            <button id="backToIntroBtn" style="background:#95a5a6;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;margin-left:10px;">처음으로 돌아가기</button>
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 컨테이너 숨기기
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            // 기존 GAD-7 검사 화면이 있다면 제거
            const existingGAD7 = document.querySelector('.gad7-screening');
            if (existingGAD7) {
                existingGAD7.remove();
            }
            
            // PHQ-9 결과 화면 추가
            document.body.appendChild(phq9ResultDiv);
            
            console.log('PHQ-9 결과 화면이 DOM에 추가됨');
            console.log('showIntro 값:', showIntro);
            
            // PHQ-9 결과 데이터 복원 및 표시
            if (phq9Data.score !== undefined) {
                const advice = document.getElementById('advice');
                const startBtn = document.getElementById('startBtn');
                
                // 심각도에 따른 조언 복원 (가벼운 우울군은 불안증상 검사로 진행)
                if (phq9Data.score <= 14 && ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) === 0) {
                    // 0–14점이며 9번 문항 0점: 불안증상 검사로 진행
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = '불안증상 검사 진행';
                    
                    advice.innerHTML = '<strong>💡 다음 단계:</strong> 해당 점수는 <b>0–14점</b> 범위입니다. <br><br><strong>이제 불안증상 검사(GAD-7)를 진행할 수 있습니다.</strong>';
                    advice.className = 'phq9-note phq9-info';
                } else if (phq9Data.score > 14 || ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) >= 1) {
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>15점 이상</b>이거나, <b>9번 문항에 1점 이상</b>이 있어 불안증상 검사로 진행할 수 없습니다.';
                    advice.className = 'phq9-note phq9-warn';
                } else if (phq9Data.score <= 4) {
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>정상(0–4)</b> 범위입니다. 필요 시 추후 다시 체크하거나, 생활 리듬 관리를 유지해 주세요.';
                    advice.className = 'phq9-note phq9-warn';
                } else if (phq9Data.score >= 20) {
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>20점 이상</b>으로 심각한 우울 증상이 나타나고 있습니다. 즉시 전문가의 평가와 도움을 권합니다.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                } else if (phq9Data.score >= 15 && phq9Data.score <= 19) { // 15–19
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>15점 이상</b>으로 불안증상 검사로 진행할 수 없습니다. 전문가 상담을 권합니다.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                } else { // 10-14
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 시작 불가';
                    advice.innerHTML = '현재 점수는 <b>0–14점</b> 범위이지만 9번 문항에 점수가 있어 안전상 불안증상 검사로 진행할 수 없습니다.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                }
            }
            
            // 프로그램 체험 시작 버튼 이벤트
            const startBtn = document.getElementById('startBtn');
            if (startBtn && !startBtn.disabled) {
                startBtn.addEventListener('click', () => {
                    console.log('불안증상 검사 진행 버튼 클릭');
                    renderGAD7Screening();
                });
            }
            
            // 처음으로 돌아가기 버튼 이벤트
            const backToIntroBtn = document.getElementById('backToIntroBtn');
            if (backToIntroBtn) {
                backToIntroBtn.addEventListener('click', () => {
                    document.querySelector('.phq9-screening').remove();
                    isShowingPHQ9Results = false; // 플래그 리셋
                    renderDemographicsSurvey();
                });
            }
            
            // 함수 완료 후 상태 확인
            console.log('showPHQ9ResultsFromGAD7 함수 완료, 최종 showIntro 값:', showIntro);
            console.log('showPHQ9ResultsFromGAD7 함수 완료, 최종 isShowingPHQ9Results 값:', isShowingPHQ9Results);
            
            // PHQ-9 결과 화면이 제거될 때 플래그를 리셋하는 MutationObserver 추가
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.removedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE && node.classList && node.classList.contains('phq9-screening')) {
                                console.log('PHQ-9 결과 화면이 제거됨, isShowingPHQ9Results 플래그 리셋');
                                isShowingPHQ9Results = false;
                                observer.disconnect();
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, { childList: true });
        }

        // GAD-7 불안증상 검사 함수 (통합)
        function renderGAD7Screening() {
            console.log('GAD-7 검사 화면 렌더링 시작');
            
            // 기존 PHQ-9 검사가 있다면 제거
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('기존 PHQ-9 검사 제거');
                existingScreening.remove();
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'gad7-screening';
            
            screeningDiv.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">2단계: 불안증상 검사 (GAD-7)</h1>
                        <div class="gad7-sub">
                            지난 2주일 동안 당신은 다음의 문제들로 인해서 얼마나 자주 방해를 받았습니까?<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                📋 <a href="https://nct.go.kr/distMental/rating/rating02_3.do" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    GAD-7 한국판 표준지침 (국립정신건강센터-국가트라우마센터)
                                </a> ↗
                            </small>
                        </div>
                        
                        <div class="gad7-grid" id="gad7Grid"></div>
                        
                        <div class="gad7-result" id="gad7Result" style="display: none;">
                            <div class="gad7-score">총점: <span id="gad7Total">0</span> / 21 <span id="gad7SevTag" class="gad7-sev none">불안 아님 (0–4)</span></div>
                            <div id="gad7Advice" class="gad7-note" style="margin-top:8px"></div>
                            <div class="gad7-btns">
                                <button id="gad7StartBtn" class="gad7-btn gad7-primary">다음 단계로 진행</button>
                                <button id="gad7BackBtn" class="gad7-btn gad7-ghost">PHQ-9 결과로 돌아가기</button>
                            </div>
                        </div>
                        
                        <div class="gad7-progress" id="gad7Progress">
                            <div class="gad7-btns">
                                <button id="gad7CalcBtn" class="gad7-btn gad7-primary" disabled>결과 확인하기</button>
                                <button id="gad7BackBtn2" class="gad7-btn gad7-ghost">PHQ-9 결과로 돌아가기</button>
                            </div>
                            <div class="gad7-note" style="margin-top: 8px;">
                                완료된 문항: <span id="gad7CompletedCount">0</span> / 7
                            </div>
                        </div>
                        
                        <div class="gad7-foot">
                            * 이 설문은 참고용입니다. 점수가 높으면, 위험 신호일 수 있으니 지역 정신건강 전문기관에 꼭 상의하세요.
                        </div>
                    </div>
                </div>
            `;
            
            // 기존 컨테이너 숨기기
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            document.body.appendChild(screeningDiv);
            initGAD7();
        }

        function initGAD7() {
            console.log('GAD-7 검사 초기화 시작');
            
            const ITEMS = [
                '초조하거나 불안하거나 조마조마하게 느낀다.',
                '걱정하는 것을 멈추거나 조절할 수가 없다.',
                '여러 가지 것들에 대해 걱정을 너무 많이 한다.',
                '편하게 있기가 어렵다.',
                '쉽게 짜증이 나거나 쉽게 성을 내게 된다.',
                '너무 안절부절못해서 가만히 있기가 힘들다.',
                '마치 끔찍한 일이 생길 것처럼 두렵게 느껴진다.'
            ];

            const grid = document.getElementById('gad7Grid');
            ITEMS.forEach((txt, i) => {
                const q = document.createElement('div');
                q.className = 'gad7-q';
                q.innerHTML = `<h3>${i+1}. ${txt}</h3>
                    <div class="gad7-opts">
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="0">전혀 방해받지 않았다(0점)</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="1">며칠동안 방해받았다(1점)</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="2">2주중 절반이상 방해받았다(2점)</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="3">거의매일 방해받았다(3점)</label>
                    </div>`;
                grid.appendChild(q);
            });

            const totalEl = document.getElementById('gad7Total');
            const sevTag = document.getElementById('gad7SevTag');
            const advice = document.getElementById('gad7Advice');
            const startBtn = document.getElementById('gad7StartBtn');
            const backBtn = document.getElementById('gad7BackBtn');
            const calcBtn = document.getElementById('gad7CalcBtn');
            const backBtn2 = document.getElementById('gad7BackBtn2');
            const resultDiv = document.getElementById('gad7Result');
            const progressDiv = document.getElementById('gad7Progress');
            const completedCount = document.getElementById('gad7CompletedCount');

            function getGAD7Score() {
                let sum = 0;
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector('input[name=q' + i + ']:checked');
                    sum += v ? Number(v.value) : 0;
                }
                return sum;
            }

            function getCompletedCount() {
                // DOM 기반으로 각 문항 컨테이너에서 선택 여부를 계산 (더 견고)
                let completed = 0;
                const questions = document.querySelectorAll('.gad7-q');
                questions.forEach((qEl) => {
                    const checked = qEl.querySelector('input[type="radio"]:checked');
                    if (checked) completed++;
                });
                return completed;
            }

            function updateGAD7Progress() {
                const completed = getCompletedCount();
                completedCount.textContent = completed;
                
                if(completed === 7) {
                    calcBtn.disabled = false;
                    calcBtn.textContent = '결과 확인하기 ✅';
                } else {
                    calcBtn.disabled = true;
                    calcBtn.textContent = '결과 확인하기 (' + completed + '/7)';
                }
            }

            function getGAD7SeverityClass(score) {
                if(score <= 4) return ['정상 (0–4점)', 'none'];
                if(score <= 9) return ['경미한 수준 (5–9점)', 'mild'];
                if(score <= 14) return ['중간수준 (10–14점)', 'mod'];
                return ['심한수준 (15–21점)', 'sev'];
            }

            function showGAD7Results() {
                const score = getGAD7Score();
                console.log('GAD-7 결과 계산 완료, 점수:', score);
                
                // 인구통계 데이터 가져오기
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                
                // GAD-7 점수를 하이브리드 스토리지에 저장
                const timestamp = Date.now();
                // 각 문항 점수 수집 (1–7)
                const items = {};
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector('input[name=q' + i + ']:checked');
                    items[String(i+1)] = v ? Number(v.value) : 0;
                }

                const gad7Data = {
                    score: score,
                    items: items,
                    timestamp: timestamp,
                    expires: timestamp + (24 * 60 * 60 * 1000),
                    demographics: demographicsData
                };
                
                sessionStorage.setItem('gad7_data', JSON.stringify(gad7Data));
                localStorage.setItem('gad7_data', JSON.stringify(gad7Data));
                
                totalEl.textContent = score;
                
                // GAD-7 심각도에 따른 결과 표시 및 조치
                const [severityLabel, severityClass] = getGAD7SeverityClass(score);
                sevTag.textContent = severityLabel;
                sevTag.className = 'gad7-sev ' + severityClass;
                sevTag.style.display = 'block';
                
                // 심각도에 따른 조언 및 버튼 상태 설정
                if (score <= 4) {
                    // 정상 범위
                    advice.innerHTML = '<strong>정상:</strong> 주의가 필요할 정도의 과도한 걱정이나 불안을 보고하지 않았습니다.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = '다음 단계로 진행';
                } else if (score <= 9) {
                    // 경미한 수준
                    advice.innerHTML = '<strong>경미한 수준:</strong> 다소 경미한 수준의 걱정과 불안을 보고하였습니다. 주의깊은 관찰과 관심이 필요합니다.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = '다음 단계로 진행';
                } else if (score <= 14) {
                    // 중간수준
                    advice.innerHTML = '<strong>중간수준:</strong> 주의가 필요한 수준의 과도한 걱정과 불안을 보고하였습니다. 추가적인 평가나 정신건강 전문가의 도움을 받아보시기를 권해 드립니다.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = '다음 단계로 진행';
                } else {
                    // 심한수준 (15-21점) - 프로그램 즉시 중단
                    advice.innerHTML = '<strong>심한수준:</strong> 일상생활에 지장을 초래할 정도의 과도하고 심한 걱정과 불안을 보고하였습니다. 추가적인 평가나 정신건강 전문가의 도움을 받아 보시기를 권해 드립니다.';
                    advice.className = 'gad7-note phq9-warn';
                    startBtn.disabled = true;
                    startBtn.textContent = '프로그램 중단';
                    
                    // 심리상담 포털 안내 추가
                    const portalDiv = document.createElement('div');
                    portalDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0;';
                    portalDiv.innerHTML = `
                        <h4 style="margin: 0 0 12px; color: #856404;">⚠️ 프로그램 중단 안내</h4>
                        <p style="margin: 0 0 16px; color: #856404;">현재 점수는 심한 불안 수준으로, 프로그램을 즉시 중단하고 전문가의 도움을 받으시기 바랍니다.</p>
                        
                        <h4 style="margin: 0 0 12px; color: #856404;">💡 심리상담 포털 안내</h4>
                        <div style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 12px; margin: 8px 0;">
                            <strong>심리상담 포털:</strong> 
                            <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                https://www.mindinfo.kr/new/index.asp
                            </a> ↗
                            <br><small style="color: #6b7280;">상담심리사 찾기, 심리상담센터 찾기, 공공 심리상담 기관 및 서비스 정보 제공</small>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px;">
                            <strong>📞 주요 상담 연락처:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: #1e40af;">
                                <li>정신건강 상담전화: 1577-0199 (24시간)</li>
                                <li>생명의 전화: 1588-9191 (24시간)</li>
                                <li>자살예방상담전화: 1393 (24시간)</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px;">
                            <h4 style="margin: 0 0 12px; color: #27ae60;">💡 카카오톡 상담 채널</h4>
                            <p style="margin: 0 0 12px; color: #27ae60;">우울증 및 불안증 전문 상담을 위한 채널입니다.</p>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>다 들어줄 개:</strong> 
                                <a href="https://pf.kakao.com/_CxoBxcC" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_CxoBxcC
                                </a> ↗
                                <br><small style="color: #6b7280;">우울증 및 불안증 전문 상담, 24시간 채팅 상담 가능</small>
                            </div>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>마들랜:</strong> 
                                <a href="https://pf.kakao.com/_DAxbYG" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_DAxbYG
                                </a> ↗
                                <br><small style="color: #6b7280;">우울증 및 불안증 전문 상담, 24시간 채팅 상담 가능</small>
                            </div>
                        </div>
                    `;
                    
                    // advice 요소 다음에 포털 안내 추가
                    advice.parentNode.insertBefore(portalDiv, advice.nextSibling);
                }
                
                advice.style.display = 'block';

                // 결과 화면으로 전환
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
            }

            document.addEventListener('change', e => {
                if(e.target.matches('.gad7-screening input[type=radio]')) updateGAD7Progress();
            });

            calcBtn.addEventListener('click', showGAD7Results);

            backBtn2.addEventListener('click', () => {
                document.querySelector('.gad7-screening').remove();
                showPHQ9ResultsFromGAD7();
            });

            backBtn.addEventListener('click', () => {
                document.querySelector('.gad7-screening').remove();
                showPHQ9ResultsFromGAD7();
            });

            startBtn.addEventListener('click', () => {
                console.log('GAD-7 다음 단계 버튼 클릭 - 추가 정보 입력 페이지로 이동');
                const gad = document.querySelector('.gad7-screening');
                if (!gad) return;
                gad.innerHTML = `
                    <div class="gad7-wrap">
                        <div class="gad7-card">
                            <h1 class="gad7-title">영화제작치료 참여 여부 입력</h1>
                            <div class="demo-section" style="margin-top: 16px;">
                                <div class="demo-section">
                                    <h4>영화제작치료 참여 희망 여부</h4>
                                    <div class="demo-options">
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="yes">
                                            <span class="demo-label">함께 하는 집단 영화제작치료에 참여하고 싶습니다.</span>
                                        </label>
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="no">
                                            <span class="demo-label">혼자 진행하는 개인 영화제작치료에 참여하고 싶습니다.</span>
                                        </label>
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="none">
                                            <span class="demo-label">아니오, 참여하지 않겠습니다</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="additionalInfoSection" class="demo-section" style="margin-top:8px; display: none;">
                                    <div class="demo-section">
                                        <h4>2) 성별</h4>
                                        <div class="demo-options">
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="0">
                                                <span class="demo-label">남성</span>
                                            </label>
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="1">
                                                <span class="demo-label">여성</span>
                                            </label>
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="2">
                                                <span class="demo-label">기타</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="demo-section" style="margin-top:8px;">
                                        <h4>3) 연령대</h4>
                                        <div class="demo-input">
                                            <input type="number" id="age_afterGAD7" min="13" max="100" placeholder="나이를 입력하세요">
                                            <span class="demo-unit">세</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="gad7-btns" style="margin-top: 20px;">
                                <button id="postNextBtn" class="gad7-btn gad7-primary" disabled>다음</button>
                                <button id="postBackBtn" class="gad7-btn gad7-ghost">이전으로</button>
                            </div>
                        </div>
                    </div>
                `;

                const postNextBtn = document.getElementById('postNextBtn');
                const postBackBtn = document.getElementById('postBackBtn');

                const saveDemographics = (updates) => {
                    const existing = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                    const next = { ...existing, ...updates };
                    sessionStorage.setItem('demographics_data', JSON.stringify(next));
                    localStorage.setItem('demographics_data', JSON.stringify(next));
                    console.log('인구통계 저장:', next);
                };

                function updateNextState() {
                    const selectedGP = document.querySelector('input[name="groupParticipation_afterGAD7"]:checked');
                    const additionalInfoSection = document.getElementById('additionalInfoSection');
                    
                    // 집단 참여 선택에 따라 추가 정보 섹션 표시/숨김
                    if (selectedGP && (selectedGP.value === 'yes' || selectedGP.value === 'no')) {
                        additionalInfoSection.style.display = 'block';
                        
                        // 성별과 연령대가 모두 입력되었는지 확인
                        const selectedGender = document.querySelector('input[name="gender_afterGAD7"]:checked');
                        const ageVal = document.getElementById('age_afterGAD7')?.value;
                        const ageOk = ageVal && parseInt(ageVal) >= 13 && parseInt(ageVal) <= 100;
                        
                        postNextBtn.disabled = !(selectedGender && ageOk);
                    } else if (selectedGP && selectedGP.value === 'none') {
                        // '어느 것에도 참여하지 않겠습니다' 선택 시
                        additionalInfoSection.style.display = 'none';
                        postNextBtn.disabled = false; // 바로 진행 가능
                    } else {
                        // 아무것도 선택하지 않은 경우
                        additionalInfoSection.style.display = 'none';
                        postNextBtn.disabled = true;
                    }
                }

                document.addEventListener('change', (e) => {
                    if (e.target.matches('input[name="gender_afterGAD7"]')) {
                        saveDemographics({ gender: parseInt(e.target.value) });
                        updateNextState();
                    }
                    if (e.target.matches('input[name="groupParticipation_afterGAD7"]')) {
                        saveDemographics({ groupParticipation: e.target.value });
                        updateNextState();
                        
                        // 집단 참여 선택이 변경되면 성별과 연령대 초기화
                        if (e.target.value === 'none') {
                            // '어느 것에도 참여하지 않겠습니다' 선택 시 기존 성별/연령대 선택 해제
                            document.querySelectorAll('input[name="gender_afterGAD7"]').forEach(radio => radio.checked = false);
                            document.getElementById('age_afterGAD7').value = '';
                            saveDemographics({ gender: undefined, age: undefined });
                        }
                    }
                });
                const ageInput = document.getElementById('age_afterGAD7');
                if (ageInput) {
                    ageInput.addEventListener('input', () => {
                        const ageVal = ageInput.value ? parseInt(ageInput.value) : null;
                        saveDemographics({ age: ageVal });
                        updateNextState();
                    });
                }

                // 기존 값 프리필
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                if (Number.isInteger(demographicsData.gender)) {
                    const gpre = document.querySelector(`input[name=\"gender_afterGAD7\"][value=\"${demographicsData.gender}\"]`);
                    if (gpre) gpre.checked = true;
                }
                if (demographicsData && demographicsData.age) {
                    const ap = document.getElementById('age_afterGAD7');
                    if (ap) ap.value = demographicsData.age;
                }
                if (demographicsData && demographicsData.groupParticipation) {
                    const gp = document.querySelector(`input[name=\"groupParticipation_afterGAD7\"][value=\"${demographicsData.groupParticipation}\"]`);
                    if (gp) gp.checked = true;
                }
                updateNextState();

                postBackBtn.addEventListener('click', () => {
                    // 이전: GAD-7 결과로 돌아가기
                    showGAD7Results();
                });
                postNextBtn.addEventListener('click', () => {
                    console.log('다음 버튼 클릭 - 영화제작치료 참여 여부에 따른 처리');
                    
                    // 영화제작치료 참여 여부 확인
                    const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                    const groupParticipation = demographicsData.groupParticipation;
                    
                    if (groupParticipation === 'none') {
                        // '아니오, 참여하지 않겠습니다' 선택 시
                        showCompletionMessage(gad);
                    } else if (groupParticipation === 'yes' || groupParticipation === 'no') {
                        // '함께 하는 집단 영화제작치료' 또는 '혼자 진행하는 개인 영화제작치료' 선택 시
                        showHighScoreItems(gad);
                    } else {
                        // 선택하지 않은 경우
                        gad.innerHTML = '<div style="text-align:center; padding:20px;">영화제작치료 참여 여부를 선택해주세요.</div>';
                    }
                });
            });

            updateGAD7Progress();
            
            // 라디오 버튼 스타일 설정
            setupRadioButtonStyles();
            
            // 라디오 버튼 스타일 설정 함수
            function setupRadioButtonStyles() {
                console.log('라디오 버튼 스타일 설정 시작');
                
                // GAD-7 문항들의 라디오 버튼 스타일 설정
                const gad7Questions = document.querySelectorAll('.gad7-q');
                console.log('찾은 GAD-7 문항 개수:', gad7Questions.length);
                
                gad7Questions.forEach((questionItem, questionIndex) => {
                    const labels = questionItem.querySelectorAll('.gad7-opt');
                    console.log(`문항 ${questionIndex + 1}의 라벨 개수:`, labels.length);
                    
                    labels.forEach((label, labelIndex) => {
                        const radio = label.querySelector('input[type="radio"]');
                        
                        if (!radio) {
                            console.error(`문항 ${questionIndex + 1}, 라벨 ${labelIndex}에 radio 요소가 없음:`, label);
                            return;
                        }
                        
                        // 클릭 이벤트 추가 (라벨 전체 클릭 가능)
                        label.addEventListener('click', () => {
                            console.log(`문항 ${questionIndex + 1}, 라벨 ${labelIndex} 클릭됨, 값: ${radio.value}`);
                            
                            // 같은 문항 내의 다른 라디오 버튼들 해제
                            const sameQuestionLabels = questionItem.querySelectorAll('.gad7-opt');
                            sameQuestionLabels.forEach(l => {
                                const r = l.querySelector('input[type="radio"]');
                                if (r) r.checked = false;
                                l.classList.remove('selected');
                            });
                            
                            // 현재 라디오 버튼 선택
                            radio.checked = true;
                            label.classList.add('selected');
                            
                            // change 이벤트 발생
                            radio.dispatchEvent(new Event('change'));
                            updateGAD7Progress();
                        });
                        
                        // radio change 이벤트도 유지
                        radio.addEventListener('change', () => {
                            console.log(`문항 ${questionIndex + 1}, 라디오 버튼 ${labelIndex} 변경됨, 값: ${radio.value}, 체크됨: ${radio.checked}`);
                            
                            if (radio.checked) {
                                // 같은 문항 내의 다른 라벨들 스타일 초기화
                                const sameQuestionLabels = questionItem.querySelectorAll('.gad7-opt');
                                sameQuestionLabels.forEach(l => {
                                    l.classList.remove('selected');
                                });
                                
                                // 선택된 라벨 스타일 변경
                                label.classList.add('selected');
                            }
                            updateGAD7Progress();
                        });
                    });
                });
                
                console.log('라디오 버튼 스타일 설정 완료');
            }
        }

        // 개인정보 보호법 상세 가이드 함수
        function showPrivacyGuide() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="width: min(720px,92vw); background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <h2 style="color: #e5e7eb; margin: 0;">🔒 개인정보 보호법 상세 가이드</h2>
                        <button onclick="this.closest('.privacy-modal').remove()" style="background: transparent; border: 1px solid #374151; color: #9ca3af; padding: 8px 12px; border-radius: 8px; cursor: pointer;">닫기</button>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">수집·이용 동의 (제15조, 제16조, 제22조)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>목적·항목·보유기간·거부권 및 불이익 고지 후 동의 받아야 함(제15조②, 제22조)</li>
                            <li>목적에 필요한 '최소한의 정보'만 수집(제16조)</li>
                            <li>선택 동의 미체크만으로 서비스 제공 거부 금지(제22조⑤)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">제3자 제공 및 목적 외 제한 (제17조, 제18조)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>제공받는 자·목적·항목·보유기간을 알리고 '별도 동의' 필요(제17조②)</li>
                            <li>수집 목적 외 이용·제공은 원칙적으로 금지(제18조①)</li>
                            <li>예외 제공 시에도 정보주체 이익 침해 금지 및 안전조치 요청(제18조②·⑤)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">정보주체 권리 (제35·36·37·37의2)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>본인정보 '열람' 요구(제35조), '정정·삭제' 요구(제36조), '처리정지/동의철회'(제37조)</li>
                            <li>완전 자동화된 '결정'에 대한 거부·설명요구 가능(제37의2)</li>
                            <li>요구 절차는 수집 절차보다 어렵지 않게 제공(제38조④)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">파기 (제21조) & 안전조치(제29조)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>보유기간 경과·목적 달성 등 불필요 시 '지체없이' 파기(제21조①)</li>
                            <li>복구·재생 불가 방식으로 파기하고 분리보관 시 분리 유지(제21조②·③)</li>
                            <li>접근통제·로그보관 등 안전조치 의무(제29조)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1e3a8a; border: 1px solid #3b82f6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">상담윤리 및 비밀보장 (상담심리학회)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><b>비밀보장 원칙:</b> 모든 상담 내용은 철저한 비밀보장 원칙을 따릅니다</li>
                            <li><b>윤리적 책임:</b> 상담사는 내담자의 복지를 최우선으로 합니다</li>
                            <li><b>경계 설정:</b> 전문적 관계 유지를 위한 명확한 경계를 설정합니다</li>
                            <li><b>자기결정권:</b> 내담자의 자기결정권을 존중하고 보호합니다</li>
                            <li><b>전문성 유지:</b> 지속적인 교육과 훈련을 통해 전문성을 유지합니다</li>
                        </ul>
                    </div>
                    
                    <div style="background: #dc2626; border: 1px solid #ef4444; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">최우선 보호 원칙</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><b>1순위:</b> 개인정보 보호법 및 상담윤리 준수</li>
                            <li><b>절대 원칙:</b> 비밀보장 및 프라이버시 보호</li>
                            <li><b>안전조치:</b> 모든 데이터는 암호화 및 가명처리 후 처리</li>
                            <li><b>접근 제한:</b> 승인된 인원만 제한적으로 접근 가능</li>
                            <li><b>감사 추적:</b> 모든 접근 및 처리 과정을 기록하고 추적</li>
                        </ul>
                    </div>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">원문 보기(국가법령정보센터)</summary>
                        <div style="margin-top: 12px;">
                            <div style="margin-bottom: 8px;">↗ <a href="https://www.law.go.kr/법령/개인정보보호법/제15조" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">제15조 수집·이용</a></div>
                            <div style="margin-bottom: 8px;">↗ <a href="https://www.law.go.kr/법령/개인정보보호법/제17조" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">제17조 제3자 제공</a></div>
                            <div style="margin-bottom: 8px;">↗ <a href="https://www.law.go.kr/법령/개인정보보호법/제35조" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">제35조 열람</a></div>
                            <div style="margin-bottom: 8px;">↗ <a href="https://www.law.go.kr/법령/개인정보보호법/제21조" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">제21조 파기</a></div>
                            <div style="margin-bottom: 8px;">↗ <a href="https://www.privacy.go.kr" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">개인정보보호위원회</a></div>
                        </div>
                    </details>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">상담심리학회 관련 링크</summary>
                        <div style="margin-top: 12px;">
                            <div style="margin-bottom: 8px;">↗ <a href="http://krcpa.or.kr/user/new/sub03_1.asp" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">한국상담심리학회 윤리규정</a></div>
                            <div style="margin-bottom: 8px;">↗ <a href="http://krcpa.or.kr" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">한국상담심리학회 홈페이지</a></div>
                            <div style="margin-bottom: 8px; color: #fca5a5; font-size: 0.9em;">
                                💡 링크가 작동하지 않을 경우: 주소를 복사해서 브라우저에 직접 붙여넣기 하세요
                            </div>
                            <div style="margin-bottom: 8px; color: #fca5a5; font-size: 0.9em;">
                                📧 문의: kcpa@krcpa.or.kr | 📞 02-498-8293
                            </div>
                        </div>
                    </details>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">상담윤리 핵심 원칙 (직접 제공)</summary>
                        <div style="margin-top: 12px; color: #d1d5db; line-height: 1.6;">
                            <div style="margin-bottom: 12px;">
                                <strong>1. 비밀보장 원칙</strong><br>
                                • 모든 상담 내용은 철저한 비밀보장 원칙을 따릅니다<br>
                                • 제3자에게 정보를 제공하지 않습니다<br>
                                • 예외: 자해/타해 위험 시에만 법적 의무로 신고
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>2. 내담자 복지 최우선</strong><br>
                                • 상담사는 내담자의 복지를 최우선으로 합니다<br>
                                • 내담자의 자기결정권을 존중합니다<br>
                                • 전문적 경계를 유지합니다
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>3. 전문성과 윤리적 책임</strong><br>
                                • 지속적인 교육과 훈련을 통해 전문성을 유지합니다<br>
                                • 윤리적 딜레마 발생 시 전문가 상담을 받습니다<br>
                                • 내담자에게 해를 끼치지 않습니다
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>4. 개인정보 보호</strong><br>
                                • 개인정보 보호법을 철저히 준수합니다<br>
                                • 최소한의 정보만 수집하고 안전하게 보관합니다<br>
                                • 목적 달성 후 지체없이 파기합니다
                            </div>
                        </div>
                    </details>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('.privacy-modal').remove()" style="background: #22c55e; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">확인</button>
                    </div>
                </div>
            `;
            
            modal.className = 'privacy-modal';
            document.body.appendChild(modal);
            
            // 모달 외부 클릭 시 닫기
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // 초기 로드 시, 의도치 않게 문서 말미에 붙은 사본 UI 블록을 제거
        (function removeAppendedDuplicatesOnLoad(){
            if (document.readyState !== 'loading') cleanup();
            else document.addEventListener('DOMContentLoaded', cleanup);
            function cleanup(){
                // 페이지 최초 로드 시에만 정리: 이후 동적 렌더링은 유지
                const stray = document.querySelectorAll('body > .demographics-survey, body > .gad7-screening');
                stray.forEach(el => {
                    try { el.remove(); } catch(e) {}
                });
            }
        })();
</script>
</body>
</html>