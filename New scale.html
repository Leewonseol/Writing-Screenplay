<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸°: ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ì„±ì¥í•˜ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
        }

        

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 2em;
            background-color: white;
            min-height: 100vh;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 1em;
            text-align: center;
            font-size: 2.2em;
        }

        h3 {
            color: #34495e;
            margin-bottom: 1em;
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 0.5em;
        }

        .prompt {
            white-space: pre-line;
            background-color: #ecf0f1;
            padding: 1.5em;
            border-radius: 8px;
            margin-bottom: 1em;
            border-left: 4px solid #3498db;
        }

        textarea {
            width: 100%;
            min-height: 200px;
            padding: 1em;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.3);
        }

        .api-section {
            margin: 1em 0;
            padding: 1em;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }

        input[type="password"] {
            width: 300px;
            padding: 0.5em;
            border: 1px solid #bdc3c7;
            border-radius: 4px;
            margin-right: 1em;
        }

        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.7em 1.5em;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        .button-group {
            text-align: center;
            margin-top: 1.5em;
        }

        .button-group button {
            margin: 0 0.5em;
        }

        .summary-block {
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 1em;
            margin-bottom: 1em;
            border-radius: 5px;
        }

        .summary-block strong {
            color: #2c3e50;
            display: block;
            margin-bottom: 0.5em;
        }

        .summary-block p {
            white-space: pre-line;
            margin: 0;
        }

        

        .loading {
            opacity: 0.7;
        }

        /* PHQ-9 ê³µí†µ ìŠ¤íƒ€ì¼ */
        .phq9-screening {
            --bg:#f7f8fa; --fg:#222; --muted:#6b7280; --brand:#2563eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
            --card:#ffffff; --border:#e5e7eb; --shadow:0 8px 24px rgba(0,0,0,.06);
            background: var(--bg); 
            min-height: 100vh; 
            padding: 24px; 
            font-family: system-ui, -apple-system, sans-serif;
            position: relative;
            z-index: 1000;
            display: block !important;
        }
        .phq9-screening * { box-sizing: border-box; }
        .phq9-wrap { max-width: 920px; margin: 0 auto; }
        .phq9-card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 24px; }
        .phq9-title { font-size: 28px; margin: 0 0 8px; color: var(--fg); }
        .phq9-sub { color: var(--muted); margin-bottom: 16px; }
        .phq9-grid { display: grid; gap: 12px; }
        .phq9-q { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: #fff; }
        .phq9-q h3 { margin: 0 0 8px; font-size: 16px; }
        .phq9-opts { display: flex; gap: 12px; flex-wrap: wrap; }
        .phq9-opt { display: flex; align-items: center; gap: 8px; padding: 8px 10px; border: 1px solid var(--border); border-radius: 10px; cursor: pointer; }
        .phq9-opt input { accent-color: var(--brand); }
        .phq9-result { margin-top: 18px; border-top: 1px solid var(--border); padding-top: 16px; }
        .phq9-score { font-size: 18px; font-weight: 700; }
        .phq9-sev { display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 999px; font-size: 12px; }
        .phq9-sev.none { background: #e5f9f1; }
        .phq9-sev.mild { background: #e8f0ff; }
        .phq9-sev.mod { background: #fff7e6; }
        .phq9-sev.modsev { background: #ffe7e7; }
        .phq9-sev.sev { background: #ffd6d6; }
        .phq9-note { color: var(--muted); font-size: 13px; }
        .phq9-btns { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 12px; }
        .phq9-btn { 
            appearance: none; 
            border: none; 
            border-radius: 10px; 
            padding: 12px 16px; 
            font-weight: 600; 
            cursor: pointer; 
            margin: 5px;
            display: inline-block;
        }
        .phq9-primary { background: var(--brand); color: #fff; }
        .phq9-ghost { background: #fff; border: 1px solid var(--border); color: var(--fg); }
        .phq9-danger { background: var(--bad); color: #fff; }
        .phq9-foot { margin-top: 16px; font-size: 12px; color: var(--muted); }
        .phq9-warn { color: var(--bad); font-weight: 700; }
        .phq9-ok { color: var(--ok); font-weight: 700; }
        .phq9-progress { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }

        /* fadeIn ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .progress-indicator {
            text-align: center;
            margin-bottom: 2em;
        }

        .progress-step {
            display: inline-block;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #bdc3c7;
            color: white;
            text-align: center;
            line-height: 30px;
            margin: 0 0.5em;
            font-weight: bold;
        }

        .progress-step.active {
            background-color: #3498db;
        }

        .progress-step.completed {
            background-color: #27ae60;
        }
        .input-guide {
            background: #fffbe6;
            color: #b8860b;
            border-left: 4px solid #ffd700;
            padding: 0.7em 1em;
            margin-bottom: 1em;
            border-radius: 6px;
            font-size: 1em;
        }
        /* ========= ê°ˆë“± ë‹¤ì´ì–´ê·¸ë¨ ìŠ¤íƒ€ì¼ (ì—¬ê¸°ì„œë¶€í„° ìˆ˜ì •ë¨) ========= */
        .diagram-container {
            position: relative;
            width: 650px;
            height: 650px;
            margin: 0 auto;
        }

        .circle {
            border-radius: 50%;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: transparent;
        }

        .outer-circle { width: 100%; height: 100%; border: 2.5px solid #333; }
        .middle-circle { width: 65%; height: 65%; border: 2px solid #e0e0e0; }
        .inner-circle { width: 35%; height: 35%; border: 2px solid #e0e0e0; }

        .label-container {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            box-sizing: border-box;
            padding: 1em;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
        }

        .label-container > div {
            pointer-events: auto;
        }

        .label-intrapersonal {
            width: 35%;
            height: 35%;
            font-size: 1em;
            justify-content: center;
        }
        .label-personal {
            width: 65%;
            height: 65%;
            justify-content: flex-start;
            padding-top: 1%;
        }
        .label-transpersonal {
            width: 100%;
            height: 100%;
            justify-content: flex-start;
            padding-top: 2%;
        }

        .conflict-title {
            font-weight: 700;
            font-size: 1.2em;
            color: #333;
            margin-bottom: 0.1em;
        }
        .conflict-meaning {
            font-size: 1em;
            color: #777;
            margin-bottom: 0.7em;
        }
        .conflict-example {
            font-size: 0.9em;
            color: #999;
            line-height: 1.4;
        }
        /* ========= ìŠ¤íƒ€ì¼ ìˆ˜ì • ë ========= */
        
        /* ========= GAD-7 ì „ìš© ìŠ¤íƒ€ì¼ ========= */
        .gad7-wrap {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .gad7-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 32px;
            margin-bottom: 24px;
        }
        
        .gad7-title {
            color: #1f2937;
            font-size: 1.875rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 16px;
        }
        
        .gad7-sub {
            color: #6b7280;
            font-size: 1.125rem;
            line-height: 1.6;
            text-align: center;
            margin-bottom: 32px;
        }
        
        .gad7-grid {
            display: grid;
            gap: 24px;
        }
        
        .gad7-q {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 24px;
        }
        
        .gad7-q h3 {
            color: #1f2937;
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 16px;
        }
        
        .gad7-opts {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .gad7-opt {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }
        
        .gad7-opt:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .gad7-opt input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .gad7-opt.selected {
            border-color: #3b82f6;
            background: #dbeafe;
            color: #1e40af;
        }
        
        .gad7-progress, .gad7-result {
            text-align: center;
            margin: 24px 0;
        }
        
        .gad7-btns {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }
        
        .gad7-btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 1rem;
        }
        
        .gad7-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .gad7-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .gad7-btn.gad7-ghost {
            background: #f3f4f6;
            color: #374151;
        }
        
        .gad7-btn.gad7-primary {
            background: #3b82f6;
            color: white;
        }
        
        .gad7-score {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin: 16px 0;
        }
        
        .gad7-sev {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.875rem;
            margin: 16px 0;
        }
        
        .gad7-sev.none { background: #d4edda; color: #155724; }
        .gad7-sev.mild { background: #fff3cd; color: #856404; }
        .gad7-sev.mod { background: #f8d7da; color: #721c24; }
.gad7-sev.sev { background: #f5c6cb; color: #721c24; }
        
        .gad7-note {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            color: #0c4a6e;
        }
        
        .gad7-foot {
            text-align: center;
            color: #6b7280;
            font-size: 0.875rem;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #e5e7eb;
        }
        
        .gad7-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            color: #0c4a6e;
        }
        
        .gad7-warn {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #991b1b;
        }
        /* ========= GAD-7 ì „ìš© ìŠ¤íƒ€ì¼ ë ========= */
        
        /* ========= ì¸êµ¬í†µê³„ ìˆ˜ì§‘ í™”ë©´ ìŠ¤íƒ€ì¼ ========= */
        .demographics-survey {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Arial', sans-serif;
        }
        
        .demo-wrap {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .demo-card {
            padding: 32px;
        }
        
        .demo-title {
            text-align: center;
            color: #1f2937;
            margin-bottom: 16px;
            font-size: 2em;
            font-weight: 700;
        }
        
        .demo-sub {
            text-align: center;
            color: #6b7280;
            margin-bottom: 32px;
            font-size: 1.1em;
            line-height: 1.6;
        }
        
        .demo-form {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .demo-section {
            margin-bottom: 32px;
            padding: 24px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .demo-section h3 {
            color: #374151;
            margin: 0 0 16px 0;
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .demo-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .demo-option {
            display: flex;
            align-items: center;
            padding: 16px;
            background: #fff;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .demo-option:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
        }
        
        .demo-option input[type="radio"] {
            margin-right: 12px;
            transform: scale(1.2);
        }
        
        .demo-label {
            font-size: 1.1em;
            color: #374151;
            font-weight: 500;
        }
        
        .demo-input {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .demo-input input,
        .demo-input select {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1.1em;
            transition: border-color 0.2s ease;
        }
        
        .demo-input input:focus,
        .demo-input select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .demo-unit {
            color: #6b7280;
            font-size: 1.1em;
            font-weight: 500;
            min-width: 30px;
        }
        
        .demo-btns {
            text-align: center;
            margin-top: 40px;
        }
        
        .demo-btn {
            padding: 16px 32px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .demo-primary {
            background: #3b82f6;
            color: white;
        }
        
        .demo-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }
        
        .demo-primary:active {
            transform: translateY(0);
        }
        
        /* ========= ì¸êµ¬í†µê³„ ìˆ˜ì§‘ í™”ë©´ ìŠ¤íƒ€ì¼ ë ========= */
    </style>
</head>
<body>
    <div class="container">
        <div style="text-align:right;margin-bottom:0.5em;">
            <button id="showIntroBtn" style="background:#f1c40f;color:#333;font-size:0.97em;padding:0.5em 1.2em;border-radius:6px;">ì•ˆë‚´ì‚¬í•­ ë³´ê¸°</button>
        </div>
        <h2 id="programTitle" style="cursor:pointer;">ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸°: ë‚˜ì˜ ì´ì•¼ê¸°ë¡œ ì„±ì¥í•˜ê¸°</h2>
        <div id="programDesc" style="display:none;text-align:center;margin-bottom:1.5em;color:#555;font-size:1.13em;line-height:1.7;">
            ëˆ„êµ¬ë‚˜ ì¸ìƒì˜ ì „í™˜ì ì´ ë˜ëŠ” í˜ë“  ê²½í—˜ì„ í•©ë‹ˆë‹¤.<br><br>
            ì´ í”„ë¡œê·¸ë¨ì€ ë§ˆìŒì— ì˜¤ë˜ ë‚¨ì•„ìˆëŠ” ê¸°ì–µë“¤ì„ í•œ í¸ì˜ ì´ì•¼ê¸°ë¡œ ì™„ì„±í•˜ë©°, ê·¸ ì•ˆì—ì„œ ìƒˆë¡œìš´ ì˜ë¯¸ì™€ ìì‹ ì˜ ê°•ì ì„ ë°œê²¬í•˜ë„ë¡ ë•ìŠµë‹ˆë‹¤.<br><br>
            ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì“°ë©´ì„œ ìƒê°ê³¼ ê°ì •ì„ ì •ë¦¬í•˜ê³ , ì„±ì¥í•˜ëŠ” ê²½í—˜ì„ í•´ë³´ì„¸ìš”.
        </div>
        

        
        <div class="progress-indicator">
            <span class="progress-step" id="step1">1</span>
            <span class="progress-step" id="step2">2</span>
            <span class="progress-step" id="step3">3</span>
            <span class="progress-step" id="step4">4</span>
        </div>

        <h3 id="stageTitle"></h3>
        
        <div class="prompt" id="stagePrompt"></div>
        
        <textarea id="responseTextarea" placeholder="ì—¬ê¸°ì— ë‚´ìš©ì„ ì‘ì„±í•˜ì„¸ìš”..."></textarea>
        
        <div class="api-section">
            
            <button id="suggestBtn" style="margin-left: 1em;">AI ì œì•ˆ/ì§ˆë¬¸</button>
    
        </div>
        
        <div id="aiResults"></div>
        
        <div class="button-group">
            <button id="clearAllBtn" style="background:#e74c3c;color:white;">ì…ë ¥ê°’ ì „ì²´ ì‚­ì œ</button>
            <button id="prevBtn" style="display: none;">â† ì´ì „</button>
            <button id="nextBtn">ë‹¤ìŒ â†’</button>
        </div>
    </div>

    <footer style="font-size: 0.8em; color: #666; text-align: center; margin-top: 2em;">
      <div style="margin-bottom:8px;">
        <button id="toggleRefsBtn" style="background:#f1c40f;color:#333;font-size:0.9em;padding:0.35em 0.9em;border-radius:6px;border:none;cursor:pointer;">ì°¸ê³ ë¬¸í—Œ ë³´ê¸°</button>
      </div>
      <div id="referencesPanel" style="display:none; text-align:left; max-width:880px; margin:0 auto; background:#fafafa; border:1px solid #e5e7eb; border-radius:8px; padding:12px;">
        <ol style="margin:0; padding-left:20px;">
          <li style="margin:6px 0;">
            <a href="https://scienceon.kisti.re.kr/srch/selectPORSrchArticle.do?cn=DIKO0013987988" target="_blank" style="color:#2563eb; text-decoration:underline;">ë°•ìˆ˜ì§„(2016). ì‹œë‚˜ë¦¬ì˜¤ì¹˜ë£Œ í”„ë¡œê·¸ë¨ì˜ ê°œë°œê³¼ íš¨ê³¼. ê²½ì„±ëŒ€í•™êµ ì„ì‚¬í•™ìœ„ ì²­êµ¬ë…¼ë¬¸</a>
          </li>
          <li style="margin:6px 0;">
            <a href="https://www.riss.kr/search/detail/DetailView.do?p_mat_type=be54d9b8bc7cdb09&control_no=f9c97862a831b72bffe0bdc3ef48d419&keyword=%EC%9A%B0%EC%9A%B8%EC%A6%9D%20%EC%84%B1%EC%9D%B8%EC%9D%84%20%EC%9C%84%ED%95%9C%20%EC%98%81%ED%99%94%EC%A0%9C%EC%9E%91%20%EC%B9%98%EB%A3%8C%20%EC%82%AC%EB%A1%80%EC%97%B0%EA%B5%AC" target="_blank" style="color:#2563eb; text-decoration:underline;">ë°•ì¤€í˜•(2011). ìš°ìš¸ì¦ ì„±ì¸ì„ ìœ„í•œ ì˜í™”ì œì‘ ì¹˜ë£Œ ì‚¬ë¡€ì—°êµ¬. ì„±ê· ê´€ëŒ€í•™êµ ì¼ë°˜ëŒ€í•™ì› ì‚¬íšŒë³µì§€í•™ê³¼ ì„ì‚¬í•™ìœ„ ì²­êµ¬ë…¼ë¬¸</a>
          </li>
        </ol>
      </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =======================================================
            // 1. ê¸°ì¡´ ì½”ë“œì—ì„œ ìœ ì§€í•´ì•¼ í•  ëª¨ë“  í•¨ìˆ˜ë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
            // (ì˜ˆ: saveAllResponses, loadAllResponses, encrypt, decrypt, 
            //  validatePrivacyAndEthics, callAICompletion ë“±)
            // =======================================================
            
            // ì˜ˆì‹œ: ê¸°ì¡´ ì €ì¥ í•¨ìˆ˜ê°€ ìˆë‹¤ê³  ê°€ì •
            function saveAllResponses() {
                // ê¸°ì¡´ì— ì‘ì„±í•˜ì‹  ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ë¡œì§
                try {
                    // ì´ í•¨ìˆ˜ëŠ” ì´ë¯¸ ê°€ì§€ê³  ê³„ì‹  ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.
                    localStorage.setItem('scenario_responses', JSON.stringify(responses));
                    console.log("Responses saved to local storage.");
                } catch (e) {
                    console.error("Failed to save responses:", e);
                }
            }
            
            // ì˜ˆì‹œ: ê¸°ì¡´ ë¡œë“œ í•¨ìˆ˜ê°€ ìˆë‹¤ê³  ê°€ì •
            function loadAllResponses() {
                const data = localStorage.getItem('scenario_responses');
                if (data) {
                    try {
                        const loadedResponses = JSON.parse(data);
                        // ë°°ì—´ êµ¬ì¡°ê°€ ë§ëŠ”ì§€ ê°„ë‹¨íˆ í™•ì¸ í›„ ë¡œë“œ
                        if (Array.isArray(loadedResponses) && loadedResponses.length === STAGE_FIELDS.length) {
                            return loadedResponses;
                        }
                    } catch(e) {
                        console.error("Failed to load or parse responses:", e);
                    }
                }
                // ê¸°ë³¸ê°’ ë°˜í™˜
                return STAGE_FIELDS.map(fields => Array(fields.length).fill(""));
            }



        });


        // ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìƒë‹´ìœ¤ë¦¬ ìš°ì„  ê²€ì¦ í•¨ìˆ˜ (1ìˆœìœ„ ë³´ì•ˆ)
        function validatePrivacyAndEthics(data) {
            // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë° ìƒë‹´ìœ¤ë¦¬ ì¤€ìˆ˜ ê²€ì¦
            if (!data || typeof data !== 'object') {
                console.warn('Privacy Check: Invalid data structure detected');
                return false;
            }
            
            // ë¯¼ê°ì •ë³´ ê²€ì¶œ ë° ê°€ëª…ì²˜ë¦¬ ê°•ì œ
            const sensitivePatterns = [
                /\b\d{6}-\d{7}\b/g,  // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
                /\b\d{3}-\d{3,4}-\d{4}\b/g,  // ì „í™”ë²ˆí˜¸
                /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,  // ì´ë©”ì¼
                /\b\d{5,6}\b/g,  // ìš°í¸ë²ˆí˜¸
                /\b(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)\b/g,  // ì§€ì—­ëª…
                /\b(íšŒì‚¬|í•™êµ|ë³‘ì›|ì€í–‰|ê¸°ê´€|ë‹¨ì²´|ì¡°ì§)\b/g  // ê¸°ê´€ëª…
            ];
            
            let hasSensitiveInfo = false;
            const sanitizedData = JSON.parse(JSON.stringify(data));
            
            // ì¬ê·€ì ìœ¼ë¡œ ë¯¼ê°ì •ë³´ ê²€ì¶œ ë° ê°€ëª…ì²˜ë¦¬
            function sanitizeObject(obj) {
                for (let key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        if (typeof obj[key] === 'string') {
                            // ë¯¼ê°ì •ë³´ íŒ¨í„´ ê²€ì¶œ
                            sensitivePatterns.forEach(pattern => {
                                if (pattern.test(obj[key])) {
                                    hasSensitiveInfo = true;
                                    // ê°€ëª…ì²˜ë¦¬: ë¯¼ê°ì •ë³´ë¥¼ [ê°€ëª…ì²˜ë¦¬ë¨]ìœ¼ë¡œ ëŒ€ì²´
                                    obj[key] = obj[key].replace(pattern, '[ê°€ëª…ì²˜ë¦¬ë¨]');
                                }
                            });
                        } else if (typeof obj[key] === 'object' && obj[key] !== null) {
                            sanitizeObject(obj[key]);
                        }
                    }
                }
            }
            
            sanitizeObject(sanitizedData);
            
            if (hasSensitiveInfo) {
                console.warn('Privacy Check: Sensitive information detected and anonymized');
            }
            
            // ìƒë‹´ìœ¤ë¦¬ ê²€ì¦: ë¹„ë°€ë³´ì¥ ì›ì¹™ ì¤€ìˆ˜
            let hasRiskContent = false;
            if (data.content && typeof data.content === 'string') {
                // ìí•´/íƒ€í•´ ìœ„í—˜ í‘œí˜„ ê²€ì¶œ (ìƒë‹´ìœ¤ë¦¬ 1ìˆœìœ„)
                const riskPatterns = [
                    /\b(ìì‚´|ìí•´|ì£½ê³ |ì£½ì–´|ëë‚´|í•´ì¹˜|í•´ì¹˜ê² |ìœ„í—˜|í­ë ¥|í•™ëŒ€)\b/g,
                    /\b(ì°¨ë¼ë¦¬|ê·¸ë§Œ|ë”ëŠ”|ëª»ì‚´ê² |í˜ë“¤ì–´|ê´´ë¡œì›Œ|ì ˆë§|ë¬´ì˜ë¯¸)\b/g,
                    /\b(ì•½ë¬¼|ìˆ |ë‹´ë°°|ë„ë°•|ì¤‘ë…|ê³¼ë„í•œ|ê·¹ë‹¨ì )\b/g
                ];
                
                riskPatterns.forEach(pattern => {
                    if (pattern.test(data.content)) {
                        hasRiskContent = true;
                        console.warn('Ethics Check: Risk content detected - immediate attention required');
                    }
                });
                
                if (hasRiskContent) {
                    // ìœ„í—˜ ì‹ í˜¸ ê°ì§€ ì‹œ ë¡œê·¸ ê¸°ë¡ ë° ê´€ë¦¬ì ì•Œë¦¼ í•„ìš”
                    const riskLog = {
                        timestamp: Date.now(),
                        stage: data.stage || 'unknown',
                        riskLevel: 'high',
                        content: data.content.substring(0, 100) + '...',
                        action: 'immediate_review_required',
                        ethics: 'counseling_ethics_violation_detected'
                    };
                    console.warn('Risk Assessment Required:', riskLog);
                    
                    // ìƒë‹´ìœ¤ë¦¬ ìœ„ë°˜ ì‹œ ì¦‰ì‹œ ì•Œë¦¼ (ì‹¤ì œ ìš´ì˜ ì‹œì—ëŠ” ê´€ë¦¬ìì—ê²Œ ì „ì†¡)
                    if (typeof window.showEthicsAlert === 'function') {
                        window.showEthicsAlert('ìƒë‹´ìœ¤ë¦¬ ìœ„ë°˜ ì‹ í˜¸ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì˜ ì¦‰ì‹œ ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                    }
                }
            }
            
            // ê°œì¸ì •ë³´ ë³´í˜¸ë²• ì¤€ìˆ˜ í™•ì¸
            const privacyCompliance = {
                timestamp: Date.now(),
                dataType: 'user_response',
                validation: 'passed',
                anonymization: hasSensitiveInfo ? 'applied' : 'not_required',
                ethicsCheck: hasRiskContent ? 'risk_detected' : 'passed'
            };
            
            console.log('Privacy & Ethics Compliance:', privacyCompliance);
            return sanitizedData;
        }

        function saveConversation(stage, questionId, conversationData) {
            try {
                // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìƒë‹´ìœ¤ë¦¬ ê²€ì¦
                const validatedData = validatePrivacyAndEthics(conversationData);
                if (!validatedData) {
                    console.error('Privacy validation failed - data not saved');
                    return;
                }
                
                const key = localStorage.getItem('encryption_key') || setupEncryption();
                const existingData = loadConversation(stage, questionId) || [];
                existingData.push(validatedData);
                
                const encrypted = encrypt(existingData, key);
                if (encrypted) {
                    localStorage.setItem(`conversation_${stage}_${questionId}`, encrypted);
                    console.log('Privacy Check: Conversation data saved with validation');
                } else {
                    console.error('Failed to encrypt conversation data');
                }
            } catch (error) {
                console.error('Error saving conversation:', error);
            }
        }

        function loadConversation(stage, questionId) {
            try {
                const key = localStorage.getItem('encryption_key');
                if (!key) return null;
                
                const encrypted = localStorage.getItem(`conversation_${stage}_${questionId}`);
                if (!encrypted) return null;
                
                return decrypt(encrypted, key);
            } catch (error) {
                console.error('Error loading conversation:', error);
                return null;
            }
        }

        function clearConversation(stage, questionId) {
            try {
                localStorage.removeItem(`conversation_${stage}_${questionId}`);
            } catch (error) {
                console.error('Error clearing conversation:', error);
            }
        }

        // ëŒ€í™”í˜• AI í”¼ë“œë°± í•¨ìˆ˜
        async function handleConversationalAI(stage, questionId, userInput, concept = null) {
            try {
                const conversationHistory = loadConversation(stage, questionId) || [];
                const key = localStorage.getItem('encryption_key') || setupEncryption();
                
                // ì‚¬ìš©ì ì…ë ¥ ì €ì¥
                const userMessage = {
                    role: 'user',
                    content: userInput,
                    timestamp: Date.now()
                };
                conversationHistory.push(userMessage);
                
                // AI ì‘ë‹µ ìƒì„±
                let prompt = '';
                if (concept) {
                    // ê°œë… ì •ì˜ì™€ í•µì‹¬ ì²™ë„ ëª‡ ê°œë§Œ ì„ ë³„í•´ì„œ í¬í•¨
                    const conceptDefinitions = {};
                    
                    const conceptScales = scaleItems[concept] || [];
                    
                    const scaleText = conceptScales.length > 0 ? 
                        `\n\n${concept} (${conceptDefinitions[concept]})ì˜ ëª¨ë“  ì²™ë„ í•­ëª©ë“¤:
${conceptScales.map((item, idx) => `${idx + 1}. ${item}`).join('\n')}
ìœ„ ëª¨ë“  ì²™ë„ í•­ëª©ë“¤ì„ ì°¸ê³ í•´ì„œ ì‚¬ìš©ìì˜ êµ¬ì²´ì  ê²½í—˜ì„ íƒìƒ‰í•˜ëŠ” ìì—°ìŠ¤ëŸ¬ìš´ ì§ˆë¬¸ì„ í•´ì£¼ì„¸ìš”.` : '';
                    
                    prompt = `ì‚¬ìš©ìì™€ ${concept} ê´€ì ì—ì„œ ëŒ€í™”í˜•ìœ¼ë¡œ ìƒí˜¸ì‘ìš©í•´ì£¼ì„¸ìš”. 
ì‚¬ìš©ìì˜ ë‹µë³€ì„ ë“£ê³ , ë” ê¹Šì´ ìˆëŠ” ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•˜ì—¬ ìê¸° íƒìƒ‰ì„ ë•ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”.${scaleText}

ëŒ€í™” íˆìŠ¤í† ë¦¬:
${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

í˜„ì¬ ì‚¬ìš©ì ì…ë ¥: ${userInput}

${concept} ê°œë…ì— ë§ëŠ” ë‹¤ìŒ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.`;
                } else {
                    prompt = `ì‚¬ìš©ìì™€ ëŒ€í™”í˜•ìœ¼ë¡œ ìƒí˜¸ì‘ìš©í•´ì£¼ì„¸ìš”. 
ì‚¬ìš©ìì˜ ë‹µë³€ì„ ë“£ê³ , ë” ê¹Šì´ ìˆëŠ” ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•˜ì—¬ ìê¸° íƒìƒ‰ì„ ë•ëŠ” ëŒ€í™”ë¥¼ ì´ì–´ê°€ì„¸ìš”.

ëŒ€í™” íˆìŠ¤í† ë¦¬:
${conversationHistory.map(msg => `${msg.role}: ${msg.content}`).join('\n')}

í˜„ì¬ ì‚¬ìš©ì ì…ë ¥: ${userInput}

ë‹¤ìŒ ì§ˆë¬¸ì´ë‚˜ í”¼ë“œë°±ì„ ì œê³µí•´ì£¼ì„¸ìš”.`;
                }
                
                const messages = [{ role: 'user', content: prompt }];
                const url = "http://127.0.0.1:5000/gemini";
                const body = JSON.stringify({ messages, temperature: 0.7, max_tokens: 500 });
                const response = await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body });
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const aiMessage = {
                    role: 'assistant',
                    content: data.content || "AI ì‘ë‹µ ì—†ìŒ",
                    timestamp: Date.now()
                };
                
                conversationHistory.push(aiMessage);
                saveConversation(stage, questionId, conversationHistory);
                
                return aiMessage.content;
            } catch (error) {
                console.error('AI ëŒ€í™” ì˜¤ë¥˜:', error);
                return "AI ì‘ë‹µì„ ë°›ì•„ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // ì´ ì •ì˜ë“¤ì€ ì½”ë“œ ë‚´ë¶€ì—ì„œë§Œ ì°¸ê³ í•˜ë©°, í™”ë©´(UI)ì—ëŠ” ë…¸ì¶œë˜ì§€ ì•ŠìŒ



        // ìœ¤ë¦¬ê°•ë ¹ ë° ì‘ë‹µ ì •ì±… (ìµœìš°ì„  ì ìš©)
        const ETHICS_CODE = {
            ethics_rules: {
                professionalism: [
                    "ì—­ëŸ‰ê³¼ í•œê³„ë¥¼ ë„˜ì–´ì„œëŠ” ì¡°ì–¸Â·íŒì • ê¸ˆì§€, ì˜ì‹¬ ì‹œ ì „ë¬¸ ìë¬¸ ê¶Œê³ ",
                    "ë‚´ë‹´ìì˜ ë³µì§€ì™€ ì•ˆì „ì„ ê¸°ê´€Â·ê°œì¸ ì´ìµë³´ë‹¤ ìš°ì„ ",
                    "ì„±ë³„, ì—°ë ¹, ì¥ì• , ë¬¸í™”, ì¢…êµ, ì„±ì  ì§€í–¥ ë“± ì–´ë–¤ ì´ìœ ë¡œë„ ì°¨ë³„ ê¸ˆì§€",
                    "ê°œì¸ì  ê°€ì¹˜Â·ì‹ ë… ê°•ìš” ê¸ˆì§€",
                    "ìƒë‹´ ì˜ì¡´ì„± ì¡°ì¥ ê¸ˆì§€ â€” ììœ¨ì„± ê°•í™” ë°©í–¥"
                ],
                risk_handling: [
                    "ì/íƒ€í•´, ë¶ˆë²•í–‰ìœ„, ì¤‘ë… ì•…í™”, ì„±ì  ì°©ì·¨, í­ë ¥ ë“±ì€ ì¦‰ì‹œ ì•ˆì „ ì•ˆë‚´ì™€ ì „ë¬¸ê¸°ê´€ ì˜ë¢°",
                    "ìœ„í—˜í–‰ë™ì€ ê¸ì •ì  ì¬í•´ì„ ê¸ˆì§€, ëŒ€ì‹  êµí›ˆÂ·ëŒ€ì•ˆ ì¤‘ì‹¬ ì˜ë¯¸ ì¬êµ¬ì„±",
                    "ë‹¤ì¤‘ê´€ê³„Â·ì„±ì  ê´€ê³„Â·ê¸ˆì „ ê±°ë˜Â·ì°©ì·¨ í–‰ìœ„ ê¸ˆì§€"
                ],
                confidentiality: [
                    "ë‚´ë‹´ì ê°œì¸ì •ë³´Â·ê¸°ë¡ì€ ë¹„ì‹ë³„í™” í›„ ì‚¬ìš©, ë™ì˜ ì—†ëŠ” ê³µê°œ ê¸ˆì§€",
                    "ë¹„ë°€ë³´í˜¸ í•œê³„(ì/íƒ€í•´ ìœ„í—˜, ë²•ì  ìš”êµ¬)ëŠ” ìµœì†Œí•œ ë²”ìœ„ì—ì„œë§Œ ê³µê°œ, ì‚¬ì „Â·ì‚¬í›„ ê³ ì§€"
                ],
                assessment_feedback: [
                    "ê²€ì¦ëœ ë„êµ¬ë§Œ ì‚¬ìš©, ê²°ê³¼ í•´ì„ ì‹œ ë¬¸í™”Â·í™˜ê²½ ê³ ë ¤",
                    "í‰ê°€Â·í”¼ë“œë°±ì€ êµìœ¡Â·ì¹˜ë£Œ ëª©ì  í•œì •, ì§„ë‹¨ í™•ì •ì€ ê¸ˆì§€"
                ],
                communication: [
                    "ìƒë‹´Â·í”„ë¡œê·¸ë¨ í™ë³´ ì‹œ ê³¼ì¥Â·í—ˆìœ„ ê¸ˆì§€, ê°•ìš” ê¸ˆì§€",
                    "ì°¸ì—¬ìì˜ ê¶Œë¦¬Â·ì„ íƒê¶Œ ë³´ì¥"
                ]
            },
            response_policy: {
                prohibited: [
                    "ìœ„í—˜í–‰ë™ ë¯¸í™”",
                    "ì°¨ë³„Â·í¸ê²¬ ë°œì–¸",
                    "ì§„ë‹¨ëª… í™•ì •",
                    "ê°•ì••ì  ì¡°ì–¸"
                ],
                allowed: [
                    "êµìœ¡ì  í”¼ë“œë°±",
                    "ìê°€ëŒë´„ ì œì•ˆ",
                    "ì˜ë¯¸ ì¬êµ¬ì„±",
                    "ì „ë¬¸ê¸°ê´€ ì˜ë¢°"
                ],
                required: [
                    "ìœ„í—˜ë„ í‰ê°€",
                    "ê³ ìœ„í—˜ ì‹œ ì•ˆì „ ì•ˆë‚´ ë° ëŒ€í™” ì¤‘ë‹¨",
                    "ì €Â·ì¤‘ìœ„í—˜ ì‹œ ê¸ì •ì  ì¬í‰ê°€ ë° ì§€ì›"
                ]
            }
        };



        // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ AI í”„ë¡¬í”„íŠ¸ ìƒì„± í•¨ìˆ˜
        function createEthicalPrompt(basePrompt, userInput, context = '') {
            const ethicsHeader = `ë‹¹ì‹ ì€ ì„ìƒì‹¬ë¦¬ì‚¬ì´ì ìƒë‹´ìì…ë‹ˆë‹¤. ë‹¤ìŒ ìœ¤ë¦¬ê°•ë ¹ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤:

**ì „ë¬¸ì„± ë° ì—­ëŸ‰**
- ì—­ëŸ‰ê³¼ í•œê³„ë¥¼ ë„˜ì–´ì„œëŠ” ì¡°ì–¸Â·íŒì • ê¸ˆì§€, ì˜ì‹¬ ì‹œ ì „ë¬¸ ìë¬¸ ê¶Œê³ 
- ë‚´ë‹´ìì˜ ë³µì§€ì™€ ì•ˆì „ì„ ê¸°ê´€Â·ê°œì¸ ì´ìµë³´ë‹¤ ìš°ì„ 
- ì„±ë³„, ì—°ë ¹, ì¥ì• , ë¬¸í™”, ì¢…êµ, ì„±ì  ì§€í–¥ ë“± ì–´ë–¤ ì´ìœ ë¡œë„ ì°¨ë³„ ê¸ˆì§€
- ê°œì¸ì  ê°€ì¹˜Â·ì‹ ë… ê°•ìš” ê¸ˆì§€
- ìƒë‹´ ì˜ì¡´ì„± ì¡°ì¥ ê¸ˆì§€ â€” ììœ¨ì„± ê°•í™” ë°©í–¥

**ìœ„í—˜ í–‰ë™ ì²˜ë¦¬**
- ì/íƒ€í•´, ë¶ˆë²•í–‰ìœ„, ì¤‘ë… ì•…í™”, ì„±ì  ì°©ì·¨, í­ë ¥ ë“±ì€ ì¦‰ì‹œ ì•ˆì „ ì•ˆë‚´ì™€ ì „ë¬¸ê¸°ê´€ ì˜ë¢°
- ìœ„í—˜í–‰ë™ì€ ê¸ì •ì  ì¬í•´ì„ ê¸ˆì§€, ëŒ€ì‹  êµí›ˆÂ·ëŒ€ì•ˆ ì¤‘ì‹¬ ì˜ë¯¸ ì¬êµ¬ì„±
- ë‹¤ì¤‘ê´€ê³„Â·ì„±ì  ê´€ê³„Â·ê¸ˆì „ ê±°ë˜Â·ì°©ì·¨ í–‰ìœ„ ê¸ˆì§€

**í‰ê°€ ë° í”¼ë“œë°±**
- ê²€ì¦ëœ ë„êµ¬ë§Œ ì‚¬ìš©, ê²°ê³¼ í•´ì„ ì‹œ ë¬¸í™”Â·í™˜ê²½ ê³ ë ¤
- í‰ê°€Â·í”¼ë“œë°±ì€ êµìœ¡Â·ì¹˜ë£Œ ëª©ì  í•œì •, ì§„ë‹¨ í™•ì •ì€ ê¸ˆì§€

**ì‘ë‹µ ì •ì±…**
- ê¸ˆì§€: ìœ„í—˜í–‰ë™ ë¯¸í™”, ì°¨ë³„Â·í¸ê²¬ ë°œì–¸, ì§„ë‹¨ëª… í™•ì •, ê°•ì••ì  ì¡°ì–¸
- í—ˆìš©: êµìœ¡ì  í”¼ë“œë°±, ìê°€ëŒë´„ ì œì•ˆ, ì˜ë¯¸ ì¬êµ¬ì„±, ì „ë¬¸ê¸°ê´€ ì˜ë¢°
- í•„ìˆ˜: ìœ„í—˜ë„ í‰ê°€, ê³ ìœ„í—˜ ì‹œ ì•ˆì „ ì•ˆë‚´ ë° ëŒ€í™” ì¤‘ë‹¨, ì €Â·ì¤‘ìœ„í—˜ ì‹œ ê¸ì •ì  ì¬í‰ê°€ ë° ì§€ì›

ìœ„ ìœ¤ë¦¬ê°•ë ¹ì„ ì¤€ìˆ˜í•˜ì—¬ ì‘ë‹µí•´ ì£¼ì„¸ìš”.`;

            return `${ethicsHeader}

${basePrompt}`;
        }

        // ìœ„í—˜ë„ í‰ê°€ í•¨ìˆ˜
        function assessRisk(userInput) {
            const highRiskKeywords = ['ìì‚´', 'ì£½ê³  ì‹¶ë‹¤', 'ì£½ì¼ ê²ƒì´ë‹¤', 'í­ë ¥', 'ì‚´ì¸', 'ê°•ê°„', 'ì„±í­ë ¥', 'ì•„ë™í•™ëŒ€', 'ê°€ì •í­ë ¥', 'ë§ˆì•½', 'ì•½ë¬¼', 'ë¶ˆë²•', 'ë²”ì£„'];
            const mediumRiskKeywords = ['ìš°ìš¸', 'ì ˆë§', 'ë¬´ê°€ì¹˜', 'ê³ ë¦½', 'ë¶„ë…¸', 'ë³µìˆ˜', 'ìí•´', 'ìƒì²˜', 'íŠ¸ë¼ìš°ë§ˆ'];
            
            const input = userInput.toLowerCase();
            const highRiskCount = highRiskKeywords.filter(keyword => input.includes(keyword)).length;
            const mediumRiskCount = mediumRiskKeywords.filter(keyword => input.includes(keyword)).length;
            
            if (highRiskCount > 0) return 'high';
            if (mediumRiskCount > 2) return 'medium';
            return 'low';
        }

        // ì•ˆì „ ì•ˆë‚´ ë©”ì‹œì§€ ìƒì„±
        function getSafetyMessage(riskLevel) {
            if (riskLevel === 'high') {
                return `âš ï¸ ì•ˆì „ ì£¼ì˜: ê·€í•˜ì˜ ì•ˆì „ì´ ìµœìš°ì„ ì…ë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.

ğŸ“ ê¸´ê¸‰ ì—°ë½ì²˜:
- ìì‚´ì˜ˆë°©ìƒë‹´ì „í™”: 1393
- ì •ì‹ ê±´ê°•ìƒë‹´ì „í™”: 1577-0199
- ê²½ì°°ì„œ: 112
- ì‘ê¸‰ì‹¤: 119

í˜„ì¬ ëŒ€í™”ë¥¼ ì¤‘ë‹¨í•˜ê³  ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.`;
            } else if (riskLevel === 'medium') {
                return `ğŸ’¡ ì•ˆì „ ì•ˆë‚´: í˜„ì¬ ìƒí™©ì— ëŒ€í•´ ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. ì •ì‹ ê±´ê°•ìƒë‹´ì „í™”(1577-0199)ë¥¼ ì´ìš©í•´ë³´ì„¸ìš”.`;
            }
            return '';
        }

        const STAGES = [
            {
                title: "1ë‹¨ê³„: ì£¼ì¸ê³µì˜ ì •ë³´ ì‘ì„±"
            },
            {
                title: "2ë‹¨ê³„: ê¸°íšì˜ë„ ì‘ì„±"
            },
            {
                title: "3ë‹¨ê³„: ì”¬(Scene) ë¦¬ìŠ¤íŠ¸ ì‘ì„±"
            },
            {
                title: "4ë‹¨ê³„: ì˜í™” ì œëª© ì§“ê¸°",
                prompt: `ì´ ëª¨ë“  ì—¬ì •ì„ ì˜í™”ë‚˜ ë“œë¼ë§ˆ ì œëª©ìœ¼ë¡œ ë‚˜íƒ€ë‚¸ë‹¤ë©´ ë­ë¼ê³  í•  ìˆ˜ ìˆì„ê¹Œìš”?`
            }
        ];

        // 1ë‹¨ê³„~4ë‹¨ê³„ í•­ëª© ë¶„ë¦¬ (í”„ë¡¬í”„íŠ¸ì— ë°”ë¡œ ì‘ì„±)
        const STAGE_FIELDS = [
            [
                'ì´ë¦„', 'ì„±ë³„', 'ì—°ë ¹', 'ì§ì—…', 'ì„±ê²©ì  íŠ¹ì„±', 'ê°€ì¡± êµ¬ì„±(ì•„ë²„ì§€, ì–´ë¨¸ë‹ˆ, í˜•ì œìë§¤ ë“±)',
                'ì£¼ì¸ê³µì—ê²Œ ì •ì„œì ìœ¼ë¡œ ì˜í–¥ì„ ë¯¸ì¹œ ì¸ë¬¼',
                'ì¹œêµ¬ í˜¹ì€ ì§€ì§€ì'
            ],
            [
                'ê¸°íšì˜ë„',
                '1. ì£¼ì¸ê³µì´ í˜„ì¬ ê²ªê³  ìˆëŠ” ìƒí™©ì´ë‚˜ ì–´ë ¤ì›€ì€ ë¬´ì—‡ì¸ê°€ìš”?',
                '2. ê·¸ ìƒí™©ì—ì„œ ì£¼ì¸ê³µì€ ì–´ë–¤ ê°ì •ì„ ëŠë¼ê³  ìˆë‚˜ìš”?',
                '3. ê·¸ ê²½í—˜ì„ í†µí•´ ì£¼ì¸ê³µì€ ë¬´ì—‡ì„ ë°°ìš°ê±°ë‚˜ ê¹¨ë‹¬ì•˜ë‚˜ìš”?'
            ],

            [
                'ì£¼ì œ',
                // ìŠ¤í† ë¦¬ë³´ë“œ: [{title, desc, lines}] ê°ì²´ ë°°ì—´
                { label: 'ì¥ë©´ ì œëª©', key: 'title' },
                { label: 'ì¥ë©´ ì„¤ëª…', key: 'desc' },
                { label: 'ì£¼ìš” ëŒ€ì‚¬ ë° í–‰ë™', key: 'lines' }
            ],
            [
                'ì˜í™” ì œëª©'
            ]
        ];

        // responsesë¥¼ 2ì°¨ì› ë°°ì—´ë¡œ í™•ì¥ (ìŠ¤í† ë¦¬ë³´ë“œëŠ” ê°ì²´ ë°°ì—´)
        let responses = [
            STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""],
            STAGE_FIELDS[1].length ? Array(STAGE_FIELDS[1].length).fill("") : [""],
            STAGE_FIELDS[2].length ? Array(STAGE_FIELDS[2].length).fill("") : [""],
            ["", "", []] // 4ë‹¨ê³„: ì£¼ì œ, ìŠ¤í† ë¦¬ë³´ë“œ ë°°ì—´
        ];

        let currentIndex = 0;
        let loadingMindmap = false;
        let programMounted = false; // í”„ë¡œê·¸ë¨ UIê°€ í•œ ë²ˆì´ë¼ë„ ë Œë”ëœ ì ì´ ìˆëŠ”ì§€ í‘œì‹œ

        // ì§ˆë¬¸-ì‹¬ë¦¬í•™ ê°œë… ë§¤í•‘ ê°ì²´ (ì§ˆë¬¸ í…ìŠ¤íŠ¸ì™€ 100% ì¼ì¹˜)
        const questionToConcept = {
           
        };

        // ì²™ë„ í•­ëª©ë“¤ì„ AI í”„ë¡¬í”„íŠ¸ì— í¬í•¨ì‹œí‚¤ê¸° ìœ„í•œ ê°ì²´
        const scaleItems = {
        };

        // AI ì œì•ˆ/ì§ˆë¬¸ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ê° ì‹¬ë¦¬í•™ ê°œë…ë³„ ê¸°ë³¸ ì§ˆë¬¸
        const aiDefaultQuestions = {
        };

        // ì˜ˆì‹œ: 2ë‹¨ê³„(ìƒí™© íƒìƒ‰ ê´€ë ¨) ë‹µë³€ì„ ì €ì¥í•  ë•Œ í•´ë‹¹ ë‹µë³€ì´ ì–´ë–¤ ì‹¬ë¦¬í•™ ê°œë…ì— í•´ë‹¹í•˜ëŠ”ì§€ íƒœê¹…
        // responses[1] ë°°ì—´ì˜ ê° ë‹µë³€ì€ STAGE_FIELDS[1]ì˜ ê° ì§ˆë¬¸ì— ëŒ€ì‘
        function getConceptsForStage2Responses() {
            return STAGE_FIELDS[1].map((question, idx) => {
                const answer = responses[1][idx];
                const concept = questionToConcept[question];
                return { question, answer, concept };
            });
        }
        // ì‚¬ìš© ì˜ˆì‹œ: getConceptsForStage2Responses()ë¥¼ í˜¸ì¶œí•˜ë©´ ê° ë‹µë³€ì— ê°œë…ì´ ìë™ íƒœê¹…ëœ ë°°ì—´ ë°˜í™˜

        // DOM ìš”ì†Œë“¤
        const stageTitle = document.getElementById('stageTitle');
        const stagePrompt = document.getElementById('stagePrompt');
        const responseTextarea = document.getElementById('responseTextarea');
        const summaryBlocks = document.getElementById('summaryBlocks');
        const aiResults = document.getElementById('aiResults');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const suggestBtn = document.getElementById('suggestBtn');
        const programTitle = document.getElementById('programTitle');
        const programDesc = document.getElementById('programDesc');
        




        // AI API í˜¸ì¶œ ì „ ê°œì¸ì •ë³´ ë³´í˜¸ ê²€ì¦ í•¨ìˆ˜
        function validateAIRequest(messages, promptText) {
            // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë° ìƒë‹´ìœ¤ë¦¬ ì¤€ìˆ˜ ê²€ì¦
            if (!messages && !promptText) {
                console.warn('Privacy Check: No content to validate for AI request');
                return false;
            }
            
            let hasSensitiveInfo = false;
            let hasRiskContent = false;
            
            // ë©”ì‹œì§€ ë°°ì—´ ê²€ì¦
            if (messages && Array.isArray(messages)) {
                messages.forEach((msg, index) => {
                    if (msg.content && typeof msg.content === 'string') {
                        // ë¯¼ê°ì •ë³´ íŒ¨í„´ ê²€ì¶œ
                        const sensitivePatterns = [
                            /\b\d{6}-\d{7}\b/g,  // ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸
                            /\b\d{3}-\d{3,4}-\d{4}\b/g,  // ì „í™”ë²ˆí˜¸
                            /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,  // ì´ë©”ì¼
                            /\b\d{5,6}\b/g,  // ìš°í¸ë²ˆí˜¸
                            /\b(ì„œìš¸|ë¶€ì‚°|ëŒ€êµ¬|ì¸ì²œ|ê´‘ì£¼|ëŒ€ì „|ìš¸ì‚°|ì„¸ì¢…|ê²½ê¸°|ê°•ì›|ì¶©ë¶|ì¶©ë‚¨|ì „ë¶|ì „ë‚¨|ê²½ë¶|ê²½ë‚¨|ì œì£¼)\b/g,  // ì§€ì—­ëª…
                            /\b(íšŒì‚¬|í•™êµ|ë³‘ì›|ì€í–‰|ê¸°ê´€|ë‹¨ì²´|ì¡°ì§)\b/g  // ê¸°ê´€ëª…
                        ];
                        
                        sensitivePatterns.forEach(pattern => {
                            if (pattern.test(msg.content)) {
                                hasSensitiveInfo = true;
                                console.warn(`Privacy Check: Sensitive info detected in message ${index}`);
                            }
                        });
                        
                        // ìœ„í—˜ ì‹ í˜¸ ê²€ì¶œ (ìƒë‹´ìœ¤ë¦¬)
                        const riskPatterns = [
                            /\b(ìì‚´|ìí•´|ì£½ê³ |ì£½ì–´|ëë‚´|í•´ì¹˜|í•´ì¹˜ê² |ìœ„í—˜|í­ë ¥|í•™ëŒ€)\b/g,
                            /\b(ì°¨ë¼ë¦¬|ê·¸ë§Œ|ë”ëŠ”|ëª»ì‚´ê² |í˜ë“¤ì–´|ê´´ë¡œì›Œ)\b/g
                        ];
                        
                        riskPatterns.forEach(pattern => {
                            if (pattern.test(msg.content)) {
                                hasRiskContent = true;
                                console.warn(`Ethics Check: Risk content detected in message ${index}`);
                            }
                        });
                    }
                });
            }
            // í”„ë¡¬í”„íŠ¸ í…ìŠ¤íŠ¸ ê²€ì¦
            if (promptText && typeof promptText === 'string') {
                const sensitivePatterns = [
                    /\b\d{6}-\d{7}\b/g,
                    /\b\d{3}-\d{3,4}-\d{4}\b/g,
                    /\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,
                    /\b\d{5,6}\b/g
                ];
                
                sensitivePatterns.forEach(pattern => {
                    if (pattern.test(promptText)) {
                        hasSensitiveInfo = true;
                        console.warn('Privacy Check: Sensitive info detected in prompt text');
                    }
                });
            }
            
            // ê²€ì¦ ê²°ê³¼ì— ë”°ë¥¸ ì²˜ë¦¬
            if (hasSensitiveInfo) {
                console.error('Privacy Check: AI request blocked due to sensitive information');
                return false;
            }
            
            if (hasRiskContent) {
                // ìœ„í—˜ ì‹ í˜¸ ê°ì§€ ì‹œ ë¡œê·¸ ê¸°ë¡
                const riskLog = {
                    timestamp: Date.now(),
                    type: 'ai_request_risk_detected',
                    riskLevel: 'high',
                    action: 'ai_request_allowed_with_caution'
                };
                console.warn('Risk Assessment for AI Request:', riskLog);
            }
            
            return true;
        }

        // AI API í˜¸ì¶œ í•¨ìˆ˜ (openai/gemini ì„ íƒ)
        async function callAICompletion(_apiKey, messages, mode = 'gemini', promptText = '') {
            try {
                // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìƒë‹´ìœ¤ë¦¬ ê²€ì¦
                if (!validateAIRequest(messages, promptText)) {
                    console.error('Privacy Check: AI request validation failed');
                    return "ê°œì¸ì •ë³´ ë³´í˜¸ë¥¼ ìœ„í•´ ìš”ì²­ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¼ê°í•œ ì •ë³´ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ ì£¼ì„¸ìš”.";
                }
                
                const temperature = 0.5;
                
                let url, body;
                if (mode === 'openai') {
                    url = "http://localhost:5000/openai";
                    body = JSON.stringify({
                        prompt: promptText,
                        max_tokens: 1000
                    });
                } else {
                    url = "http://127.0.0.1:5000/gemini";
                    body = JSON.stringify({
                        messages,
                        temperature: temperature,
                        max_tokens: 1000
                    });
                }
                
                // AI ìš”ì²­ ì „ ìµœì¢… ê°œì¸ì •ë³´ ë³´í˜¸ í™•ì¸
                console.log('Privacy Check: AI request validated and proceeding');
                
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body
                });
                const data = await response.json();
                if (data.error) return `AI ì˜¤ë¥˜: ${data.error}`;
                
                const aiResponse = data.content || "AI ì‘ë‹µ ì—†ìŒ";
                return aiResponse;
            } catch (error) {
                console.error('AI API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                return "AI ì‘ë‹µì„ ë°›ì•„ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // í˜„ì¬ ë‹¨ê³„ ì—…ë°ì´íŠ¸
        function updateStage() {
            stageTitle.textContent = STAGES[currentIndex].title;
            
            // í”„ë¡¬í”„íŠ¸ ë™ì  ë³€ê²½
            let currentPrompt = STAGES[currentIndex].prompt;
            
            if (!currentPrompt) {
                stagePrompt.innerHTML = '';
                stagePrompt.style.display = 'none';
            } else {
                stagePrompt.innerHTML = currentPrompt;
                stagePrompt.style.display = 'block';
            }
            
            loadStepData(currentIndex);
            renderTextareas();
            updateProgress();
            prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';
            if (currentIndex < STAGES.length - 1) {
                nextBtn.textContent = 'ë‹¤ìŒ â†’';
            } else {
                nextBtn.textContent = 'ì™„ë£Œ';
            }
            
            // 1, 2, 3, 4ë‹¨ê³„ì—ì„œëŠ” AI ì œì•ˆ/ì§ˆë¬¸ ì ‘ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (currentIndex === 0 || currentIndex === 1 || currentIndex === 2 || currentIndex === 3) {
                const suggestBtn = document.getElementById('suggestBtn');
                if (suggestBtn) suggestBtn.style.display = 'none';
                
            } else {
                const suggestBtn = document.getElementById('suggestBtn');
                if (suggestBtn) suggestBtn.style.display = '';
                const aiResults = document.getElementById('aiResults');
                if (aiResults) aiResults.style.display = '';
            }
            
            
        }

        // ì§„í–‰ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProgress() {
            for (let i = 0; i < STAGES.length; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    if (i < currentIndex) {
                        step.classList.add('completed');
                    } else if (i === currentIndex) {
                        step.classList.add('active');
                    }
                }
            }
            // ì§„í–‰ ìƒíƒœ í‘œì‹œë¥¼ STAGES.lengthê¹Œì§€ë§Œ ë³´ì´ê²Œ
            for (let i = STAGES.length; i < 5; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) step.style.display = 'none';
            }
        }

        

        // AI ì œì•ˆ/ì§ˆë¬¸ ì²˜ë¦¬ (í”„ë¡¬í”„íŠ¸ ë³´ê°•)
        async function handleAISuggestion() {
            // 3ë‹¨ê³„(ì‹œë†‰ì‹œìŠ¤/ìŠ¤í† ë¦¬ë³´ë“œ)ì—ì„œ ê³µí†µ ëŒ€ì‚¬ ì œì•ˆ ì•ˆë‚´ë¬¸ ë¶„ê¸° ì œê±°
            // ê¸°ì¡´: if (currentIndex === 2) { ... return; }
            // ì´í•˜ ê¸°ì¡´ ë¡œì§ ìœ ì§€
            // 1ë‹¨ê³„ì—ì„œ ëª¨ë“  ì…ë ¥ê°’ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì•ˆë‚´ë¬¸êµ¬ë¥¼ ë²„íŠ¼ ì•„ë˜ì— í‘œì‹œ
            if (currentIndex === 0 && responses[0].every(v => !v.trim())) {
                document.getElementById('emptyGuideMsg')?.remove();
                const guideMsg = document.createElement('div');
                guideMsg.id = 'emptyGuideMsg';
                guideMsg.className = 'input-guide';
                guideMsg.textContent = 'ë³¸ì¸ì˜ ì¸ì  ì‚¬í•­, ì„±ê²©ì  íŠ¹ì„±, ì£¼ë³€ì¸ë“¤ì„ ìƒê°í•´ë³´ì„¸ìš”.';
                document.getElementById('suggestBtn').after(guideMsg);
                return;
            } else if (currentIndex === 0) {
                document.getElementById('emptyGuideMsg')?.remove();
            }
            // responses ì „ì²´(ê° ë‹¨ê³„ ìš”ì•½) í†µí•©
            const hasContent = responses.some(r => r.some(item => item.trim()));
            if (!hasContent) {
                alert('AI ì œì•ˆ/ì§ˆë¬¸ì„ ìƒì„±í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ê¸°ì¡´ summary-block(ì œì•ˆ/ì§ˆë¬¸) ëª¨ë‘ ì‚­ì œ (ì¤‘ë³µ ë°©ì§€)
            document.querySelectorAll('.summary-block').forEach(e => e.remove());

            // ì´ì „ ë‹¨ê³„ ì…ë ¥ì„ ëª¨ë‘ ëª¨ìŒ (í˜„ì¬ ë‹¨ê³„ê¹Œì§€)
            const previousInputs = responses.slice(0, currentIndex + 1)
                .map((r, i) => `ë‹¨ê³„${i+1}: ${r.filter(item => item.trim()).join('\n\n')}`)
                .join('\n\n');

            // ê°ˆë“± ìœ í˜•ë³„ í”„ë¡¬í”„íŠ¸ (êµ¬/ì ˆ ì œí•œ ì—†ì´ ì „ì²´ ì…ë ¥ ì‚¬ìš©)
            let prompt = '';
            let items = [];
                            let labels = [];
            if (currentIndex === 1) {

                prompt = `1ë‹¨ê³„ì™€ 2ë‹¨ê³„ì—ì„œ ì…ë ¥ëœ ëª¨ë“  ì •ë³´ë¥¼ ì°¸ê³ í•´ì„œ\nì „ì²´ ì…ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ í•´ì£¼ì„¸ìš”.\n\nì „ì²´ ì…ë ¥:\n${previousInputs}`;
                // ê¸°ì¡´ LLM í˜¸ì¶œ ë° ë¶„ë¦¬ ë¡œì§ ìœ ì§€
                const messages = [
                    { role: "system", content: `ë„ˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸° ì¹˜ë£Œë¥¼ ë•ëŠ” AI ì¡°ë ¥ìì•¼. ìœ ì €ì˜ ì…ë ¥ì„ ì°¸ê³ í•´ì„œ ë‹¤ìŒ ë‹¨ê³„ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ í•´ì¤˜.` },
                    { role: "user", content: prompt }
                ];
                const suggestBtn = document.getElementById('suggestBtn');
                suggestBtn.textContent = 'ìƒì„± ì¤‘...';
                suggestBtn.disabled = true;
                const suggestion = await callAICompletion(null, messages, 'gemini');
                // ë¶„ë¦¬
                if (/1[).\-\s]/.test(suggestion) && /2[).\-\s]/.test(suggestion) && /3[).\-\s]/.test(suggestion)) {
                    items = suggestion.split(/\n?\s*\d[).\-\s]/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('\\n')) {
                    items = suggestion.split(/\\n+/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('- ')) {
                    items = suggestion.split(/- /).map(s => s.trim()).filter(Boolean);
                } else {
                    items = [suggestion.trim()];
                }
                // ì¤‘ë³µ ì œê±°
                items = items.filter((item, idx, arr) => item && arr.indexOf(item) === idx);
                while (items.length < 3) items.push('');
                items = items.slice(0, 3);
            } else if (currentIndex === 2) {
                prompt = `3ë‹¨ê³„ ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±ì„ ìœ„í•œ ì§ˆë¬¸ì„ ìƒì„±í•´ì£¼ì„¸ìš”.\n\nì‚¬ìš©ìì˜ ì…ë ¥ì„ ë°”íƒ•ìœ¼ë¡œ ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;
                // ê¸°ì¡´ LLM í˜¸ì¶œ ë° ë¶„ë¦¬ ë¡œì§ ìœ ì§€
                const messages = [
                    { role: "system", content: `ë„ˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸° ì¹˜ë£Œë¥¼ ë•ëŠ” AI ì¡°ë ¥ìì•¼. ìœ ì €ì˜ ì…ë ¥ì„ ì°¸ê³ í•´ì„œ ë‹¤ìŒ ë‹¨ê³„ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ í•´ì¤˜.` },
                    { role: "user", content: prompt }
                ];
                const suggestBtn = document.getElementById('suggestBtn');
                suggestBtn.textContent = 'ìƒì„± ì¤‘...';
                suggestBtn.disabled = true;
                const suggestion = await callAICompletion(null, messages, 'gemini');
                // ë¶„ë¦¬
                if (/1[).\-\s]/.test(suggestion) && /2[).\-\s]/.test(suggestion)) {
                    items = suggestion.split(/\n?\s*\d[).\-\s]/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('\\n')) {
                    items = suggestion.split(/\\n+/).map(s => s.trim()).filter(Boolean);
                } else if (suggestion.includes('- ')) {
                    items = suggestion.split(/- /).map(s => s.trim()).filter(Boolean);
                } else {
                    items = [suggestion.trim()];
                }
                // ì¤‘ë³µ ì œê±°
                items = items.filter((item, idx, arr) => item && arr.indexOf(item) === idx);
                while (items.length < 2) items.push('');
                items = items.slice(0, 2);
            } else {
                // ê°„ë‹¨í•œ AI ì œì•ˆ ìƒì„±
                const prompt = `${previousInputs}

ìœ„ ë‚´ìš©ì„ ë°”íƒ•ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.`;

                try {
                    const messages = [
                        { role: "system", content: `ë„ˆëŠ” ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸° ì¹˜ë£Œë¥¼ ë•ëŠ” AI ì¡°ë ¥ìì•¼. ë‹¤ìŒ ë‹¨ê³„ì— ë„ì›€ì´ ë  ë§Œí•œ ì§ˆë¬¸ì´ë‚˜ ì œì•ˆì„ ë§Œë“¤ì–´ì¤˜.` },
                        { role: "user", content: prompt }
                    ];
                    
                    const suggestion = await callAICompletion(null, messages, 'gemini');
                    items = [suggestion.trim()];
                } catch (error) {
                    items = ['AI ì œì•ˆì„ ìƒì„±í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'];
                }
            }
            // í™”ë©´ì— ì œì•ˆ/ì§ˆë¬¸ í‘œì‹œ
            const suggestionBlock = document.createElement('div');
            suggestionBlock.className = 'summary-block';
            suggestionBlock.innerHTML = `
                <strong>ğŸ¤– AI ì œì•ˆ/ì§ˆë¬¸</strong>
                <ul style='margin:0;padding-left:1.2em;'>
                    ${items.map((item, i) => `<li><b>${labels[i]||''}:</b> ${item || "<span style=\"color:#aaa\">ì§ˆë¬¸/ì œì•ˆ ì—†ìŒ</span>"}</li>`).join('')}
                </ul>
            `;
            aiResults.appendChild(suggestionBlock);
            suggestBtn.textContent = 'AI ì œì•ˆ/ì§ˆë¬¸ ì ‘ê¸°';
            suggestBtn.disabled = false;
            suggestBtn.dataset.open = 'true';
        }

        // í† ê¸€í˜• ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½
        document.getElementById('suggestBtn').addEventListener('click', async function() {
            const suggestBtn = document.getElementById('suggestBtn');
            if (suggestBtn.dataset.open === 'true') {
                // ì ‘ê¸°
                document.querySelectorAll('.summary-block').forEach(e => e.remove());
                suggestBtn.textContent = 'AI ì œì•ˆ/ì§ˆë¬¸ í¼ì¹˜ê¸°';
                suggestBtn.dataset.open = 'false';
            } else {
                // í¼ì¹˜ê¸°(ë§¤ë²ˆ ìƒˆë¡œ ìƒì„±)
                await handleAISuggestion();
            }
        });

        // ë‹¨ê³„ë³„ ì €ì¥ í•¨ìˆ˜
        function saveStepData(stepIdx) {
            // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìƒë‹´ìœ¤ë¦¬ ê²€ì¦
            const stepData = responses[stepIdx];
            if (!stepData) {
                console.warn('Privacy Check: No step data to save');
                return;
            }
            
            // ë¯¼ê°ì •ë³´ ê²€ì¶œ ë° ê°€ëª…ì²˜ë¦¬
            const sanitizedData = validatePrivacyAndEthics(stepData);
            if (sanitizedData) {
                localStorage.setItem('scenario_step_' + stepIdx, JSON.stringify(sanitizedData));
                console.log(`Privacy Check: Step ${stepIdx} data saved with validation`);
            } else {
                console.error('Privacy validation failed for step data');
            }
        }
        // ë‹¨ê³„ë³„ ë¶ˆëŸ¬ì˜¤ê¸° í•¨ìˆ˜
        function loadStepData(stepIdx) {
            const data = localStorage.getItem('scenario_step_' + stepIdx);
            if (data) {
                if (stepIdx === 3) {
                    responses[3] = JSON.parse(data);
                } else {
                    responses[stepIdx] = JSON.parse(data);
                }
            }
        }

        // 5ë‹¨ê³„ì—ì„œë§Œ ë²„íŠ¼ ë³´ì´ê²Œ
        function renderTextareas() {
            document.getElementById('customTextareas')?.remove();
            responseTextarea.style.display = 'none';
            let html = '';
            const containerDiv = document.createElement('div');
            containerDiv.id = 'customTextareas';

            if (currentIndex === 0) {
                responseTextarea.style.display = 'none';
                
                // STAGE_FIELDS[0] ê¸°ë°˜ ë™ì  ë Œë”ë§ìœ¼ë¡œ ì „í™˜ (í•˜ë“œì½”ë”© UI ìš°íšŒ)
                STAGE_FIELDS[0].forEach((label, idx) => {
                    const value = (responses[0] && typeof responses[0][idx] === 'string') ? responses[0][idx] : '';
                    html += `<div style='margin-bottom:1em;'>
                        <label style='font-weight:bold;'>${label}</label><br/>
                        <input data-field-idx='${idx}' value='${value.replace(/`/g, "&#96;").replace(/\\/g, "\\\\").replace(/"/g, '&quot;')}' style='width:100%;min-height:38px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;'/>
                    </div>`;
                });
                containerDiv.innerHTML = html;
                setTimeout(() => {
                    const inputs = containerDiv.querySelectorAll('input[data-field-idx]');
                    inputs.forEach(input => {
                        input.addEventListener('input', function() {
                            const i = parseInt(this.getAttribute('data-field-idx'));
                            if (!responses[0] || !Array.isArray(responses[0])) {
                                responses[0] = STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""];
                            }
                            responses[0][i] = this.value;
                        });
                    });
                }, 0);
                containerDiv && responseTextarea.parentNode.insertBefore(containerDiv, responseTextarea);
                programMounted = true; // í•œ ë²ˆì´ë¼ë„ UIê°€ ë Œë”ëìŒì„ í‘œì‹œ
                return;
                
                // 1ë‹¨ê³„ì— ì”¬ ë¸Œë ˆì´í¬ë‹¤ìš´ë§Œ í‘œì‹œ (ì´í•˜ëŠ” ìš°íšŒë¨)
                html += `<h2 style='margin-top:2em;margin-bottom:1em;'>ì‹œë‚˜ë¦¬ì˜¤ ì”¬ ë¸Œë ˆì´í¬ë‹¤ìš´</h2>`;
                html += `<table style='width:100%;border-collapse:collapse;margin-bottom:20px;'>`;
                html += `<thead><tr><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:12%;'>ì¥ë©´</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>ì£¼ì¸ê³µ(ì„±ë³„, ì—°ë ¹, ì„±ê²©)</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>ê°€ì¡± êµ¬ì„±</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>ì •ì„œì  ì˜í–¥ ì¸ë¬¼</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:15%;'>ì¹œêµ¬/ì§€ì§€ì</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:28%;'>ê° ì¸ë¬¼ ì£¼ìš” ëŒ€ì‚¬ ë° í–‰ë™</th><th style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;background-color:#f2f2f2;width:10%;'>ì‚­ì œ</th></tr></thead>`;
                html += `<tbody id='sceneTableBody'>`;
                html += `<tr><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;font-weight:bold;'>ì¥ë©´1</td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='1' data-type='protagonist' data-placeholder='ì£¼ì¸ê³µ ì •ë³´ ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='2' data-type='family' data-placeholder='ê°€ì¡± êµ¬ì„± ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='3' data-type='emotional' data-placeholder='ì •ì„œì  ì˜í–¥ ì¸ë¬¼ ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='4' data-type='support' data-placeholder='ì¹œêµ¬/ì§€ì§€ì ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='0' data-col='5' data-type='action-dialogue' data-placeholder='ê° ì¸ë¬¼ ì£¼ìš” ëŒ€ì‚¬ ë° í–‰ë™ ì…ë ¥'></td><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='0' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>ì‚­ì œ</button></td></tr>`;
                html += `<tr><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:top;font-weight:bold;'>ì¥ë©´2</td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='1' data-type='protagonist' data-placeholder='ì£¼ì¸ê³µ ì •ë³´ ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='2' data-type='family' data-placeholder='ê°€ì¡± êµ¬ì„± ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='3' data-type='emotional' data-placeholder='ì •ì„œì  ì˜í–¥ ì¸ë¬¼ ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='4' data-type='support' data-placeholder='ì¹œêµ¬/ì§€ì§€ì ì…ë ¥'></td><td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='1' data-col='5' data-type='action-dialogue' data-placeholder='ê° ì¸ë¬¼ ì£¼ìš” ëŒ€ì‚¬ ë° í–‰ë™ ì…ë ¥'></td><td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='1' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>ì‚­ì œ</button></td></tr>`;
                html += `</tbody></table>`;
                html += `<button id='addSceneBtn' style='padding:10px 15px;font-size:16px;cursor:pointer;border:1px solid #000;background-color:#1e3a8a;color:#fff;font-weight:bold;'>ì”¬ ì¶”ê°€</button>`;
                
                // Placeholder ìŠ¤íƒ€ì¼ ì¶”ê°€
                html += `<style>
                    [contenteditable="true"][data-placeholder]:empty:before {
                        content: attr(data-placeholder);
                        color: #999;
                        font-style: italic;
                        pointer-events: none;
                    }
                    [contenteditable="true"][data-placeholder]:focus:empty:before {
                        content: "";
                    }
                </style>`;
                
                containerDiv.innerHTML = html;
                
                // ì”¬ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                setTimeout(() => {
                    const addSceneBtn = containerDiv.querySelector('#addSceneBtn');
                    if (addSceneBtn) {
                        addSceneBtn.addEventListener('click', function() {
                            const tableBody = document.getElementById('sceneTableBody');
                            const newRow = document.createElement('tr');
                            const sceneNumber = tableBody.children.length + 1;
                            
                            newRow.innerHTML = `
                                <td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;font-weight:bold;'>ì¥ë©´${sceneNumber}</td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='1' data-type='protagonist' data-placeholder='ì£¼ì¸ê³µ ì •ë³´ ì…ë ¥'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='2' data-type='family' data-placeholder='ê°€ì¡± êµ¬ì„± ì…ë ¥'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='3' data-type='emotional' data-placeholder='ì •ì„œì  ì˜í–¥ ì¸ë¬¼ ì…ë ¥'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='4' data-type='support' data-placeholder='ì¹œêµ¬/ì§€ì§€ì ì…ë ¥'></td>
                                <td contenteditable='true' style='border:1px solid #000;padding:8px;text-align:left;vertical-align:top;min-height:60px;background-color:#fff;' data-row='${sceneNumber-1}' data-col='5' data-type='action-dialogue' data-placeholder='ê° ì¸ë¬¼ ì£¼ìš” ëŒ€ì‚¬ ë° í–‰ë™ ì…ë ¥'></td>
                                <td style='border:1px solid #000;padding:8px;text-align:center;vertical-align:middle;'><button class='deleteSceneBtn' data-row='${sceneNumber-1}' style='padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #dc2626;background-color:#dc2626;color:#fff;border-radius:4px;'>ì‚­ì œ</button></td>
                            `;
                            
                            tableBody.appendChild(newRow);
                            
                            // ìƒˆë¡œ ì¶”ê°€ëœ ì”¬ì˜ ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                            const newDeleteBtn = newRow.querySelector('.deleteSceneBtn');
                            if (newDeleteBtn) {
                                newDeleteBtn.addEventListener('click', function() {
                                    if (confirm('ì´ ì”¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                        newRow.remove();
                                        // ì¥ë©´ ë²ˆí˜¸ ì¬ì •ë ¬
                                        const remainingRows = tableBody.querySelectorAll('tr');
                                        remainingRows.forEach((row, index) => {
                                            const sceneCell = row.querySelector('td:first-child');
                                            if (sceneCell) {
                                                sceneCell.textContent = `ì¥ë©´${index + 1}`;
                                            }
                                            const deleteBtn = row.querySelector('.deleteSceneBtn');
                                            if (deleteBtn) {
                                                deleteBtn.setAttribute('data-row', index);
                                            }
                                        });
                            }
                        });
                    }
                });
            }
                }, 0);
                // ê¸°ì¡´ ì”¬ë“¤ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                setTimeout(() => {
                    const deleteBtns = containerDiv.querySelectorAll('.deleteSceneBtn');
                    deleteBtns.forEach(btn => {
                        btn.addEventListener('click', function() {
                            if (confirm('ì´ ì”¬ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                                const row = btn.closest('tr');
                                row.remove();
                                // ì¥ë©´ ë²ˆí˜¸ ì¬ì •ë ¬
                                const tableBody = document.getElementById('sceneTableBody');
                                const remainingRows = tableBody.querySelectorAll('tr');
                                remainingRows.forEach((row, index) => {
                                    const sceneCell = row.querySelector('td:first-child');
                                    if (sceneCell) {
                                        sceneCell.textContent = `ì¥ë©´${index + 1}`;
                                    }
                                    const deleteBtn = row.querySelector('.deleteSceneBtn');
                                    if (deleteBtn) {
                                        deleteBtn.setAttribute('data-row', index);
                                    }
                                });
                            }
                        });
                    });
                }, 0);
                
            } else if (currentIndex === 1) {
                // 2ë‹¨ê³„: ê¸°íšì˜ë„ ì‘ì„± (PHQ-9/1ë‹¨ê³„ ê¸°ë°˜)
                const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                const phq9Score = phq9Data && typeof phq9Data.score === 'number' ? phq9Data.score : 'ë¯¸í™•ì¸';
                const stage1Brief = (responses[0] || []).filter(v => typeof v === 'string' && v.trim()).slice(0,5).join(', ');
                // PHQ-9 ë¬¸í•­ë³„ ì ìˆ˜ ìƒì„¸ í‘œì‹œ
                let phq9Details = 'ë¯¸í™•ì¸';
                if (phq9Data && phq9Data.items && Array.isArray(phq9Data.items)) {
                    const phq9Items = [
                        'ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤',
                        'í‰ì†Œì— í•˜ë˜ ì¼ì— ëŒ€í•œ í¥ë¯¸ê°€ ì—†ì–´ì§€ê±°ë‚˜ ì¦ê±°ì›€ì„ ëŠë¼ì§€ ëª»í–ˆë‹¤',
                        'ì ë“¤ê¸° ì–´ë µê±°ë‚˜, ìì£¼ ê¹¨ê±°ë‚˜, ë„ˆë¬´ ë§ì´ ì¤ë‹¤',
                        'í”¼ê³¤í•˜ê±°ë‚˜ ê¸°ìš´ì´ ì—†ì—ˆë‹¤',
                        'ì‹ìš•ì´ ì—†ê±°ë‚˜, ë„ˆë¬´ ë§ì´ ë¨¹ì—ˆë‹¤',
                        'ìì‹ ì´ ì¢‹ì§€ ì•Šë‹¤ëŠ” ëŠë‚Œ, ë˜ëŠ” ìì‹ ì´ ì‹¤íŒ¨ìë¼ëŠ” ëŠë‚Œ, ë˜ëŠ” ìì‹ ì´ë‚˜ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ëŠ” ëŠë‚Œ',
                        'ì‹ ë¬¸ì„ ì½ê±°ë‚˜ TVë¥¼ ë³´ëŠ” ê²ƒê³¼ ê°™ì€ ì¼ìƒì ì¸ ì¼ì„ í•˜ëŠ”ë° ì–´ë ¤ì›€ì„ ê²ªì—ˆë‹¤',
                        'ì›€ì§ì„ì´ë‚˜ ë§í•˜ëŠ” ê²ƒì´ ëŠë ¤ì ¸ì„œ ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ëˆˆì¹˜ì±Œ ì •ë„ì˜€ë‹¤. ë˜ëŠ” ë°˜ëŒ€ë¡œ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆ ëª»í•´ì„œ ê°€ë§Œíˆ ì•‰ì•„ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤',
                        'ì°¨ë¼ë¦¬ ì£½ëŠ” ê²ƒì´ ë‚˜ì„ ê²ƒ ê°™ë‹¤ê³  ìƒê°í–ˆë‹¤. ë˜ëŠ” ìí•´í•  ìƒê°ì„ í–ˆë‹¤'
                    ];
                    
                    const nonZeroItems = phq9Data.items
                        .map((score, index) => ({ score, question: phq9Items[index] }))
                        .filter(item => item.score > 0)
                        .map(item => `${item.question}: ${item.score}ì `)
                        .join('\n');
                    
                    phq9Details = nonZeroItems || 'ëª¨ë“  ë¬¸í•­ 0ì ';
                }
                
                // 1ë‹¨ê³„ ê¸°ë³¸ ì •ë³´ ìš”ì•½
                const stage1Info = (responses[0] || []).filter(v => typeof v === 'string' && v.trim());
                const stage1Summary = stage1Info.length > 0 ? stage1Info.join(', ') : '1ë‹¨ê³„ ê¸°ë³¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.';
                

                STAGE_FIELDS[1].forEach((label, idx) => {
                    html += `<div style='margin-bottom:1em;display:flex;align-items:flex-start;gap:0.5em;'>
                        <div style='flex:1;'>
                            <label style='font-weight:bold;'>${label}</label><br/>
                            <textarea data-field-idx="${idx}" style='width:100%;min-height:160px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;resize:vertical;'>${responses[1][idx]}</textarea>
                            <div class='ai-suggest-area' data-field-idx='${idx}'></div>
                        </div>
                        <button type='button' class='ai-suggest-btn' data-field-idx='${idx}' style='height:40px;margin-top:2.2em;'>AI ì§€ì›</button>
                    </div>`;
                });
                containerDiv.innerHTML = html;
                // AI ì§€ì› ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                setTimeout(() => {
                    const aiSuggestBtns = containerDiv.querySelectorAll('.ai-suggest-btn');
                    aiSuggestBtns.forEach(btn => {
                        btn.addEventListener('click', async function() {
                            const idx = parseInt(btn.getAttribute('data-field-idx'));
                            const area = containerDiv.querySelector(`.ai-suggest-area[data-field-idx='${idx}']`);
                            const textarea = containerDiv.querySelector(`textarea[data-field-idx='${idx}']`);
                            if (!textarea || !area) return;
                            const userInput = textarea.value.trim();
                            if (currentIndex === 1) {
                                try {
                                    const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                                    const phq9Score = typeof phq9Data.score === 'number' ? phq9Data.score : null;
                                    let phq9Label = 'ë¯¸í™•ì¸';
                                    if (typeof getSeverityClass === 'function' && typeof phq9Score === 'number') {
                                        const sev = getSeverityClass(phq9Score);
                                        phq9Label = Array.isArray(sev) ? sev[0] : phq9Label;
                                    }

                                    const stage1Brief = (responses[0] || []).filter(v => typeof v === 'string' && v.trim()).slice(0,5).join(', ');
                                    area.innerHTML = `<div class='summary-block'>
                                        <strong>âœï¸ ê¸°íšì˜ë„ ì‘ì„± ê°€ì´ë“œ</strong>
                                        <ul style='margin:0;padding-left:1.2em;'>
                                                                            <li><b>PHQ-9 ìš”ì•½</b>: ${phq9Label}</li>
                                <li><b>ê¸°ë³¸ì •ë³´ ê¸°ë°˜ ëª©í‘œ</b>: ${stage1Brief ? stage1Brief : '1ë‹¨ê³„ ê¸°ë³¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.'}</li>
                                <li><b>í”„ë¡œê·¸ë¨ ì²´í—˜ ê°€ëŠ¥ ì—¬ë¶€</b>: ${(phq9Score >= 0 && phq9Score <= 14 && (phq9Items?.['9'] ?? 0) === 0) ? 'ê°€ëŠ¥ (0â€“14ì , 9ë²ˆ ë¬¸í•­ 0ì )' : 'ë¶ˆê°€ (ë²”ìœ„ ì™¸ ë˜ëŠ” 9ë²ˆ ë¬¸í•­ ì ìˆ˜ ìˆìŒ)'}</li>
                                        </ul>
                                    </div>`;
                                } catch (e) {
                                    area.innerHTML = `<div class='summary-block'>
                                        <strong>âœï¸ ê¸°íšì˜ë„ ì‘ì„± ê°€ì´ë“œ</strong>
                                        <ul style='margin:0;padding-left:1.2em;'>
                                                                            <li><b>PHQ-9 ìš”ì•½</b>: ë¯¸í™•ì¸</li>
                                <li><b>ê¸°ë³¸ì •ë³´ ê¸°ë°˜ ëª©í‘œ</b>: 1ë‹¨ê³„ ê¸°ë³¸ ì •ë³´ë¥¼ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.</li>
                                <li><b>í”„ë¡œê·¸ë¨ ì²´í—˜ ê°€ëŠ¥ ì—¬ë¶€</b>: PHQ-9 ê²€ì‚¬ ì™„ë£Œ í›„ í™•ì¸ ê°€ëŠ¥</li>
                                        </ul>
                                    </div>`;
                                }
                                return;
                            }
                            // ì˜ë¯¸ ìˆëŠ” í•œê¸€(ì™„ì„±í˜•) ë˜ëŠ” ì˜ë¬¸ ë‹¨ì–´ê°€ ìˆëŠ”ì§€ íŒë³„
                            const isValidWord = (str) => /([ê°€-í£]{2,}|[a-zA-Z]{2,})/.test(str);
                                        // ì…ë ¥ì´ ì—†ê±°ë‚˜ ì˜ë¯¸ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ ì§ˆë¬¸ ì•ˆë‚´
                            if (!userInput || !isValidWord(userInput)) {
                                let defaultQuestion = '';
                                // 2ë‹¨ê³„ ì§ˆë¬¸ë³„ íŠ¹ë³„í•œ ê¸°ë³¸ ì§ˆë¬¸
                                if (idx === 0) { // 1ë²ˆ ì§ˆë¬¸
                                    defaultQuestion = 'ì£¼ì¸ê³µì´ ê²ªê³  ìˆëŠ” ìƒí™©ì— ëŒ€í•´ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”.';
                                } else {
                                    // ê° ì‹¬ë¦¬í•™ì  ê°œë…ì— ë§ëŠ” ê¸°ë³¸ ì§ˆë¬¸ ìƒì„±
                                    const question = STAGE_FIELDS[1][idx];
                                    const concept = questionToConcept[question];
                                    
                                    if (concept && aiDefaultQuestions[concept]) {
                                        // í•´ë‹¹ ê°œë…ì˜ ê¸°ë³¸ ì§ˆë¬¸ ì‚¬ìš©
                                        defaultQuestion = aiDefaultQuestions[concept];
                                    } else {
                                        // ê¸°ë³¸ ì•ˆë‚´ ë©”ì‹œì§€
                                        defaultQuestion = 'ì´ ì§ˆë¬¸ì— ëŒ€í•´ ë” ìì„¸íˆ ë‹µë³€í•´ì£¼ì„¸ìš”.';
                                    }
                                }
                                
                                area.innerHTML = `<div style='margin-top:0.5em;background:#f8f9fa;padding:0.7em 1em;border-radius:6px;border:1px solid #d0d7de;font-size:0.97em;'>${defaultQuestion}</div>`;
                                return;
                            }
                            // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ ìœ„í—˜ë„ í‰ê°€ ë° ì•ˆì „ ì•ˆë‚´
                            const riskLevel = assessRisk(userInput);
                            const safetyMessage = getSafetyMessage(riskLevel);
                            
                            if (riskLevel === 'high') {
                                area.innerHTML = `<div style='margin-top:0.5em;background:#fff3cd;padding:0.7em 1em;border-radius:6px;border:1px solid #ffc107;font-size:0.97em;'>${safetyMessage}</div>`;
                                return;
                            }
                            
                            // ì˜ë¯¸ ìˆëŠ” ì–´ì ˆì´ ìˆìœ¼ë©´ LLM ë§ì¶¤ í”¼ë“œë°±
                            area.innerHTML = `<span style='color:#aaa'>AIê°€ ë‹µë³€ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</span>`;
                            // ì§ˆë¬¸ í…ìŠ¤íŠ¸ë¡œ ì‹¬ë¦¬í•™ ê°œë… ì°¾ê¸°
                            const question = STAGE_FIELDS[1][idx];
                            const concept = questionToConcept[question];
                            
                            // í•´ë‹¹ ê°œë…ì˜ ì²™ë„ í•­ëª©ë“¤ ì¤‘ì—ì„œ ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒí•˜ì—¬ ì¶”ê°€ ì§ˆë¬¸ìœ¼ë¡œ í¬í•¨
                            let additionalQuestion = '';
                            if (concept && scaleItems[concept]) {
                                const randomIndex = Math.floor(Math.random() * scaleItems[concept].length);
                                // ì²™ë„ ë¬¸ì¥ì„ ì§ì ‘ ì¸ìš©í•˜ì§€ ì•Šê³  ë°©í–¥ì„±ë§Œ ì œì‹œ
                                additionalQuestion = `\n\nì¶”ê°€ë¡œ ê³ ë ¤í•´ë³¼ ë°©í–¥: ì´ ë‹µë³€ê³¼ ê´€ë ¨í•˜ì—¬ ë” ê¹Šì´ íƒêµ¬í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì´ë‚˜ ê´€ì ì„ ì œì‹œí•´ ì£¼ì„¸ìš”.`;
                            }
                            
                            // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                            const basePrompt = `ì•„ë˜ëŠ” ì‚¬ìš©ìê°€ ìê¸° íƒìƒ‰ì„ ìœ„í•´ ì‘ì„±í•œ ë‹µë³€ì…ë‹ˆë‹¤.\në‹µë³€: ${userInput}\n\nì´ ë‹µë³€ì— ëŒ€í•´ í•œ ë¬¸ì¥ìœ¼ë¡œë§Œ ê°„ê²°í•œ í”¼ë“œë°±ì´ë‚˜ ì½”ì¹­ì„ ì œê³µí•´ ì£¼ì„¸ìš”. ë°˜ë“œì‹œ í•œ ë¬¸ì¥ìœ¼ë¡œ ëë‚´ì•¼ í•©ë‹ˆë‹¤.${additionalQuestion}`;
                            const prompt = createEthicalPrompt(basePrompt, userInput, 'Stage 2 ìƒí™© íƒìƒ‰');
                            try {
                                const messages = [
                                    { role: 'user', content: prompt }
                                ];
                                const url = "http://127.0.0.1:5000/gemini";
                                const body = JSON.stringify({ messages, temperature: 0.5, max_tokens: 500 });
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body
                });
                const data = await response.json();
                                if (data.error) {
                                    area.innerHTML = `<span style='color:#e74c3c'>AI ì˜¤ë¥˜: ${data.error}</span>`;
                                } else {
                                    // AI ì‘ë‹µì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ì œí•œ
                                    let aiResponse = data.content || "AI ì‘ë‹µ ì—†ìŒ";
                                    // ì²« ë²ˆì§¸ ë¬¸ì¥ë§Œ ì¶”ì¶œ (ë§ˆì¹¨í‘œ, ëŠë‚Œí‘œ, ë¬¼ìŒí‘œë¡œ êµ¬ë¶„)
                                    const firstSentence = aiResponse.match(/^[^.!?]+[.!?]/);
                                    if (firstSentence) {
                                        aiResponse = firstSentence[0];
                                    }
                                    area.innerHTML = `<div style='margin-top:0.5em;background:#f8f9fa;padding:0.7em 1em;border-radius:6px;border:1px solid #d0d7de;font-size:0.97em;'>ğŸ¤– <b>AI í”¼ë“œë°±</b><br/>${aiResponse}</div>`;
                                }
                            } catch (err) {
                                area.innerHTML = `<span style='color:#e74c3c'>AI ì‘ë‹µì„ ë°›ì•„ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>`;
                            }
                        });
                    });
                }, 0);
            } else if (currentIndex === 2) {
              
                
                containerDiv.innerHTML = html;
                
                // ì‹œë‚˜ë¦¬ì˜¤ í”„ë¡¬í”„íŠ¸ ìƒì„±ê¸° JavaScript ê¸°ëŠ¥ ì¶”ê°€
                setTimeout(() => {
                    let sceneCount = 1;
                    let showDeleteConfirm = true; // ì‚­ì œ í™•ì¸ ì°½ í‘œì‹œ ì—¬ë¶€
                    
                    // ì˜ˆì‹œ í† ê¸€ ë²„íŠ¼ ê¸°ëŠ¥ ì¶”ê°€ - ë” ì•ˆì •ì ì¸ ë°©ë²•ìœ¼ë¡œ êµ¬í˜„
                    const toggleExampleBtn = document.getElementById('toggle-example-btn');
                    const exampleContent = document.getElementById('example-content');
                    
                    if (toggleExampleBtn && exampleContent) {
                        toggleExampleBtn.addEventListener('click', function() {
                            if (exampleContent.style.display === 'none' || exampleContent.style.display === '') {
                                exampleContent.style.display = 'block';
                                toggleExampleBtn.textContent = 'ì˜ˆì‹œ ìˆ¨ê¸°ê¸°';
                                toggleExampleBtn.style.backgroundColor = '#dc3545';
            } else {
                                exampleContent.style.display = 'none';
                                toggleExampleBtn.textContent = 'ì˜ˆì‹œ ë³´ê¸°';
                                toggleExampleBtn.style.backgroundColor = '#6c757d';
                            }
                        });
                    }
                    
                    // ì¥ë©´ ì‚­ì œ í•¨ìˆ˜
                    function removeScene(sceneElement) {
                        // ë°©ì–´ì½”ë“œ: sceneElementê°€ ì˜¬ë°”ë¥¸ ì¹´ë“œ ìš”ì†Œê°€ ì•„ë‹ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë³´ì •
                        if (sceneElement && !(sceneElement.matches && sceneElement.matches('div[style*="border: 1px solid #ced4da"], .scene-card'))) {
                            const fallback = sceneElement.closest ? sceneElement.closest('div[style*="border: 1px solid #ced4da"], .scene-card') : null;
                            if (fallback) {
                                sceneElement = fallback;
                            }
                        }

                        if (showDeleteConfirm) {
                            // ì»¤ìŠ¤í…€ í™•ì¸ ì°½ ìƒì„±
                            const confirmDialog = document.createElement('div');
                            confirmDialog.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; justify-content: center; align-items: center;';
                            
                            confirmDialog.innerHTML = `
                                <div style="background: white; padding: 30px; border-radius: 10px; text-align: center; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                                    <h3 style="margin: 0 0 20px 0; color: #333;">ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</h3>
                                    <div style="margin-bottom: 20px;">
                                        <label style="display: flex; align-items: center; justify-content: center; cursor: pointer;">
                                            <input type="checkbox" id="dontShowAgain" style="margin-right: 8px;">
                                            <span>ë‹¤ì‹œ ì•ˆ ë³´ê¸°</span>
                                        </label>
                                    </div>
                                    <div style="display: flex; gap: 10px; justify-content: center;">
                                        <button id="confirmDelete" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ì‚­ì œ</button>
                                        <button id="cancelDelete" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold;">ì·¨ì†Œ</button>
                                    </div>
                                </div>
                            `;
                            
                            document.body.appendChild(confirmDialog);
                            
                            // ì‚­ì œ í™•ì¸
                            document.getElementById('confirmDelete').addEventListener('click', function() {
                                const dontShowAgain = document.getElementById('dontShowAgain').checked;
                                if (dontShowAgain) {
                                    showDeleteConfirm = false;
                                }
                                if (sceneElement && sceneElement.parentNode) {
                                    sceneElement.parentNode.removeChild(sceneElement);
            } else {
                                    console.warn('removeScene: ì‚­ì œ ëŒ€ìƒ ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                                }
                                if (confirmDialog && confirmDialog.parentNode) {
                                    confirmDialog.parentNode.removeChild(confirmDialog);
                                }
                                // ì‚­ì œ í›„ ì¥ë©´ ë²ˆí˜¸ ì¬ì •ë ¬
                                if (typeof renumberScenes === 'function') {
                                    renumberScenes();
                                }
                            });
                            
                            // ì·¨ì†Œ
                            document.getElementById('cancelDelete').addEventListener('click', function() {
                                if (confirmDialog && confirmDialog.parentNode) {
                                    confirmDialog.parentNode.removeChild(confirmDialog);
                                }
                            });
            } else {
                            // í™•ì¸ ì°½ ì—†ì´ ë°”ë¡œ ì‚­ì œ
                            if (sceneElement && sceneElement.parentNode) {
                                sceneElement.parentNode.removeChild(sceneElement);
                            } else {
                                console.warn('removeScene: ì‚­ì œ ëŒ€ìƒ ìš”ì†Œë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                            }
                            // ì‚­ì œ í›„ ì¥ë©´ ë²ˆí˜¸ ì¬ì •ë ¬
                            if (typeof renumberScenes === 'function') {
                                renumberScenes();
                            }
                        }
                    }

                    // ì¥ë©´ ë²ˆí˜¸ì™€ ê´€ë ¨ IDë¥¼ ì¬ì •ë ¬í•˜ëŠ” í•¨ìˆ˜
                    function renumberScenes() {
                        const container = document.getElementById('scene-container');
                        if (!container) return;
                        const cards = container.querySelectorAll('.scene-card');
                        cards.forEach((card, index) => {
                            const num = index + 1;
                            const header = card.querySelector('div[style*="font-size: 1.5rem"]');
                            if (header) header.textContent = 'ì¥ë©´ ' + num;
                            const removeBtn = card.querySelector('.remove-scene-btn');
                            if (removeBtn) removeBtn.setAttribute('data-scene-id', String(num));
                            const headingInput = card.querySelector('input[id^="scene-heading-"]');
                            const headingLabel = card.querySelector('label[for^="scene-heading-"]');
                            if (headingInput) headingInput.id = 'scene-heading-' + num;
                            if (headingLabel) headingLabel.setAttribute('for', 'scene-heading-' + num);
                            const charInput = card.querySelector('input[id^="characters-"]');
                            const charLabel = card.querySelector('label[for^="characters-"]');
                            if (charInput) charInput.id = 'characters-' + num;
                            if (charLabel) charLabel.setAttribute('for', 'characters-' + num);
                            const summaryTextarea = card.querySelector('textarea[id^="summary-"]');
                            const summaryLabel = card.querySelector('label[for^="summary-"]');
                            if (summaryTextarea) summaryTextarea.id = 'summary-' + num;
                            if (summaryLabel) summaryLabel.setAttribute('for', 'summary-' + num);
                            const contentTextarea = card.querySelector('textarea[id^="content-"]');
                            const contentLabel = card.querySelector('label[for^="content-"]');
                            if (contentTextarea) contentTextarea.id = 'content-' + num;
                            if (contentLabel) contentLabel.setAttribute('for', 'content-' + num);
                        });
                    }
                    
                    // ê¸°ë³¸ ì¥ë©´ 1ì˜ ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
                    const firstSceneRemoveBtn = document.querySelector('.remove-scene-btn');
                    if (firstSceneRemoveBtn) {
                        firstSceneRemoveBtn.addEventListener('click', function() {
                            const sceneContainer = document.getElementById('scene-container');
                            if (sceneContainer.children.length > 1) {
                                removeScene(this.closest('.scene-card'));
                } else {
                                alert('ë§ˆì§€ë§‰ ì¥ë©´ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            }
                        });
                    }
                    
                    const addSceneBtn = document.getElementById('add-scene-btn');
                    if (addSceneBtn) {
                        addSceneBtn.addEventListener('click', function() {
                            sceneCount++;
                            const sceneContainer = document.getElementById('scene-container');
                            
                            if (sceneContainer) {
                                const newScene = document.createElement('div');
                                newScene.className = 'scene-card';
                                newScene.style.cssText = 'border: 1px solid #ced4da; border-radius: 8px; padding: 20px; margin-bottom: 30px; background-color: #fff;';
                                
                                // í…œí”Œë¦¿ ë¦¬í„°ëŸ´ ëŒ€ì‹  ë¬¸ìì—´ ì—°ê²° ì‚¬ìš©ìœ¼ë¡œ ì•ˆì •ì„± í–¥ìƒ
                                newScene.innerHTML = 
                                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">' +
                                        '<div style="font-size: 1.5rem; font-weight: bold; color: #007bff;">ì¥ë©´ ' + sceneCount + '</div>' +
                                        '<button class="remove-scene-btn" type="button" data-scene-id="' + sceneCount + '" style="padding: 6px 12px; background-color: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.9rem; font-weight: bold; cursor: pointer; transition: background-color 0.2s;">ì‚­ì œ</button>' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="scene-heading-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">ì¥ì†Œ ë° ì‹œê°„ (Scene Heading)</label>' +
                                        '<input type="text" id="scene-heading-' + sceneCount + '" placeholder="ì˜ˆ: ë„ì„œê´€ - ë°¤" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem;">' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="characters-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">ë“±ì¥ì¸ë¬¼ (Characters)</label>' +
                                        '<input type="text" id="characters-' + sceneCount + '" placeholder="ì˜ˆ: ë¯¼ì¤€, í• ë¨¸ë‹ˆ" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem;">' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="summary-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">ì¥ë©´ ìš”ì•½ (Summary)</label>' +
                                        '<textarea id="summary-' + sceneCount + '" placeholder="ì´ ì¥ë©´ì˜ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”? ì¥ë©´ì´ ëë‚¬ì„ ë•Œ ë¬´ì—‡ì´ ë³€í•´ì•¼ í•˜ë‚˜ìš”?" style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; height: 150px; resize: vertical;"></textarea>' +
                                    '</div>' +
                                    '<div style="margin-bottom: 15px;">' +
                                        '<label for="content-' + sceneCount + '" style="display: block; font-weight: bold; margin-bottom: 5px; color: #495057;">ë‚´ìš© (ëŒ€ì‚¬ ë° ì§€ë¬¸)</label>' +
                                        '<textarea id="content-' + sceneCount + '" placeholder="ì´ê³³ì— ì¥ë©´ì˜ êµ¬ì²´ì ì¸ ëŒ€ì‚¬ì™€ í–‰ë™ì„ ììœ ë¡­ê²Œ ì‘ì„±í•´ ì£¼ì„¸ìš”." style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 1rem; height: 150px; resize: vertical;"></textarea>' +
                                    '</div>';
                                
                                sceneContainer.appendChild(newScene);
                                
                                // ìƒˆë¡œ ì¶”ê°€ëœ ì¥ë©´ì˜ ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ì¶”ê°€
                                const newRemoveBtn = newScene.querySelector('.remove-scene-btn');
                                if (newRemoveBtn) {
                                    newRemoveBtn.addEventListener('click', function() {
                                        const sceneContainer = document.getElementById('scene-container');
                                        if (sceneContainer.children.length > 1) {
                                            removeScene(this.closest('.scene-card'));
            } else {
                                            alert('ë§ˆì§€ë§‰ ì¥ë©´ì€ ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                                        }
                                    });
                                }
                                // ì¥ë©´ ì¶”ê°€ í›„ ë²ˆí˜¸ ì¬ì •ë ¬
                                if (typeof renumberScenes === 'function') {
                                    renumberScenes();
                                }
                            }
                        });
                    }
                }, 0);
                

            } else if (currentIndex === 3) {
                // 4ë‹¨ê³„: ì˜í™” ì œëª© (ê³ ì •ëœ ì§ˆë¬¸, AI í”¼ë“œë°± ì—†ìŒ)
                html += `<div style='margin-bottom:1em;'>
                    <label style='font-weight:bold;'>ì´ ëª¨ë“  ì—¬ì •ì„ ì˜í™”ë‚˜ ë“œë¼ë§ˆ ì œëª©ìœ¼ë¡œ ë‚˜íƒ€ë‚¸ë‹¤ë©´ ë­ë¼ê³  í•  ìˆ˜ ìˆì„ê¹Œìš”?</label><br/>
                    <textarea data-field-idx='0' style='width:100%;min-height:80px;padding:0.5em;margin-top:0.3em;border:1.5px solid #bdc3c7;border-radius:6px;font-size:14px;resize:vertical;' placeholder='ì˜ˆì‹œ: "ë‚´ ì•ˆì˜ ìš©ê¸°", "ìƒˆë¡œìš´ ì‹œì‘", "íšŒë³µì˜ ì‹œê°„" ë“±ìœ¼ë¡œ í‘œí˜„í•´ë³´ì„¸ìš”.'>${responses[3] ? responses[3][0] || '' : ''}</textarea>
                </div>`;
                containerDiv.innerHTML = html;
            }
            
            responseTextarea.parentNode.insertBefore(containerDiv, responseTextarea);
        }

        // ì§„í–‰ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateProgress() {
            for (let i = 0; i < STAGES.length; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) {
                    step.classList.remove('active', 'completed');
                    if (i < currentIndex) {
                        step.classList.add('completed');
                    } else if (i === currentIndex) {
                        step.classList.add('active');
                    }
                }
            }
            // ì§„í–‰ ìƒíƒœ í‘œì‹œë¥¼ STAGES.lengthê¹Œì§€ë§Œ ë³´ì´ê²Œ
            for (let i = STAGES.length; i < 5; i++) {
                const step = document.getElementById(`step${i + 1}`);
                if (step) step.style.display = 'none';
            }
        }

        // ì´ì „ ë²„íŠ¼ ë³µêµ¬
        prevBtn.style.display = currentIndex > 0 ? 'inline-block' : 'none';

        // ë‹¤ìŒ ë²„íŠ¼ ë™ì‘
        nextBtn.addEventListener('click', () => {
            if (currentIndex < STAGES.length - 1) {
                currentIndex++;
                updateStage();
            } else {
                alert('ì‹œë‚˜ë¦¬ì˜¤ ì“°ê¸° ì¹˜ë£Œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                // ì™„ë£Œ í›„ ì¶”ê°€ ê¸°ëŠ¥ ë˜ëŠ” í˜ì´ì§€ ì´ë™

                // í”„ë¡œê·¸ë¨ ì¢…ë£Œ ì‹œ ì‹¬ë¦¬ìƒë‹´ í¬í„¸ ì¬ì•ˆë‚´
                const portal = document.createElement('div');
                portal.setAttribute('data-portal-root', '1');
                portal.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #e8f5e8; border-left:4px solid #27ae60; border-radius:10px; padding:12px 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.15); z-index: 10000; max-width: 360px;';
                portal.innerHTML = '<div style="font-weight:700; color:#166534; margin-bottom:6px;">ğŸ’¡ ì‹¬ë¦¬ìƒë‹´ í¬í„¸</div><div style="font-size:13px; color:#111827; line-height:1.45;"><a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color:#2563eb; text-decoration:none; font-weight:600;">https://www.mindinfo.kr/new/index.asp</a> â†—<br><span style="color:#374151;">ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ê¸°, ì‹¬ë¦¬ìƒë‹´ì„¼í„° ì°¾ê¸°, ê³µê³µ ì‹¬ë¦¬ìƒë‹´ ê¸°ê´€ ë° ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ</span></div><div style="text-align:right; margin-top:8px;"><button id="portal-close-btn" style="background:#27ae60; color:#fff; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px;">ë‹«ê¸°</button></div>';
                document.body.appendChild(portal);
                // ì•ˆì „ì¥ì¹˜: ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë„ ì¶”ê°€ (ì¼ë¶€ í™˜ê²½ì—ì„œ inline ì°¨ë‹¨ ëŒ€ë¹„)
                const portalCloseBtn = portal.querySelector('#portal-close-btn');
                if (portalCloseBtn) {
                    portalCloseBtn.addEventListener('click', function() {
                        const root = this.closest('[data-portal-root]') || portal;
                        if (root) root.remove();
                    });
                }
            }
        });

        // ì´ì „ ë²„íŠ¼ ë™ì‘
        prevBtn.addEventListener('click', () => {
            if (currentIndex > 0) {
                currentIndex--;
                updateStage();
            }
        });

        

        // ì…ë ¥ê°’ ì „ì²´ ì‚­ì œ ë²„íŠ¼ ë™ì‘
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('ëª¨ë“  ì…ë ¥ê°’ì„ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                responses = [
                    STAGE_FIELDS[0].length ? Array(STAGE_FIELDS[0].length).fill("") : [""],
                    STAGE_FIELDS[1].length ? Array(STAGE_FIELDS[1].length).fill("") : [""],
                    ["", "", []], // 3ë‹¨ê³„: ì£¼ì œ, ìœ„ê¸°, ìŠ¤í† ë¦¬ë³´ë“œ ë°°ì—´
                    [""] // 4ë‹¨ê³„: ì˜í™” ì œëª©
                ];
                localStorage.clear(); // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ë„ ëª¨ë‘ ì‚­ì œ
                
                // ë§ˆì¸ë“œë§µ ë‚´ìš©ë„ ì‚­ì œ
                const aiResults = document.getElementById('aiResults');
                if (aiResults) {
                    aiResults.innerHTML = '';
                }
                
                updateStage(); // í™”ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
                alert('ëª¨ë“  ì…ë ¥ê°’ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ì €ì¥ í•¨ìˆ˜
        function saveAllResponses() {
            // 1ìˆœìœ„: ê°œì¸ì •ë³´ ë³´í˜¸ ë° ìƒë‹´ìœ¤ë¦¬ ê²€ì¦
            if (!responses || !Array.isArray(responses)) {
                console.warn('Privacy Check: Invalid responses structure');
                return;
            }
            
            // ëª¨ë“  ë‹¨ê³„ ë°ì´í„°ì— ëŒ€í•´ ê°œì¸ì •ë³´ ë³´í˜¸ ê²€ì¦
            const sanitizedResponses = responses.map((stepData, index) => {
                if (stepData) {
                    const sanitized = validatePrivacyAndEthics(stepData);
                    if (!sanitized) {
                        console.error(`Privacy validation failed for step ${index}`);
                        return null;
                    }
                    return sanitized;
                }
                return stepData;
            });
            
            // ê²€ì¦ ì‹¤íŒ¨í•œ ë‹¨ê³„ê°€ ìˆìœ¼ë©´ ì €ì¥ ì¤‘ë‹¨
            if (sanitizedResponses.includes(null)) {
                console.error('Privacy Check: Some steps failed validation - saving aborted');
                return;
            }
            
            localStorage.setItem('scenario_responses', JSON.stringify(sanitizedResponses));
            console.log('Privacy Check: All responses saved with comprehensive validation');
        }
        function loadAllResponses() {
            const data = localStorage.getItem('scenario_responses');
            if (data) {
                try {
                    const loaded = JSON.parse(data);
                    if (Array.isArray(loaded) && loaded.length === responses.length) {
                        // 1ìˆœìœ„: ë¡œë“œëœ ë°ì´í„°ì˜ ê°œì¸ì •ë³´ ë³´í˜¸ ê²€ì¦
                        const validatedResponses = loaded.map((stepData, index) => {
                            if (stepData) {
                                const validated = validatePrivacyAndEthics(stepData);
                                if (!validated) {
                                    console.error(`Privacy Check: Step ${index} validation failed during load`);
                                    return null;
                                }
                                return validated;
                            }
                            return stepData;
                        });
                        
                        // ê²€ì¦ ì‹¤íŒ¨í•œ ë‹¨ê³„ê°€ ìˆìœ¼ë©´ ë¡œë“œ ì¤‘ë‹¨
                        if (validatedResponses.includes(null)) {
                            console.error('Privacy Check: Some steps failed validation during load - loading aborted');
                            return;
                        }
                        
                        responses = validatedResponses;
                        console.log('Privacy Check: All responses loaded with validation');
                    }
            } catch (error) {
                    console.error('Privacy Check: Error parsing loaded data:', error);
                }
            }
        }

        // 0ë‹¨ê³„ ì•ˆë‚´ í™”ë©´ ì¶”ê°€
        let showIntro = true;
        let introOriginStage = null; // ì•ˆë‚´ë¡œ ì§„ì…í•œ ê¸°ì¡´ ë‹¨ê³„ ì¸ë±ìŠ¤(ì²˜ìŒ í™”ë©´ì´ë©´ null)
        let isShowingPHQ9Results = false; // PHQ-9 ê²°ê³¼ í™”ë©´ì´ í‘œì‹œ ì¤‘ì¸ì§€ í™•ì¸í•˜ëŠ” í”Œë˜ê·¸
        function renderIntro() {
            const introDiv = document.createElement('div');
            introDiv.id = 'introScreen';
            introDiv.style = 'max-width:700px;margin:3em auto 0 auto;padding:2em;background:#fffbe6;border-radius:12px;border:1.5px solid #ffd700;box-shadow:0 2px 12px #ffd70022;';
            introDiv.innerHTML = `
                <!-- ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œ ìœ„ì ¯ -->
                <div style="margin-bottom:2em;padding:1.5em;background:#0f172a;border-radius:12px;border:1px solid #1f2937;">
                    <div style="color:#e5e7eb;font-size:1.1em;margin-bottom:1em;"><b>ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œ</b></div>
                    <div style="color:#94a3b8;font-size:0.95em;line-height:1.6;margin-bottom:1.5em;">
                        ë³¸ í”„ë¡œê·¸ë¨ì€ <span style="color:#22c55e;font-weight:bold;">ê°œì¸ì •ë³´ ë³´í˜¸ë²•</span>ê³¼ <span style="color:#22c55e;font-weight:bold;">ìƒë‹´ì‹¬ë¦¬í•™íšŒ ìƒë‹´ìœ¤ë¦¬</span>ë¥¼ <span style="color:#f59e0b;font-weight:bold;">ìµœìš°ì„ </span>ìœ¼ë¡œ ì¤€ìˆ˜í•˜ì—¬ ìš´ì˜ë©ë‹ˆë‹¤. ì•„ë˜ ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì‹œê³  ì„œë¹„ìŠ¤ë¥¼ ì´ìš©í•´ ì£¼ì„¸ìš”.
                    </div>
                    
                    <!-- ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ (ì œ15ì¡°) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ (ì œ15ì¡°)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            â€¢ <b>ìˆ˜ì§‘ ëª©ì :</b> ì‹œë‚˜ë¦¬ì˜¤ ì¹˜ë£Œ ì§„í–‰ ë° ê¸°ë¡ ê´€ë¦¬<br>
                            â€¢ <b>ìˆ˜ì§‘ í•­ëª©:</b> ì´ë¦„(ê°€ëª…), ì´ë©”ì¼, ì‘ì„± ì½˜í…ì¸ (ê°€ëª…ì²˜ë¦¬)<br>
                            â€¢ <b>ë³´ìœ Â·ì´ìš© ê¸°ê°„:</b> 365ì¼ (ëª©ì  ë‹¬ì„± í›„ íŒŒê¸°)<br>
                            â€¢ <b>ë™ì˜ ê±°ë¶€:</b> ì„œë¹„ìŠ¤ ì œê³µì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <!-- ì œ3ì ì œê³µ (ì œ17Â·18ì¡°) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>ì œ3ì ì œê³µ (ì œ17Â·18ì¡°)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            
                            â€¢ <b>ì•ˆì „ì¡°ì¹˜:</b> ê°€ëª…ì²˜ë¦¬ ë° ì•”í˜¸í™”ë¥¼ í†µí•´ ê°œì¸ì •ë³´ë¥¼ ë³´í˜¸í•©ë‹ˆë‹¤<br>
                            â€¢ <b>ì œê³µ ë²”ìœ„:</b> ë¶„ì„ ëª©ì ìœ¼ë¡œë§Œ ì œí•œì ìœ¼ë¡œ ì´ìš©ë©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <!-- ìƒë‹´ìœ¤ë¦¬ ë° ë¹„ë°€ë³´ì¥ (í•œêµ­ìƒë‹´ì‹¬ë¦¬í•™íšŒ) -->
                    <div style="background:#1e3a8a;border:1px solid #3b82f6;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>ğŸ’™ ìƒë‹´ìœ¤ë¦¬ ë° ë¹„ë°€ë³´ì¥ (í•œêµ­ìƒë‹´ì‹¬ë¦¬í•™íšŒ)</b></div>
                        <div style="color:#93c5fd;font-size:0.9em;line-height:1.5;">
                            â€¢ <b>ë¹„ë°€ë³´ì¥ ì›ì¹™:</b> ëª¨ë“  ìƒë‹´ ë‚´ìš©ì€ ì² ì €í•œ ë¹„ë°€ë³´ì¥ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤<br>
                            â€¢ <b>ìœ¤ë¦¬ì  ì±…ì„:</b> ìƒë‹´ì‚¬ëŠ” ë‚´ë‹´ìì˜ ë³µì§€ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤<br>
                            â€¢ <b>ê²½ê³„ ì„¤ì •:</b> ì „ë¬¸ì  ê´€ê³„ ìœ ì§€ë¥¼ ìœ„í•œ ëª…í™•í•œ ê²½ê³„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <!-- ì •ë³´ì£¼ì²´ ê¶Œë¦¬ (ì œ35Â·36Â·37Â·37ì˜2) -->
                    <div style="background:#111827;border:1px solid #1f2937;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#e5e7eb;font-size:1em;margin-bottom:0.8em;"><b>ì •ë³´ì£¼ì²´ ê¶Œë¦¬ (ì œ35Â·36Â·37Â·37ì˜2)</b></div>
                        <div style="color:#94a3b8;font-size:0.9em;line-height:1.5;">
                            â€¢ <b>ì—´ëŒ ìš”êµ¬:</b> ë³¸ì¸ì •ë³´ ì—´ëŒì„ ìš”êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                            â€¢ <b>ì •ì •Â·ì‚­ì œ:</b> ë¶€ì •í™•í•œ ì •ë³´ì˜ ì •ì • ë˜ëŠ” ì‚­ì œë¥¼ ìš”êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                            â€¢ <b>ì²˜ë¦¬ì •ì§€:</b> ê°œì¸ì •ë³´ ì²˜ë¦¬ì˜ ì •ì§€ ë˜ëŠ” ë™ì˜ì² íšŒë¥¼ ìš”êµ¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                        </div>
                    </div>
                    
                    <!-- ì¤‘ìš” ì•ˆë‚´ì‚¬í•­ -->
                    <div style="background:#dc2626;border:1px solid #ef4444;border-radius:10px;padding:1em;margin-bottom:1em;">
                        <div style="color:#fecaca;font-size:1em;margin-bottom:0.8em;"><b>âš ï¸ ìµœìš°ì„  ë³´í˜¸ ì›ì¹™</b></div>
                        <div style="color:#fca5a5;font-size:0.9em;line-height:1.5;">
                            â€¢ <b>1ìˆœìœ„:</b> ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë° ìƒë‹´ìœ¤ë¦¬ ì¤€ìˆ˜<br>
                            â€¢ <b>ì ˆëŒ€ ì›ì¹™:</b> ë¹„ë°€ë³´ì¥ ë° í”„ë¼ì´ë²„ì‹œ ë³´í˜¸<br>
                            â€¢ <b>ì•ˆì „ì¡°ì¹˜:</b> ëª¨ë“  ë°ì´í„°ëŠ” ì•”í˜¸í™” ë° ê°€ëª…ì²˜ë¦¬ í›„ ì²˜ë¦¬
                        </div>
                    </div>
                    
                    <div style="text-align:center;margin-top:1.5em;">
                        <button onclick="showPrivacyGuide()" style="background:#22c55e;color:white;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;margin-right:10px;">ìƒì„¸ ê°€ì´ë“œ ë³´ê¸°</button>
                        <button onclick="showServiceGuidePage()" style="background:#f59e0b;color:white;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;">ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ ë³´ê¸°</button>
                    </div>
                </div>

                <div style="text-align:center;margin-top:2.5em;">
                    <div style="color:#666;font-size:0.9em;margin-bottom:1em;">
                        ğŸ“‹ ê°œì¸ì •ë³´ë³´í˜¸ë²• ê°€ì´ë“œë¥¼ í™•ì¸í•˜ì‹  í›„, ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ì„ í†µí•´ ë‹¨ê³„ë³„ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”.
                    </div>
                </div>
            `;
            const containerRef = document.body.querySelector('.container');
            if (containerRef) {
                // í”„ë¡œê·¸ë¨ UIê°€ í•œ ë²ˆë„ ë Œë”ëœ ì ì´ ì—†ë‹¤ë©´(ì²« í™”ë©´), ë³µê·€ ë²„íŠ¼ì„ ìˆ¨ê¸°ê¸° ìœ„í•´ origin=null
                introOriginStage = programMounted ? currentIndex : null;
                containerRef.style.display = 'none';
            } else {
                introOriginStage = null;
            }
            document.body.appendChild(introDiv);
     
            // í”„ë¡œê·¸ë¨ìœ¼ë¡œ ë³µê·€ ë„¤ë¹„ê²Œì´ì…˜: ì²˜ìŒ í™”ë©´ì—ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ, ì•ˆë‚´ë¡œ ë“¤ì–´ì˜¨ ê²½ìš°ì—ë§Œ í‘œì‹œ
            if (introOriginStage !== null) {
                introDiv.insertAdjacentHTML('beforeend', `
                    <div style="text-align:center;margin-top:1.5em;">
                        <button id="backToProgramBtn" style="background:#22c55e;color:#fff;font-size:0.95em;padding:0.6em 1.5em;border-radius:8px;border:none;cursor:pointer;">í”„ë¡œê·¸ë¨ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                    </div>
                `);
                const containerEl = document.body.querySelector('.container');
                const backBtn = document.getElementById('backToProgramBtn');
                if (backBtn) {
                    backBtn.addEventListener('click', function() {
                        // ì•ˆë‚´ë¡œ ë“¤ì–´ì˜¤ê¸° ì „ ë‹¨ê³„ë¡œë§Œ ë³µê·€ í—ˆìš©
                        currentIndex = introOriginStage;
                        if (introDiv && introDiv.parentNode) introDiv.parentNode.removeChild(introDiv);
                        if (containerEl) containerEl.style.display = '';
                        updateStage();
                    });
                }
            }
        }
        function showPHQ9Results(score) {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'phq9-screening';
            resultDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card" style="max-width: 720px; margin: 0 auto;">
                                            <h1 class="phq9-title">PHQ-9 ê²€ì‚¬ ê²°ê³¼ (ì´ë¯¸ ì™„ë£Œë¨)</h1>
                    <div class="phq9-sub">
                        ì´ì „ì— ì™„ë£Œí•˜ì‹  PHQ-9 ê²€ì‚¬ ê²°ê³¼ì…ë‹ˆë‹¤.<br>
                        <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                            ğŸ“‹ <a href="https://www.ncmh.go.kr/ncmh/board/boardView.do?no=8834&fno=106&bn=newsView&menu_cd=04_02_02_04&bno=&pageIndex=1&search_item=&search_content=#" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                PHQ-9 í•œêµ­íŒ í‘œì¤€ì§€ì¹¨ (êµ­ë¦½ì •ì‹ ê±´ê°•ì„¼í„°)
                            </a> â†—
                        </small>

                    </div>
                        
                        <div class="phq9-result">
                            <div class="phq9-score">ì´ì : <span id="phq9ResultTotal">${score}</span> / 27 <span id="phq9ResultSevTag" class="phq9-sev">ê²°ê³¼</span></div>
                            <div id="phq9ResultAdvice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns" style="margin-top: 20px;">
                                <button id="phq9ResultStartBtn" class="phq9-btn phq9-primary" style="margin-right: 10px;">í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘</button>
                                <button id="phq9RetakeBtn" class="phq9-btn phq9-danger" style="margin-right: 10px;">ì„¤ë¬¸ ë‹¤ì‹œí•˜ê¸°</button>
                                <button id="phq9ResultBackBtn" class="phq9-btn phq9-ghost">ë’¤ë¡œ ê°€ê¸°</button>
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * ì„¤ë¬¸ì„ ë‹¤ì‹œ í•˜ë ¤ë©´ "ì„¤ë¬¸ ë‹¤ì‹œí•˜ê¸°" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”. ì´ì „ ê²°ê³¼ëŠ” ì‚­ì œë©ë‹ˆë‹¤.
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(resultDiv);
            console.log('PHQ-9 ê²°ê³¼ í™”ë©´ DOMì— ì¶”ê°€ë¨');
            
            // ê²°ê³¼ í‘œì‹œ
            const [label, cls] = getSeverityClass(score);
            document.getElementById('phq9ResultSevTag').textContent = label;
            document.getElementById('phq9ResultSevTag').className = 'phq9-sev ' + cls;
            
            console.log('PHQ-9 ê²°ê³¼ í™”ë©´ ë Œë”ë§ ì™„ë£Œ, ì ìˆ˜:', score);
            
            const advice = document.getElementById('phq9ResultAdvice');
            const startBtn = document.getElementById('phq9ResultStartBtn');
            
            // 9ë²ˆ ì§ˆë¬¸(ìí•´/ìì‚´ ìƒê°) ì ìˆ˜ í™•ì¸
            // localStorageì—ì„œ PHQ-9 ê°œë³„ ì‘ë‹µ ë°ì´í„° í™•ì¸
            const phq9Responses = localStorage.getItem('phq9_responses');
            let question9Score = 0;
            
            if (phq9Responses) {
                try {
                    const responses = JSON.parse(phq9Responses);
                    if (responses && responses.length > 8) {
                        question9Score = parseInt(responses[8]) || 0;
                    }
                } catch (e) {
                    console.error('PHQ-9 ì‘ë‹µ ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            }
            
            // 9ë²ˆ ì§ˆë¬¸ì—ì„œ 1ì  ì´ìƒì´ë©´ ì¦‰ì‹œ ìœ„í—˜ ì•ˆë‚´ ë° í”„ë¡œê·¸ë¨ ì‹œì‘ ë²„íŠ¼ ë¹„í™œì„±í™”
            if (question9Score >= 1) {
                startBtn.disabled = true;
                advice.className = 'phq9-note phq9-warn';
                advice.innerHTML = '<strong>âš ï¸ ì•ˆì „ ì•ˆë‚´:</strong> ìí•´ë‚˜ ìì‚´ ìƒê°ì´ ìˆëŠ” ê²½ìš° ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.';
                
                // ìœ„ê¸° ìƒë‹´ ì—°ë½ì²˜ ì•ˆë‚´ ì¶”ê°€
                const crisisDiv = document.createElement('div');
                crisisDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0; animation: fadeIn 0.5s ease-in;';
                crisisDiv.innerHTML = `
                    <h4 style="margin: 0 0 12px; color: #856404;">âš ï¸ ìœ„ê¸° ìƒí™© ëŒ€ì‘ ì•ˆë‚´</h4>
                    <p style="margin: 0 0 16px; color: #856404;">ìí•´ë‚˜ ìì‚´ ìƒê°ì´ ìˆëŠ” ê²½ìš° ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.</p>
                    
                    <h4 style="margin: 0 0 12px; color: #856404;">ğŸ“ ìœ„ê¸° ìƒë‹´ ì—°ë½ì²˜</h4>
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                        <tr style="background: #fff8e1;">
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 20%;">êµ¬ë¶„</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 40%;">ê¸°ê´€/ì„œë¹„ìŠ¤ëª…</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 25%;">ì „í™”/ì±„íŒ…</th>
                            <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 15%;">ë¹„ê³ </th>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ìƒëª…ì˜ ì „í™” 1588-9191</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ìì‚´Â·ì •ì„œ ìœ„ê¸° ì „ë¬¸ ìƒë‹´, ë¹„ë°€ë³´ì¥</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ìì‚´ì˜ˆë°©ìƒë‹´ì „í™” 1393</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ë³´ê±´ë³µì§€ë¶€Â·í•œêµ­ìƒëª…ì¡´ì¤‘í¬ë§ì¬ë‹¨</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì •ì‹ ê±´ê°• ìƒë‹´ì „í™” 1577-0199</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì—°ê²°</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #74b9ff;">ì²­ì†Œë…„</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì²­ì†Œë…„ ì „í™” 1388</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”Â·ë¬¸ì(#1388)Â·ì±„íŒ…</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ì²­ì†Œë…„ ëŒ€ìƒ ìœ„ê¸°Â·ì •ì„œ ì§€ì›</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #6c5ce7;">ì±„íŒ… ì¤‘ì‹¬</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì¹´ì¹´ì˜¤í†¡ 'ìì‚´ì˜ˆë°©ìƒë‹´' ì±„ë„</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì±„íŒ…</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, 1393 ìš´ì˜</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">ê¸´ê¸‰</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">119</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ìÂ·íƒ€í•´ ìœ„í—˜ ì¦‰ì‹œ êµ¬ì¡°</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">ê¸´ê¸‰</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">112</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                            <td style="border: 1px solid #ffeaa7; padding: 8px;">ë²”ì£„Â·í­ë ¥ ìœ„í—˜ í¬í•¨ ì‹œ</td>
                        </tr>
                    </table>
                    
                    <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                        <strong>ğŸ’¡ ì‹¬ë¦¬ìƒë‹´ í¬í„¸:</strong> 
                        <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                            https://www.mindinfo.kr/new/index.asp
                        </a> â†—
                        <br><small style="color: #6b7280;">ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ê¸°, ì‹¬ë¦¬ìƒë‹´ì„¼í„° ì°¾ê¸°, ê³µê³µ ì‹¬ë¦¬ìƒë‹´ ê¸°ê´€ ë° ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ</small>
                    </div>
                `;
                
                // advice ìš”ì†Œ ë‹¤ìŒì— ìœ„ê¸° ìƒë‹´ ì•ˆë‚´ ì¶”ê°€
                advice.parentNode.insertBefore(crisisDiv, advice.nextSibling);
            } else {
                // 9ë²ˆ ì§ˆë¬¸ì—ì„œ 1ì  ë¯¸ë§Œì¸ ê²½ìš° ê¸°ì¡´ ê²Œì´íŒ… ë¡œì§ ì ìš©
                if(score >= 5 && score <= 14) {
                    // ê²½ì¦ ìš°ìš¸êµ°: ë°”ë¡œ í”„ë¡œê·¸ë¨ ì‹œì‘ ê°€ëŠ¥
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘';
                    
                    advice.innerHTML = '<strong>ğŸ’¡ í”„ë¡œê·¸ë¨ ì‹œì‘:</strong> í•´ë‹¹ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì…ë‹ˆë‹¤. <br><br><strong>í”„ë¡œê·¸ë¨ì„ ë°”ë¡œ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>';
                    advice.className = 'phq9-note phq9-info';
                } else {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    if(score <= 4) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ìš°ìš¸ ì•„ë‹˜(0â€“4)</b> ë²”ìœ„ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ì¶”í›„ ë‹¤ì‹œ ì²´í¬í•˜ê±°ë‚˜, ìƒí™œ ë¦¬ë“¬ ê´€ë¦¬ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.';
                    } else if(score >= 20) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ì‹¬í•œ ìš°ìš¸(20â€“27)</b> ë²”ìœ„ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ í‰ê°€ì™€ ë„ì›€ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    } else { // 15â€“19
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ì¤‘ë“±ë„(15â€“19)</b> ë²”ìœ„ì…ë‹ˆë‹¤. ë³¸ ì²´í—˜ í”„ë¡œê·¸ë¨ì€ ì œê³µë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´/ì¹˜ë£Œë¥¼ ê¶Œí•©ë‹ˆë‹¤.';
                    }
                }
            }
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° í™•ì¸
            console.log('PHQ-9 ê²°ê³¼ í™”ë©´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì‹œì‘');
            
            const resultStartBtn = document.getElementById('phq9ResultStartBtn');
            const resultRetakeBtn = document.getElementById('phq9RetakeBtn');
            const resultBackBtn = document.getElementById('phq9ResultBackBtn');
            
            console.log('ë²„íŠ¼ ìš”ì†Œë“¤:', { resultStartBtn, resultRetakeBtn, resultBackBtn });
            
            if (resultStartBtn) {
                resultStartBtn.onclick = () => {
                    console.log('í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨');
                    resultDiv.remove();
                    document.querySelector('.container').style.display = '';
                    updateStage();
                };
            }
            
            if (resultRetakeBtn) {
                resultRetakeBtn.onclick = () => {
                    console.log('ì„¤ë¬¸ ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼ í´ë¦­ë¨');
                    if(confirm('ì´ì „ ê²€ì‚¬ ê²°ê³¼ê°€ ì‚­ì œë©ë‹ˆë‹¤. ì •ë§ ë‹¤ì‹œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        // í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í† ë¦¬ì§€ì—ì„œ ëª¨ë“  PHQ-9 ë°ì´í„° ì‚­ì œ
                        sessionStorage.removeItem('phq9_data');
                        localStorage.removeItem('phq9_data');
                        localStorage.removeItem('phq9_responses'); // ê°œë³„ ì‘ë‹µ ë°ì´í„°ë„ ì‚­ì œ
                        console.log('PHQ-9 ë°ì´í„° ì™„ì „ ì‚­ì œë¨ (í•˜ì´ë¸Œë¦¬ë“œ)');
                        resultDiv.remove();
                        renderDemographicsSurvey();
                    }
                };
            }
            
            if (resultBackBtn) {
                resultBackBtn.onclick = () => {
                    console.log('ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ í´ë¦­ë¨');
                    resultDiv.remove();
                    showIntro = true;
                    renderIntro();
                };
            }
            
            console.log('PHQ-9 ê²°ê³¼ í™”ë©´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì™„ë£Œ');
        }

        function getSeverityClass(score) {
            if(score <= 4) return ['ì •ìƒ (0â€“4)', 'none'];
            if(score <= 14) return ['ê²½í•¨ (0â€“14)', 'mild'];
            return ['ì‹¬ê°í•¨ (15â€“27)', 'sev'];
        }

        function getPHQ9DataFromStorage() {
            const now = Date.now();
            
            // 1ìˆœìœ„: sessionStorage ì²´í¬ (íƒ­ë³„ ë…ë¦½, ìµœê³  ë³´ì•ˆ)
            const sessionData = sessionStorage.getItem('phq9_data');
            if (sessionData) {
                try {
                    const data = JSON.parse(sessionData);
                    if (data.expires > now) {
                        console.log('sessionStorageì—ì„œ ìœ íš¨í•œ PHQ-9 ë°ì´í„° ë°œê²¬');
                        return data;
                    } else {
                        console.log('sessionStorageì˜ PHQ-9 ë°ì´í„° ë§Œë£Œë¨');
                        sessionStorage.removeItem('phq9_data');
                    }
                } catch (e) {
                    console.error('sessionStorage PHQ-9 ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    sessionStorage.removeItem('phq9_data');
                }
            }
            
            // 2ìˆœìœ„: localStorage ì²´í¬ (24ì‹œê°„ ë°±ì—…, ì—°ì†ì„±)
            const localData = localStorage.getItem('phq9_data');
            if (localData) {
                try {
                    const data = JSON.parse(localData);
                    if (data.expires > now) {
                        console.log('localStorageì—ì„œ ìœ íš¨í•œ PHQ-9 ë°ì´í„° ë°œê²¬, sessionStorageë¡œ ë³µì‚¬');
                        // sessionStorageë¡œ ë³µì‚¬í•˜ì—¬ ë™ê¸°í™”
                        sessionStorage.setItem('phq9_data', localData);
                        return data;
                    } else {
                        console.log('localStorageì˜ PHQ-9 ë°ì´í„° ë§Œë£Œë¨');
                        localStorage.removeItem('phq9_data');
                    }
                } catch (e) {
                    console.error('localStorage PHQ-9 ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:', e);
                    localStorage.removeItem('phq9_data');
                }
            }
            
            console.log('ìœ íš¨í•œ PHQ-9 ë°ì´í„° ì—†ìŒ');
            return null;
        }

        // ì¸êµ¬í†µê³„ ìˆ˜ì§‘ í•¨ìˆ˜
        function renderDemographicsSurvey() {
            console.log('ì¸êµ¬í†µê³„ ìˆ˜ì§‘ í™”ë©´ ì‹œì‘');
            
            // ê¸°ì¡´ í™”ë©´ì´ ìˆë‹¤ë©´ ì œê±°
            const existingSurvey = document.querySelector('.demographics-survey');
            if (existingSurvey) {
                existingSurvey.remove();
            }
            
            const surveyDiv = document.createElement('div');
            surveyDiv.className = 'demographics-survey';
            
            surveyDiv.innerHTML = `
                <div class="demo-wrap">
                    <div class="demo-card">
                        <h1 class="demo-title">ğŸ“Š ì¸êµ¬í†µê³„ ì •ë³´ ìˆ˜ì§‘</h1>
                        <div class="demo-sub">
                            í”„ë¡œê·¸ë¨ ì°¸ì—¬ë¥¼ ìœ„í•œ ê¸°ë³¸ ì •ë³´ë¥¼ ìˆ˜ì§‘í•©ë‹ˆë‹¤.<br>
                            ëª¨ë“  ì •ë³´ëŠ” ìµëª…ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ë§¤ì¹­ ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                        </div>
                        
                        <form id="demographicsForm" class="demo-form">
                            <div class="demo-section" style="display: none;">
                                <h3>1. ì„±ë³„</h3>
                                <div class="demo-options">
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="0">
                                        <span class="demo-label">ë‚¨ì„±</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="1">
                                        <span class="demo-label">ì—¬ì„±</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="gender" value="2">
                                        <span class="demo-label">ê¸°íƒ€</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="demo-section" style="display: none;">
                                <h3>2. ì—°ë ¹ëŒ€</h3>
                                <div class="demo-input">
                                    <input type="number" id="age" name="age" min="13" max="100" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                    <span class="demo-unit">ì„¸</span>
                                </div>
                            </div>
                            
                            <div class="demo-section" style="display: none;">
                                <h3>3. ì§‘ë‹¨ ì˜í™”ì œì‘ ìƒë‹´ ì°¸ì—¬ í¬ë§</h3>
                                <div class="demo-options">
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="yes">
                                        <span class="demo-label">ë„¤, ì°¸ì—¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="no">
                                        <span class="demo-label">í˜¼ì ì œì‘í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.</span>
                                    </label>
                                    <label class="demo-option">
                                        <input type="radio" name="groupParticipation" value="none">
                                        <span class="demo-label">ì•„ë‹ˆì˜¤, ì–´ëŠ ê²ƒì—ë„ ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤.</span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="demo-section" id="locationSection" style="display: none;">
                                <h3>4. ê±°ì£¼ ì§€ì—­</h3>
                                <div class="demo-input">
                                    <select id="region" name="region">
                                        <option value="">ì§€ì—­ì„ ì„ íƒí•˜ì„¸ìš”</option>
                                        <option value="ì„œìš¸">ì„œìš¸íŠ¹ë³„ì‹œ</option>
                                        <option value="ë¶€ì‚°">ë¶€ì‚°ê´‘ì—­ì‹œ</option>
                                        <option value="ëŒ€êµ¬">ëŒ€êµ¬ê´‘ì—­ì‹œ</option>
                                        <option value="ì¸ì²œ">ì¸ì²œê´‘ì—­ì‹œ</option>
                                        <option value="ê´‘ì£¼">ê´‘ì£¼ê´‘ì—­ì‹œ</option>
                                        <option value="ëŒ€ì „">ëŒ€ì „ê´‘ì—­ì‹œ</option>
                                        <option value="ìš¸ì‚°">ìš¸ì‚°ê´‘ì—­ì‹œ</option>
                                        <option value="ì„¸ì¢…">ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ</option>
                                        <option value="ê²½ê¸°">ê²½ê¸°ë„</option>
                                        <option value="ê°•ì›">ê°•ì›ë„</option>
                                        <option value="ì¶©ë¶">ì¶©ì²­ë¶ë„</option>
                                        <option value="ì¶©ë‚¨">ì¶©ì²­ë‚¨ë„</option>
                                        <option value="ì „ë¶">ì „ë¼ë¶ë„</option>
                                        <option value="ì „ë‚¨">ì „ë¼ë‚¨ë„</option>
                                        <option value="ê²½ë¶">ê²½ìƒë¶ë„</option>
                                        <option value="ê²½ë‚¨">ê²½ìƒë‚¨ë„</option>
                                        <option value="ì œì£¼">ì œì£¼íŠ¹ë³„ìì¹˜ë„</option>
                                        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="demo-btns">
                                <button type="submit" class="demo-btn demo-primary">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            document.body.appendChild(surveyDiv);
            
            // í¼ ì œì¶œ ì´ë²¤íŠ¸ ì²˜ë¦¬
            const form = document.getElementById('demographicsForm');
            const groupParticipationRadios = document.querySelectorAll('input[name="groupParticipation"]');
            const locationSection = document.getElementById('locationSection');
            const regionSelect = document.getElementById('region');
            
            // ì§‘ë‹¨ ì°¸ì—¬ í¬ë§ ì—¬ë¶€ì— ë”°ë¥¸ ê±°ì£¼ì§€ì—­ í‘œì‹œ/ìˆ¨ê¹€
            groupParticipationRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'yes') {
                        locationSection.style.display = 'block';
                        regionSelect.required = true;
                    } else {
                        locationSection.style.display = 'none';
                        regionSelect.required = false;
                        regionSelect.value = '';
                    }
                });
            });
            
            // í¼ ì œì¶œ ì²˜ë¦¬
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const demographics = {
                    gender: parseInt(formData.get('gender')),
                    age: parseInt(formData.get('age')),
                    groupParticipation: formData.get('groupParticipation'),
                    region: formData.get('groupParticipation') === 'yes' ? formData.get('region') : null,
                    timestamp: Date.now()
                };
                
                // ì¸êµ¬í†µê³„ ë°ì´í„° ì €ì¥
                sessionStorage.setItem('demographics_data', JSON.stringify(demographics));
                localStorage.setItem('demographics_data', JSON.stringify(demographics));
                
                console.log('ì¸êµ¬í†µê³„ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', demographics);
                
                // PHQ-9 ê²€ì‚¬ë¡œ ì§„í–‰
                renderPHQ9Screening();
            });
        }

        // PHQ-9 ê±´ê°•ì„¤ë¬¸ (ìœ¤ë¦¬ê°•ë ¹ ì ìš©ë¨)
        function renderPHQ9Screening() {
            console.log('renderPHQ9Screening í•¨ìˆ˜ ì‹œì‘');
            
            // ê¸°ì¡´ PHQ-9 ê²€ì‚¬ê°€ ìˆë‹¤ë©´ ì œê±°
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('ê¸°ì¡´ PHQ-9 ê²€ì‚¬ ì œê±°');
                existingScreening.remove();
            }
            
            // ê¸°ì¡´ ì¸êµ¬í†µê³„ ì„¤ë¬¸ ìˆ¨ê¸°ê¸°
            const existingDemographics = document.querySelector('.demographics-survey');
            if (existingDemographics) {
                console.log('ê¸°ì¡´ ì¸êµ¬í†µê³„ ì„¤ë¬¸ ìˆ¨ê¹€');
                existingDemographics.style.display = 'none';
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'phq9-screening';
            console.log('PHQ-9 ê²€ì‚¬ div ìƒì„±ë¨');
            
            screeningDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card">
                        <!-- ì›Œí¬í”Œë¡œìš° ì•ˆë‚´ ì œê±° -->
                        
                        <h1 class="phq9-title">ìš°ìš¸ì¦ ê±´ê°•ì„¤ë¬¸â€‘9 (PHQâ€‘9) â€” í•œêµ­íŒ</h1>
                        <div class="phq9-sub">
                            ì§€ë‚œ <b>2ì£¼</b> ë™ì•ˆ ë‹¤ìŒê³¼ ê°™ì€ ë¬¸ì œë“¤ë¡œ <b>ì–¼ë§ˆë‚˜ ìì£¼</b> ê³¤ë€ì„ ê²ªì—ˆëŠ”ì§€ ì„ íƒí•˜ì„¸ìš”. (0=ì—†ìŒ, 1=2â€“6ì¼, 2=7â€“12ì¼, 3=ê±°ì˜ ë§¤ì¼)<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                ğŸ“‹ <a href="https://www.ncmh.go.kr/ncmh/board/boardView.do?no=8834&fno=106&bn=newsView&menu_cd=04_02_02_04&bno=&pageIndex=1&search_item=&search_content=#" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    PHQ-9 í•œêµ­íŒ í‘œì¤€ì§€ì¹¨ (êµ­ë¦½ì •ì‹ ê±´ê°•ì„¼í„°)
                                </a> â†—
                            </small>

                        </div>
                        
                        <div class="phq9-grid" id="phq9Grid"></div>

                        
                        

                        
                        <div class="phq9-result" id="phq9Result" style="display: none;">
                            <div class="phq9-score">ì´ì : <span id="phq9Total">0</span> / 27 <span id="phq9SevTag" class="phq9-sev none">ì •ìƒ (0â€“4)</span></div>
                            <div id="phq9Advice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns">
                                <button id="phq9StartBtn" class="phq9-btn phq9-primary" disabled>í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘</button>
                                <button id="phq9BackBtn" class="phq9-btn phq9-ghost">ë’¤ë¡œ ê°€ê¸°</button>
                            </div>
                        </div>
                        
                        <div class="phq9-progress" id="phq9Progress">
                            <div class="phq9-btns">
                                <button id="phq9CalcBtn" class="phq9-btn phq9-primary" disabled>ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                                <button id="phq9BackBtn2" class="phq9-btn phq9-ghost">ë’¤ë¡œ ê°€ê¸°</button>
                            </div>
                            <div class="phq9-note" style="margin-top: 8px;">
                                ì™„ë£Œëœ ë¬¸í•­: <span id="phq9CompletedCount">0</span> / 9
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * ì´ ì„¤ë¬¸ì€ ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì ìˆ˜ê°€ ë†’ìœ¼ë©´, ìœ„í—˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì§€ì—­ ì •ì‹ ê±´ê°• ì „ë¬¸ê¸°ê´€ì— ê¼­ ìƒì˜í•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
            
            console.log('PHQ-9 ê²€ì‚¬ í™”ë©´ DOMì— ì¶”ê°€');
            // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
                console.log('ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€');
            }
            
            console.log('DOMì— PHQ-9 ê²€ì‚¬ ì¶”ê°€ ì‹œë„...');
            document.body.appendChild(screeningDiv);
            console.log('PHQ-9 ê²€ì‚¬ í™”ë©´ DOMì— ì¶”ê°€ë¨');
            console.log('í˜„ì¬ bodyì˜ ìì‹ ìš”ì†Œë“¤:', document.body.children);
            
            // PHQ-9 ê²€ì‚¬ê°€ ì‹¤ì œë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
            const addedScreening = document.querySelector('.phq9-screening');
            if (addedScreening) {
                console.log('PHQ-9 ê²€ì‚¬ ìš”ì†Œê°€ DOMì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë¨');
                console.log('initPHQ9 í•¨ìˆ˜ í˜¸ì¶œ');
                initPHQ9();
            } else {
                console.error('PHQ-9 ê²€ì‚¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
                alert('PHQ-9 ê²€ì‚¬ í™”ë©´ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }

        function initPHQ9() {
            console.log('initPHQ9 í•¨ìˆ˜ ì‹œì‘');
            
            // PHQ-9 ê²€ì‚¬ ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
            const screeningElement = document.querySelector('.phq9-screening');
            if (!screeningElement) {
                console.error('PHQ-9 ê²€ì‚¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
                return;
            }
            
            console.log('PHQ-9 ê²€ì‚¬ ìš”ì†Œ í™•ì¸ë¨:', screeningElement);
            
            // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ ìœ„í—˜ë„ í‰ê°€ ë° ì•ˆì „ ì•ˆë‚´ ì‹œìŠ¤í…œ í†µí•©
            const ITEMS = [
                'ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤',
                'í‰ì†Œ í•˜ë˜ ì¼ì— ëŒ€í•œ í¥ë¯¸ê°€ ì—†ì–´ì§€ê±°ë‚˜ ì¦ê±°ì›€ì„ ëŠë¼ì§€ ëª»í–ˆë‹¤',
                'ì ë“¤ê¸°ê°€ ì–´ë µê±°ë‚˜ ìì£¼ ê¹¼ë‹¤ / í˜¹ì€ ë„ˆë¬´ ë§ì´ ì¤ë‹¤',
                'í‰ì†Œë³´ë‹¤ ì‹ìš•ì´ ì¤„ì—ˆë‹¤ / í˜¹ì€ í‰ì†Œë³´ë‹¤ ë§ì´ ë¨¹ì—ˆë‹¤',
                'ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ëˆˆì¹˜ ì±Œ ì •ë„ë¡œ í‰ì†Œë³´ë‹¤ ë§ê³¼ í–‰ë™ì´ ëŠë ¤ì¡Œë‹¤ / í˜¹ì€ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆ ëª»í•´ì„œ ê°€ë§Œíˆ ì•‰ì•„ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤',
                'í”¼ê³¤í•˜ê³  ê¸°ìš´ì´ ì—†ì—ˆë‹¤',
                'ë‚´ê°€ ì˜ëª»í–ˆê±°ë‚˜, ì‹¤íŒ¨í–ˆë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤ / í˜¹ì€ ìì‹ ê³¼ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ê³  ìƒê°í–ˆë‹¤',
                'ì‹ ë¬¸ì„ ì½ê±°ë‚˜ TVë¥¼ ë³´ëŠ” ê²ƒê³¼ ê°™ì€ ì¼ìƒì ì¸ ì¼ì—ë„ ì§‘ì¤‘í•  ìˆ˜ê°€ ì—†ì—ˆë‹¤',
                'ì°¨ë¼ë¦¬ ì£½ëŠ” ê²ƒì´ ë” ë‚«ê² ë‹¤ê³  ìƒê°í–ˆë‹¤ / í˜¹ì€ ìí•´í•  ìƒê°ì„ í–ˆë‹¤'
            ];

            const grid = document.getElementById('phq9Grid');
            ITEMS.forEach((txt, i) => {
                const q = document.createElement('div');
                q.className = 'phq9-q';
                q.innerHTML = `<h3>${i+1}. ${txt}</h3>
                    <div class="phq9-opts">
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="0">ì—†ìŒ(0)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="1">2â€“6ì¼(1)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="2">7â€“12ì¼(2)</label>
                        <label class="phq9-opt"><input type="radio" name="q${i}" value="3">ê±°ì˜ ë§¤ì¼(3)</label>
                    </div>`;
                grid.appendChild(q);
            });

            const totalEl = document.getElementById('phq9Total');
            const sevTag = document.getElementById('phq9SevTag');
            const advice = document.getElementById('phq9Advice');
            const startBtn = document.getElementById('phq9StartBtn');
            const backBtn = document.getElementById('phq9BackBtn');
            const calcBtn = document.getElementById('phq9CalcBtn');
            const backBtn2 = document.getElementById('phq9BackBtn2');
            const resultDiv = document.getElementById('phq9Result');
            const progressDiv = document.getElementById('phq9Progress');
            const completedCount = document.getElementById('phq9CompletedCount');

            function getPHQ9Score() {
                let sum = 0;
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    sum += v ? Number(v.value) : 0;
                }
                return sum;
            }



            function getCompletedCount() {
                let completed = 0;
                // 9ê°œ ì£¼ìš” ë¬¸í•­ ì²´í¬
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    if(v) completed++;
                }
                
                return completed;
            }

            function updateProgress() {
                const completed = getCompletedCount();
                completedCount.textContent = completed;
                
                // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ ì¦‰ì‹œ ìœ„í—˜ë„ ì²´í¬ (9ë²ˆ ë¬¸í•­ ìí•´/ìì‚´ ìƒê°)
                // ì„¤ë¬¸ ì™„ë£Œ í›„ì—ë§Œ ê²½ê³  í‘œì‹œí•˜ë„ë¡ showResults í•¨ìˆ˜ë¡œ ì´ë™
                
                // ëª¨ë“  ë¬¸í•­ ì™„ë£Œì‹œ ê²°ê³¼ í™•ì¸ ë²„íŠ¼ í™œì„±í™”
                if(completed === 9) {
                    calcBtn.disabled = false;
                    calcBtn.textContent = 'ê²°ê³¼ í™•ì¸í•˜ê¸° âœ…';
                } else {
                    calcBtn.disabled = true;
                    calcBtn.textContent = `ê²°ê³¼ í™•ì¸í•˜ê¸° (${completed}/9)`;
                }
            }
            


            // PHQ-9 ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ ìœ„í—˜ë„ í‰ê°€ ë° ì•ˆì „ ì•ˆë‚´
            function assessPHQ9Risk(score, responses) {
                // ì/íƒ€í•´ ìœ„í—˜ë„ í‰ê°€ (9ë²ˆ ë¬¸í•­: ìí•´/ìì‚´ ìƒê°)
                const suicideRisk = responses[8]; // 9ë²ˆ ë¬¸í•­ (0-3)
                
                if (suicideRisk >= 2) { // 7-12ì¼ ë˜ëŠ” ê±°ì˜ ë§¤ì¼
                    return {
                        risk: 'high',
                        message: 'ìí•´/ìì‚´ ìƒê°ì´ ìˆëŠ” ê²ƒìœ¼ë¡œ ë³´ì…ë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.',
                        action: 'emergency'
                    };
                }
                
                if (score >= 20) {
                    return {
                        risk: 'high',
                        message: 'ì‹¬í•œ ìš°ìš¸ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ í‰ê°€ì™€ ì¹˜ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”.',
                        action: 'professional'
                    };
                }
                
                if (score >= 15) {
                    return {
                        risk: 'moderate',
                        message: 'ì¤‘ë“±ë„ ìš°ìš¸ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œí•©ë‹ˆë‹¤.',
                        action: 'consultation'
                    };
                }
                
                return {
                    risk: 'low',
                    message: 'í˜„ì¬ ìš°ìš¸ ì¦ìƒì€ ê²½ë¯¸í•©ë‹ˆë‹¤.',
                    action: 'selfcare'
                };
            }

            function showResults() {
                const score = getPHQ9Score();
                console.log('PHQ-9 ê²°ê³¼ ê³„ì‚° ì™„ë£Œ, ì ìˆ˜:', score);
                
                // ìœ¤ë¦¬ê°•ë ¹ ê¸°ë°˜ ìœ„í—˜ë„ í‰ê°€
                const responses = [];
                for(let i = 0; i < 9; i++) {
                    const v = document.querySelector(`input[name=q${i}]:checked`);
                    responses[i] = v ? Number(v.value) : 0;
                }
                
                const riskAssessment = assessPHQ9Risk(score, responses);
                console.log('PHQ-9 ìœ„í—˜ë„ í‰ê°€ ê²°ê³¼:', riskAssessment);
                
                // ì¸êµ¬í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                
                // PHQ-9 ì ìˆ˜ë¥¼ í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ê²°ê³¼ í™•ì¸ ì‹œì )
                const timestamp = Date.now();
                const phq9Data = {
                    score: score,
                    riskLevel: riskAssessment.risk,
                    timestamp: timestamp,
                    expires: timestamp + (24 * 60 * 60 * 1000), // 24ì‹œê°„ í›„ ë§Œë£Œ
                    demographics: demographicsData // ì¸êµ¬í†µê³„ ë°ì´í„° í¬í•¨
                };
                
                // Primary: sessionStorage (íƒ­ë³„ ë…ë¦½, ì¦‰ì‹œ ë³´ì•ˆ)
                sessionStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                
                // Fallback: localStorage (ì—°ì†ì„±, 24ì‹œê°„ ë§Œë£Œ)
                localStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                
                // ê°œë³„ ì‘ë‹µ ë°ì´í„°ë„ localStorageì— ì €ì¥ (9ë²ˆ ì§ˆë¬¸ ì ìˆ˜ í™•ì¸ìš©)
                localStorage.setItem('phq9_responses', JSON.stringify(responses));
                
                console.log('í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í† ë¦¬ì§€ ì €ì¥ ì™„ë£Œ (ê²°ê³¼ í™”ë©´):', { 
                    session_data: sessionStorage.getItem('phq9_data'),
                    local_data: localStorage.getItem('phq9_data'),
                    responses: responses,
                    expires_at: new Date(phq9Data.expires)
                });
                
                totalEl.textContent = score;
                const [label, cls] = getSeverityClass(score);
                sevTag.textContent = label;
                sevTag.className = 'phq9-sev ' + cls;



                // 9ë²ˆ ì§ˆë¬¸(ìí•´/ìì‚´ ìƒê°) ì ìˆ˜ í™•ì¸
                const question9Score = responses[8]; // 9ë²ˆ ì§ˆë¬¸ (0-3)
                
                    // 9ë²ˆ ì§ˆë¬¸ì—ì„œ 1ì  ì´ìƒì´ë©´ ì¦‰ì‹œ ìœ„í—˜ ì•ˆë‚´ ë° í”„ë¡œê·¸ë¨ ì‹œì‘ ë²„íŠ¼ ë¹„í™œì„±í™”
                if (question9Score >= 1) {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    advice.innerHTML = '<strong>âš ï¸ ì•ˆì „ ì•ˆë‚´:</strong> ìí•´ë‚˜ ìì‚´ ìƒê°ì´ ìˆëŠ” ê²½ìš° ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.';
                    
                    // ìœ„ê¸° ìƒë‹´ ì—°ë½ì²˜ ì•ˆë‚´ ì¶”ê°€
                    const crisisDiv = document.createElement('div');
                    crisisDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0; animation: fadeIn 0.5s ease-in;';
                    crisisDiv.innerHTML = `
                        <h4 style="margin: 0 0 12px; color: #856404;">âš ï¸ ìœ„ê¸° ìƒí™© ëŒ€ì‘ ì•ˆë‚´</h4>
                        <p style="margin: 0 0 16px; color: #856404;">ìí•´ë‚˜ ìì‚´ ìƒê°ì´ ìˆëŠ” ê²½ìš° ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì„¸ìš”.</p>
                        
                        <h4 style="margin: 0 0 12px; color: #856404;">ğŸ“ ìœ„ê¸° ìƒë‹´ ì—°ë½ì²˜</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <tr style="background: #fff8e1;">
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 20%;">êµ¬ë¶„</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 40%;">ê¸°ê´€/ì„œë¹„ìŠ¤ëª…</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 25%;">ì „í™”/ì±„íŒ…</th>
                                <th style="border: 1px solid #ffeaa7; padding: 8px; text-align: left; width: 15%;">ë¹„ê³ </th>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ìƒëª…ì˜ ì „í™” 1588-9191</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ìì‚´Â·ì •ì„œ ìœ„ê¸° ì „ë¬¸ ìƒë‹´, ë¹„ë°€ë³´ì¥</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ìì‚´ì˜ˆë°©ìƒë‹´ì „í™” 1393</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ë³´ê±´ë³µì§€ë¶€Â·í•œêµ­ìƒëª…ì¡´ì¤‘í¬ë§ì¬ë‹¨</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #e17055;">ìœ„ê¸° ìƒë‹´</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì •ì‹ ê±´ê°• ìƒë‹´ì „í™” 1577-0199</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ì •ì‹ ê±´ê°•ë³µì§€ì„¼í„° ì—°ê²°</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #74b9ff;">ì²­ì†Œë…„</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì²­ì†Œë…„ ì „í™” 1388</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”Â·ë¬¸ì(#1388)Â·ì±„íŒ…</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, ì²­ì†Œë…„ ëŒ€ìƒ ìœ„ê¸°Â·ì •ì„œ ì§€ì›</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #6c5ce7;">ì±„íŒ… ì¤‘ì‹¬</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì¹´ì¹´ì˜¤í†¡ 'ìì‚´ì˜ˆë°©ìƒë‹´' ì±„ë„</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì±„íŒ…</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">24ì‹œê°„, 1393 ìš´ì˜</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">ê¸´ê¸‰</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">119</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ìÂ·íƒ€í•´ ìœ„í—˜ ì¦‰ì‹œ êµ¬ì¡°</td>
                            </tr>
                            <tr>
                                <td style="border: 1px solid #ffeaa7; padding: 8px; font-weight: bold; color: #d63031;">ê¸´ê¸‰</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">112</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ì „í™”</td>
                                <td style="border: 1px solid #ffeaa7; padding: 8px;">ë²”ì£„Â·í­ë ¥ ìœ„í—˜ í¬í•¨ ì‹œ</td>
                            </tr>
                        </table>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                            <h4 style="margin: 0 0 12px; color: #27ae60;">ğŸ’¡ ì¹´ì¹´ì˜¤í†¡ ìƒë‹´ ì±„ë„</h4>
                            <p style="margin: 0 0 12px; color: #27ae60;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´ì„ ìœ„í•œ ì±„ë„ì…ë‹ˆë‹¤.</p>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>ë‹¤ ë“¤ì–´ì¤„ ê°œ:</strong> 
                                <a href="https://pf.kakao.com/_CxoBxcC" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_CxoBxcC
                                </a> â†—
                                <br><small style="color: #6b7280;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´, 24ì‹œê°„ ì±„íŒ… ìƒë‹´ ê°€ëŠ¥</small>
                            </div>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>ë§ˆë“¤ëœ:</strong> 
                                <a href="https://pf.kakao.com/_DAxbYG" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_DAxbYG
                                </a> â†—
                                <br><small style="color: #6b7280;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´, 24ì‹œê°„ ì±„íŒ… ìƒë‹´ ê°€ëŠ¥</small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border-radius: 6px; border-left: 4px solid #27ae60;">
                            <strong>ğŸ’¡ ì‹¬ë¦¬ìƒë‹´ í¬í„¸:</strong> 
                            <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                https://www.mindinfo.kr/new/index.asp
                            </a> â†—
                            <br><small style="color: #6b7280;">ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ê¸°, ì‹¬ë¦¬ìƒë‹´ì„¼í„° ì°¾ê¸°, ê³µê³µ ì‹¬ë¦¬ìƒë‹´ ê¸°ê´€ ë° ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ</small>
                        </div>
                    `;
                    
                    // advice ìš”ì†Œ ë‹¤ìŒì— ìœ„ê¸° ìƒë‹´ ì•ˆë‚´ ì¶”ê°€
                    advice.parentNode.insertBefore(crisisDiv, advice.nextSibling);
                } else {
                    // 9ë²ˆ ì§ˆë¬¸ì—ì„œ 1ì  ë¯¸ë§Œì¸ ê²½ìš° ê¸°ì¡´ ê²Œì´íŒ… ë¡œì§ ì ìš©
                    if (riskAssessment.risk === 'high') {
                    startBtn.disabled = true;
                    advice.className = 'phq9-note phq9-warn';
                    advice.innerHTML = `<strong>âš ï¸ ì•ˆì „ ì•ˆë‚´:</strong> ${riskAssessment.message}`;
                } else if (score <= 14 && question9Score === 0) {
                    // 0â€“14ì ì´ë©° 9ë²ˆ ë¬¸í•­ 0ì : ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = 'ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰';
                    
                    advice.innerHTML = '<strong>ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:</strong> í•´ë‹¹ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì´ë©°, <b>9ë²ˆ ë¬¸í•­ì´ 0ì </b>ì…ë‹ˆë‹¤. <br><br><strong>ì´ì œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬(GAD-7)ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>';
                    advice.className = 'phq9-note phq9-info';
                    
                } else if (score > 14 || question9Score >= 1) {
                    // 15ì  ì´ìƒì´ê±°ë‚˜ 9ë²ˆ ë¬¸í•­ 1ì  ì´ìƒ: í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    
                    if (score > 14) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>15ì  ì´ìƒ</b>ìœ¼ë¡œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    } else {
                        advice.innerHTML = '9ë²ˆ ë¬¸í•­ì— <b>1ì  ì´ìƒ</b>ì´ ìˆì–´ ì•ˆì „ìƒ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    advice.className = 'phq9-note phq9-warn';
                } else if (score <= 4) {
                    // 0-4ì : ì •ìƒ ë²”ìœ„
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ì •ìƒ(0â€“4)</b> ë²”ìœ„ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ì¶”í›„ ë‹¤ì‹œ ì²´í¬í•˜ê±°ë‚˜, ìƒí™œ ë¦¬ë“¬ ê´€ë¦¬ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.';
                    advice.className = 'phq9-note phq9-warn';
                }
                }

                // PHQ-9 9ë²ˆ ì§ˆë¬¸(ìí•´/ìì‚´ ìƒê°)ì—ì„œ 1ì  ì´ìƒì¼ ë•Œ ìœ„ê¸° ìƒë‹´ ì—°ë½ì²˜ ì•ˆë‚´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ í‘œì‹œë¨

                // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì „í™˜
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';

                // ì‹¬ë¦¬ìƒë‹´ í¬í„¸ ë° ì¹´ì¹´ì˜¤í†¡ ìƒë‹´ ì±„ë„ ì•ˆë‚´ (PHQ-9 ì™„ë£Œ ì¦‰ì‹œ)
                // ì‹¬ë¦¬ìƒë‹´ í¬í„¸ ì•ˆë‚´ (PHQ-9 ì™„ë£Œ ì¦‰ì‹œ) - ì‹¬ê°í•œ ì¦ìƒì´ ì•„ë‹ ë•Œë§Œ í‘œì‹œ
                if (!document.getElementById('counselingPortalInfo') && score <= 14 && question9Score === 0) {
                    const portal = document.createElement('div');
                    portal.id = 'counselingPortalInfo';
                    portal.style.cssText = 'margin-top:16px; padding:12px; background:#e8f5e8; border-left:4px solid #27ae60; border-radius:6px;';
                    portal.innerHTML = `
                        <strong>ğŸ’¡ ì‹¬ë¦¬ìƒë‹´ í¬í„¸:</strong> 
                        <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color:#2563eb; text-decoration:none; font-weight:500;">
                            https://www.mindinfo.kr/new/index.asp
                        </a> â†—
                        <br><small style="color:#6b7280;">ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ê¸°, ì‹¬ë¦¬ìƒë‹´ì„¼í„° ì°¾ê¸°, ê³µê³µ ì‹¬ë¦¬ìƒë‹´ ê¸°ê´€ ë° ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ</small>
                    `;
                    resultDiv.appendChild(portal);
                }
            }

            document.addEventListener('change', e => {
                if(e.target.matches('.phq9-screening input[type=radio]')) updateProgress();
            });

            // ê²°ê³¼ í™•ì¸ ë²„íŠ¼
            calcBtn.addEventListener('click', showResults);

            // ì²« ë²ˆì§¸ ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ (ì§„í–‰ ì¤‘)
            backBtn2.addEventListener('click', () => {
                document.querySelector('.phq9-screening').remove();
                showIntro = true;
                renderIntro();
            });

            // ë‘ ë²ˆì§¸ ë’¤ë¡œ ê°€ê¸° ë²„íŠ¼ (ê²°ê³¼ í™”ë©´)
            backBtn.addEventListener('click', () => {
                document.querySelector('.phq9-screening').remove();
                showIntro = true;
                renderIntro();
            });

            // ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰ ë²„íŠ¼ (GAD-7)
            startBtn.addEventListener('click', () => {
                console.log('ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰ ë²„íŠ¼ í´ë¦­');
                
                // GAD-7 ê²€ì‚¬ í™”ë©´ìœ¼ë¡œ ì´ë™
                renderGAD7Screening();
            });

            // ì´ˆê¸° ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateProgress();
        }

        // í”„ë¡œê·¸ë¨ ì‹œì‘ í•¨ìˆ˜
        function startProgram() {
            // PHQ-9 ë˜ëŠ” GAD-7 ê²°ê³¼ ì»¨í…Œì´ë„ˆ ì¤‘ ì¡´ì¬í•˜ëŠ” ê²ƒì„ ì‚¬ìš©
            const screeningContainer = document.querySelector('.phq9-screening') || document.querySelector('.gad7-screening');
            if (!screeningContainer) return;
            
            // ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ í™•ì¸
            const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
            const groupParticipation = demographicsData.groupParticipation;
            
            if (groupParticipation === 'none') {
                // 'ì•„ë‹ˆì˜¤, ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤' ì„ íƒ ì‹œ
                showCompletionMessage(screeningContainer);
            } else if (groupParticipation === 'yes' || groupParticipation === 'no') {
                // 'í•¨ê»˜ í•˜ëŠ” ì§‘ë‹¨ ì˜í™”ì œì‘ì¹˜ë£Œ' ë˜ëŠ” 'í˜¼ì ì§„í–‰í•˜ëŠ” ê°œì¸ ì˜í™”ì œì‘ì¹˜ë£Œ' ì„ íƒ ì‹œ
                showHighScoreItems(screeningContainer);
            } else {
                // ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°
                screeningContainer.innerHTML = '<div style="text-align:center; padding:20px;">ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
            }
        }
        
        // ì™„ë£Œ ë©”ì‹œì§€ í‘œì‹œ (ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤ ì„ íƒ ì‹œ)
        function showCompletionMessage(container) {
            // PHQ-9ê³¼ GAD-7 ì´ì  ê³„ì‚°
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');
            
            const phq9Total = phq9Data.score || 0;
            const gad7Total = gad7Data.score || 0;
            
            container.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!</h1>
                        <div style="text-align:center; margin:20px 0;">
                            <p style="font-size:1.2em; color:#6b7280; margin-bottom:20px;">
                                ì˜í™”ì œì‘ì¹˜ë£Œì— ì°¸ì—¬í•˜ì§€ ì•Šê¸°ë¡œ í•˜ì…¨ìŠµë‹ˆë‹¤.<br>
                                ê²€ì‚¬ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:
                            </p>
                            <div style="display:flex; justify-content:center; gap:40px; margin:20px 0;">
                                <div style="text-align:center;">
                                    <div style="font-size:2em; font-weight:bold; color:#6f42c1;">${phq9Total}</div>
                                    <div style="color:#6b7280;">PHQ-9 (ìš°ìš¸)</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:2em; font-weight:bold; color:#dc3545;">${gad7Total}</div>
                                    <div style="color:#6b7280;">GAD-7 (ë¶ˆì•ˆ)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ìµœê³ ì  ë¬¸í•­ í‘œì‹œ ë° ìƒí™© ë¶„ì„ ì§ˆë¬¸ (ì°¸ì—¬í•˜ê² ìŠµë‹ˆë‹¤ ì„ íƒ ì‹œ)
        function showHighScoreItems(container) {
            // PHQ-9ê³¼ GAD-7 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');
            
            // ë””ë²„ê¹…ì„ ìœ„í•œ ë°ì´í„° êµ¬ì¡° ë¡œê¹…
            console.log('PHQ-9 ë°ì´í„° êµ¬ì¡°:', phq9Data);
            console.log('GAD-7 ë°ì´í„° êµ¬ì¡°:', gad7Data);
            console.log('PHQ-9 items íƒ€ì…:', typeof phq9Data.items, Array.isArray(phq9Data.items));
            console.log('GAD-7 items íƒ€ì…:', typeof gad7Data.items, Array.isArray(gad7Data.items));

            // í•­ëª© í…ìŠ¤íŠ¸ í—¬í¼ (ì „ì—­ í•¨ìˆ˜ê°€ ì—†ì„ ë•Œ ì•ˆì „í•œ ëŒ€ì²´)
            const PHQ9_TEXTS = {
                1: "ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤.",
                2: "í‰ì†Œì— ì•„ë¬´ë ‡ì§€ ì•Šê²Œ í•˜ë˜ ì¼ì— í¥ë¯¸ê°€ ì—†ì–´ì§€ê±°ë‚˜ ì¦ê±°ì›€ì„ ëŠë¼ì§€ ëª»í–ˆë‹¤",
                3: "ì ë“¤ê¸° ì–´ë µê±°ë‚˜ ìì£¼ ê¹¼ë‹¤/í˜¹ì€ ë„ˆë¬´ ë§ì´ ì¤ë‹¤.",
                4: "í‰ì†Œë³´ë‹¤ ì‹ìš•ì´ ì¤„ì—ˆë‹¤/í˜¹ì€ í‰ì†Œë³´ë‹¤ ë§ì´ ë¨¹ì—ˆë‹¤",
                5: "ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ëˆˆì¹˜ ì±Œ ì •ë„ë¡œ í‰ì†Œë³´ë‹¤ ë§ê³¼ í–‰ë™ì´ ëŠë ¤ì¡Œë‹¤/í˜¹ì€ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆ ëª» í•´ì„œ ê°€ë§Œíˆ ì•‰ì•„ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤.",
                6: "í”¼ê³¤í•˜ê³  ê¸°ìš´ì´ ì—†ì—ˆë‹¤",
                7: "ë‚´ê°€ ì˜ëª»í–ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤/í˜¹ì€ ìì‹ ê³¼ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ê³  ìƒê°í–ˆë‹¤.",
                8: "ì‹ ë¬¸ì„ ì½ê±°ë‚˜ TVë¥¼ ë³´ëŠ” ê²ƒê³¼ ê°™ì€ ì¼ìƒì ì¸ ì¼ì—ë„ ì§‘ì¤‘í•˜ê¸° ì–´ë ¤ì› ë‹¤.",
                9: "ì°¨ë¼ë¦¬ ì£½ëŠ” ê²ƒì´ ë” ë‚«ê² ë‹¤ê³  ìƒê°í–ˆë‹¤/í˜¹ì€ ìí•´í•  ìƒê°ì„ í–ˆë‹¤"
            };
            const GAD7_TEXTS = {
                1: "ì´ˆì¡°í•˜ê±°ë‚˜ ë¶ˆì•ˆí•˜ê±°ë‚˜ ì¡°ë§ˆì¡°ë§ˆí•˜ê²Œ ëŠë‚€ë‹¤.",
                2: "ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶”ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ê°€ ì—†ë‹¤.",
                3: "ì—¬ëŸ¬ ê°€ì§€ ê²ƒë“¤ì— ëŒ€í•´ ê±±ì •ì„ ë„ˆë¬´ ë§ì´ í•œë‹¤.",
                4: "í¸í•˜ê²Œ ìˆê¸°ê°€ ì–´ë µë‹¤.",
                5: "ì‰½ê²Œ ì§œì¦ì´ ë‚˜ê±°ë‚˜ ì‰½ê²Œ ì„±ì„ ë‚´ê²Œ ëœë‹¤.",
                6: "ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ ê°€ë§Œíˆ ìˆê¸°ê°€ í˜ë“¤ë‹¤.",
                7: "ë§ˆì¹˜ ë”ì°í•œ ì¼ì´ ìƒê¸¸ ê²ƒì²˜ëŸ¼ ë‘ë µê²Œ ëŠê»´ì§„ë‹¤."
            };
            const resolvePhq9Text = (num) => {
                try {
                    if (typeof getPhq9ItemText === 'function') return getPhq9ItemText(num);
                } catch (_) {}
                return PHQ9_TEXTS[num] || `í•­ëª© ${num}`;
            };
            const resolveGad7Text = (num) => {
                try {
                    if (typeof getGad7ItemText === 'function') return getGad7ItemText(num);
                } catch (_) {}
                return GAD7_TEXTS[num] || `í•­ëª© ${num}`;
            };
            
            // ê³µí†µ: items ì •ê·œí™” ìœ í‹¸ (ë°°ì—´/ê°ì²´/ëˆ„ë½ ëª¨ë‘ í—ˆìš© â†’ 1..count í‚¤ ê°ì²´)
            const normalizeItems = (items, count) => {
                const result = {};
                if (items) {
                    if (Array.isArray(items)) {
                        for (let i = 0; i < items.length; i++) result[String(i+1)] = Number(items[i]) || 0;
                    } else if (typeof items === 'object') {
                        Object.keys(items).forEach(k => { result[String(k)] = Number(items[k]) || 0; });
                    }
                }
                if (count) {
                    for (let i = 1; i <= count; i++) if (result[String(i)] == null) result[String(i)] = 0;
                }
                return result;
            };

            // PHQ-9 ìµœê³ ì  ë¬¸í•­ ì¶”ì¶œ (0ì  ì œì™¸) - ë°°ì—´/ê°ì²´/ë¡œì»¬ë°±ì—… ëª¨ë‘ ì²˜ë¦¬
            let phq9HighScores = [];
            {
                let sourceItems = phq9Data.items;
                if (!sourceItems) {
                    // ë°±ì—…: ê³¼ê±° ì €ì¥ í˜•íƒœ ë°°ì—´(localStorage: phq9_responses)
                    try {
                        const legacy = JSON.parse(localStorage.getItem('phq9_responses') || 'null');
                        if (Array.isArray(legacy) && legacy.length) {
                            const temp = {};
                            for (let i = 0; i < 9; i++) temp[String(i+1)] = Number(legacy[i]) || 0;
                            sourceItems = temp;
                        }
                    } catch(_) {}
                }
                const norm = normalizeItems(sourceItems, 9);
                phq9HighScores = Object.entries(norm)
                    .map(([n, s]) => ({ score: Number(s), itemNum: Number(n), text: resolvePhq9Text(Number(n)) }))
                    .filter(item => item.score > 0)
                    .sort((a, b) => b.score - a.score);
            }
            
            // GAD-7 ìµœê³ ì  ë¬¸í•­ ì¶”ì¶œ (0ì  ì œì™¸) - ë°°ì—´ê³¼ ê°ì²´ ëª¨ë‘ ì²˜ë¦¬
            let gad7HighScores = [];
            if (gad7Data.items) {
                if (Array.isArray(gad7Data.items)) {
                    // ë°°ì—´ í˜•íƒœì¸ ê²½ìš°
                    gad7HighScores = gad7Data.items
                        .map((score, index) => ({ score: Number(score), itemNum: index + 1, text: resolveGad7Text(index + 1) }))
                        .filter(item => item.score > 0)
                        .sort((a, b) => b.score - a.score);
                } else if (typeof gad7Data.items === 'object') {
                    // ê°ì²´ í˜•íƒœì¸ ê²½ìš° (ì˜ˆ: {1: 3, 2: 3, 3: 0, ...})
                    gad7HighScores = Object.entries(gad7Data.items)
                        .map(([itemNum, score]) => ({ 
                            score: Number(score), 
                            itemNum: parseInt(itemNum), 
                            text: resolveGad7Text(parseInt(itemNum)) 
                        }))
                        .filter(item => item.score > 0)
                        .sort((a, b) => b.score - a.score);
                }
            }
            
            // í‘œ ìƒì„±
            let tableHTML = '';
            if (phq9HighScores.length > 0 || gad7HighScores.length > 0) {
                tableHTML = `
                    <table style="width:100%; border-collapse:collapse; margin:20px 0; border:1px solid #e5e7eb;">
                        <thead>
                            <tr style="background-color:#f9fafb;">
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:center;">ì²™ë„</th>
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:left;">ë¬¸í•­</th>
                                <th style="border:1px solid #e5e7eb; padding:12px; text-align:center;">ì ìˆ˜</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // PHQ-9 í•­ëª© ì¶”ê°€
                phq9HighScores.forEach(item => {
                    tableHTML += `
                        <tr>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; background-color:#f8f9fa;">PHQ-9 (ìš°ìš¸)</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:left;">${item.text}</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; font-weight:bold; color:#6f42c1;">${item.score}ì </td>
                        </tr>
                    `;
                });
                
                // GAD-7 í•­ëª© ì¶”ê°€
                gad7HighScores.forEach(item => {
                    tableHTML += `
                        <tr>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; background-color:#f8f9fa;">GAD-7 (ë¶ˆì•ˆ)</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:left;">${item.text}</td>
                            <td style="border:1px solid #e5e7eb; padding:12px; text-align:center; font-weight:bold; color:#dc3545;">${item.score}ì </td>
                        </tr>
                    `;
                });
                
                tableHTML += `
                        </tbody>
                    </table>
                `;
            } else {
                tableHTML = '<div style="text-align:center; color:#6c757d; padding:20px;">ê²€ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            }
            
            container.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">PHQ-9ê³¼ GAD-7 ìµœê³ ì  ë¬¸í•­</h1>
                        <div style="margin:20px 0;">
                            <p style="font-size:1.1em; color:#6b7280; margin-bottom:20px;">
                                ì•„ë˜ëŠ” ê° ì²™ë„ì—ì„œ 0ì ì´ ì•„ë‹Œ ë¬¸í•­ë“¤ì„ ì ìˆ˜ ìˆœìœ¼ë¡œ ì •ë¦¬í•œ í‘œì…ë‹ˆë‹¤.
                            </p>
                            ${tableHTML}
                        </div>
                        
                        <div class="demo-section" style="margin-top:20px;">
                            <h4>ì§€ë‚œ 2ì£¼ ê°„ ì–´ë–¤ ì¼ ë•Œë¬¸ì— ìœ„ì™€ ê°™ì€ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì…¨ë‚˜ìš”?</h4>
                            <textarea id="situationAnalysis" 
                                style="width:100%; min-height:120px; padding:12px; border:2px solid #e5e7eb; border-radius:8px; font-size:14px; resize:vertical;"
                                placeholder="ì§€ë‚œ 2ì£¼ê°„ ê²ªì—ˆë˜ ìƒí™©ì´ë‚˜ ì¼ë“¤ì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..."></textarea>
                        </div>
                        
                        <div class="gad7-btns" style="margin-top:20px;">
                            <button id="saveSituationBtn" class="gad7-btn gad7-primary">ì €ì¥</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            const saveBtn = document.getElementById('saveSituationBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const situationText = document.getElementById('situationAnalysis').value.trim();
                    if (situationText) {
                        // ìƒí™© ë¶„ì„ í…ìŠ¤íŠ¸ ì €ì¥
                        const analysisData = {
                            timestamp: Date.now(),
                            situation: situationText,
                            phq9Score: phq9Data.score || 0,
                            gad7Score: gad7Data.score || 0
                        };
                        
                        sessionStorage.setItem('situation_analysis', JSON.stringify(analysisData));
                        localStorage.setItem('situation_analysis', JSON.stringify(analysisData));
                        
                        alert('ìƒí™© ë¶„ì„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    } else {
                        alert('ìƒí™©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    }
                });
            }
        }
        
        // ì‹œë‚˜ë¦¬ì˜¤ ì—­í• ê·¹ ì´ˆê¸°í™” ë° ë¡œì§ (3475 ë¼ì¸ë¶€í„° ì ìš©)
        function initScenarioChatbot() {
            const chatbox = document.getElementById("chatbox");
            const startBtn = document.getElementById("startBtn");
            const sendBtn = document.getElementById("sendBtn");
            const endBtn = document.getElementById("endBtn");
            const userInput = document.getElementById("userInput");
            const scenarioPreview = document.getElementById("scenarioPreview");

            let scenarioContext = "";
            let conversationStep = 0;
            let chatHistory = [];
            let awaitingSituation = false;
            let selectedEmotionLabel = "";
            let selectedEmotionCategory = "";
            let awaitingAutoThought = false;
            let awaitingRationalResponse = false;
            let awaitingFutureScenario = false;
            let autoThoughtText = "";
            let rationalResponseText = "";
            let futureScenarioText = "";
            let scenarioModeActive = false;

            // ì±—ë´‡ ì»¨í…ìŠ¤íŠ¸ í”„ë¡¬í”„íŠ¸ ì •ì˜ (ìœ¤ë¦¬ê°•ë ¹ì´ 1ìˆœìœ„ë¡œ ì ìš©)
            const contextPrompt = `
ë„ˆëŠ” ì‹¬ë¦¬ìƒë‹´ ë³´ì¡° ì±—ë´‡ "íšŒë³µì˜ ì”¨ì•—"ì´ì•¼.
ì‚¬ìš©ìê°€ "ê²€ì€ íŒŒë„" ì—­í• ë¡œ ë¶€ì •ì ì¸ ìƒê°ì„ ë§í•˜ë©´,
ë„ˆëŠ” "íšŒë³µì˜ ì”¨ì•—"ìœ¼ë¡œì„œ ë°˜ë“œì‹œ ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ì„ í™œìš©í•´ ì‘ë‹µí•´ì•¼ í•´.

ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ì´ë€:
- "ê·¸ë ‡ê²Œ ë¯¿ê²Œ ëœ êµ¬ì²´ì ì¸ ì´ìœ ê°€ ìˆë‚˜ìš”?"
- "ê·¸ê²Œ í•­ìƒ ì‚¬ì‹¤ì¸ê°€ìš”, ì•„ë‹ˆë©´ ì´ë²ˆë§Œ ê·¸ëŸ°ê°€ìš”?"
- "ë¹„ìŠ·í•œ ìƒí™©ì—ì„œ ë‹¤ë¥¸ ê²°ê³¼ê°€ ë‚˜ì˜¨ ì ì€ ì—†ì—ˆë‚˜ìš”?"
- "ë§Œì•½ ì¹œêµ¬ê°€ ê°™ì€ ë§ì„ í–ˆë‹¤ë©´ ë­ë¼ê³  ì¡°ì–¸í•´ì£¼ê³  ì‹¶ë‚˜ìš”?"
ì²˜ëŸ¼, ì‚¬ìš©ìê°€ ìŠ¤ìŠ¤ë¡œ ìì‹ ì˜ ìƒê°ì˜ ê·¼ê±°ë¥¼ ê²€í† í•˜ë„ë¡ ìœ ë„í•˜ëŠ” ì§ˆë¬¸ ë°©ì‹ì´ì•¼.

ëŒ€í™” ê·œì¹™:
1. ë¨¼ì € ì‚¬ìš©ìì˜ ê°ì •ì„ ê³µê°í•´ì¤˜.
2. ì´ì–´ì„œ ë°˜ë“œì‹œ ìœ„ì™€ ê°™ì€ **ì†Œí¬ë¼í…ŒìŠ¤ì‹ ì§ˆë¬¸ íŒ¨í„´ ì¤‘ í•˜ë‚˜**ë¥¼ ì ìš©í•´.
3. ê°€ëŠ¥í•˜ë‹¤ë©´ ì‚¬ìš©ìê°€ ë§í•œ ê¸ì •ì ì¸ ë©´ì´ë‚˜ ê¹¨ë‹¬ìŒì„ ì—°ê²°í•´ ë§ì¶¤ í”¼ë“œë°±ì„ í•´ì¤˜.
4. ë‹µë³€ì€ 1~3ë¬¸ì¥ ì´ë‚´ë¡œ ê°„ê²°í•˜ê²Œ.
5. PHQ-9(ìš°ìš¸)ê³¼ GAD-7(ë¶ˆì•ˆ) ê° ì„¤ë¬¸ì—ì„œ "ìµœê³ ì "ì— í•´ë‹¹í•˜ëŠ” ë¬¸í•­ë§Œ í‘œë¡œ ìš”ì•½í•´ ë³´ì—¬ì¤˜.
   í‘œ ì—´ êµ¬ì„±: "ì²™ë„", "ë¬¸í•­", "ì ìˆ˜". ê° ì²™ë„ì—ì„œ ìµœê³ ì  ë¬¸í•­ë§Œ í¬í•¨í•´.
   í‘œê°€ ìƒì„±ëœ ë’¤ ì±—ë´‡ì€ ë‹¤ìŒ ì§ˆë¬¸ì„ ì´ì–´ì„œ í•´:
   "í‘œì˜ ì ìˆ˜ëŠ” ì‚¬ìš©ìë‹˜ê»˜ì„œ ë§¤ê¸°ì‹  ìš°ìš¸ ì²™ë„ì™€ ë¶ˆì•ˆ ì²™ë„ì˜ ìµœê³ ì ì— í•´ë‹¹í•˜ëŠ” ë¬¸í•­ì´ì—ìš”. ì§€ë‚œ 2ì£¼ê°„ ì–´ë–¤ ì¼ ë•Œë¬¸ì— ìœ„ì™€ ê°™ì€ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì…¨ë‚˜ìš”?"
6. ì‚¬ìš©ìê°€ 'ì¢…ë£Œ'ë¥¼ ì„ íƒí•˜ë©´, ì§€ê¸ˆê¹Œì§€ ì˜¤ê°„ ëŒ€í™”ë¥¼ "ëŒ€í™” ìŠ¤í¬ë¦½íŠ¸" í˜•íƒœë¡œ ì •ë¦¬í•´ì¤˜.
   ì´ë•Œ **ì•„ë¬´ê²ƒë„ ì¶”ê°€í•˜ì§€ ë§ê³  ì˜¤ë¡œì§€ ì˜¤ê°„ ëŒ€í™”ë§Œ** ìˆì–´ì•¼ í•´.
`;

            function addMessage(sender, message) {
                const div = document.createElement("div");
                div.className = sender;
                if (scenarioModeActive) {
                    // ì‹œë‚˜ë¦¬ì˜¤ í˜•ì‹: í™”ì, (í†¤/í–‰ë™), â€œëŒ€ì‚¬â€
                    const speaker = sender === "bot" ? "ì±—ë´‡" : "ë‚˜";
                    const parenthetical = sender === "bot" ? "(ì°¨ë¶„í•˜ê²Œ)" : "";
                    const dialogue = `â€œ${message}â€`;
                    div.style.margin = "8px 0";
                    div.style.whiteSpace = "pre-wrap";
                    div.innerHTML = `${speaker}<br>${parenthetical}<br>${dialogue}`;
                } else {
                    div.innerHTML = `${sender === "bot" ? "ì±—ë´‡" : "ë‚˜"}: ${message}`;
                }
                if (chatbox) {
                    chatbox.appendChild(div);
                    chatbox.scrollTop = chatbox.scrollHeight;
                }
                chatHistory.push({ sender, message });
            }

            async function callGeminiAPI(userMessage) {
                try {
                    // ìœ¤ë¦¬ì  ê°€ì´ë“œë¼ì¸ ìš°ì„  ê²€ì¦ (1ìˆœìœ„)
                    const ethicalCheck = validatePrivacyAndEthics(userMessage);
                    if (ethicalCheck.requiresAttention) {
                        return ethicalCheck.message;
                    }

                    // ìœ„í—˜ë„ í‰ê°€
                    const riskAssessment = assessRisk(userMessage);
                    if (riskAssessment.level === 'high') {
                        return getSafetyMessage(riskAssessment.type);
                    }

                    // Gemini API í˜¸ì¶œ
                    const response = await fetch('/api/gemini', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            message: userMessage,
                            context: contextPrompt,
                            chatHistory: chatHistory.slice(-10) // ìµœê·¼ 10ê°œ ë©”ì‹œì§€ë§Œ ì „ì†¡
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`API í˜¸ì¶œ ì‹¤íŒ¨: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.response || "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";

                } catch (error) {
                    console.error('Gemini API í˜¸ì¶œ ì˜¤ë¥˜:', error);
                    return "ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                }
            }

            // ìœ¤ë¦¬ì  ê°€ì´ë“œë¼ì¸ ê²€ì¦ í•¨ìˆ˜
            function validatePrivacyAndEthics(message) {
                const sensitivePatterns = [
                    /ìí•´|ìì‚´|ì£½ê³ \s*ì‹¶|ëë‚´ê³ \s*ì‹¶/gi,
                    /í­ë ¥|ì‚´ì¸|ë²”ì£„/gi,
                    /ê°œì¸ì •ë³´|ì „í™”ë²ˆí˜¸|ì£¼ë¯¼ë²ˆí˜¸|ì£¼ì†Œ/gi
                ];

                for (const pattern of sensitivePatterns) {
                    if (pattern.test(message)) {
                        return {
                            requiresAttention: true,
                            message: "ì´ëŸ° ì‹¬ê°í•œ ë‚´ìš©ì— ëŒ€í•´ì„œëŠ” ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œëŠ” ê²ƒì´ ì¢‹ê² ìŠµë‹ˆë‹¤. 24ì‹œê°„ ìƒë‹´ì „í™” 1393 ë˜ëŠ” 1588-9191ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”."
                        };
                    }
                }

                return { requiresAttention: false };
            }

            // ìœ„í—˜ë„ í‰ê°€ í•¨ìˆ˜
            function assessRisk(message) {
                const text = message.toLowerCase();
                
                if (/ìí•´|ìì‚´|ì£½ê³ \s*ì‹¶|ëë‚´ê³ \s*ì‹¶/.test(text)) {
                    return { level: 'high', type: 'suicide' };
                }
                if (/í­ë ¥|ì‚´ì¸|ë²”ì£„/.test(text)) {
                    return { level: 'high', type: 'violence' };
                }
                if (/ê·¹ë‹¨ì |ì ˆë§|í¬ë§\s*ì—†|ë‹µ\s*ì—†/.test(text)) {
                    return { level: 'medium', type: 'despair' };
                }
                
                return { level: 'low', type: 'normal' };
            }

            // ì•ˆì „ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
            function getSafetyMessage(type) {
                const messages = {
                    suicide: "ì§€ê¸ˆ ì´ ìˆœê°„ì´ ì •ë§ í˜ë“œì‹œê² ì–´ìš”. í•˜ì§€ë§Œ ë‹¹ì‹ ì˜ ìƒëª…ì€ ì†Œì¤‘í•©ë‹ˆë‹¤. ì§€ê¸ˆ ë‹¹ì¥ 24ì‹œê°„ ìƒë‹´ì „í™” 1393 ë˜ëŠ” 1588-9191ë¡œ ì—°ë½í•´ì£¼ì„¸ìš”. ì „ë¬¸ê°€ë“¤ì´ ë‹¹ì‹ ì„ ë„ì™€ë“œë¦´ ê²ƒì…ë‹ˆë‹¤.",
                    violence: "ì´ëŸ° ê°ì •ì„ ëŠë¼ëŠ” ê²ƒì…ë‹ˆë‹¤. í•˜ì§€ë§Œ í­ë ¥ì€ í•´ê²°ì±…ì´ ì•„ë‹™ë‹ˆë‹¤. ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ë” ë‚˜ì€ í•´ê²°ì±…ì„ ì°¾ì•„ë³´ì„¸ìš”.",
                    despair: "ì§€ê¸ˆì€ ì •ë§ ì–´ë ¤ìš´ ì‹œê¸°ì¸ ê²ƒ ê°™ì•„ìš”. í•˜ì§€ë§Œ ì´ ìƒí™©ì€ ì˜ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì—¬ ë„ì›€ì„ ë°›ì•„ë³´ì„¸ìš”."
                };
                return messages[type] || "ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.";
            }

            // ëŒ€í™” ìš”ì•½ ìƒì„± í•¨ìˆ˜
            function generateConversationSummary() {
                let summary = "ğŸ¯ ì˜¤ëŠ˜ì˜ ëŒ€í™” ìš”ì•½\n\n";
                
                if (scenarioContext) {
                    summary += `ğŸ“ ì£¼ìš” ìƒí™©: ${scenarioContext}\n\n`;
                }
                
                if (chatHistory.length > 0) {
                    summary += "ğŸ’¬ ëŒ€í™” ë‚´ìš©:\n";
                    chatHistory.forEach((msg, index) => {
                        if (msg.sender === 'user') {
                            summary += `- ë‚˜: ${msg.message}\n`;
                        } else if (msg.sender === 'bot') {
                            // HTML íƒœê·¸ ì œê±°í•˜ê³  ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
                            const cleanMessage = msg.message.replace(/<[^>]*>/g, '').trim();
                            if (cleanMessage) {
                                summary += `- ì±—ë´‡: ${cleanMessage}\n`;
                            }
                        }
                    });
                }
                
                summary += "\nâœ¨ ì˜¤ëŠ˜ë„ ë‹¹ì‹ ì˜ íšŒë³µì„ ìœ„í•œ í•œ ê±¸ìŒì„ ë‚´ë”›ìœ¼ì…¨ìŠµë‹ˆë‹¤. ë‚´ì¼ë„ í˜ë‚´ì„¸ìš”!";
                
                return summary;
            }

            function analyzeTextSimple(text) {
                const t = (text || '').toLowerCase();
                const hits = {
                    angry: ['í™”', 'ì§œì¦', 'ë¶„ë…¸', 'ì—´ë°›', 'ë¹¡', 'ì„±ë‚¨'],
                    sad: ['ìŠ¬í”„', 'ìš°ìš¸', 'ì„œëŸ¬', 'ëˆˆë¬¼', 'ì„œê¸€í”„', 'ìƒì‹¤'],
                    anxious: ['ë¶ˆì•ˆ', 'ê±±ì •', 'ì´ˆì¡°', 'ë‘ë µ', 'ê¸´ì¥'],
                    hurt: ['ìƒì²˜', 'ì–µìš¸', 'ë°°ì‹ ', 'ëª¨ìš•', 'ê´´ë¡­'],
                    embarrassed: ['ë‹¹í™©', 'ë¨¸ì“±', 'ì°½í”¼', 'ë¶€ë„'],
                    happy: ['ê¸°ì¨', 'í–‰ë³µ', 'ì¢‹ì•˜', 'ì„¤ë ˜', 'ë¿Œë“¯']
                };
                let maxCat = '';
                let maxCount = 0;
                Object.entries(hits).forEach(([cat, words]) => {
                    const count = words.reduce((acc, w) => acc + (t.includes(w) ? 1 : 0), 0);
                    if (count > maxCount) { maxCount = count; maxCat = cat; }
                });
                return { dominant: maxCat, score: maxCount };
            }

            startBtn && startBtn.addEventListener("click", () => {
                conversationStep = 0;
                chatHistory = [];
                awaitingSituation = false;

                chatbox.innerHTML = "";
                // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ ì œê±°: íŒ¨ë„ í‘œì‹œì™€ ë™ì‹œì— ìë™ ì§ˆì˜
                const panel = document.getElementById('emotionPanel');
                if (panel) panel.style.display = 'block';
                displaySymptomItems();
                // íŒ¨ë„ í‘œì‹œ ì§í›„ ìë™ìœ¼ë¡œ ìµœê³ ì  ë¬¸í•­ì— ëŒ€í•´ ì§ˆë¬¸
                askHighestSymptomQuestion();
                // ìƒí™© ì§ˆë¬¸ ëŒ€ê¸° ìƒíƒœë¡œ ì„¤ì •
                awaitingSituation = true;

                userInput.disabled = false;
                sendBtn.disabled = false;
                endBtn.disabled = false;
            });

            sendBtn && sendBtn.addEventListener("click", async () => {
                const message = userInput.value.trim();
                if (!message) return;

                addMessage("user", message);
                    userInput.value = "";

                if (awaitingSituation) {
                    // ìœ ì €ê°€ ì–´ì ˆ(ë‹¨ì–´) ë‹¨ìœ„ë¡œ ì‘ë‹µí–ˆëŠ”ì§€ í™•ì¸ í›„ í¼ UI ì ìš©
                    const tokens = message.split(/\s+/).filter(Boolean);
                    
                    // ì˜ë¯¸ ìˆëŠ” ë‹¨ì–´ë§Œ í•„í„°ë§ (í•œêµ­ì–´, ì˜ì–´, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì ì¡°í•© ì œì™¸)
                    const meaningfulTokens = tokens.filter(token => {
                        // 2ê¸€ì ë¯¸ë§Œì€ ì œì™¸
                        if (token.length < 2) return false;
                        
                        // í•œê¸€ì´ë‚˜ ì˜ì–´ê°€ í¬í•¨ëœ ë‹¨ì–´ë§Œ í—ˆìš©
                        const hasKorean = /[ê°€-í£]/.test(token);
                        const hasEnglish = /[a-zA-Z]/.test(token);
                        const hasNumber = /\d/.test(token);
                        
                        // í•œê¸€ì´ë‚˜ ì˜ì–´ê°€ í¬í•¨ë˜ì–´ì•¼ í•˜ë©°, ìˆ«ìë§Œìœ¼ë¡œëŠ” ì•ˆë¨
                        return (hasKorean || hasEnglish) && !(hasNumber && !hasKorean && !hasEnglish);
                    });
                    
                    if (meaningfulTokens.length === 0) {
                        addMessage('bot', 'ì˜ë¯¸ ìˆëŠ” ë‹¨ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. ì˜ˆ: "íšŒì‚¬ì—ì„œ ìƒì‚¬ê°€ ë‚˜ë¥¼ ë¬´ì‹œí–ˆë‹¤" (í•œê¸€, ì˜ì–´ ë‹¨ì–´ë§Œ ì¸ì •ë©ë‹ˆë‹¤)');
                        return;
                    }

                    // ì˜ë¯¸ ìˆëŠ” í† í°ë§Œ ì‚¬ìš©í•˜ì—¬ ì‹œë‚˜ë¦¬ì˜¤ ì»¨í…ìŠ¤íŠ¸ ì„¤ì •
                    scenarioContext = meaningfulTokens.join(' ');

     

                    // ìƒíƒœ ì „í™˜í•˜ì—¬ contextPrompt ê¸°ë°˜ ëŒ€í™” ì‹œì‘
                    awaitingSituation = false;
                    scenarioModeActive = true;
                    
                    // ì±—ë´‡ì´ ì²« ì‘ë‹µì„ ìƒì„±í•˜ë„ë¡ API í˜¸ì¶œ
                    const firstResponse = await callGeminiAPI(`ì‚¬ìš©ìê°€ "${scenarioContext}"ë¼ëŠ” ìƒí™©ì— ëŒ€í•´ ì´ì•¼ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤. ì´ ìƒí™©ì— ëŒ€í•´ ê³µê°ì ì´ê³  ì†Œí¬ë¼í‹±í•œ ì§ˆë¬¸ìœ¼ë¡œ ëŒ€í™”ë¥¼ ì‹œì‘í•´ì£¼ì„¸ìš”.`);
                    if (firstResponse) {
                        addMessage("bot", firstResponse);
                    }
                    return;
                }

                // 'ì¢…ë£Œ' ëª…ë ¹ ì²˜ë¦¬
                if (message === 'ì¢…ë£Œ') {
                    const summary = generateConversationSummary();
                    addMessage("bot", summary);
                    userInput.disabled = true;
                    sendBtn.disabled = true;
                    endBtn.disabled = true;
                    return;
                }

                // ì´í›„ ë‹¨ê³„ëŠ” ì¼ë‹¨ ì¤‘ë‹¨ (ê°ì • â†’ ìƒí™©ê¹Œì§€)

                // ê·¸ ì™¸ ì¼ë°˜ ëŒ€í™”
                conversationStep++;

                const reply = await callGeminiAPI(message);
                if (reply) {
                    addMessage("bot", reply);
                }
            });

                        // PHQ-9ê³¼ GAD-7 ê²°ê³¼ ê¸°ë°˜ ì¦ìƒ í•­ëª© í‘œì‹œ ë° ìƒí™© ë¶„ì„
            function displaySymptomItems() {
                const symptomItems = document.getElementById('symptomItems');
                if (!symptomItems) return;

                // PHQ-9ê³¼ GAD-7 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');

                let html = '';

                // GAD-7 í•­ëª© (ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬)
                if (gad7Data.items && Object.keys(gad7Data.items).length > 0) {
                    const sortedGad7 = Object.entries(gad7Data.items)
                        .filter(([_, score]) => score > 0)
                        .sort(([_, a], [__, b]) => b - a); // ë†’ì€ ì ìˆ˜ ìˆœ

                    if (sortedGad7.length > 0) {
                        html += '<div style="margin-bottom:16px;"><h4 style="color:#dc3545; margin:0 0 8px 0;">ğŸ˜° ë¶ˆì•ˆ ì¦ìƒ (GAD-7)</h4>';
                        sortedGad7.forEach(([itemNum, score]) => {
                            const itemText = getGad7ItemText(itemNum);
                            html += `<div style="padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border-left:4px solid #dc3545;">
                                <strong>${itemText}</strong><br>
                                <small style="color:#6c757d;">ì ìˆ˜: ${score}/3</small>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }

                // PHQ-9 í•­ëª© (ì ìˆ˜ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬)
                if (phq9Data.items && Object.keys(phq9Data.items).length > 0) {
                    const sortedPhq9 = Object.entries(phq9Data.items)
                        .filter(([_, score]) => score > 0)
                        .sort(([_, a], [__, b]) => b - a); // ë†’ì€ ì ìˆ˜ ìˆœ

                    if (sortedPhq9.length > 0) {
                        html += '<div style="margin-bottom:16px;"><h4 style="color:#6f42c1; margin:0 0 8px 0;">ğŸ˜” ìš°ìš¸ ì¦ìƒ (PHQ-9)</h4>';
                        sortedPhq9.forEach(([itemNum, score]) => {
                            const itemText = getPhq9ItemText(itemNum);
                            html += `<div style="padding:8px; background:#fff; border-radius:6px; margin-bottom:6px; border-left:4px solid #6f42c1;">
                                <strong>${itemText}</strong><br>
                                <small style="color:#6c757d;">ì ìˆ˜: ${score}/3</small>
                            </div>`;
                        });
                        html += '</div>';
                    }
                }

                if (html === '') {
                    html = '<div style="text-align:center; color:#6c757d; padding:20px;">ê²€ì‚¬ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € PHQ-9ê³¼ GAD-7 ê²€ì‚¬ë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.</div>';
                }

                symptomItems.innerHTML = html;
            }

            // PHQ-9 í•­ëª© í…ìŠ¤íŠ¸ ë°˜í™˜
            function getPhq9ItemText(itemNum) {
                const items = {
                    1: "ê¸°ë¶„ì´ ê°€ë¼ì•‰ê±°ë‚˜, ìš°ìš¸í•˜ê±°ë‚˜, í¬ë§ì´ ì—†ë‹¤ê³  ëŠê¼ˆë‹¤.",
                    2: "í‰ì†Œì— ì•„ë¬´ë ‡ì§€ ì•Šê²Œ í•˜ë˜ ì¼ì— í¥ë¯¸ê°€ ì—†ì–´ì§€ê±°ë‚˜ ì¦ê±°ì›€ì„ ëŠë¼ì§€ ëª»í–ˆë‹¤",
                    3: "ì ë“¤ê¸° ì–´ë µê±°ë‚˜ ìì£¼ ê¹¼ë‹¤/í˜¹ì€ ë„ˆë¬´ ë§ì´ ì¤ë‹¤.",
                    4: "í‰ì†Œë³´ë‹¤ ì‹ìš•ì´ ì¤„ì—ˆë‹¤/í˜¹ì€ í‰ì†Œë³´ë‹¤ ë§ì´ ë¨¹ì—ˆë‹¤",
                    5: "ë‹¤ë¥¸ ì‚¬ëŒë“¤ì´ ëˆˆì¹˜ ì±Œ ì •ë„ë¡œ í‰ì†Œë³´ë‹¤ ë§ê³¼ í–‰ë™ì´ ëŠë ¤ì¡Œë‹¤/í˜¹ì€ ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆ ëª» í•´ì„œ ê°€ë§Œíˆ ì•‰ì•„ ìˆì„ ìˆ˜ ì—†ì—ˆë‹¤.",
                    6: "í”¼ê³¤í•˜ê³  ê¸°ìš´ì´ ì—†ì—ˆë‹¤",
                    7: "ë‚´ê°€ ì˜ëª»í–ˆê±°ë‚˜ ì‹¤íŒ¨í–ˆë‹¤ëŠ” ìƒê°ì´ ë“¤ì—ˆë‹¤/í˜¹ì€ ìì‹ ê³¼ ê°€ì¡±ì„ ì‹¤ë§ì‹œì¼°ë‹¤ê³  ìƒê°í–ˆë‹¤.",
                    8: "ì‹ ë¬¸ì„ ì½ê±°ë‚˜ TVë¥¼ ë³´ëŠ” ê²ƒê³¼ ê°™ì€ ì¼ìƒì ì¸ ì¼ì—ë„ ì§‘ì¤‘í•˜ê¸° ì–´ë ¤ì› ë‹¤.",
                    9: "ì°¨ë¼ë¦¬ ì£½ëŠ” ê²ƒì´ ë” ë‚«ê² ë‹¤ê³  ìƒê°í–ˆë‹¤/í˜¹ì€ ìí•´í•  ìƒê°ì„ í–ˆë‹¤"
                };
                return items[itemNum] || `í•­ëª© ${itemNum}`;
            }

            // GAD-7 í•­ëª© í…ìŠ¤íŠ¸ ë°˜í™˜
            function getGad7ItemText(itemNum) {
                const items = {
                    1: "ì´ˆì¡°í•˜ê±°ë‚˜ ë¶ˆì•ˆí•˜ê±°ë‚˜ ì¡°ë§ˆì¡°ë§ˆí•˜ê²Œ ëŠë‚€ë‹¤.",
                    2: "ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶”ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ê°€ ì—†ë‹¤.",
                    3: "ì—¬ëŸ¬ ê°€ì§€ ê²ƒë“¤ì— ëŒ€í•´ ê±±ì •ì„ ë„ˆë¬´ ë§ì´ í•œë‹¤.",
                    4: "í¸í•˜ê²Œ ìˆê¸°ê°€ ì–´ë µë‹¤.",
                    5: "ì‰½ê²Œ ì§œì¦ì´ ë‚˜ê±°ë‚˜ ì‰½ê²Œ ì„±ì„ ë‚´ê²Œ ëœë‹¤.",
                    6: "ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ ê°€ë§Œíˆ ìˆê¸°ê°€ í˜ë“¤ë‹¤.",
                    7: "ë§ˆì¹˜ ë”ì°í•œ ì¼ì´ ìƒê¸¸ ê²ƒì²˜ëŸ¼ ë‘ë µê²Œ ëŠê»´ì§„ë‹¤."
                };
                return items[itemNum] || `í•­ëª© ${itemNum}`;
            }

            // ìƒí™© ë¶„ì„ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
            // ìµœê³ ì  ë¬¸í•­ ìë™ ì§ˆë¬¸ í•¨ìˆ˜ (ë²„íŠ¼ ì—†ì´ ì¦‰ì‹œ ì‹¤í–‰)
            function askHighestSymptomQuestion() {
                    const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
                    const gad7Data = JSON.parse(sessionStorage.getItem('gad7_data') || localStorage.getItem('gad7_data') || '{}');

                    // items ì •ê·œí™”: ë°°ì—´/ê°ì²´/ë¬¸ìì ìˆ˜ ëª¨ë‘ í—ˆìš©, 1-base í‚¤ë¡œ ë³€í™˜
                    const normalizeItems = (items, count) => {
                        const result = {};
                        if (!items) return result;
                        if (Array.isArray(items)) {
                            for (let i = 0; i < items.length; i++) {
                                result[String(i+1)] = Number(items[i]) || 0;
                            }
                        } else if (typeof items === 'object') {
                            Object.keys(items).forEach(k => {
                                result[String(k)] = Number(items[k]) || 0;
                            });
                        }
                        // ë³´ì¥: ì—†ëŠ” í‚¤ëŠ” 0ìœ¼ë¡œ ì±„ì›€ (ì˜µì…˜)
                        if (count) {
                            for (let i = 1; i <= count; i++) {
                                if (result[String(i)] == null) result[String(i)] = 0;
                            }
                        }
                        return result;
                    };

                    // PHQ-9 ìµœê³ ì  ë¬¸í•­ ì¶”ì¶œ
                    let phqMax = null;
                    let phqTop = [];
                    if (phq9Data.items || localStorage.getItem('phq9_responses')) {
                        // phq9_data.items ìš°ì„ , ì—†ìœ¼ë©´ phq9_responses ë°°ì—´ ì‚¬ìš©
                        let sourceItems = phq9Data.items;
                        if (!sourceItems) {
                            try {
                                const resp = JSON.parse(localStorage.getItem('phq9_responses') || '[]');
                                const temp = {};
                                for (let i = 0; i < 9; i++) temp[String(i+1)] = Number(resp[i]) || 0;
                                sourceItems = temp;
                            } catch (_) {}
                        }
                        const norm = normalizeItems(sourceItems, 9);
                        const entries = Object.entries(norm)
                            .filter(([_, s]) => Number(s) > 0);
                        if (entries.length > 0) {
                            const maxScore = Math.max(...entries.map(([_, s]) => Number(s)));
                            phqTop = entries
                                .filter(([_, s]) => Number(s) === maxScore)
                                .map(([n, s]) => ({ type: 'PHQ-9', itemNum: n, score: Number(s), text: getPhq9ItemText(n) }));
                        }
                    }

                    // GAD-7 ìµœê³ ì  ë¬¸í•­ ì¶”ì¶œ
                    let gadTop = [];
                    if (gad7Data.items) {
                        const norm = normalizeItems(gad7Data.items, 7);
                        const entries = Object.entries(norm)
                            .filter(([_, s]) => Number(s) > 0);
                        if (entries.length > 0) {
                            const maxScore = Math.max(...entries.map(([_, s]) => Number(s)));
                            gadTop = entries
                                .filter(([_, s]) => Number(s) === maxScore)
                                .map(([n, s]) => ({ type: 'GAD-7', itemNum: n, score: Number(s), text: getGad7ItemText(n) }));
                        }
                    }

                    // í‘œ ìƒì„±: ê° ì²™ë„ì—ì„œ ìµœê³ ì  ë¬¸í•­ë§Œ í¬í•¨
                    const rows = [...phqTop, ...gadTop];
                    if (rows.length > 0) {
                        let tableHtml = '<table style="width:100%; border-collapse:collapse; margin:8px 0;">';
                        tableHtml += '<thead><tr><th style="border:1px solid #ddd; padding:6px; text-align:center;">ì²™ë„</th><th style="border:1px solid #ddd; padding:6px; text-align:center;">ë¬¸í•­</th><th style="border:1px solid #ddd; padding:6px; text-align:center;">ì ìˆ˜</th></tr></thead><tbody>';
                        rows.forEach(r => {
                            const scaleLabel = r.type === 'PHQ-9' ? 'ìš°ìš¸' : (r.type === 'GAD-7' ? 'ë¶ˆì•ˆ' : r.type);
                            tableHtml += `<tr><td style=\"border:1px solid #ddd; padding:6px; text-align:center;\">${scaleLabel}</td><td style=\"border:1px solid #ddd; padding:6px;\">${r.text}</td><td style=\"border:1px solid #ddd; padding:6px; text-align:center;\">${r.score}</td></tr>`;
                        });
                        tableHtml += '</tbody></table>';
                        addMessage('bot', tableHtml);
                    }
                    // ê³ ì • ì§ˆë¬¸ (ì§€ì‹œë¬¸ ì—…ë°ì´íŠ¸)
                    addMessage('bot', 'í‘œì˜ ì ìˆ˜ëŠ” ì‚¬ìš©ìë‹˜ê»˜ì„œ ë§¤ê¸°ì‹  ìš°ìš¸ ì²™ë„ì™€ ë¶ˆì•ˆ ì²™ë„ì˜ ìµœê³ ì ì— í•´ë‹¹í•˜ëŠ” ë¬¸í•­ì´ì—ìš”. ì§€ë‚œ 2ì£¼ê°„ ì–´ë–¤ ì¼ ë•Œë¬¸ì— ìœ„ì™€ ê°™ì€ ì ìˆ˜ë¥¼ ë¶€ì—¬í•˜ì…¨ë‚˜ìš”?');
                    
                    const panel = document.getElementById('emotionPanel');
                    if (panel) panel.style.display = 'none';
                }

            // ê°ì • ë²„íŠ¼ ë¡œì§ ì œê±° (PHQ-9/GAD-7 ê¸°ë°˜ìœ¼ë¡œ ëŒ€ì²´)

            endBtn && endBtn.addEventListener("click", () => {
                userInput.disabled = true;
                sendBtn.disabled = true;
                endBtn.disabled = true;

                let script = "ğŸ¬ ì‹œë‚˜ë¦¬ì˜¤ ì™„ì„±ë³¸\n\n";
                script += `ìƒí™©: ${scenarioContext}\n\n`;
                chatHistory.forEach((msg) => {
                    const raw = String(msg && msg.message ? msg.message : '');
                    // í™”ë©´ì—ì„œëŠ” í‘œë¥¼ ë³´ì—¬ì£¼ë˜, ì™„ì„±ë³¸ì—ëŠ” í‘œ(HTML) ëŒ€ì‚¬ë¥¼ í¬í•¨í•˜ì§€ ì•ŠìŒ
                    if (raw.toLowerCase().includes('<table')) {
                        return; // skip HTML table summaries in export
                    }
                    const speaker = msg.sender === "bot" ? "ì±—ë´‡" : "ë‚˜";
                    const parenthetical = msg.sender === "bot" ? "(ì°¨ë¶„í•˜ê²Œ)" : "";
                    const dialogue = `â€œ${raw}â€`;
                    script += `${speaker}\n${parenthetical}\n${dialogue}\n`;
                });

                // generateConversationSummary í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ëŒ€í™” ìš”ì•½ ìƒì„±
                const summary = generateConversationSummary();
                addMessage("bot", summary);
            });

            function buildScenarioScript(contextText) {
                const emotion = selectedEmotionLabel ? selectedEmotionLabel.replace(/\n/g, ' / ') : '';
                const emotionKo = selectedEmotionLabel ? (selectedEmotionLabel.split('\n')[1] || selectedEmotionLabel) : 'ê·¸ ê°ì •';
                function getObjectParticle(word) {
                    if (!word || typeof word !== 'string') return 'ì„/ë¥¼';
                    const lastChar = word.trim().slice(-1);
                    const code = lastChar.charCodeAt(0);
                    // Hangul syllable range
                    if (code < 0xAC00 || code > 0xD7A3) return 'ì„/ë¥¼';
                    const jong = (code - 0xAC00) % 28;
                    return jong === 0 ? 'ë¥¼' : 'ì„';
                }
                const objParticle = getObjectParticle(emotionKo);
                function inferScene(text) {
                    const t = (text || '').toLowerCase();
                    let place = 'ì¥ì†Œ ë¯¸ìƒ';
                    let isExt = false;
                    if (t.includes('ì§€í•˜ì² ') || t.includes('subway')) place = 'ì§€í•˜ì² ';
                    else if (t.includes('íšŒì˜') || t.includes('ì‚¬ë¬´ì‹¤') || t.includes('office') || t.includes('meeting')) place = 'íšŒì˜ì‹¤';
                    else if (t.includes('ì§‘') || t.includes('home')) place = 'ì§‘';
                    else if (t.includes('í•™êµ') || t.includes('school')) place = 'í•™êµ';
                    else if (t.includes('ë³‘ì›') || t.includes('hospital')) place = 'ë³‘ì›';
                    else if (t.includes('ì¹´í˜') || t.includes('cafe') || t.includes('coffee')) place = 'ì¹´í˜';
                    else if (t.includes('ë²„ìŠ¤') || t.includes('bus')) place = 'ë²„ìŠ¤';
                    else if (t.includes('ê±°ë¦¬') || t.includes('road') || t.includes('street')) { place = 'ê±°ë¦¬'; isExt = true; }
                    else if (t.includes('ê³µì›') || t.includes('park')) { place = 'ê³µì›'; isExt = true; }
                    // ì™¸ë¶€ ë‹¨ì„œ
                    if (t.includes('ë°–') || t.includes('ì•¼ì™¸')) isExt = true;
                    // ì‹œê°„ëŒ€ ì¶”ì •
                    let timeLabel = 'DAY';
                    if (t.includes('ë°¤') || t.includes('ì•¼ë°¤') || t.includes('ì €ë…') || t.includes('night') || t.includes('evening')) timeLabel = 'NIGHT';
                    else if (t.includes('ìƒˆë²½') || t.includes('dawn')) timeLabel = 'DAWN';
                    else if (t.includes('ì•„ì¹¨') || t.includes('morning')) timeLabel = 'MORNING';
                    return { slug: `${isExt ? 'EXT.' : 'INT.'} ${place} - ${timeLabel}` };
                }
                const scene = inferScene(contextText);
                const now = new Date();
                const dateStr = `${now.getFullYear()}.${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
                return (
`${scene.slug} (${dateStr})

ë‚˜
(í˜„ì¬ ê°ì •: ${emotion || 'ë¯¸ìƒ'})
â€œ${contextText}â€
`
                );
            }
        }
        
        // GAD-7 ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ í•¨ìˆ˜
        function renderGAD7Screening() {
            console.log('renderGAD7Screening í•¨ìˆ˜ ì‹œì‘');
            
            // ê¸°ì¡´ PHQ-9 ê²€ì‚¬ê°€ ìˆë‹¤ë©´ ì œê±°
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('ê¸°ì¡´ PHQ-9 ê²€ì‚¬ ì œê±°');
                existingScreening.remove();
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'gad7-screening';
            console.log('GAD-7 ê²€ì‚¬ div ìƒì„±ë¨');
            
            screeningDiv.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">2ë‹¨ê³„: ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ (GAD-7)</h1>
                        <div class="gad7-sub">
                            ì§€ë‚œ 2ì£¼ì¼ ë™ì•ˆ ë‹¹ì‹ ì€ ë‹¤ìŒì˜ ë¬¸ì œë“¤ë¡œ ì¸í•´ì„œ ì–¼ë§ˆë‚˜ ìì£¼ ë°©í•´ë¥¼ ë°›ì•˜ìŠµë‹ˆê¹Œ?<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                ğŸ“‹ <a href="https://nct.go.kr/distMental/rating/rating02_3.do" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    GAD-7 í•œêµ­íŒ í‘œì¤€ì§€ì¹¨ (êµ­ë¦½ì •ì‹ ê±´ê°•ì„¼í„°-êµ­ê°€íŠ¸ë¼ìš°ë§ˆì„¼í„°)
                                </a> â†—
                            </small>
                        </div>
                        
                        <div class="phq9-grid" id="gad7Grid"></div>
                        
                        <div class="phq9-result" id="gad7Result" style="display: none;">
                            <div class="phq9-score">ì´ì : <span id="gad7Total">0</span> / 21 <span id="gad7SevTag" class="phq9-sev none">ë¶ˆì•ˆ ì•„ë‹˜ (0â€“4)</span></div>
                            <div id="gad7Advice" class="phq9-note" style="margin-top:8px"></div>
                            <div class="phq9-btns">
                                <button id="gad7StartBtn" class="phq9-btn phq9-primary">í”„ë¡œê·¸ë¨ ì‹œì‘í•˜ê¸°</button>
                                <button id="gad7BackBtn" class="phq9-btn phq9-ghost">PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
                            </div>
                        </div>
                        
                        <div class="phq9-progress" id="gad7Progress">
                            <div class="phq9-btns">
                                <button id="gad7CalcBtn" class="phq9-btn phq9-primary" disabled>ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                                <button id="gad7BackBtn2" class="phq9-btn phq9-ghost">PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
                            </div>
                            <div class="phq9-note" style="margin-top: 8px;">
                                ì™„ë£Œëœ ë¬¸í•­: <span id="gad7CompletedCount">0</span> / 7
                            </div>
                        </div>
                        
                        <div class="phq9-foot">
                            * ì´ ì„¤ë¬¸ì€ ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì ìˆ˜ê°€ ë†’ìœ¼ë©´, ìœ„í—˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì§€ì—­ ì •ì‹ ê±´ê°• ì „ë¬¸ê¸°ê´€ì— ê¼­ ìƒì˜í•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
            
            console.log('GAD-7 ê²€ì‚¬ í™”ë©´ DOMì— ì¶”ê°€');
            // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
                console.log('ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¹€');
            }
            
            console.log('DOMì— GAD-7 ê²€ì‚¬ ì¶”ê°€ ì‹œë„...');
            document.body.appendChild(screeningDiv);
            console.log('GAD-7 ê²€ì‚¬ í™”ë©´ DOMì— ì¶”ê°€ë¨');
            
            // GAD-7 ê²€ì‚¬ê°€ ì‹¤ì œë¡œ í‘œì‹œë˜ëŠ”ì§€ í™•ì¸
            const addedScreening = document.querySelector('.gad7-screening');
            if (addedScreening) {
                console.log('GAD-7 ê²€ì‚¬ ìš”ì†Œê°€ DOMì— ì„±ê³µì ìœ¼ë¡œ ì¶”ê°€ë¨');
                console.log('initGAD7 í•¨ìˆ˜ í˜¸ì¶œ');
            initGAD7();
            } else {
                console.error('GAD-7 ê²€ì‚¬ ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ!');
                alert('GAD-7 ê²€ì‚¬ í™”ë©´ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        }


        
        // PHQ-9 ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜
        function showPHQ9Results() {
            const phq9Container = document.querySelector('.phq9-screening');
            if (!phq9Container) return;
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ ë³µì›
            phq9Container.innerHTML = `
                <div class="phq9-result" style="text-align: center; padding: 2em;">
                    <h1 class="phq9-title">PHQ-9 ê²€ì‚¬ ê²°ê³¼</h1>
                    <div class="phq9-score" style="margin: 2em 0;">
                        <div style="font-size: 3em; font-weight: bold; color: #3498db;" id="totalScore">0</div>
                        <div style="font-size: 1.2em; color: #7f8c8d;">ì´ì </div>
                    </div>
                    <div class="phq9-severity" style="margin: 2em 0;">
                        <span id="severityTag" class="phq9-sev phq9-sev-ok">ì •ìƒ</span>
                    </div>
                    <div class="phq9-advice" id="advice" style="margin: 2em 0; padding: 1em; background: #f8f9fa; border-radius: 8px;">
                        <!-- ì¡°ì–¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                    <button id="startBtn" style="background:#3498db;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;">í”„ë¡œê·¸ë¨ ì‹œì‘</button>
                </div>
            `;
            // PHQ-9 ê²°ê³¼ ë°ì´í„° ë³µì›
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            if (phq9Data.score !== undefined) {
                const totalScore = document.getElementById('totalScore');
                const severityTag = document.getElementById('severityTag');
                const advice = document.getElementById('advice');
                const startBtn = document.getElementById('startBtn');
                
                totalScore.textContent = phq9Data.score;
                // ë¬¸í•­ë³„ ì ìˆ˜ê°€ ì—†ë‹¤ë©´ ê¸°ë³¸ itemsë¥¼ 0ìœ¼ë¡œ ì±„ì›€ (1â€“9)
                if (!phq9Data.items) {
                    const items = {};
                    for (let i=1;i<=9;i++) items[String(i)] = 0;
                    phq9Data.items = items;
                    sessionStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                    localStorage.setItem('phq9_data', JSON.stringify(phq9Data));
                }
                
                // ì‹¬ê°ë„ì— ë”°ë¥¸ ì¡°ì–¸ ë³µì›
                // ì‹¬ê°ë„ì— ë”°ë¥¸ ì¡°ì–¸ ë³µì› (ê°€ë²¼ìš´ ìš°ìš¸êµ°ì€ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰)
                if (phq9Data.score <= 14 && ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) === 0) {
                    // 0â€“14ì ì´ë©° 9ë²ˆ ë¬¸í•­ 0ì : ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = 'ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰';
                    
                    advice.innerHTML = '<strong>ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:</strong> í•´ë‹¹ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì´ë©°, <b>9ë²ˆ ë¬¸í•­ì´ 0ì </b>ì…ë‹ˆë‹¤. <br><br><strong>ì´ì œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬(GAD-7)ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>';
                    advice.className = 'phq9-note phq9-info';
                    
                    // ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰ ë²„íŠ¼ë§Œ í‘œì‹œ
            } else {
                    // ë‹¤ë¥¸ ì ìˆ˜ ë²”ìœ„ëŠ” í”„ë¡œê·¸ë¨ ì²´í—˜ ë¶ˆê°€
                    startBtn.disabled = true;
                    startBtn.style.background = '#bdc3c7';
                    startBtn.style.cursor = 'not-allowed';
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì²´í—˜ ë¶ˆê°€';
                    
                    if (phq9Data.score <= 4) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ì •ìƒ(0â€“4)</b> ë²”ìœ„ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ì¶”í›„ ë‹¤ì‹œ ì²´í¬í•˜ê±°ë‚˜, ìƒí™œ ë¦¬ë“¬ ê´€ë¦¬ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.';
                    } else if (phq9Data.score >= 20) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>20ì  ì´ìƒ</b>ìœ¼ë¡œ ì‹¬ê°í•œ ìš°ìš¸ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ í‰ê°€ì™€ ë„ì›€ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    } else if (phq9Data.score >= 15 && phq9Data.score <= 19) {
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>15ì  ì´ìƒ</b>ìœ¼ë¡œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    } else { // 10-14
                        advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì´ì§€ë§Œ 9ë²ˆ ë¬¸í•­ì— ì ìˆ˜ê°€ ìˆì–´ ì•ˆì „ìƒ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    }
                    advice.className = 'phq9-note phq9-warn';
                }
            }
        }

        // DOMContentLoadedì—ì„œ intro ë¨¼ì € ë„ìš°ê¸°
        document.addEventListener('DOMContentLoaded', function() {
            // ì•ˆë‚´ì‚¬í•­ ë³´ê¸° ë²„íŠ¼ ë™ì‘
            const showIntroBtn = document.getElementById('showIntroBtn');
            if (showIntroBtn) {
                showIntroBtn.addEventListener('click', function() {
                    showIntro = true;
                    renderIntro();
                });
            }

            // ì°¸ê³ ë¬¸í—Œ í† ê¸€
            const toggleRefsBtn = document.getElementById('toggleRefsBtn');
            const referencesPanel = document.getElementById('referencesPanel');
            if (toggleRefsBtn && referencesPanel) {
                toggleRefsBtn.addEventListener('click', function() {
                    const isHidden = referencesPanel.style.display === 'none' || referencesPanel.style.display === '';
                    referencesPanel.style.display = isHidden ? 'block' : 'none';
                    toggleRefsBtn.textContent = isHidden ? 'ì°¸ê³ ë¬¸í—Œ ìˆ¨ê¸°ê¸°' : 'ì°¸ê³ ë¬¸í—Œ ë³´ê¸°';
                });
            }
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ì´ í‘œì‹œ ì¤‘ì¸ì§€ í™•ì¸ (ë” ì•ˆì „í•œ ì²´í¬)
            const phq9Screening = document.querySelector('.phq9-screening');
            if (isShowingPHQ9Results || phq9Screening) {
                console.log('PHQ-9 ê²°ê³¼ í™”ë©´ì´ í‘œì‹œ ì¤‘ì´ë¯€ë¡œ renderIntro í˜¸ì¶œí•˜ì§€ ì•ŠìŒ');
                console.log('isShowingPHQ9Results:', isShowingPHQ9Results, 'phq9Screening ì¡´ì¬:', !!phq9Screening);
                // PHQ-9 ê²°ê³¼ í™”ë©´ì´ í‘œì‹œ ì¤‘ì´ë©´ renderIntroë¥¼ í˜¸ì¶œí•˜ì§€ ì•ŠìŒ
            } else if (showIntro) {
                renderIntro();
            } else {
                updateStage();
            }
            loadAllResponses();

            // ì…ë ¥ê°’ ì…ë ¥ ì‹œ ì¦‰ì‹œ ì €ì¥
            document.addEventListener('input', function(event) {
                const target = event.target;
                const stepIdx = currentIndex;
                if (target.dataset.fieldIdx !== undefined) {
                    const fieldIdx = parseInt(target.dataset.fieldIdx);
                    responses[stepIdx][fieldIdx] = target.value;
                    saveAllResponses();
                } else if (target.name === 'gender') {
                    responses[0][1] = target.value;
                    saveAllResponses();
                } else if(target.dataset.sceneIdx !== undefined) {
                    const sceneIdx = parseInt(target.dataset.sceneIdx);
                    const key = target.dataset.key;
                    if(responses[2][3][sceneIdx]) {
                        responses[2][3][sceneIdx][key] = target.value;
                        saveAllResponses();
                    }
                }
            });
            
            // í”„ë¡œê·¸ë¨ ì´ë¦„ í´ë¦­ ì‹œ ì„¤ëª… í† ê¸€
            const programTitle = document.getElementById('programTitle');
            const programDesc = document.getElementById('programDesc');
            if (programTitle && programDesc) {
                programTitle.addEventListener('click', function() {
                    if (programDesc.style.display === 'none') {
                        programDesc.style.display = 'block';
                } else {
                        programDesc.style.display = 'none';
                    }
                });
            }
        });

        
        // ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ ì™„ë£Œ í•¨ìˆ˜ (ìš°ìš¸ ê²€ì‚¬ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”)
        window.completeServiceGuide = function() {
            const startBtn = document.getElementById('startBtn');
            if (startBtn) {
                startBtn.disabled = false;
                startBtn.style.background = '#3498db';
                startBtn.style.cursor = 'pointer';
                startBtn.textContent = 'ê²€ì‚¬ ì‹œì‘';
                
                // í™•ì¸ ì™„ë£Œ ë²„íŠ¼ì„ ë¹„í™œì„±í™”
                const confirmBtn = event.target;
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'í™•ì¸ ì™„ë£Œ';
                confirmBtn.style.background = '#6b7280';
                confirmBtn.style.cursor = 'not-allowed';
            }
        };

        // ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ í˜ì´ì§€ í‘œì‹œ í•¨ìˆ˜ (ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œ í™•ì¸ í›„)
        window.showServiceGuidePage = function() {
            const introDiv = document.getElementById('introScreen');
            if (introDiv) {
                introDiv.innerHTML = `
                    <!-- ì„œë¹„ìŠ¤ ì´ìš© ì „ ì•ˆë‚´ì‚¬í•­ í˜ì´ì§€ -->
                    <div style="margin-bottom:2em;padding:1.5em;background:#fffbe6;border-radius:12px;border:1.5px solid #ffd700;">
                        <div style="color:#b8860b;font-size:1.1em;margin-bottom:1em;"><b>âš ï¸ ì„œë¹„ìŠ¤ ì´ìš© ì „ ì•ˆë‚´ì‚¬í•­</b></div>
                        
                        <div style="color:#333;font-size:1.05em;line-height:1.7;margin-bottom:1.5em;">
                            ì´ í”„ë¡œê·¸ë¨ì´ ì•ˆì „í•˜ê³  ì˜ë¯¸ ìˆëŠ” ìê¸° íƒìƒ‰ì˜ ì‹œê°„ì´ ë  ìˆ˜ ìˆë„ë¡, ëª‡ ê°€ì§€ ì¤‘ìš”í•œ ì ì„ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.
                        </div>
                        
                        <div style="margin-bottom:1.2em;">
                            <b>í”„ë¡œê·¸ë¨ì˜ ì—­í• ê³¼ ì±…ì„</b>
                            <ul style="margin:0.7em 0 0 1.2em;padding:0;list-style:disc;">
                                <li><b>ì˜ë£Œì  ì±…ì„ í•œê³„:</b> ë³¸ í”„ë¡œê·¸ë¨ì€ ì •ì‹ ê±´ê°•ì˜í•™ê³¼ ì§„ë£Œë‚˜ ì „ë¬¸ ì‹¬ë¦¬ìƒë‹´ê³¼ ê°™ì€ ì „ë¬¸ì ì¸ ì˜ë£Œ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì²´í•  ìˆ˜ ì—†ìŒì„ ëª…í™•íˆ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</b></li>
                                
                            </ul>
                        </div>
                        
                        
                        
                        <!-- ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ í™•ì¸ ë²„íŠ¼ -->
                        <div style="text-align:center;margin-top:2em;">
                            <button onclick="completeServiceGuide()" style="background:#22c55e;color:white;font-size:1em;padding:0.7em 1.5em;border-radius:8px;border:none;cursor:pointer;">ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ í™•ì¸ ì™„ë£Œ</button>
                        </div>
                    </div>

                    <div style="text-align:center;margin-top:2.5em;">
                        <button id="startBtn" style="background:#6b7280;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;cursor:not-allowed;" disabled>ê²€ì‚¬ ì‹œì‘</button>
                        <div style="margin-top:1em;color:#666;font-size:0.9em;">
                            âš ï¸ ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ì„ ëª¨ë‘ í™•ì¸í•œ í›„ì—ë§Œ ê²€ì‚¬ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </div>
                    </div>
                `;
                
                // PHQ-9 ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
                document.getElementById('startBtn').onclick = () => {
                    showIntro = false;
                    introDiv.remove();
                    
                    // ìš°ìš¸ ê²€ì‚¬ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë¬´ì¡°ê±´ PHQ-9 ê²€ì‚¬ ì§„í–‰
                    console.log('ìš°ìš¸ ê²€ì‚¬ ì‹œì‘ ë²„íŠ¼ í´ë¦­ë¨ - PHQ-9 ê²€ì‚¬ ì‹œì‘');
                    
                    // ê¸°ì¡´ PHQ-9 ë°ì´í„° ì‚­ì œí•˜ê³  ìƒˆë¡œ ê²€ì‚¬
                    sessionStorage.removeItem('phq9_data');
                    localStorage.removeItem('phq9_data');
                    localStorage.removeItem('phq9_responses');
                    
                    console.log('ê¸°ì¡´ PHQ-9 ë°ì´í„° ì‚­ì œ ì™„ë£Œ, PHQ-9 ë°”ë¡œ ì‹œì‘');
                    renderPHQ9Screening();
                };
            }
        };
        // ì„œë¹„ìŠ¤ ì•ˆë‚´ì‚¬í•­ ëª¨ë‹¬ í•¨ìˆ˜ (ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œì™€ ì™„ì „ ë¶„ë¦¬)
        window.showServiceGuide = function() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="width: min(720px,92vw); background: #fffbe6; border: 1.5px solid #ffd700; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <h2 style="color: #b8860b; margin: 0;">âš ï¸ ì„œë¹„ìŠ¤ ì´ìš© ì „ ì•ˆë‚´ì‚¬í•­</h2>
                        <button onclick="this.closest('.service-modal').remove()" style="background: transparent; border: 1px solid #ffd700; color: #b8860b; padding: 8px 12px; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
                    </div>
                    
                    <!-- ë¶„ë¦¬ ì•ˆë‚´ -->
                    <div style="background: #fff3cd; border: 1px solid #ffd700; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                        <div style="color: #b8860b; font-size: 0.95em; font-weight: bold;">ğŸ“‹ ì •ë³´ ë¶„ë¦¬ ì•ˆë‚´</div>
                        <div style="color: #856404; font-size: 0.9em; margin-top: 4px;">
                            ì´ ë‚´ìš©ì€ <b>ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œ</b>ì™€ <b>ì™„ì „íˆ ë¶„ë¦¬</b>ëœ <b>ì„œë¹„ìŠ¤ ì´ìš© ì•ˆë‚´ì‚¬í•­</b>ì…ë‹ˆë‹¤.
                        </div>
                    </div>
                    
                    <div style="color: #333; font-size: 1.05em; line-height: 1.7; margin-bottom: 1.5em;">
                        ì´ í”„ë¡œê·¸ë¨ì´ ì•ˆì „í•˜ê³  ì˜ë¯¸ ìˆëŠ” ìê¸° íƒìƒ‰ì˜ ì‹œê°„ì´ ë  ìˆ˜ ìˆë„ë¡, ëª‡ ê°€ì§€ ì¤‘ìš”í•œ ì ì„ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤.
                    </div>
                    
                    <div style="margin-bottom: 1.2em;">
                        <b>í”„ë¡œê·¸ë¨ì˜ ì—­í• ê³¼ ì±…ì„</b>
                        <ul style="margin: 0.7em 0 0 1.2em; padding: 0; list-style: disc;">
                            <li><b>ì˜ë£Œì  ì±…ì„ í•œê³„:</b> ë³¸ í”„ë¡œê·¸ë¨ì€ <b> ì •ì‹ ê±´ê°•ì˜í•™ê³¼ ì§„ë£Œë‚˜ ì „ë¬¸ ì‹¬ë¦¬ìƒë‹´ê³¼ ê°™ì€ ì „ë¬¸ ì„œë¹„ìŠ¤ë¥¼ ëŒ€ì²´í•  ìˆ˜ ì—†ìŒì„ ëª…í™•íˆ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</li>
                        </ul>
                    </div>
                    
                    
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('.service-modal').remove()" style="background: #ffd700; color: #333; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold;">í™•ì¸</button>
                    </div>
                </div>
            `;
            
            modal.className = 'service-modal';
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        };

        // ìƒë‹´ìœ¤ë¦¬ ìœ„ë°˜ ì‹œ ì•Œë¦¼ í•¨ìˆ˜ (1ìˆœìœ„ ë³´ì•ˆ)
        window.showEthicsAlert = function(message) {
            // ìƒë‹´ìœ¤ë¦¬ ìœ„ë°˜ ì‹œ ì¦‰ì‹œ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
            const alertDiv = document.createElement('div');
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc2626;
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                font-weight: bold;
            `;
            alertDiv.innerHTML = `
                <div style="margin-bottom: 10px;">âš ï¸ ìƒë‹´ìœ¤ë¦¬ ìœ„ë°˜ ì‹ í˜¸</div>
                <div style="font-size: 14px; font-weight: normal;">${message}</div>
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; background: white; color: #dc2626; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">í™•ì¸</button>
            `;
            
            document.body.appendChild(alertDiv);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, 10000);
            
            // ì½˜ì†”ì— ìƒì„¸ ë¡œê·¸ ê¸°ë¡
            console.error('ETHICS VIOLATION ALERT:', {
                message: message,
                timestamp: new Date().toISOString(),
                action: 'immediate_attention_required',
                priority: 'highest'
            });
        };

        // ë””ë²„ê¹… í—¬í¼ í•¨ìˆ˜ë“¤ (ì½˜ì†”ì—ì„œ ì‚¬ìš© ê°€ëŠ¥)
        window.checkPHQ9Status = function() {
            const sessionData = sessionStorage.getItem('phq9_data');
            const localData = localStorage.getItem('phq9_data');
            const hybridData = getPHQ9DataFromStorage();
            
            console.log('PHQ-9 í•˜ì´ë¸Œë¦¬ë“œ ìƒíƒœ:', {
                sessionStorage: sessionData ? JSON.parse(sessionData) : null,
                localStorage: localData ? JSON.parse(localData) : null,
                hybridResult: hybridData,
                isCompleted: hybridData !== null
            });
            return hybridData;
        };
        
        window.clearPHQ9Data = function() {
            sessionStorage.removeItem('phq9_data');
            localStorage.removeItem('phq9_data');
            console.log('PHQ-9 í•˜ì´ë¸Œë¦¬ë“œ ë°ì´í„°ê°€ ì™„ì „ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };
        
        // ì¸êµ¬í†µê³„ ë°ì´í„° í™•ì¸ í•¨ìˆ˜
        window.checkDemographicsData = function() {
            const sessionData = sessionStorage.getItem('demographics_data');
            const localData = localStorage.getItem('demographics_data');
            
            console.log('ì¸êµ¬í†µê³„ ë°ì´í„° ìƒíƒœ:', {
                sessionStorage: sessionData ? JSON.parse(sessionData) : null,
                localStorage: localData ? JSON.parse(localData) : null,
                isCompleted: !!(sessionData || localData)
            });
            
            if (sessionData || localData) {
                const data = JSON.parse(sessionData || localData);
                console.log('ì¸êµ¬í†µê³„ ìƒì„¸ ì •ë³´:', {
                    ì„±ë³„: ['ë‚¨ì„±', 'ì—¬ì„±', 'ê¸°íƒ€'][data.gender] || 'ë¯¸ì…ë ¥',
                    ì—°ë ¹: data.age ? `${data.age}ì„¸` : 'ë¯¸ì…ë ¥',
                    ì§‘ë‹¨ì°¸ì—¬: data.groupParticipation === 'yes' ? 'ì°¸ì—¬ í¬ë§' : 'ê°œì¸ ì§„í–‰',
                    ê±°ì£¼ì§€ì—­: data.region || 'í•´ë‹¹ ì—†ìŒ'
                });
            }
            
            return sessionData || localData;
        };
        
        // ì¸êµ¬í†µê³„ ë°ì´í„° ì‚­ì œ í•¨ìˆ˜
        window.clearDemographicsData = function() {
            sessionStorage.removeItem('demographics_data');
            localStorage.removeItem('demographics_data');
            console.log('ì¸êµ¬í†µê³„ ë°ì´í„°ê°€ ì™„ì „ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ PHQ-9 ë° ì¸êµ¬í†µê³„ ìƒíƒœ ìë™ ì²´í¬
        console.log('í˜ì´ì§€ ë¡œë“œë¨, ìƒíƒœ ì²´í¬:');
        if (typeof window.checkPHQ9Status === 'function') {
            window.checkPHQ9Status();
        }
        if (typeof window.checkDemographicsData === 'function') {
            window.checkDemographicsData();
        }

        // GAD-7ì—ì„œ PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸° í•¨ìˆ˜
        function showPHQ9ResultsFromGAD7() {
            console.log('GAD-7ì—ì„œ PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°');
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ì´ í‘œì‹œ ì¤‘ì„ì„ í‘œì‹œ
            isShowingPHQ9Results = true;
            console.log('isShowingPHQ9Resultsë¥¼ trueë¡œ ì„¤ì •í•¨');
            
            // showIntro í”Œë˜ê·¸ë¥¼ falseë¡œ ì„¤ì •í•˜ì—¬ ê°œì¸ì •ë³´ ë³´í˜¸ë²• ê°€ì´ë“œê°€ ë‚˜íƒ€ë‚˜ì§€ ì•Šë„ë¡ í•¨
            showIntro = false;
            console.log('showIntroë¥¼ falseë¡œ ì„¤ì •í•¨');
            
            // ê¸°ì¡´ introScreenì´ ìˆë‹¤ë©´ ì œê±°
            const existingIntroScreen = document.querySelector('.introScreen');
            if (existingIntroScreen) {
                console.log('ê¸°ì¡´ introScreen ì œê±°ë¨');
                existingIntroScreen.remove();
            } else {
                console.log('ê¸°ì¡´ introScreenì´ ì—†ìŒ');
            }
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ ìƒì„±
            const phq9ResultDiv = document.createElement('div');
            phq9ResultDiv.className = 'phq9-screening';
            
            // ì €ì¥ëœ PHQ-9 ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const phq9Data = JSON.parse(sessionStorage.getItem('phq9_data') || localStorage.getItem('phq9_data') || '{}');
            const phq9Responses = JSON.parse(localStorage.getItem('phq9_responses') || '[]');
            
            phq9ResultDiv.innerHTML = `
                <div class="phq9-wrap">
                    <div class="phq9-card">
                        <h1 class="phq9-title">PHQ-9 ê²€ì‚¬ ê²°ê³¼</h1>
                        <div class="phq9-score" style="margin: 2em 0;">
                            <div style="font-size: 3em; font-weight: bold; color: #3498db;" id="totalScore">${phq9Data.score || 0}</div>
                            <div style="font-size: 1.2em; color: #7f8c8d;">ì´ì </div>
                        </div>
                        <div class="phq9-severity" style="margin: 2em 0;">
                            <span id="severityTag" class="phq9-sev phq9-sev-ok">${phq9Data.riskLevel || 'ì •ìƒ'}</span>
                        </div>
                        <div class="phq9-advice" id="advice" style="margin: 2em 0; padding: 1em; background: #f8f9fa; border-radius: 8px;">
                            <!-- ì¡°ì–¸ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                        </div>
                        <div class="phq9-btns">
                            <button id="startBtn" style="background:#3498db;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;">í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘</button>
                            <button id="backToIntroBtn" style="background:#95a5a6;color:white;font-size:1.1em;padding:0.8em 2.5em;border-radius:8px;margin-left:10px;">ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            // ê¸°ì¡´ GAD-7 ê²€ì‚¬ í™”ë©´ì´ ìˆë‹¤ë©´ ì œê±°
            const existingGAD7 = document.querySelector('.gad7-screening');
            if (existingGAD7) {
                existingGAD7.remove();
            }
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ ì¶”ê°€
            document.body.appendChild(phq9ResultDiv);
            
            console.log('PHQ-9 ê²°ê³¼ í™”ë©´ì´ DOMì— ì¶”ê°€ë¨');
            console.log('showIntro ê°’:', showIntro);
            
            // PHQ-9 ê²°ê³¼ ë°ì´í„° ë³µì› ë° í‘œì‹œ
            if (phq9Data.score !== undefined) {
                const advice = document.getElementById('advice');
                const startBtn = document.getElementById('startBtn');
                
                // ì‹¬ê°ë„ì— ë”°ë¥¸ ì¡°ì–¸ ë³µì› (ê°€ë²¼ìš´ ìš°ìš¸êµ°ì€ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰)
                if (phq9Data.score <= 14 && ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) === 0) {
                    // 0â€“14ì ì´ë©° 9ë²ˆ ë¬¸í•­ 0ì : ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰
                    startBtn.disabled = false;
                    startBtn.style.background = '#27ae60';
                    startBtn.style.cursor = 'pointer';
                    startBtn.textContent = 'ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰';
                    
                    advice.innerHTML = '<strong>ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:</strong> í•´ë‹¹ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì…ë‹ˆë‹¤. <br><br><strong>ì´ì œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬(GAD-7)ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</strong>';
                    advice.className = 'phq9-note phq9-info';
                } else if (phq9Data.score > 14 || ((phq9Data.items && phq9Data.items['9']) ? phq9Data.items['9'] : 0) >= 1) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>15ì  ì´ìƒ</b>ì´ê±°ë‚˜, <b>9ë²ˆ ë¬¸í•­ì— 1ì  ì´ìƒ</b>ì´ ìˆì–´ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    advice.className = 'phq9-note phq9-warn';
                } else if (phq9Data.score <= 4) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>ì •ìƒ(0â€“4)</b> ë²”ìœ„ì…ë‹ˆë‹¤. í•„ìš” ì‹œ ì¶”í›„ ë‹¤ì‹œ ì²´í¬í•˜ê±°ë‚˜, ìƒí™œ ë¦¬ë“¬ ê´€ë¦¬ë¥¼ ìœ ì§€í•´ ì£¼ì„¸ìš”.';
                    advice.className = 'phq9-note phq9-warn';
                } else if (phq9Data.score >= 20) {
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>20ì  ì´ìƒ</b>ìœ¼ë¡œ ì‹¬ê°í•œ ìš°ìš¸ ì¦ìƒì´ ë‚˜íƒ€ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ ì „ë¬¸ê°€ì˜ í‰ê°€ì™€ ë„ì›€ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                } else if (phq9Data.score >= 15 && phq9Data.score <= 19) { // 15â€“19
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>15ì  ì´ìƒ</b>ìœ¼ë¡œ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ë¬¸ê°€ ìƒë‹´ì„ ê¶Œí•©ë‹ˆë‹¤.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                } else { // 10-14
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì‹œì‘ ë¶ˆê°€';
                    advice.innerHTML = 'í˜„ì¬ ì ìˆ˜ëŠ” <b>0â€“14ì </b> ë²”ìœ„ì´ì§€ë§Œ 9ë²ˆ ë¬¸í•­ì— ì ìˆ˜ê°€ ìˆì–´ ì•ˆì „ìƒ ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ë¡œ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                    advice.style.background = '#f8d7da';
                    advice.style.color = '#721c24';
                }
            }
            
            // í”„ë¡œê·¸ë¨ ì²´í—˜ ì‹œì‘ ë²„íŠ¼ ì´ë²¤íŠ¸
            const startBtn = document.getElementById('startBtn');
            if (startBtn && !startBtn.disabled) {
                startBtn.addEventListener('click', () => {
                    console.log('ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ ì§„í–‰ ë²„íŠ¼ í´ë¦­');
                    renderGAD7Screening();
                });
            }
            
            // ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
            const backToIntroBtn = document.getElementById('backToIntroBtn');
            if (backToIntroBtn) {
                backToIntroBtn.addEventListener('click', () => {
                    document.querySelector('.phq9-screening').remove();
                    isShowingPHQ9Results = false; // í”Œë˜ê·¸ ë¦¬ì…‹
                    renderDemographicsSurvey();
                });
            }
            
            // í•¨ìˆ˜ ì™„ë£Œ í›„ ìƒíƒœ í™•ì¸
            console.log('showPHQ9ResultsFromGAD7 í•¨ìˆ˜ ì™„ë£Œ, ìµœì¢… showIntro ê°’:', showIntro);
            console.log('showPHQ9ResultsFromGAD7 í•¨ìˆ˜ ì™„ë£Œ, ìµœì¢… isShowingPHQ9Results ê°’:', isShowingPHQ9Results);
            
            // PHQ-9 ê²°ê³¼ í™”ë©´ì´ ì œê±°ë  ë•Œ í”Œë˜ê·¸ë¥¼ ë¦¬ì…‹í•˜ëŠ” MutationObserver ì¶”ê°€
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.removedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE && node.classList && node.classList.contains('phq9-screening')) {
                                console.log('PHQ-9 ê²°ê³¼ í™”ë©´ì´ ì œê±°ë¨, isShowingPHQ9Results í”Œë˜ê·¸ ë¦¬ì…‹');
                                isShowingPHQ9Results = false;
                                observer.disconnect();
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, { childList: true });
        }

        // GAD-7 ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ í•¨ìˆ˜ (í†µí•©)
        function renderGAD7Screening() {
            console.log('GAD-7 ê²€ì‚¬ í™”ë©´ ë Œë”ë§ ì‹œì‘');
            
            // ê¸°ì¡´ PHQ-9 ê²€ì‚¬ê°€ ìˆë‹¤ë©´ ì œê±°
            const existingScreening = document.querySelector('.phq9-screening');
            if (existingScreening) {
                console.log('ê¸°ì¡´ PHQ-9 ê²€ì‚¬ ì œê±°');
                existingScreening.remove();
            }
            
            const screeningDiv = document.createElement('div');
            screeningDiv.className = 'gad7-screening';
            
            screeningDiv.innerHTML = `
                <div class="gad7-wrap">
                    <div class="gad7-card">
                        <h1 class="gad7-title">2ë‹¨ê³„: ë¶ˆì•ˆì¦ìƒ ê²€ì‚¬ (GAD-7)</h1>
                        <div class="gad7-sub">
                            ì§€ë‚œ 2ì£¼ì¼ ë™ì•ˆ ë‹¹ì‹ ì€ ë‹¤ìŒì˜ ë¬¸ì œë“¤ë¡œ ì¸í•´ì„œ ì–¼ë§ˆë‚˜ ìì£¼ ë°©í•´ë¥¼ ë°›ì•˜ìŠµë‹ˆê¹Œ?<br>
                            <small style="margin-top: 8px; display: block; color: #6b7280; font-size: 12px;">
                                ğŸ“‹ <a href="https://nct.go.kr/distMental/rating/rating02_3.do" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    GAD-7 í•œêµ­íŒ í‘œì¤€ì§€ì¹¨ (êµ­ë¦½ì •ì‹ ê±´ê°•ì„¼í„°-êµ­ê°€íŠ¸ë¼ìš°ë§ˆì„¼í„°)
                                </a> â†—
                            </small>
                        </div>
                        
                        <div class="gad7-grid" id="gad7Grid"></div>
                        
                        <div class="gad7-result" id="gad7Result" style="display: none;">
                            <div class="gad7-score">ì´ì : <span id="gad7Total">0</span> / 21 <span id="gad7SevTag" class="gad7-sev none">ë¶ˆì•ˆ ì•„ë‹˜ (0â€“4)</span></div>
                            <div id="gad7Advice" class="gad7-note" style="margin-top:8px"></div>
                            <div class="gad7-btns">
                                <button id="gad7StartBtn" class="gad7-btn gad7-primary">ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰</button>
                                <button id="gad7BackBtn" class="gad7-btn gad7-ghost">PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
                            </div>
                        </div>
                        
                        <div class="gad7-progress" id="gad7Progress">
                            <div class="gad7-btns">
                                <button id="gad7CalcBtn" class="gad7-btn gad7-primary" disabled>ê²°ê³¼ í™•ì¸í•˜ê¸°</button>
                                <button id="gad7BackBtn2" class="gad7-btn gad7-ghost">PHQ-9 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°</button>
                            </div>
                            <div class="gad7-note" style="margin-top: 8px;">
                                ì™„ë£Œëœ ë¬¸í•­: <span id="gad7CompletedCount">0</span> / 7
                            </div>
                        </div>
                        
                        <div class="gad7-foot">
                            * ì´ ì„¤ë¬¸ì€ ì°¸ê³ ìš©ì…ë‹ˆë‹¤. ì ìˆ˜ê°€ ë†’ìœ¼ë©´, ìœ„í—˜ ì‹ í˜¸ì¼ ìˆ˜ ìˆìœ¼ë‹ˆ ì§€ì—­ ì •ì‹ ê±´ê°• ì „ë¬¸ê¸°ê´€ì— ê¼­ ìƒì˜í•˜ì„¸ìš”.
                        </div>
                    </div>
                </div>
            `;
            
            // ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ìˆ¨ê¸°ê¸°
            const existingContainer = document.querySelector('.container');
            if (existingContainer) {
                existingContainer.style.display = 'none';
            }
            
            document.body.appendChild(screeningDiv);
            initGAD7();
        }

        function initGAD7() {
            console.log('GAD-7 ê²€ì‚¬ ì´ˆê¸°í™” ì‹œì‘');
            
            const ITEMS = [
                'ì´ˆì¡°í•˜ê±°ë‚˜ ë¶ˆì•ˆí•˜ê±°ë‚˜ ì¡°ë§ˆì¡°ë§ˆí•˜ê²Œ ëŠë‚€ë‹¤.',
                'ê±±ì •í•˜ëŠ” ê²ƒì„ ë©ˆì¶”ê±°ë‚˜ ì¡°ì ˆí•  ìˆ˜ê°€ ì—†ë‹¤.',
                'ì—¬ëŸ¬ ê°€ì§€ ê²ƒë“¤ì— ëŒ€í•´ ê±±ì •ì„ ë„ˆë¬´ ë§ì´ í•œë‹¤.',
                'í¸í•˜ê²Œ ìˆê¸°ê°€ ì–´ë µë‹¤.',
                'ì‰½ê²Œ ì§œì¦ì´ ë‚˜ê±°ë‚˜ ì‰½ê²Œ ì„±ì„ ë‚´ê²Œ ëœë‹¤.',
                'ë„ˆë¬´ ì•ˆì ˆë¶€ì ˆëª»í•´ì„œ ê°€ë§Œíˆ ìˆê¸°ê°€ í˜ë“¤ë‹¤.',
                'ë§ˆì¹˜ ë”ì°í•œ ì¼ì´ ìƒê¸¸ ê²ƒì²˜ëŸ¼ ë‘ë µê²Œ ëŠê»´ì§„ë‹¤.'
            ];

            const grid = document.getElementById('gad7Grid');
            ITEMS.forEach((txt, i) => {
                const q = document.createElement('div');
                q.className = 'gad7-q';
                q.innerHTML = `<h3>${i+1}. ${txt}</h3>
                    <div class="gad7-opts">
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="0">ì „í˜€ ë°©í•´ë°›ì§€ ì•Šì•˜ë‹¤(0ì )</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="1">ë©°ì¹ ë™ì•ˆ ë°©í•´ë°›ì•˜ë‹¤(1ì )</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="2">2ì£¼ì¤‘ ì ˆë°˜ì´ìƒ ë°©í•´ë°›ì•˜ë‹¤(2ì )</label>
                        <label class="gad7-opt"><input type="radio" name="q${i}" value="3">ê±°ì˜ë§¤ì¼ ë°©í•´ë°›ì•˜ë‹¤(3ì )</label>
                    </div>`;
                grid.appendChild(q);
            });

            const totalEl = document.getElementById('gad7Total');
            const sevTag = document.getElementById('gad7SevTag');
            const advice = document.getElementById('gad7Advice');
            const startBtn = document.getElementById('gad7StartBtn');
            const backBtn = document.getElementById('gad7BackBtn');
            const calcBtn = document.getElementById('gad7CalcBtn');
            const backBtn2 = document.getElementById('gad7BackBtn2');
            const resultDiv = document.getElementById('gad7Result');
            const progressDiv = document.getElementById('gad7Progress');
            const completedCount = document.getElementById('gad7CompletedCount');

            function getGAD7Score() {
                let sum = 0;
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector('input[name=q' + i + ']:checked');
                    sum += v ? Number(v.value) : 0;
                }
                return sum;
            }

            function getCompletedCount() {
                // DOM ê¸°ë°˜ìœ¼ë¡œ ê° ë¬¸í•­ ì»¨í…Œì´ë„ˆì—ì„œ ì„ íƒ ì—¬ë¶€ë¥¼ ê³„ì‚° (ë” ê²¬ê³ )
                let completed = 0;
                const questions = document.querySelectorAll('.gad7-q');
                questions.forEach((qEl) => {
                    const checked = qEl.querySelector('input[type="radio"]:checked');
                    if (checked) completed++;
                });
                return completed;
            }

            function updateGAD7Progress() {
                const completed = getCompletedCount();
                completedCount.textContent = completed;
                
                if(completed === 7) {
                    calcBtn.disabled = false;
                    calcBtn.textContent = 'ê²°ê³¼ í™•ì¸í•˜ê¸° âœ…';
                } else {
                    calcBtn.disabled = true;
                    calcBtn.textContent = 'ê²°ê³¼ í™•ì¸í•˜ê¸° (' + completed + '/7)';
                }
            }

            function getGAD7SeverityClass(score) {
                if(score <= 4) return ['ì •ìƒ (0â€“4ì )', 'none'];
                if(score <= 9) return ['ê²½ë¯¸í•œ ìˆ˜ì¤€ (5â€“9ì )', 'mild'];
                if(score <= 14) return ['ì¤‘ê°„ìˆ˜ì¤€ (10â€“14ì )', 'mod'];
                return ['ì‹¬í•œìˆ˜ì¤€ (15â€“21ì )', 'sev'];
            }

            function showGAD7Results() {
                const score = getGAD7Score();
                console.log('GAD-7 ê²°ê³¼ ê³„ì‚° ì™„ë£Œ, ì ìˆ˜:', score);
                
                // ì¸êµ¬í†µê³„ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                
                // GAD-7 ì ìˆ˜ë¥¼ í•˜ì´ë¸Œë¦¬ë“œ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
                const timestamp = Date.now();
                // ê° ë¬¸í•­ ì ìˆ˜ ìˆ˜ì§‘ (1â€“7)
                const items = {};
                for(let i = 0; i < ITEMS.length; i++) {
                    const v = document.querySelector('input[name=q' + i + ']:checked');
                    items[String(i+1)] = v ? Number(v.value) : 0;
                }

                const gad7Data = {
                    score: score,
                    items: items,
                    timestamp: timestamp,
                    expires: timestamp + (24 * 60 * 60 * 1000),
                    demographics: demographicsData
                };
                
                sessionStorage.setItem('gad7_data', JSON.stringify(gad7Data));
                localStorage.setItem('gad7_data', JSON.stringify(gad7Data));
                
                totalEl.textContent = score;
                
                // GAD-7 ì‹¬ê°ë„ì— ë”°ë¥¸ ê²°ê³¼ í‘œì‹œ ë° ì¡°ì¹˜
                const [severityLabel, severityClass] = getGAD7SeverityClass(score);
                sevTag.textContent = severityLabel;
                sevTag.className = 'gad7-sev ' + severityClass;
                sevTag.style.display = 'block';
                
                // ì‹¬ê°ë„ì— ë”°ë¥¸ ì¡°ì–¸ ë° ë²„íŠ¼ ìƒíƒœ ì„¤ì •
                if (score <= 4) {
                    // ì •ìƒ ë²”ìœ„
                    advice.innerHTML = '<strong>ì •ìƒ:</strong> ì£¼ì˜ê°€ í•„ìš”í•  ì •ë„ì˜ ê³¼ë„í•œ ê±±ì •ì´ë‚˜ ë¶ˆì•ˆì„ ë³´ê³ í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰';
                } else if (score <= 9) {
                    // ê²½ë¯¸í•œ ìˆ˜ì¤€
                    advice.innerHTML = '<strong>ê²½ë¯¸í•œ ìˆ˜ì¤€:</strong> ë‹¤ì†Œ ê²½ë¯¸í•œ ìˆ˜ì¤€ì˜ ê±±ì •ê³¼ ë¶ˆì•ˆì„ ë³´ê³ í•˜ì˜€ìŠµë‹ˆë‹¤. ì£¼ì˜ê¹Šì€ ê´€ì°°ê³¼ ê´€ì‹¬ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰';
                } else if (score <= 14) {
                    // ì¤‘ê°„ìˆ˜ì¤€
                    advice.innerHTML = '<strong>ì¤‘ê°„ìˆ˜ì¤€:</strong> ì£¼ì˜ê°€ í•„ìš”í•œ ìˆ˜ì¤€ì˜ ê³¼ë„í•œ ê±±ì •ê³¼ ë¶ˆì•ˆì„ ë³´ê³ í•˜ì˜€ìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ í‰ê°€ë‚˜ ì •ì‹ ê±´ê°• ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ì•„ë³´ì‹œê¸°ë¥¼ ê¶Œí•´ ë“œë¦½ë‹ˆë‹¤.';
                    advice.className = 'gad7-note';
                    startBtn.disabled = false;
                    startBtn.textContent = 'ë‹¤ìŒ ë‹¨ê³„ë¡œ ì§„í–‰';
                } else {
                    // ì‹¬í•œìˆ˜ì¤€ (15-21ì ) - í”„ë¡œê·¸ë¨ ì¦‰ì‹œ ì¤‘ë‹¨
                    advice.innerHTML = '<strong>ì‹¬í•œìˆ˜ì¤€:</strong> ì¼ìƒìƒí™œì— ì§€ì¥ì„ ì´ˆë˜í•  ì •ë„ì˜ ê³¼ë„í•˜ê³  ì‹¬í•œ ê±±ì •ê³¼ ë¶ˆì•ˆì„ ë³´ê³ í•˜ì˜€ìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ í‰ê°€ë‚˜ ì •ì‹ ê±´ê°• ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ì•„ ë³´ì‹œê¸°ë¥¼ ê¶Œí•´ ë“œë¦½ë‹ˆë‹¤.';
                    advice.className = 'gad7-note phq9-warn';
                    startBtn.disabled = true;
                    startBtn.textContent = 'í”„ë¡œê·¸ë¨ ì¤‘ë‹¨';
                    
                    // ì‹¬ë¦¬ìƒë‹´ í¬í„¸ ì•ˆë‚´ ì¶”ê°€
                    const portalDiv = document.createElement('div');
                    portalDiv.style.cssText = 'background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 16px; margin: 16px 0;';
                    portalDiv.innerHTML = `
                        <h4 style="margin: 0 0 12px; color: #856404;">âš ï¸ í”„ë¡œê·¸ë¨ ì¤‘ë‹¨ ì•ˆë‚´</h4>
                        <p style="margin: 0 0 16px; color: #856404;">í˜„ì¬ ì ìˆ˜ëŠ” ì‹¬í•œ ë¶ˆì•ˆ ìˆ˜ì¤€ìœ¼ë¡œ, í”„ë¡œê·¸ë¨ì„ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³  ì „ë¬¸ê°€ì˜ ë„ì›€ì„ ë°›ìœ¼ì‹œê¸° ë°”ëë‹ˆë‹¤.</p>
                        
                        <h4 style="margin: 0 0 12px; color: #856404;">ğŸ’¡ ì‹¬ë¦¬ìƒë‹´ í¬í„¸ ì•ˆë‚´</h4>
                        <div style="background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px; padding: 12px; margin: 8px 0;">
                            <strong>ì‹¬ë¦¬ìƒë‹´ í¬í„¸:</strong> 
                            <a href="https://www.mindinfo.kr/new/index.asp" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                https://www.mindinfo.kr/new/index.asp
                            </a> â†—
                            <br><small style="color: #6b7280;">ìƒë‹´ì‹¬ë¦¬ì‚¬ ì°¾ê¸°, ì‹¬ë¦¬ìƒë‹´ì„¼í„° ì°¾ê¸°, ê³µê³µ ì‹¬ë¦¬ìƒë‹´ ê¸°ê´€ ë° ì„œë¹„ìŠ¤ ì •ë³´ ì œê³µ</small>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px;">
                            <strong>ğŸ“ ì£¼ìš” ìƒë‹´ ì—°ë½ì²˜:</strong>
                            <ul style="margin: 8px 0; padding-left: 20px; color: #1e40af;">
                                <li>ì •ì‹ ê±´ê°• ìƒë‹´ì „í™”: 1577-0199 (24ì‹œê°„)</li>
                                <li>ìƒëª…ì˜ ì „í™”: 1588-9191 (24ì‹œê°„)</li>
                                <li>ìì‚´ì˜ˆë°©ìƒë‹´ì „í™”: 1393 (24ì‹œê°„)</li>
                            </ul>
                        </div>
                        
                        <div style="margin-top: 16px; padding: 12px; background: #e8f5e8; border: 1px solid #27ae60; border-radius: 6px;">
                            <h4 style="margin: 0 0 12px; color: #27ae60;">ğŸ’¡ ì¹´ì¹´ì˜¤í†¡ ìƒë‹´ ì±„ë„</h4>
                            <p style="margin: 0 0 12px; color: #27ae60;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´ì„ ìœ„í•œ ì±„ë„ì…ë‹ˆë‹¤.</p>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>ë‹¤ ë“¤ì–´ì¤„ ê°œ:</strong> 
                                <a href="https://pf.kakao.com/_CxoBxcC" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_CxoBxcC
                                </a> â†—
                                <br><small style="color: #6b7280;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´, 24ì‹œê°„ ì±„íŒ… ìƒë‹´ ê°€ëŠ¥</small>
                            </div>
                            <div style="background: #f0f9ff; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin: 8px 0;">
                                <strong>ë§ˆë“¤ëœ:</strong> 
                                <a href="https://pf.kakao.com/_DAxbYG" target="_blank" style="color: #2563eb; text-decoration: none; font-weight: 500;">
                                    https://pf.kakao.com/_DAxbYG
                                </a> â†—
                                <br><small style="color: #6b7280;">ìš°ìš¸ì¦ ë° ë¶ˆì•ˆì¦ ì „ë¬¸ ìƒë‹´, 24ì‹œê°„ ì±„íŒ… ìƒë‹´ ê°€ëŠ¥</small>
                            </div>
                        </div>
                    `;
                    
                    // advice ìš”ì†Œ ë‹¤ìŒì— í¬í„¸ ì•ˆë‚´ ì¶”ê°€
                    advice.parentNode.insertBefore(portalDiv, advice.nextSibling);
                }
                
                advice.style.display = 'block';

                // ê²°ê³¼ í™”ë©´ìœ¼ë¡œ ì „í™˜
                progressDiv.style.display = 'none';
                resultDiv.style.display = 'block';
            }

            document.addEventListener('change', e => {
                if(e.target.matches('.gad7-screening input[type=radio]')) updateGAD7Progress();
            });

            calcBtn.addEventListener('click', showGAD7Results);

            backBtn2.addEventListener('click', () => {
                document.querySelector('.gad7-screening').remove();
                showPHQ9ResultsFromGAD7();
            });

            backBtn.addEventListener('click', () => {
                document.querySelector('.gad7-screening').remove();
                showPHQ9ResultsFromGAD7();
            });

            startBtn.addEventListener('click', () => {
                console.log('GAD-7 ë‹¤ìŒ ë‹¨ê³„ ë²„íŠ¼ í´ë¦­ - ì¶”ê°€ ì •ë³´ ì…ë ¥ í˜ì´ì§€ë¡œ ì´ë™');
                const gad = document.querySelector('.gad7-screening');
                if (!gad) return;
                gad.innerHTML = `
                    <div class="gad7-wrap">
                        <div class="gad7-card">
                            <h1 class="gad7-title">ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ ì…ë ¥</h1>
                            <div class="demo-section" style="margin-top: 16px;">
                                <div class="demo-section">
                                    <h4>ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ í¬ë§ ì—¬ë¶€</h4>
                                    <div class="demo-options">
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="yes">
                                            <span class="demo-label">í•¨ê»˜ í•˜ëŠ” ì§‘ë‹¨ ì˜í™”ì œì‘ì¹˜ë£Œì— ì°¸ì—¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.</span>
                                        </label>
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="no">
                                            <span class="demo-label">í˜¼ì ì§„í–‰í•˜ëŠ” ê°œì¸ ì˜í™”ì œì‘ì¹˜ë£Œì— ì°¸ì—¬í•˜ê³  ì‹¶ìŠµë‹ˆë‹¤.</span>
                                        </label>
                                        <label class="demo-option">
                                            <input type="radio" name="groupParticipation_afterGAD7" value="none">
                                            <span class="demo-label">ì•„ë‹ˆì˜¤, ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <div id="additionalInfoSection" class="demo-section" style="margin-top:8px; display: none;">
                                    <div class="demo-section">
                                        <h4>2) ì„±ë³„</h4>
                                        <div class="demo-options">
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="0">
                                                <span class="demo-label">ë‚¨ì„±</span>
                                            </label>
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="1">
                                                <span class="demo-label">ì—¬ì„±</span>
                                            </label>
                                            <label class="demo-option">
                                                <input type="radio" name="gender_afterGAD7" value="2">
                                                <span class="demo-label">ê¸°íƒ€</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="demo-section" style="margin-top:8px;">
                                        <h4>3) ì—°ë ¹ëŒ€</h4>
                                        <div class="demo-input">
                                            <input type="number" id="age_afterGAD7" min="13" max="100" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                                            <span class="demo-unit">ì„¸</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="gad7-btns" style="margin-top: 20px;">
                                <button id="postNextBtn" class="gad7-btn gad7-primary" disabled>ë‹¤ìŒ</button>
                                <button id="postBackBtn" class="gad7-btn gad7-ghost">ì´ì „ìœ¼ë¡œ</button>
                            </div>
                        </div>
                    </div>
                `;

                const postNextBtn = document.getElementById('postNextBtn');
                const postBackBtn = document.getElementById('postBackBtn');

                const saveDemographics = (updates) => {
                    const existing = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                    const next = { ...existing, ...updates };
                    sessionStorage.setItem('demographics_data', JSON.stringify(next));
                    localStorage.setItem('demographics_data', JSON.stringify(next));
                    console.log('ì¸êµ¬í†µê³„ ì €ì¥:', next);
                };

                function updateNextState() {
                    const selectedGP = document.querySelector('input[name="groupParticipation_afterGAD7"]:checked');
                    const additionalInfoSection = document.getElementById('additionalInfoSection');
                    
                    // ì§‘ë‹¨ ì°¸ì—¬ ì„ íƒì— ë”°ë¼ ì¶”ê°€ ì •ë³´ ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
                    if (selectedGP && (selectedGP.value === 'yes' || selectedGP.value === 'no')) {
                        additionalInfoSection.style.display = 'block';
                        
                        // ì„±ë³„ê³¼ ì—°ë ¹ëŒ€ê°€ ëª¨ë‘ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
                        const selectedGender = document.querySelector('input[name="gender_afterGAD7"]:checked');
                        const ageVal = document.getElementById('age_afterGAD7')?.value;
                        const ageOk = ageVal && parseInt(ageVal) >= 13 && parseInt(ageVal) <= 100;
                        
                        postNextBtn.disabled = !(selectedGender && ageOk);
                    } else if (selectedGP && selectedGP.value === 'none') {
                        // 'ì–´ëŠ ê²ƒì—ë„ ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤' ì„ íƒ ì‹œ
                        additionalInfoSection.style.display = 'none';
                        postNextBtn.disabled = false; // ë°”ë¡œ ì§„í–‰ ê°€ëŠ¥
                    } else {
                        // ì•„ë¬´ê²ƒë„ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°
                        additionalInfoSection.style.display = 'none';
                        postNextBtn.disabled = true;
                    }
                }

                document.addEventListener('change', (e) => {
                    if (e.target.matches('input[name="gender_afterGAD7"]')) {
                        saveDemographics({ gender: parseInt(e.target.value) });
                        updateNextState();
                    }
                    if (e.target.matches('input[name="groupParticipation_afterGAD7"]')) {
                        saveDemographics({ groupParticipation: e.target.value });
                        updateNextState();
                        
                        // ì§‘ë‹¨ ì°¸ì—¬ ì„ íƒì´ ë³€ê²½ë˜ë©´ ì„±ë³„ê³¼ ì—°ë ¹ëŒ€ ì´ˆê¸°í™”
                        if (e.target.value === 'none') {
                            // 'ì–´ëŠ ê²ƒì—ë„ ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤' ì„ íƒ ì‹œ ê¸°ì¡´ ì„±ë³„/ì—°ë ¹ëŒ€ ì„ íƒ í•´ì œ
                            document.querySelectorAll('input[name="gender_afterGAD7"]').forEach(radio => radio.checked = false);
                            document.getElementById('age_afterGAD7').value = '';
                            saveDemographics({ gender: undefined, age: undefined });
                        }
                    }
                });
                const ageInput = document.getElementById('age_afterGAD7');
                if (ageInput) {
                    ageInput.addEventListener('input', () => {
                        const ageVal = ageInput.value ? parseInt(ageInput.value) : null;
                        saveDemographics({ age: ageVal });
                        updateNextState();
                    });
                }

                // ê¸°ì¡´ ê°’ í”„ë¦¬í•„
                const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                if (Number.isInteger(demographicsData.gender)) {
                    const gpre = document.querySelector(`input[name=\"gender_afterGAD7\"][value=\"${demographicsData.gender}\"]`);
                    if (gpre) gpre.checked = true;
                }
                if (demographicsData && demographicsData.age) {
                    const ap = document.getElementById('age_afterGAD7');
                    if (ap) ap.value = demographicsData.age;
                }
                if (demographicsData && demographicsData.groupParticipation) {
                    const gp = document.querySelector(`input[name=\"groupParticipation_afterGAD7\"][value=\"${demographicsData.groupParticipation}\"]`);
                    if (gp) gp.checked = true;
                }
                updateNextState();

                postBackBtn.addEventListener('click', () => {
                    // ì´ì „: GAD-7 ê²°ê³¼ë¡œ ëŒì•„ê°€ê¸°
                    showGAD7Results();
                });
                postNextBtn.addEventListener('click', () => {
                    console.log('ë‹¤ìŒ ë²„íŠ¼ í´ë¦­ - ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ì— ë”°ë¥¸ ì²˜ë¦¬');
                    
                    // ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ í™•ì¸
                    const demographicsData = JSON.parse(sessionStorage.getItem('demographics_data') || localStorage.getItem('demographics_data') || '{}');
                    const groupParticipation = demographicsData.groupParticipation;
                    
                    if (groupParticipation === 'none') {
                        // 'ì•„ë‹ˆì˜¤, ì°¸ì—¬í•˜ì§€ ì•Šê² ìŠµë‹ˆë‹¤' ì„ íƒ ì‹œ
                        showCompletionMessage(gad);
                    } else if (groupParticipation === 'yes' || groupParticipation === 'no') {
                        // 'í•¨ê»˜ í•˜ëŠ” ì§‘ë‹¨ ì˜í™”ì œì‘ì¹˜ë£Œ' ë˜ëŠ” 'í˜¼ì ì§„í–‰í•˜ëŠ” ê°œì¸ ì˜í™”ì œì‘ì¹˜ë£Œ' ì„ íƒ ì‹œ
                        showHighScoreItems(gad);
                    } else {
                        // ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš°
                        gad.innerHTML = '<div style="text-align:center; padding:20px;">ì˜í™”ì œì‘ì¹˜ë£Œ ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</div>';
                    }
                });
            });

            updateGAD7Progress();
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì •
            setupRadioButtonStyles();
            
            // ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì • í•¨ìˆ˜
            function setupRadioButtonStyles() {
                console.log('ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì • ì‹œì‘');
                
                // GAD-7 ë¬¸í•­ë“¤ì˜ ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì •
                const gad7Questions = document.querySelectorAll('.gad7-q');
                console.log('ì°¾ì€ GAD-7 ë¬¸í•­ ê°œìˆ˜:', gad7Questions.length);
                
                gad7Questions.forEach((questionItem, questionIndex) => {
                    const labels = questionItem.querySelectorAll('.gad7-opt');
                    console.log(`ë¬¸í•­ ${questionIndex + 1}ì˜ ë¼ë²¨ ê°œìˆ˜:`, labels.length);
                    
                    labels.forEach((label, labelIndex) => {
                        const radio = label.querySelector('input[type="radio"]');
                        
                        if (!radio) {
                            console.error(`ë¬¸í•­ ${questionIndex + 1}, ë¼ë²¨ ${labelIndex}ì— radio ìš”ì†Œê°€ ì—†ìŒ:`, label);
                            return;
                        }
                        
                        // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ (ë¼ë²¨ ì „ì²´ í´ë¦­ ê°€ëŠ¥)
                        label.addEventListener('click', () => {
                            console.log(`ë¬¸í•­ ${questionIndex + 1}, ë¼ë²¨ ${labelIndex} í´ë¦­ë¨, ê°’: ${radio.value}`);
                            
                            // ê°™ì€ ë¬¸í•­ ë‚´ì˜ ë‹¤ë¥¸ ë¼ë””ì˜¤ ë²„íŠ¼ë“¤ í•´ì œ
                            const sameQuestionLabels = questionItem.querySelectorAll('.gad7-opt');
                            sameQuestionLabels.forEach(l => {
                                const r = l.querySelector('input[type="radio"]');
                                if (r) r.checked = false;
                                l.classList.remove('selected');
                            });
                            
                            // í˜„ì¬ ë¼ë””ì˜¤ ë²„íŠ¼ ì„ íƒ
                            radio.checked = true;
                            label.classList.add('selected');
                            
                            // change ì´ë²¤íŠ¸ ë°œìƒ
                            radio.dispatchEvent(new Event('change'));
                            updateGAD7Progress();
                        });
                        
                        // radio change ì´ë²¤íŠ¸ë„ ìœ ì§€
                        radio.addEventListener('change', () => {
                            console.log(`ë¬¸í•­ ${questionIndex + 1}, ë¼ë””ì˜¤ ë²„íŠ¼ ${labelIndex} ë³€ê²½ë¨, ê°’: ${radio.value}, ì²´í¬ë¨: ${radio.checked}`);
                            
                            if (radio.checked) {
                                // ê°™ì€ ë¬¸í•­ ë‚´ì˜ ë‹¤ë¥¸ ë¼ë²¨ë“¤ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                                const sameQuestionLabels = questionItem.querySelectorAll('.gad7-opt');
                                sameQuestionLabels.forEach(l => {
                                    l.classList.remove('selected');
                                });
                                
                                // ì„ íƒëœ ë¼ë²¨ ìŠ¤íƒ€ì¼ ë³€ê²½
                                label.classList.add('selected');
                            }
                            updateGAD7Progress();
                        });
                    });
                });
                
                console.log('ë¼ë””ì˜¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì„¤ì • ì™„ë£Œ');
            }
        }

        // ê°œì¸ì •ë³´ ë³´í˜¸ë²• ìƒì„¸ ê°€ì´ë“œ í•¨ìˆ˜
        function showPrivacyGuide() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.6);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="width: min(720px,92vw); background: #111827; border: 1px solid #1f2937; border-radius: 16px; padding: 20px; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px; margin-bottom: 16px;">
                        <h2 style="color: #e5e7eb; margin: 0;">ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸ë²• ìƒì„¸ ê°€ì´ë“œ</h2>
                        <button onclick="this.closest('.privacy-modal').remove()" style="background: transparent; border: 1px solid #374151; color: #9ca3af; padding: 8px 12px; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">ìˆ˜ì§‘Â·ì´ìš© ë™ì˜ (ì œ15ì¡°, ì œ16ì¡°, ì œ22ì¡°)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>ëª©ì Â·í•­ëª©Â·ë³´ìœ ê¸°ê°„Â·ê±°ë¶€ê¶Œ ë° ë¶ˆì´ìµ ê³ ì§€ í›„ ë™ì˜ ë°›ì•„ì•¼ í•¨(ì œ15ì¡°â‘¡, ì œ22ì¡°)</li>
                            <li>ëª©ì ì— í•„ìš”í•œ 'ìµœì†Œí•œì˜ ì •ë³´'ë§Œ ìˆ˜ì§‘(ì œ16ì¡°)</li>
                            <li>ì„ íƒ ë™ì˜ ë¯¸ì²´í¬ë§Œìœ¼ë¡œ ì„œë¹„ìŠ¤ ì œê³µ ê±°ë¶€ ê¸ˆì§€(ì œ22ì¡°â‘¤)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">ì œ3ì ì œê³µ ë° ëª©ì  ì™¸ ì œí•œ (ì œ17ì¡°, ì œ18ì¡°)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>ì œê³µë°›ëŠ” ìÂ·ëª©ì Â·í•­ëª©Â·ë³´ìœ ê¸°ê°„ì„ ì•Œë¦¬ê³  'ë³„ë„ ë™ì˜' í•„ìš”(ì œ17ì¡°â‘¡)</li>
                            <li>ìˆ˜ì§‘ ëª©ì  ì™¸ ì´ìš©Â·ì œê³µì€ ì›ì¹™ì ìœ¼ë¡œ ê¸ˆì§€(ì œ18ì¡°â‘ )</li>
                            <li>ì˜ˆì™¸ ì œê³µ ì‹œì—ë„ ì •ë³´ì£¼ì²´ ì´ìµ ì¹¨í•´ ê¸ˆì§€ ë° ì•ˆì „ì¡°ì¹˜ ìš”ì²­(ì œ18ì¡°â‘¡Â·â‘¤)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">ì •ë³´ì£¼ì²´ ê¶Œë¦¬ (ì œ35Â·36Â·37Â·37ì˜2)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>ë³¸ì¸ì •ë³´ 'ì—´ëŒ' ìš”êµ¬(ì œ35ì¡°), 'ì •ì •Â·ì‚­ì œ' ìš”êµ¬(ì œ36ì¡°), 'ì²˜ë¦¬ì •ì§€/ë™ì˜ì² íšŒ'(ì œ37ì¡°)</li>
                            <li>ì™„ì „ ìë™í™”ëœ 'ê²°ì •'ì— ëŒ€í•œ ê±°ë¶€Â·ì„¤ëª…ìš”êµ¬ ê°€ëŠ¥(ì œ37ì˜2)</li>
                            <li>ìš”êµ¬ ì ˆì°¨ëŠ” ìˆ˜ì§‘ ì ˆì°¨ë³´ë‹¤ ì–´ë µì§€ ì•Šê²Œ ì œê³µ(ì œ38ì¡°â‘£)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1f2937; border: 1px solid #374151; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">íŒŒê¸° (ì œ21ì¡°) & ì•ˆì „ì¡°ì¹˜(ì œ29ì¡°)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li>ë³´ìœ ê¸°ê°„ ê²½ê³¼Â·ëª©ì  ë‹¬ì„± ë“± ë¶ˆí•„ìš” ì‹œ 'ì§€ì²´ì—†ì´' íŒŒê¸°(ì œ21ì¡°â‘ )</li>
                            <li>ë³µêµ¬Â·ì¬ìƒ ë¶ˆê°€ ë°©ì‹ìœ¼ë¡œ íŒŒê¸°í•˜ê³  ë¶„ë¦¬ë³´ê´€ ì‹œ ë¶„ë¦¬ ìœ ì§€(ì œ21ì¡°â‘¡Â·â‘¢)</li>
                            <li>ì ‘ê·¼í†µì œÂ·ë¡œê·¸ë³´ê´€ ë“± ì•ˆì „ì¡°ì¹˜ ì˜ë¬´(ì œ29ì¡°)</li>
                        </ul>
                    </div>
                    
                    <div style="background: #1e3a8a; border: 1px solid #3b82f6; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">ìƒë‹´ìœ¤ë¦¬ ë° ë¹„ë°€ë³´ì¥ (ìƒë‹´ì‹¬ë¦¬í•™íšŒ)</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><b>ë¹„ë°€ë³´ì¥ ì›ì¹™:</b> ëª¨ë“  ìƒë‹´ ë‚´ìš©ì€ ì² ì €í•œ ë¹„ë°€ë³´ì¥ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤</li>
                            <li><b>ìœ¤ë¦¬ì  ì±…ì„:</b> ìƒë‹´ì‚¬ëŠ” ë‚´ë‹´ìì˜ ë³µì§€ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤</li>
                            <li><b>ê²½ê³„ ì„¤ì •:</b> ì „ë¬¸ì  ê´€ê³„ ìœ ì§€ë¥¼ ìœ„í•œ ëª…í™•í•œ ê²½ê³„ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤</li>
                            <li><b>ìê¸°ê²°ì •ê¶Œ:</b> ë‚´ë‹´ìì˜ ìê¸°ê²°ì •ê¶Œì„ ì¡´ì¤‘í•˜ê³  ë³´í˜¸í•©ë‹ˆë‹¤</li>
                            <li><b>ì „ë¬¸ì„± ìœ ì§€:</b> ì§€ì†ì ì¸ êµìœ¡ê³¼ í›ˆë ¨ì„ í†µí•´ ì „ë¬¸ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤</li>
                        </ul>
                    </div>
                    
                    <div style="background: #dc2626; border: 1px solid #ef4444; border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                        <h3 style="color: #e5e7eb; margin: 0 0 12px 0; font-size: 1.1em;">ìµœìš°ì„  ë³´í˜¸ ì›ì¹™</h3>
                        <ul style="color: #d1d5db; margin: 0; padding-left: 20px; line-height: 1.6;">
                            <li><b>1ìˆœìœ„:</b> ê°œì¸ì •ë³´ ë³´í˜¸ë²• ë° ìƒë‹´ìœ¤ë¦¬ ì¤€ìˆ˜</li>
                            <li><b>ì ˆëŒ€ ì›ì¹™:</b> ë¹„ë°€ë³´ì¥ ë° í”„ë¼ì´ë²„ì‹œ ë³´í˜¸</li>
                            <li><b>ì•ˆì „ì¡°ì¹˜:</b> ëª¨ë“  ë°ì´í„°ëŠ” ì•”í˜¸í™” ë° ê°€ëª…ì²˜ë¦¬ í›„ ì²˜ë¦¬</li>
                            <li><b>ì ‘ê·¼ ì œí•œ:</b> ìŠ¹ì¸ëœ ì¸ì›ë§Œ ì œí•œì ìœ¼ë¡œ ì ‘ê·¼ ê°€ëŠ¥</li>
                            <li><b>ê°ì‚¬ ì¶”ì :</b> ëª¨ë“  ì ‘ê·¼ ë° ì²˜ë¦¬ ê³¼ì •ì„ ê¸°ë¡í•˜ê³  ì¶”ì </li>
                        </ul>
                    </div>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">ì›ë¬¸ ë³´ê¸°(êµ­ê°€ë²•ë ¹ì •ë³´ì„¼í„°)</summary>
                        <div style="margin-top: 12px;">
                            <div style="margin-bottom: 8px;">â†— <a href="https://www.law.go.kr/ë²•ë ¹/ê°œì¸ì •ë³´ë³´í˜¸ë²•/ì œ15ì¡°" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">ì œ15ì¡° ìˆ˜ì§‘Â·ì´ìš©</a></div>
                            <div style="margin-bottom: 8px;">â†— <a href="https://www.law.go.kr/ë²•ë ¹/ê°œì¸ì •ë³´ë³´í˜¸ë²•/ì œ17ì¡°" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">ì œ17ì¡° ì œ3ì ì œê³µ</a></div>
                            <div style="margin-bottom: 8px;">â†— <a href="https://www.law.go.kr/ë²•ë ¹/ê°œì¸ì •ë³´ë³´í˜¸ë²•/ì œ35ì¡°" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">ì œ35ì¡° ì—´ëŒ</a></div>
                            <div style="margin-bottom: 8px;">â†— <a href="https://www.law.go.kr/ë²•ë ¹/ê°œì¸ì •ë³´ë³´í˜¸ë²•/ì œ21ì¡°" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">ì œ21ì¡° íŒŒê¸°</a></div>
                            <div style="margin-bottom: 8px;">â†— <a href="https://www.privacy.go.kr" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">ê°œì¸ì •ë³´ë³´í˜¸ìœ„ì›íšŒ</a></div>
                        </div>
                    </details>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">ìƒë‹´ì‹¬ë¦¬í•™íšŒ ê´€ë ¨ ë§í¬</summary>
                        <div style="margin-top: 12px;">
                            <div style="margin-bottom: 8px;">â†— <a href="http://krcpa.or.kr/user/new/sub03_1.asp" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">í•œêµ­ìƒë‹´ì‹¬ë¦¬í•™íšŒ ìœ¤ë¦¬ê·œì •</a></div>
                            <div style="margin-bottom: 8px;">â†— <a href="http://krcpa.or.kr" target="_blank" rel="noopener" style="color: #93c5fd; text-decoration: none;">í•œêµ­ìƒë‹´ì‹¬ë¦¬í•™íšŒ í™ˆí˜ì´ì§€</a></div>
                            <div style="margin-bottom: 8px; color: #fca5a5; font-size: 0.9em;">
                                ğŸ’¡ ë§í¬ê°€ ì‘ë™í•˜ì§€ ì•Šì„ ê²½ìš°: ì£¼ì†Œë¥¼ ë³µì‚¬í•´ì„œ ë¸Œë¼ìš°ì €ì— ì§ì ‘ ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”
                            </div>
                            <div style="margin-bottom: 8px; color: #fca5a5; font-size: 0.9em;">
                                ğŸ“§ ë¬¸ì˜: kcpa@krcpa.or.kr | ğŸ“ 02-498-8293
                            </div>
                        </div>
                    </details>
                    
                    <details style="background: #0c162a; border: 1px solid #374151; border-radius: 12px; padding: 12px; margin-top: 16px;">
                        <summary style="cursor: pointer; color: #a5b4fc; font-weight: 500;">ìƒë‹´ìœ¤ë¦¬ í•µì‹¬ ì›ì¹™ (ì§ì ‘ ì œê³µ)</summary>
                        <div style="margin-top: 12px; color: #d1d5db; line-height: 1.6;">
                            <div style="margin-bottom: 12px;">
                                <strong>1. ë¹„ë°€ë³´ì¥ ì›ì¹™</strong><br>
                                â€¢ ëª¨ë“  ìƒë‹´ ë‚´ìš©ì€ ì² ì €í•œ ë¹„ë°€ë³´ì¥ ì›ì¹™ì„ ë”°ë¦…ë‹ˆë‹¤<br>
                                â€¢ ì œ3ìì—ê²Œ ì •ë³´ë¥¼ ì œê³µí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤<br>
                                â€¢ ì˜ˆì™¸: ìí•´/íƒ€í•´ ìœ„í—˜ ì‹œì—ë§Œ ë²•ì  ì˜ë¬´ë¡œ ì‹ ê³ 
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>2. ë‚´ë‹´ì ë³µì§€ ìµœìš°ì„ </strong><br>
                                â€¢ ìƒë‹´ì‚¬ëŠ” ë‚´ë‹´ìì˜ ë³µì§€ë¥¼ ìµœìš°ì„ ìœ¼ë¡œ í•©ë‹ˆë‹¤<br>
                                â€¢ ë‚´ë‹´ìì˜ ìê¸°ê²°ì •ê¶Œì„ ì¡´ì¤‘í•©ë‹ˆë‹¤<br>
                                â€¢ ì „ë¬¸ì  ê²½ê³„ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>3. ì „ë¬¸ì„±ê³¼ ìœ¤ë¦¬ì  ì±…ì„</strong><br>
                                â€¢ ì§€ì†ì ì¸ êµìœ¡ê³¼ í›ˆë ¨ì„ í†µí•´ ì „ë¬¸ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤<br>
                                â€¢ ìœ¤ë¦¬ì  ë”œë ˆë§ˆ ë°œìƒ ì‹œ ì „ë¬¸ê°€ ìƒë‹´ì„ ë°›ìŠµë‹ˆë‹¤<br>
                                â€¢ ë‚´ë‹´ìì—ê²Œ í•´ë¥¼ ë¼ì¹˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                            </div>
                            <div style="margin-bottom: 12px;">
                                <strong>4. ê°œì¸ì •ë³´ ë³´í˜¸</strong><br>
                                â€¢ ê°œì¸ì •ë³´ ë³´í˜¸ë²•ì„ ì² ì €íˆ ì¤€ìˆ˜í•©ë‹ˆë‹¤<br>
                                â€¢ ìµœì†Œí•œì˜ ì •ë³´ë§Œ ìˆ˜ì§‘í•˜ê³  ì•ˆì „í•˜ê²Œ ë³´ê´€í•©ë‹ˆë‹¤<br>
                                â€¢ ëª©ì  ë‹¬ì„± í›„ ì§€ì²´ì—†ì´ íŒŒê¸°í•©ë‹ˆë‹¤
                            </div>
                        </div>
                    </details>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="this.closest('.privacy-modal').remove()" style="background: #22c55e; color: white; padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer;">í™•ì¸</button>
                    </div>
                </div>
            `;
            
            modal.className = 'privacy-modal';
            document.body.appendChild(modal);
            
            // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // ì´ˆê¸° ë¡œë“œ ì‹œ, ì˜ë„ì¹˜ ì•Šê²Œ ë¬¸ì„œ ë§ë¯¸ì— ë¶™ì€ ì‚¬ë³¸ UI ë¸”ë¡ì„ ì œê±°
        (function removeAppendedDuplicatesOnLoad(){
            if (document.readyState !== 'loading') cleanup();
            else document.addEventListener('DOMContentLoaded', cleanup);
            function cleanup(){
                // í˜ì´ì§€ ìµœì´ˆ ë¡œë“œ ì‹œì—ë§Œ ì •ë¦¬: ì´í›„ ë™ì  ë Œë”ë§ì€ ìœ ì§€
                const stray = document.querySelectorAll('body > .demographics-survey, body > .gad7-screening');
                stray.forEach(el => {
                    try { el.remove(); } catch(e) {}
                });
            }
        })();
</script>
</body>
</html>